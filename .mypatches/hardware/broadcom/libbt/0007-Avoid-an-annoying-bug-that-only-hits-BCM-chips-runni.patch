From 29c5fadd1c684a42c59699a01b54e8061da0d3fd Mon Sep 17 00:00:00 2001
From: Dmitry Grinberg <dmitrygr@gmail.com>
Date: Sat, 10 Oct 2015 10:10:11 +0000
Subject: [PATCH 07/11] Avoid an annoying bug that only hits BCM chips running
 at less than 3MBps

Change-Id: If31e05cd4789660780b4f34288c0d4023554afe6
---
 Android.mk     | 4 ++++
 src/hardware.c | 7 +++++++
 2 files changed, 11 insertions(+)

diff --git a/Android.mk b/Android.mk
index 1cc36c6..23b9e19 100644
--- a/Android.mk
+++ b/Android.mk
@@ -53,6 +53,10 @@ ifeq ($(BOARD_HAVE_SAMSUNG_BLUETOOTH),true)
     LOCAL_CFLAGS += -DSAMSUNG_BLUETOOTH
 endif
 
+ifeq ($(BCM_BLUETOOTH_MANTA_BUG), true)
+    LOCAL_CFLAGS += -DMANTA_BUG
+endif
+
 include $(LOCAL_PATH)/vnd_buildcfg.mk
 
 include $(BUILD_SHARED_LIBRARY)
diff --git a/src/hardware.c b/src/hardware.c
index fa171c2..6d35768 100644
--- a/src/hardware.c
+++ b/src/hardware.c
@@ -1056,8 +1056,15 @@ void hw_config_cback(void *p_mem)
     } // if (p_buf != NULL)
 
     /* Free the RX event buffer */
+
+// On manta this causes a crash due to an overrun elsewhere.
+// Sad as it is, if we just do not do the free here we'll just leak less than 4K each time BT is turned on.
+// And since when it is turned off, the process dies, this realy only costs us 4K total.
+// I'm willing to part with 4K to avoid debugging bluedroid
+#ifndef MANTA_BUG
     if (bt_vendor_cbacks)
         bt_vendor_cbacks->dealloc(p_evt_buf);
+#endif
 
     if (is_proceeding == FALSE)
     {
-- 
2.7.4

