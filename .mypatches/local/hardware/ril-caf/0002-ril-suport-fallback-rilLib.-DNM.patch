From 332ed6cf86755ada11b5fb5da0535bbdccbed671 Mon Sep 17 00:00:00 2001
From: nx111 <gd.zhangdz@gmail.com>
Date: Thu, 20 Sep 2018 22:51:00 +0800
Subject: [PATCH 2/2] ril: suport fallback rilLib.[DNM]

Change-Id: Ibac7dda1ba3d9bd08d8499de232f965fd7effcf4
---
 rild/rild.c | 17 ++++++++++++++++-
 1 file changed, 16 insertions(+), 1 deletion(-)

diff --git a/rild/rild.c b/rild/rild.c
index 041413d..5c9806a 100644
--- a/rild/rild.c
+++ b/rild/rild.c
@@ -122,6 +122,8 @@ int main(int argc, char **argv) {
     int i;
     // ril/socket id received as -c parameter, otherwise set to 0
     const char *clientId = NULL;
+    const char LibPath_Fallback[] = "/system/vendor/lib/libreference-ril.so";
+    static int fallback_loaded = 0;
 
     RLOGD("**RIL Daemon Started**");
     RLOGD("**RILd param count=%d**", argc);
@@ -169,7 +171,20 @@ int main(int argc, char **argv) {
 
     if (dlHandle == NULL) {
         RLOGE("dlopen failed: %s", dlerror());
-        exit(EXIT_FAILURE);
+
+        if (!fallback_loaded) {
+            dlHandle = dlopen(LibPath_Fallback, RTLD_NOW);
+            if (dlHandle == NULL) {
+                RLOGE("dlopen failed: %s", dlerror());
+                exit(EXIT_FAILURE);
+            }
+            else {
+                fallback_loaded = 1;
+            }
+        }
+        else {
+            exit(EXIT_FAILURE);
+        }
     }
 
     RIL_startEventLoop();
-- 
2.17.1

