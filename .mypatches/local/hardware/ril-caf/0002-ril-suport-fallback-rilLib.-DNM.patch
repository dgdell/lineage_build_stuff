From d4b4be376ca093a1b7c72a513a70ae8525399146 Mon Sep 17 00:00:00 2001
From: nx111 <gd.zhangdz@gmail.com>
Date: Thu, 20 Sep 2018 22:51:00 +0800
Subject: [PATCH 2/2] ril: suport fallback rilLib.[DNM]

Change-Id: Ibac7dda1ba3d9bd08d8499de232f965fd7effcf4
---
 rild/rild.c | 18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

diff --git a/rild/rild.c b/rild/rild.c
index 041413d..c7a72ed 100644
--- a/rild/rild.c
+++ b/rild/rild.c
@@ -122,6 +122,8 @@ int main(int argc, char **argv) {
     int i;
     // ril/socket id received as -c parameter, otherwise set to 0
     const char *clientId = NULL;
+    const char LibPath_Fallback[] = "/vendor/lib/libreference-ril.so";
+    static int fallback_loaded = 0;
 
     RLOGD("**RIL Daemon Started**");
     RLOGD("**RILd param count=%d**", argc);
@@ -169,7 +171,21 @@ int main(int argc, char **argv) {
 
     if (dlHandle == NULL) {
         RLOGE("dlopen failed: %s", dlerror());
-        exit(EXIT_FAILURE);
+
+        if (!fallback_loaded) {
+            dlHandle = dlopen(LibPath_Fallback, RTLD_NOW);
+            if (dlHandle == NULL) {
+                RLOGE("dlopen failed: %s", dlerror());
+                exit(EXIT_FAILURE);
+            }
+            else {
+                RLOGD("dlopen fallback %s succeed.", LibPath_Fallback);
+                fallback_loaded = 1;
+            }
+        }
+        else {
+            exit(EXIT_FAILURE);
+        }
     }
 
     RIL_startEventLoop();
-- 
2.17.1

