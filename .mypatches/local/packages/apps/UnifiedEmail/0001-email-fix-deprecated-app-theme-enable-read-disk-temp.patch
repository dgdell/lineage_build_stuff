From 196a9189da9f866fd6db6f3a73d5819ae78acfcf Mon Sep 17 00:00:00 2001
From: nx111 <nx111.aimh@gmail.com>
Date: Tue, 22 May 2018 23:26:30 +0800
Subject: [PATCH] email:fix deprecated app:theme, enable read disk temporarily
 when init.

Change-Id: Id2767f1da524f110b611b6e60069f3cc80b0b8fc
---
 res/layout-sw600dp/mail_toolbar_view.xml                 | 4 ++--
 res/layout/mail_toolbar_view.xml                         | 4 ++--
 src/com/android/emailcommon/TempDirectory.java           | 7 ++++++-
 src/com/android/mail/preferences/AccountPreferences.java | 6 ++++++
 4 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/res/layout-sw600dp/mail_toolbar_view.xml b/res/layout-sw600dp/mail_toolbar_view.xml
index 820567645..2517a55d0 100644
--- a/res/layout-sw600dp/mail_toolbar_view.xml
+++ b/res/layout-sw600dp/mail_toolbar_view.xml
@@ -23,7 +23,7 @@
     android:layout_width="match_parent"
     android:layout_height="match_parent"
     app:contentInsetStart="@dimen/action_bar_content_inset_start"
-    app:theme="@style/ThemeOverlay.AppCompat.Dark.ActionBar"
+    android:theme="@style/ThemeOverlay.AppCompat.Dark.ActionBar"
     app:popupTheme="@style/ThemeOverlay.AppCompat.Light" >
 
     <!-- Custom view for search icon -->
@@ -51,4 +51,4 @@
 
     </LinearLayout>
 
-</com.android.mail.ui.CustomViewToolbar>
\ No newline at end of file
+</com.android.mail.ui.CustomViewToolbar>
diff --git a/res/layout/mail_toolbar_view.xml b/res/layout/mail_toolbar_view.xml
index 78a5172f2..77e265a77 100644
--- a/res/layout/mail_toolbar_view.xml
+++ b/res/layout/mail_toolbar_view.xml
@@ -22,5 +22,5 @@
     android:layout_width="match_parent"
     android:layout_height="match_parent"
     app:contentInsetStart="@dimen/action_bar_content_inset_start"
-    app:theme="@style/ThemeOverlay.AppCompat.Dark.ActionBar"
-    app:popupTheme="@style/ThemeOverlay.AppCompat.Light" />
\ No newline at end of file
+    android:theme="@style/ThemeOverlay.AppCompat.Dark.ActionBar"
+    app:popupTheme="@style/ThemeOverlay.AppCompat.Light" />
diff --git a/src/com/android/emailcommon/TempDirectory.java b/src/com/android/emailcommon/TempDirectory.java
index 252488c9f..03957cf60 100644
--- a/src/com/android/emailcommon/TempDirectory.java
+++ b/src/com/android/emailcommon/TempDirectory.java
@@ -17,7 +17,7 @@
 package com.android.emailcommon;
 
 import android.content.Context;
-
+import android.os.StrictMode;
 import java.io.File;
 
 /**
@@ -28,7 +28,12 @@ public class TempDirectory {
     private static File sTempDirectory = null;
 
     public static void setTempDirectory(Context context) {
+        StrictMode.ThreadPolicy old = StrictMode.getThreadPolicy();
+        StrictMode.setThreadPolicy(new StrictMode.ThreadPolicy.Builder(old)
+                  .permitDiskReads()
+                  .build());
         sTempDirectory = context.getCacheDir();
+        StrictMode.setThreadPolicy(old);
     }
 
     public static File getTempDirectory() {
diff --git a/src/com/android/mail/preferences/AccountPreferences.java b/src/com/android/mail/preferences/AccountPreferences.java
index 9a0b0fa1b..89acc7d7c 100644
--- a/src/com/android/mail/preferences/AccountPreferences.java
+++ b/src/com/android/mail/preferences/AccountPreferences.java
@@ -20,6 +20,7 @@ import android.content.Context;
 import com.android.mail.providers.Account;
 import com.google.common.collect.ImmutableSet;
 import com.google.common.collect.Maps;
+import android.os.StrictMode;
 
 import java.util.Map;
 
@@ -74,8 +75,13 @@ public class AccountPreferences extends VersionedPrefs {
         final String id = account.getAccountId();
         AccountPreferences pref = mInstances.get(id);
         if (pref == null) {
+            StrictMode.ThreadPolicy old = StrictMode.getThreadPolicy();
+            StrictMode.setThreadPolicy(new StrictMode.ThreadPolicy.Builder(old)
+                  .permitDiskReads()
+                  .build());
             pref = new AccountPreferences(context, id);
             mInstances.put(id, pref);
+            StrictMode.setThreadPolicy(old);
         }
         return pref;
     }
-- 
2.17.1

