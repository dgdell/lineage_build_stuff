From 71a892515d3958f2c7b137e26bdd481877621368 Mon Sep 17 00:00:00 2001
From: nx111 <gd.zhangdz@gmail.com>
Date: Wed, 3 Oct 2018 16:58:19 +0800
Subject: [PATCH 7/7] bionic: allow use legacy pthread mutex init.

this change can fix RIL issue of samsung klte.

Change-Id: I5f738ea649995f9a88c747bb7483450634318722
---
 libc/Android.bp               | 8 ++++++++
 libc/bionic/pthread_mutex.cpp | 5 +++++
 2 files changed, 13 insertions(+)

diff --git a/libc/Android.bp b/libc/Android.bp
index eeeadb672..e91bb9f62 100644
--- a/libc/Android.bp
+++ b/libc/Android.bp
@@ -1543,6 +1543,14 @@ cc_library_static {
     cppflags: ["-Wold-style-cast"],
     include_dirs: ["bionic/libstdc++/include"],
     name: "libc_pthread",
+
+    product_variables: {
+        lineage: {
+            uses_legacy_pthread_mutex: {
+                cppflags: ["-DUSES_LEGACY_PTHREAD_MUTEX", "-Wno-unused-function"],
+            },
+        },
+    },
 }
 
 // ========================================================
diff --git a/libc/bionic/pthread_mutex.cpp b/libc/bionic/pthread_mutex.cpp
index ff149a5ed..68ff0fb29 100644
--- a/libc/bionic/pthread_mutex.cpp
+++ b/libc/bionic/pthread_mutex.cpp
@@ -526,6 +526,10 @@ int pthread_mutex_init(pthread_mutex_t* mutex_interface, const pthread_mutexattr
         return EINVAL;
     }
 
+#ifdef USES_LEGACY_PTHREAD_MUTEX
+    atomic_init(&mutex->state, state);
+    atomic_init(&mutex->owner_tid, 0);
+#else
     if (((*attr & MUTEXATTR_PROTOCOL_MASK) >> MUTEXATTR_PROTOCOL_SHIFT) == PTHREAD_PRIO_INHERIT
             && bionic_get_application_target_sdk_version() >= __ANDROID_API_P__) {
 #if !defined(__LP64__)
@@ -546,6 +550,7 @@ int pthread_mutex_init(pthread_mutex_t* mutex_interface, const pthread_mutexattr
         atomic_init(&mutex->state, state);
         atomic_init(&mutex->owner_tid, 0);
     }
+#endif
     return 0;
 }
 
-- 
2.17.1

