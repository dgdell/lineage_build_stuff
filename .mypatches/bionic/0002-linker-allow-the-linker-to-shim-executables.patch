From 25a3a31ea6ec9016310cbb7043fdb8bc3d4ecc60 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Wed, 20 Sep 2017 03:05:49 -0300
Subject: [PATCH 2/2] linker: allow the linker to shim executables

Change-Id: I0980e7588e5894c22a4c76692507ab2eaf7ed334
---
 linker/linker.cpp | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/linker/linker.cpp b/linker/linker.cpp
index 8cafa6e..3d6fdf9 100644
--- a/linker/linker.cpp
+++ b/linker/linker.cpp
@@ -1167,8 +1167,23 @@ const char* fix_dt_needed(const char* dt_needed, const char* sopath __unused) {
   return dt_needed;
 }
 
+static const char* get_executable_path() {
+  static std::string executable_path;
+  if (executable_path.empty()) {
+    char path[PATH_MAX];
+    ssize_t path_len = readlink("/proc/self/exe", path, sizeof(path));
+    if (path_len == -1 || path_len >= static_cast<ssize_t>(sizeof(path))) {
+      __libc_fatal("readlink('/proc/self/exe') failed: %s", strerror(errno));
+    }
+    executable_path = std::string(path, path_len);
+  }
+
+  return executable_path.c_str();
+}
+
 template<typename F>
 static void for_each_dt_needed(const ElfReader& elf_reader, F action) {
+  for_each_matching_shim(get_executable_path(), action);
   for_each_matching_shim(elf_reader.name(), action);
   for (const ElfW(Dyn)* d = elf_reader.dynamic(); d->d_tag != DT_NULL; ++d) {
     if (d->d_tag == DT_NEEDED) {
-- 
2.7.4

