From fddf7ab6191354b14513a73256036678c0e1aeab Mon Sep 17 00:00:00 2001
From: Rashed Abdel-Tawab <rashed@linux.com>
Date: Thu, 15 Mar 2018 12:55:22 -0700
Subject: [PATCH 04/26] extract_utils: Support multidex

Change-Id: I4881658d303b6c5c7f0b141beb50c1e9100af611
---
 build/tools/extract_utils.sh | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/build/tools/extract_utils.sh b/build/tools/extract_utils.sh
index e9fff896..3b19346f 100644
--- a/build/tools/extract_utils.sh
+++ b/build/tools/extract_utils.sh
@@ -821,7 +821,10 @@ function oat2dex() {
         if get_file "$OAT" "$TMPDIR" "$SRC"; then
             if get_file "$VDEX" "$TMPDIR" "$SRC"; then
                 "$VDEXEXTRACTOR" -o "$TMPDIR/" -i "$TMPDIR/$(basename "$VDEX")" > /dev/null
-                mv "$TMPDIR/$(basename "${OEM_TARGET%.*}").apk_classes.dex" "$TMPDIR/classes.dex"
+                DEX_FILES=$(find "$TMPDIR" -type f -name "$(basename "${OEM_TARGET%.*}").apk_classes*")
+                for DEX_FILE in $DEX_FILES; do
+                    mv $DEX_FILE "$TMPDIR"/$(echo $DEX_FILE | sed 's/.*_//')
+                done
             else
                 java -jar "$BAKSMALIJAR" deodex -o "$TMPDIR/dexout" -b "$BOOTOAT" -d "$TMPDIR" "$TMPDIR/$(basename "$OAT")"
                 java -jar "$SMALIJAR" assemble "$TMPDIR/dexout" -o "$TMPDIR/classes.dex"
@@ -837,7 +840,10 @@ function oat2dex() {
             # fallback to boot.oat if vdex is not available
             if [ -f "$JARVDEX" ]; then
                 "$VDEXEXTRACTOR" -o "$TMPDIR/" -i "$JARVDEX" > /dev/null
-                mv "$TMPDIR/boot-$(basename "${OEM_TARGET%.*}").apk_classes.dex" "$TMPDIR/classes.dex"
+                DEX_FILES=$(find "$TMPDIR" -type f -name "boot-$(basename "${OEM_TARGET%.*}").apk_classes*")
+                for DEX_FILE in $DEX_FILES; do
+                    mv $DEX_FILE "$TMPDIR"/$(echo $DEX_FILE | sed 's/.*_//')
+                done
             else
                 java -jar "$BAKSMALIJAR" deodex -o "$TMPDIR/dexout" -b "$BOOTOAT" -d "$TMPDIR" "$JAROAT/$OEM_TARGET"
                 java -jar "$SMALIJAR" assemble "$TMPDIR/dexout" -o "$TMPDIR/classes.dex"
@@ -1057,8 +1063,8 @@ function extract() {
             if [[ "$FULLY_DEODEXED" -ne "1" && "${VENDOR_REPO_FILE}" =~ .(apk|jar)$ ]]; then
                 oat2dex "${VENDOR_REPO_FILE}" "${SRC_FILE}" "$SRC"
                 if [ -f "$TMPDIR/classes.dex" ]; then
-                    zip -gjq "${VENDOR_REPO_FILE}" "$TMPDIR/classes.dex"
-                    rm "$TMPDIR/classes.dex"
+                    zip -gjq "${VENDOR_REPO_FILE}" "$TMPDIR/classes*"
+                    rm "$TMPDIR/classes*"
                     printf '    (updated %s from odex files)\n' "${SRC_FILE}"
                 fi
             elif [[ "${VENDOR_REPO_FILE}" =~ .xml$ ]]; then
-- 
2.17.1

