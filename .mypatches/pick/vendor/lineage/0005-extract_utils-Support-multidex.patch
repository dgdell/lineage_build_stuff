From 2bff147275703a544aac9b6e2ca6eaa54c57c9b5 Mon Sep 17 00:00:00 2001
From: Rashed Abdel-Tawab <rashed@linux.com>
Date: Thu, 15 Mar 2018 12:55:22 -0700
Subject: [PATCH 05/12] extract_utils: Support multidex

Change-Id: I4881658d303b6c5c7f0b141beb50c1e9100af611
---
 build/tools/extract_utils.sh | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/build/tools/extract_utils.sh b/build/tools/extract_utils.sh
index 7de8e36a..007895ad 100644
--- a/build/tools/extract_utils.sh
+++ b/build/tools/extract_utils.sh
@@ -793,7 +793,10 @@ function oat2dex() {
         if get_file "$OAT" "$TMPDIR" "$SRC"; then
             if get_file "$VDEX" "$TMPDIR" "$SRC"; then
                 "$VDEXEXTRACTOR" -o "$TMPDIR/" -i "$TMPDIR/$(basename "$VDEX")" > /dev/null
-                mv "$TMPDIR/$(basename "${OEM_TARGET%.*}").apk_classes.dex" "$TMPDIR/classes.dex"
+                DEX_FILES=$(find "$TMPDIR" -type f -name "$(basename "${OEM_TARGET%.*}").apk_classes*")
+                for DEX_FILE in $DEX_FILES; do
+                    mv $DEX_FILE "$TMPDIR"/$(echo $DEX_FILE | sed 's/.*_//')
+                done
             else
                 java -jar "$BAKSMALIJAR" deodex -o "$TMPDIR/dexout" -b "$BOOTOAT" -d "$TMPDIR" "$TMPDIR/$(basename "$OAT")"
                 java -jar "$SMALIJAR" assemble "$TMPDIR/dexout" -o "$TMPDIR/classes.dex"
@@ -809,7 +812,10 @@ function oat2dex() {
             # fallback to boot.oat if vdex is not available
             if [ -f "$JARVDEX" ]; then
                 "$VDEXEXTRACTOR" -o "$TMPDIR/" -i "$JARVDEX" > /dev/null
-                mv "$TMPDIR/boot-$(basename "${OEM_TARGET%.*}").apk_classes.dex" "$TMPDIR/classes.dex"
+                DEX_FILES=$(find "$TMPDIR" -type f -name "boot-$(basename "${OEM_TARGET%.*}").apk_classes*")
+                for DEX_FILE in $DEX_FILES; do
+                    mv $DEX_FILE "$TMPDIR"/$(echo $DEX_FILE | sed 's/.*_//')
+                done
             else
                 java -jar "$BAKSMALIJAR" deodex -o "$TMPDIR/dexout" -b "$BOOTOAT" -d "$TMPDIR" "$JAROAT/$OEM_TARGET"
                 java -jar "$SMALIJAR" assemble "$TMPDIR/dexout" -o "$TMPDIR/classes.dex"
@@ -1031,8 +1037,8 @@ function extract() {
             if [[ "$FULLY_DEODEXED" -ne "1" && "$DEST" =~ .(apk|jar)$ ]]; then
                 oat2dex "$DEST" "$FILE" "$SRC"
                 if [ -f "$TMPDIR/classes.dex" ]; then
-                    zip -gjq "$DEST" "$TMPDIR/classes.dex"
-                    rm "$TMPDIR/classes.dex"
+                    zip -gjq "$DEST" "$TMPDIR/classes.*"
+                    rm "$TMPDIR/classes.*"
                     printf '    (updated %s from odex files)\n' "/$FILE"
                 fi
             elif [[ "$DEST" =~ .xml$ ]]; then
-- 
2.17.0

