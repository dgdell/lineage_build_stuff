From ecdfb736d3be6042ae6a265419e7244df5e12305 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Wed, 27 Jun 2018 13:59:20 +0200
Subject: [PATCH 14/21] libbfqio: Open bfqio once

* Also translate to cpp to match libcutils

Change-Id: I710b7b3f44a9b7b71d6ec7d6386a43cb8e6301c8
---
 libbfqio/Android.bp             |  4 +--
 libbfqio/{bfqio.c => bfqio.cpp} | 43 ++++++++++++++++-----------------
 libbfqio/include/bfqio/bfqio.h  | 10 +-------
 3 files changed, 24 insertions(+), 33 deletions(-)
 rename libbfqio/{bfqio.c => bfqio.cpp} (67%)

diff --git a/libbfqio/Android.bp b/libbfqio/Android.bp
index dd816293..c0119db6 100644
--- a/libbfqio/Android.bp
+++ b/libbfqio/Android.bp
@@ -1,5 +1,5 @@
 //
-// Copyright (C) 2017 The LineageOS Project
+// Copyright (C) 2017-2018 The LineageOS Project
 //
 // Licensed under the Apache License, Version 2.0 (the "License");
 // you may not use this file except in compliance with the License.
@@ -23,7 +23,7 @@ cc_library_headers {
 cc_defaults {
     name: "libbfqio_defaults",
     srcs: [
-        "bfqio.c",
+        "bfqio.cpp",
     ],
 
     shared_libs: [
diff --git a/libbfqio/bfqio.c b/libbfqio/bfqio.cpp
similarity index 67%
rename from libbfqio/bfqio.c
rename to libbfqio/bfqio.cpp
index e3776d58..f2f5f252 100644
--- a/libbfqio/bfqio.c
+++ b/libbfqio/bfqio.cpp
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2017 The LineageOS Project
+ * Copyright (C) 2017-2018 The LineageOS Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -16,8 +16,8 @@
 
 #define LOG_TAG "bfqio"
 
-#include <fcntl.h>
 #include <cutils/iosched_policy.h>
+#include <fcntl.h>
 #include <log/log.h>
 #include <pthread.h>
 #include <sys/stat.h>
@@ -26,8 +26,13 @@
 static int __rtio_cgroup_supported = -1;
 static pthread_once_t __rtio_init_once = PTHREAD_ONCE_INIT;
 
-static void __initialize_rtio(void) {
+static int tasks_fd = -1;
+static int realtime_tasks_fd = -1;
+
+static void __initialize_rtio() {
     if (!access("/dev/bfqio/tasks", W_OK) || !access("/dev/bfqio/rt-display/tasks", W_OK)) {
+        tasks_fd = open("/dev/bfqio/rt-display/tasks", O_WRONLY | O_CLOEXEC);
+        realtime_tasks_fd = open("/dev/bfqio/tasks", O_WRONLY | O_CLOEXEC);
         __rtio_cgroup_supported = 1;
     } else {
         __rtio_cgroup_supported = 0;
@@ -35,53 +40,47 @@ static void __initialize_rtio(void) {
 }
 
 int android_set_rt_ioprio(int tid, int rt) {
-    int fd = -1, rc = -1;
+    int fd = -1;
 
     pthread_once(&__rtio_init_once, __initialize_rtio);
-    if (__rtio_cgroup_supported != 1) {
+    if (__rtio_cgroup_supported != 1)
         return -1;
-    }
 
     if (rt) {
-        fd = open("/dev/bfqio/rt-display/tasks", O_WRONLY | O_CLOEXEC);
+        fd = realtime_tasks_fd;
     } else {
-        fd = open("/dev/bfqio/tasks", O_WRONLY | O_CLOEXEC);
+        fd = tasks_fd;
     }
 
     if (fd < 0) {
+        SLOGE("android_set_rt_ioprio failed; fd=%d\n", fd);
         return -1;
     }
 
-#ifdef HAVE_GETTID
     if (tid == 0) {
         tid = gettid();
     }
-#endif
 
     // specialized itoa -- works for tid > 0
     char text[22];
-    char *end = text + sizeof(text) - 1;
-    char *ptr = end;
+    char* end = text + sizeof(text) - 1;
+    char* ptr = end;
     *ptr = '\0';
     while (tid > 0) {
         *--ptr = '0' + (tid % 10);
         tid = tid / 10;
     }
 
-    rc = write(fd, ptr, end - ptr);
-    if (rc < 0) {
+    if (write(fd, ptr, end - ptr) < 0) {
         /*
          * If the thread is in the process of exiting,
          * don't flag an error
          */
-        if (errno == ESRCH) {
-            rc = 0;
-        } else {
-            SLOGV("android_set_rt_ioprio failed to write '%s' (%s); fd=%d\n",
-                  ptr, strerror(errno), fd);
-        }
+        if (errno == ESRCH)
+            return 0;
+        SLOGV("android_set_rt_ioprio failed to write '%s' (%s); fd=%d\n", ptr, strerror(errno), fd);
+        return -1;
     }
 
-    close(fd);
-    return rc;
+    return 0;
 }
diff --git a/libbfqio/include/bfqio/bfqio.h b/libbfqio/include/bfqio/bfqio.h
index 14392d94..6482a45c 100644
--- a/libbfqio/include/bfqio/bfqio.h
+++ b/libbfqio/include/bfqio/bfqio.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2017 The LineageOS Project
+ * Copyright (C) 2017-2018 The LineageOS Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -16,12 +16,4 @@
 
 #pragma once
 
-#ifdef __cplusplus
-extern "C" {
-#endif
-
 int android_set_rt_ioprio(int pid, int rt);
-
-#ifdef __cplusplus
-}
-#endif
-- 
2.17.1

