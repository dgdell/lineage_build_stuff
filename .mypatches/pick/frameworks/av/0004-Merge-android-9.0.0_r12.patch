From 6f51de1db37a5057d9cce86bb3e2ae776a8fc766 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Fri, 19 Oct 2018 12:00:26 +0200
Subject: [PATCH 4/4] Merge android-9.0.0_r12

commit 13f2e890b5b62f2d72ba178071350627808919d9
Merge: edf234da2 7b60b3652
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Aug 23 01:27:41 2018 +0000

    Merge cherrypicks of [4847409, 4847410, 4851733, 4851734, 4851815, 4851835, 4851836, 4851837, 4851855] into pi-dr1-release

    Change-Id: I2fd8992e9110b3416b7f8bd81b1fd48f4d616cda

commit 7b60b36525daa0adc6da293a1e0a5c9fb30fafae
Author: Yiwei Zhang <zzyiwei@google.com>
Date:   Tue Aug 21 15:13:36 2018 -0700

    Get screenrecord to exclude black cutout

    Bug: b/112869712
    Test: adb shell screenrecord
    Change-Id: I69b497b81cfca93a8ad9ed46f25cdbb5dda81a89
    Merged-In: I69b497b81cfca93a8ad9ed46f25cdbb5dda81a89
    (cherry picked from commit 5d2ca663c2144548f4236060732fe07eec6a0273)

commit edf234da2d551fa740170fa23a58b187498239df
Merge: 2dd362be4 cbc8a9b4c
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Aug 9 01:22:09 2018 +0000

    Merge cherrypicks of [4720926, 4723688, 4721047, 4721048, 4721049, 4721050, 4721051, 4722425, 4722426, 4722427] into pi-dr1-release

    Change-Id: I78fa8eea3823dfb75577535251a7fde4df06c734

commit cbc8a9b4ca498ae2c3e134b09651e05e8c10c37e
Author: Philip Cuadra <philipcuadra@google.com>
Date:   Fri Aug 3 11:22:11 2018 -0700

    Set rlimit rtprio for cameraserver

    Set rlimit rtprio for cameraserver to allow it to inherit rt priority
    via binder priority inheritance.

    Bug:  80502612
    Test: confirmed rt prio inheritance via systrace
    Change-Id: I916370981690126c7c5302699c7c1bf5b6052685
    (cherry picked from commit 4ae244cab4fe715fc2729e906b7dda3075fbbac3)

commit 2dd362be46179e17f8d74b20707ef6871d7402a0
Merge: 2788f8cb1 8f38da667
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Aug 8 03:25:36 2018 +0000

    Merge cherrypicks of [4714135, 4714136, 4714137, 4714216, 4714295, 4714354, 4714355, 4714296, 4714297, 4714298, 4714299, 4714300, 4714301, 4714302, 4714374, 4714375, 4714356, 4714394, 4714395, 4714396] into pi-dr1-release

    Change-Id: I957cedbea2d960fcfef0801adc39fa9a9f30536e

commit 8f38da667e9532d46807a0a43532d1234a135310
Author: Ray Essick <essick@google.com>
Date:   Tue Aug 7 09:39:38 2018 -0700

    Rework NuPlayer::getStats() synchronization

    undo earlier change moving this to the handler thread, instead using
    a mutex to protect the contended resources: mAudioDecoder and
    mVideoDecoder.

    Bug: 110855771
    Bug: 78365291
    Bug: 111910846
    Test: playback with persist.debug.sfstats=={0,1}
    Change-Id: If8822dba9dae6ac0698b142166604371cd6742b2
    (cherry picked from commit fcb8fd352a4ab57e16d72695883533b30f630143)

commit 2788f8cb1ff360f640ebc17afbb6deb0c8b82490
Merge: 1096855b3 f080ede14
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Aug 7 01:23:04 2018 +0000

    Merge cherrypicks of [4703954, 4703955, 4703956, 4703974, 4702197, 4701815, 4701816, 4703428, 4703957, 4703429, 4701817, 4701818, 4701819, 4701820, 4701821, 4701822, 4701823, 4703431, 4703432, 4704034, 4704035, 4701660] into pi-dr1-release

    Change-Id: Ia8cc506aa45c9e2f9b5151b0a95d754631cfc7e3

commit f080ede14edec945dd6cc35b2f4515e37399a6df
Author: Harish Mahendrakar <harish.mahendrakar@ittiam.com>
Date:   Fri Aug 3 17:05:48 2018 -0700

    SoftXaac: Handle error cases when decoder fails to initialize

    When decoder fails to initialize, it doesn't consume any bytes in
    subsequent process call. Avoid this by returning an error when decoder
    is not initialized before first process call.

    Bug: 112194305
    Test: cts-tradefed run commandAndExit cts-dev -m CtsSecurityTestCases\
     -t android.security.cts.StagefrightTest#testStagefright_c_2016_2428

    Change-Id: I38ef56e8ff544567c3219c03dc6133c1ef98f3b3
    (cherry picked from commit ec1a9b524cbbddd16f2c730c35f54b3a05f4c9a0)

commit 1096855b3d0ec96a2e67f79105a4c22e19d2443a
Merge: 6da713deb 36b715a50
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Aug 1 00:22:26 2018 +0000

    Merge cherrypicks of [4663458, 4663322, 4662823, 4662824, 4663505, 4663506, 4663507, 4663508, 4663509, 4662787, 4662788, 4662790, 4663781, 4663801, 4662825, 4662826] into pi-dr1-release

    Change-Id: Id8942d3516e7ebcbf84efa34a8cce09f70271e98

commit 36b715a50de7984777b15f8f1ff5a8b8c077422d
Author: Pawin Vongmasa <pawin@google.com>
Date:   Thu Jul 26 12:11:05 2018 -0700

    Abort read() after CameraSource has stopped

    Before this change, CameraSource::read() may loop forever if
    - setStopTimeUs() is called when there are no pending unprocessed
    frames; and
    - New frames that arrive after setStopTimeUs() was called have timestamps
    greater than what was passed to setStopTimeUs().

    This change makes read() return ERROR_END_OF_STREAM in this situation.

    Test: cts-tradefed run cts -m CtsMediaTestCases \
    -t android.media.cts.MediaRandomTest#testRecorderRandomAction

    Test: cts-tradefed run cts -m CtsCameraTestCases \
    -t android.hardware.camera2.cts.FastBasicsTest

    Bug: 111661316
    Change-Id: I4db4011849dbf9cc4b31e7f142017a650e4d0ed7
    (cherry picked from commit 44b042cacaf79836bc982de2e889fc46d291c613)

commit 6da713debea99a18c9dc74098c7b4f9600243cb8
Merge: 7631c035f b05b1f7df
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jul 31 01:08:44 2018 +0000

    Merge cherrypicks of [4658485, 4658486, 4658487, 4657188, 4657275, 4659124, 4659125, 4659141, 4659142, 4659143, 4657276, 4657814, 4658660, 4657277, 4657815, 4657278, 4659144, 4658126, 4658127, 4658128, 4658129, 4658130, 4658131, 4658132, 4658133, 4658134, 4658135, 4658136, 4658137, 4658138, 4659161, 4659162, 4659163, 4659164, 4659145, 4659146, 4659147, 4659148, 4657655, 4657656, 4658139, 4658140, 4659181, 4659182, 4659183, 4657130, 4657131, 4657132, 4657133, 4659165, 4659166, 4659167, 4657657, 4657279, 4659149] into pi-dr1-release

    Change-Id: Ida7b61ef931598f5bff187927302c8453f462d9d

commit b05b1f7df2d881906ae3ee5c7bb17060539a338e
Author: Lajos Molnar <lajos@google.com>
Date:   Fri Jul 13 14:10:21 2018 -0700

    media sync: forcefully limit correction by VideoFrameScheduler.

    Don't allow video frame scheduler to correct by more than twice the
    correction limit. If this happens, restart the scheduler.

    Bug: 79400257
    Change-Id: I9c30ee0acf3bbb8ef89ce31672fe5f8055c85e2e
    (cherry picked from commit d5523ea59a7c6e85b8ba28f6d92430a64a240e32)

commit df9466f40fdb7e70157eea0975dc12470a922fe5
Author: Eric Laurent <elaurent@google.com>
Date:   Mon Jul 23 14:15:40 2018 -0700

    audio policy: fix regression in Audio MMAP device selection

    Commit f3a5a601 caused a regression for AAudio MMAP playback use case
    where disconnecting currently selected device does not generate a
    disconnect callback to client causing silent audio until the
    stream is closed and reopened.

    This CL fixes a logical flaw in method SessionRouteMap::getActiveDeviceForStream()
    introduced by commit f3a5a601 causing a stale forced device to be
    returned after this device was disconnected.

    Bug: 111711159
    Bug: 79878501
    Test: CTS tests for audi routing and AAudio. Audio smoke tests
    Merged-In: Ibb16e26bc59b9e3f99bc74eb944601c6be5026dd
    Change-Id: Ibb16e26bc59b9e3f99bc74eb944601c6be5026dd
    (cherry picked from commit ea8ebd5fcbfe399c7876909e2e680d59fba59cf0)

commit 7631c035f4530fbbaae52e27d41bee64abb238c3
Merge: 2cf412c21 e51c135e1
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sat Jul 28 01:20:08 2018 +0000

    Merge cherrypicks of [4651530, 4651531, 4651532, 4651533, 4651534, 4651535, 4651536, 4651537, 4651550, 4651131, 4651570, 4651351, 4651232, 4651233, 4651335, 4651352, 4651353, 4651354, 4651355, 4651336, 4651337, 4651338, 4651529, 4651590, 4651591, 4651592, 4651593, 4651594, 4651595, 4651596, 4651597, 4651598, 4651599, 4651600, 4651601, 4651602, 4651603, 4651604, 4651605, 4651608, 4651610, 4651611, 4651613, 4651614, 4651339, 4651132, 4651111, 4651615, 4651356, 4651357, 4651112, 4651358, 4651551] into pi-dr1-release

    Change-Id: I5c5ca43b0c656ba8bbb7c583772eeb12f962465d

commit e51c135e160945f62a34544b1f24a669efe91329
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Wed Jul 25 16:47:40 2018 -0700

    Camera: Handle abandoned surface in finishConfiguration

    It's possible that surface for a stream goes away after
    cameraservice configures HAL stream, either during configure_streams
    or when session parameters are updated.

    In this case, do not put camera device in an error state.

    Test: Camera CTS, GCA
    Bug: 111581884
    Change-Id: I7efc5aa22bc9b60ffaea23d8dae275f9a2bd026d
    (cherry picked from commit 210ba5c4da9391e06dbb9bf624783e747d192b04)

commit 2cf412c21b4a3e5b13a8af48f9d0d0fed2ce70bb
Merge: 4fbb87d4a 633dd675e
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Mon Jul 23 23:07:01 2018 +0000

    Merge cherrypicks of [4607809, 4607810, 4609855, 4608092, 4608093, 4607931, 4607932, 4609887, 4609888, 4609907, 4609873, 4609874, 4609927, 4609928, 4609967, 4609968, 4609969, 4609970, 4609971, 4607550, 4607551, 4607552, 4607553, 4607554, 4607555, 4607556, 4607557, 4607558, 4607559, 4609929, 4608094, 4608095, 4608096, 4608097, 4608098, 4608099, 4610018, 4610019, 4610047] into pi-dr1-release

    Change-Id: I9ce7e3da985d024b91c4c0d872dae89efe176b93

commit 633dd675e123f0a849ebb23a70f293b66be7553d
Author: Wonsik Kim <wonsik@google.com>
Date:   Fri Jul 20 14:52:30 2018 -0700

    stagefright: limit software renderer for actual OMX components

    Bug: 111605816
    Test: atest CtsMediaTestCases:VideoEncoderTest
    Change-Id: I1ad7267f823abec99b73093be04e5ec38ff3c162
    (cherry picked from commit 3a31de26d3d82fddd26fcbe115c94013e7204094)

commit 994e5dbc546d372c2b683d045f444f512cd65fa3
Author: Nadav Bar <nadavbar@google.com>
Date:   Wed Jul 18 13:01:53 2018 +0300

    Allow playing output to default output device when during uplink playback

    Change the current behavior of AudioPolicyManager during incall music playback to allow apps that want to play audio with AUDIO_STREAM_MUSIC to default device to route the audio to the default device chosen by the engine (and not the one forced by the ongoing incall music routing). The current behavior still playes the audio to the default output device, which will be set to the TELEPHONY_TX device whenever there is ongoing uplink playback. This change will only affect a case in which uplink playback is in progress and another app tries to play audio using the music stream at that time.

    Test: Tested manually that the behavior described in the bug is fixed and that both apps can play audio to two different output devices.
    Bug: 111467967.
    Change-Id: I25bccb635ea436bb6827483732e53c49c4b27825
    (cherry picked from commit b2f18166ff6a85305e8921a64c47f8cbff4575e2)

commit 4fbb87d4afa21f4990e960cbed001d361218637e
Merge: ad7765d5a 72714f997
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Fri Jul 20 23:57:28 2018 +0000

    Snap for 4905103 from 72714f997a33cb85d05bfa34fdf497b18222a3ff to pi-dr1-release

    Change-Id: I5981fdbfcec6aa86fd8322befb3cd17926dfeb20

commit ad7765d5a984e7fb6762d9ab9fc7f7da80f4b354
Merge: 400863581 5b8fa88b8
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Fri Jul 20 04:21:39 2018 +0000

    Merge cherrypicks of [4591252, 4590977, 4590978, 4591304, 4591324, 4591344, 4591345, 4591346, 4591364, 4590833, 4590834, 4591325, 4591326, 4591327] into pi-dr1-release

    Change-Id: I4c01339c16a28405bf29676add6fff062cbdcb38

commit 5b8fa88b8c2d693dd88a990ee51e497eb4f3a400
Author: Wonsik Kim <wonsik@google.com>
Date:   Thu Jul 12 10:32:24 2018 -0700

    stagefright: MediaCodec to allocate by owner

    Bug: 111605816
    Test: adb shell stagefright -p
    Change-Id: I33d25ae707e151d4c703140acef730b10296f426
    (cherry picked from commit 921893fd4f3196b8154ccf9051cc3cf35926e0c0)

commit 72714f997a33cb85d05bfa34fdf497b18222a3ff
Merge: bb7f3c5ee 921893fd4
Author: Wonsik Kim <wonsik@google.com>
Date:   Fri Jul 20 00:55:51 2018 +0000

    Merge "stagefright: MediaCodec to allocate by owner" into pi-dev

commit 921893fd4f3196b8154ccf9051cc3cf35926e0c0
Author: Wonsik Kim <wonsik@google.com>
Date:   Thu Jul 12 10:32:24 2018 -0700

    stagefright: MediaCodec to allocate by owner

    Bug: 111605816
    Test: adb shell stagefright -p
    Change-Id: I33d25ae707e151d4c703140acef730b10296f426

commit bb7f3c5ee905896c5ed6efa3920e13bc1aed49b9
Merge: b14fef4ab 66a38580f
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Thu Jul 19 16:12:17 2018 +0000

    Merge "Camera: update hardware level related docs" into pi-dev

commit 4008635814eb9f7020c74c7c92e238ecd50b243d
Merge: d04c986af b14fef4ab
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jul 17 03:09:44 2018 +0000

    Snap for 4896779 from b14fef4aba730eba6bd0b1426b726ac77987158f to pi-dr1-release

    Change-Id: I4cefd227dbb9cfc04812228b9930c2123a36cbd9

commit b14fef4aba730eba6bd0b1426b726ac77987158f
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Mon Jul 16 10:22:21 2018 -0700

    Camera: Mark stream as ABANDONED if dequeueBuffer returns DEAD_OBJECT

    When consumer surface is destroyed, dequeueBuffer may return
    DEAD_OBJECT.

    We need to treat this condition as ABANDONED so that camera service
    stops repeating request. Otherwise, we may run into infinite loop.

    Test: Camera CTS
    Bug: 111384143
    Bug: 111381452
    Change-Id: If3348119521e9805085321c7f20abd7cc7f5dd43

commit d04c986af77e1f61ca0101a32c977eac2bfa7007
Merge: 8dbda04eb a2a604341
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sun Jul 15 03:07:22 2018 +0000

    Snap for 4894342 from a2a604341afe152682d4ba4f2b9990f6a74d9e34 to pi-dr1-release

    Change-Id: I4d244f9227cd69b7cdfc4d6a8981a066556bbd72

commit a2a604341afe152682d4ba4f2b9990f6a74d9e34
Merge: 4e0dcf0ce ff404db0d
Author: Robert Shih <robertshih@google.com>
Date:   Sat Jul 14 01:10:03 2018 -0700

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev am: 11eddd5a22 am: 9353b051f9
    am: ff404db0d6

    Change-Id: I5302de302163f2f341e770b7fd48df245554174e

commit ff404db0d6611e86304075cf35a8835315bed63a
Merge: f3898d413 9353b051f
Author: Robert Shih <robertshih@google.com>
Date:   Sat Jul 14 01:06:09 2018 -0700

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev am: 11eddd5a22
    am: 9353b051f9

    Change-Id: Idc0ff3824ed1bf9b7cca41702379a79bf12544f2

commit 9353b051f9ac567c67473d2ee9eb702f55ba3406
Merge: 0eaa9ea8b 11eddd5a2
Author: Robert Shih <robertshih@google.com>
Date:   Fri Jul 13 23:36:54 2018 -0700

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev
    am: 11eddd5a22

    Change-Id: Iabc41876ce5fd26e5383586d76f5f4c9b920b055

commit 11eddd5a222180edbf7fba4f69d733463ebf4553
Merge: d8cbab144 7fd048b3f
Author: Robert Shih <robertshih@google.com>
Date:   Sat Jul 14 06:23:21 2018 +0000

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev

    * changes:
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764 am: c60f2ff6b4
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5
      M3UParser: handle missing EXT-X-MEDIA URIs

commit 4e0dcf0ce1c842ed983d85716c8cacb02021d0ad
Merge: b50a84b3e f3898d413
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Fri Jul 13 17:19:13 2018 -0700

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer am: d8cbab1443 am: 0eaa9ea8b3
    am: f3898d4138

    Change-Id: I1d30a37796914c9a25c0de0613aa8979861e6498

commit f3898d4138b241e42e67062df84d40c94cb58a9f
Merge: fff36ab1b 0eaa9ea8b
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Fri Jul 13 17:06:00 2018 -0700

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer am: d8cbab1443
    am: 0eaa9ea8b3

    Change-Id: If2b503b048cb98e5b4ea851e43e821baf86e91a3

commit 0eaa9ea8b315b61aff863b729e4eccdb3560174e
Merge: 448b966b7 d8cbab144
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Fri Jul 13 15:42:41 2018 -0700

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer
    am: d8cbab1443

    Change-Id: I20857d5d8a057fb5eb6ef19d6b9b5a18fcc43144

commit 66a38580fd9e7dcdd696e9bdcc9dadeb4584ff47
Author: Yin-Chia Yeh <yinchiayeh@google.com>
Date:   Fri Jul 13 11:50:32 2018 -0700

    Camera: update hardware level related docs

    Codegen doc update

    Test: none
    Bug: 77861412
    Change-Id: Iee396cae3a2b830556174169f3a2398ed0e0e20c

commit 7fd048b3fbb31b8e53bc2d76452bd3fb20d03f7a
Merge: 48dcdf9a7 c60f2ff6b
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:17 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764 am: c60f2ff6b4

    Change-Id: I4f5b1eec29da19eb35d8bda966bda6352950a2d8

commit c60f2ff6b4a9ab2b257be43918d9f527216d3f4e
Merge: 7d583f04d 17ae20876
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:15 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764

    Change-Id: I98a69cea4885bd3b2a1c81801d51545c5bca1144

commit 17ae20876406e5b5d2e772795a62ce1b53767a40
Merge: 75a1f8ece b7b790ef8
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:13 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84

    Change-Id: I3f2bc0ae278e3353c6849c02eae543bb8a62e3f2

commit b7b790ef84dcff7205abf0c86988d8c9d3e71a8f
Merge: fd8da9c45 a3acb4c0f
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:11 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2

    Change-Id: I4cb61df3694d28593a6ba5da948ec470b0416b64

commit a3acb4c0f2131f954a0f1a3328694ac1864ce3b9
Merge: fa10a782b b8c3a74de
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:10 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5

    Change-Id: I3eb6d9c776064ab65b9966afde17887ef7f751b1

commit b8c3a74de55a76e2ee21c731828a8afca7aa4ae0
Author: Robert Shih <robertshih@google.com>
Date:   Thu Jul 12 16:17:45 2018 -0700

    M3UParser: handle missing EXT-X-MEDIA URIs

    Bug: 111381540
    Test: http://devimages.apple.com.edgekey.net/streaming/examples/bipbop_16x9/bipbop_16x9_variant.m3u8
    Change-Id: I57f6cea59ce4c25267385289ab805eefe74b04ac

commit b50a84b3e1626527b0fb904f8e94038ef94b53db
Merge: ae88c15fc ee080fed1
Author: Eino-Ville Talvala <etalvala@google.com>
Date:   Fri Jul 13 06:49:49 2018 +0000

    Merge "Camera: DistortionMapper: Fix to work consistently" into pi-dev

commit d8cbab144398d0e9b3cdc2f8c42b4ea0c921e355
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Tue Jul 10 15:38:38 2018 +0900

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer

    Test: play contents
    Bug: 77486542
    Change-Id: I422d49a137889c417d855ebef954f882f67821ed

commit ee080fed199e60df07c0fcef970182ba09bf4367
Author: Eino-Ville Talvala <etalvala@google.com>
Date:   Mon Jun 25 10:41:04 2018 -0700

    Camera: DistortionMapper: Fix to work consistently

    - Ensure the conversions between pre-correction and active array coordinates
      are applied consistenly
    - Only some regions were being clamped to ensure they were within the
      destination region. Add more clamping, though some outputs still
      need to not be clamped, such as face rectangles which may extend outside
      the FOV.
    - Add simple transform mode since the full transform cannot safely be used
      to meet all consistency requirements in Android P

    Also update the unit tests to try to check for this corner case and the
    simple mode.

    Test: adb shell /data/nativetest/cameraservice_tests/cameraservice_test \
        --gtest_filter=*Distortion*
    Bug: 109766306
    Change-Id: Id6f23794d60d5ed9e04b155426741a504487e3d6

commit 8dbda04ebd35fb696a3b16b73bc4f14844fdf364
Merge: 3cf5fcdaf ae88c15fc
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jul 12 03:02:37 2018 +0000

    Snap for 4887958 from ae88c15fc1caa87e7178185f4913b08dc7607ed1 to pi-dr1-release

    Change-Id: I5da3875bd902d533bc38addfd77156c066e228ac

commit ae88c15fc1caa87e7178185f4913b08dc7607ed1
Merge: 946f8dd29 fff36ab1b
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 16:10:18 2018 -0700

    [automerger skipped] Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev am: 48dcdf9a78 am: 448b966b7a
    am: fff36ab1b0  -s ours

    Change-Id: I3d1d64e25ad591b9bbd2befa8eabce654d69290a

commit fff36ab1b09765db4df8803380cc41552147b8c8
Merge: 58d53f6c2 448b966b7
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 16:02:40 2018 -0700

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev am: 48dcdf9a78
    am: 448b966b7a

    Change-Id: I8bfef4e2a056761a53224985f47cad9f502ad9de

commit 448b966b7aabb0e198d49c388670d5c3a8ce83af
Merge: 22eab8fec 48dcdf9a7
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 15:56:13 2018 -0700

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev
    am: 48dcdf9a78

    Change-Id: I6694213e5c47fe1d206a07b0086fb20eef68983e

commit 48dcdf9a7856d49eeecbaa13f9ed81601eb8e2fa
Merge: 77c35f6ca f88d8ba86
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88 am: 0bfabbf53d
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit 7d583f04d4068456cb40cf1c6d4694fc47d2209e
Merge: 301a0078a 0bfabbf53
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into nyc-mr2-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit 75a1f8ece070390c96228eecb5b281750cd4f21a
Merge: e5d3086f3 70c597fe8
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into cw-f-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit fd8da9c45dd1a08497272f94dbad141903aad81c
Merge: 1ff39c654 73bc1230e
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into nyc-mr1-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit fa10a782bdf739d0bbdee06d5b510031e9b915b5
Merge: e8d5d152b d04d54f84
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into nyc-dr1-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit 642929a42b9945a7a54b49201779e9da8dace11e
Merge: 25e9dff25 9bc021a32
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge "MediaExtractor: stop rendering when an error occurs" into nyc-dev

commit 946f8dd29282413be08edf61c2a5693e0fa8a249
Merge: 149cf6a4c 58d53f6c2
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jul 11 13:15:09 2018 -0700

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8 am: 77c35f6cac am: 22eab8fecd
    am: 58d53f6c28

    Change-Id: I977f6e8af49d8c38033f6e8c046deddda2b2df4f

commit 58d53f6c283731d9fbfd0e823b492fcb663fc9fe
Merge: ee82a4b03 22eab8fec
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jul 11 13:10:53 2018 -0700

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8 am: 77c35f6cac
    am: 22eab8fecd

    Change-Id: Id2135d79c7293256c74e6966f6add4bbdccb0621

commit 22eab8fecd694d9279756770e70a038f6947af5d
Merge: 767b86ffd 77c35f6ca
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jul 11 13:06:44 2018 -0700

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8
    am: 77c35f6cac

    Change-Id: I161ecd32a392f05dd535496ec119f5252fb77fc9

commit f88d8ba86a87c1e02c2062271a4404448b20aa1f
Merge: 91abb3dac 0bfabbf53
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:52 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88 am: 0bfabbf53d

    Change-Id: Ie57297887fb1bb7c851731592f62089aaee11837

commit 0bfabbf53d83c14a58f1ca38bd7505ffa2ae4e89
Merge: ac5986c05 70c597fe8
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:50 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88

    Change-Id: Iea1a919b03258d7d5653788feddc7e53461a16c9

commit 70c597fe888ab884e274f678394c35c8077c14b7
Merge: 5eb714ea0 73bc1230e
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:48 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7

    Change-Id: I1ea228f53f99030fbf846a694b02e74f56159a94

commit 73bc1230e7b4d49ec5fc1765d1768dd1ab0ca7a6
Merge: 3d634e647 d04d54f84
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:46 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843

    Change-Id: If7842c0575c4283518e15230d5550356dffe5021

commit d04d54f843c5aa314cb0cae5ac5009bd256cecb9
Merge: fe26fc144 9bc021a32
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:44 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323

    Change-Id: I5c235031af2cf5c23bc37a0922a8f8836de28202

commit 9bc021a323873091ea98f77b3b3dc4732d1c92e6
Author: akirilov <akirilov@google.com>
Date:   Mon Jul 9 15:28:01 2018 -0700

    MediaExtractor: stop rendering when an error occurs

    Bug: 68664359
    Bug: 110435401

    Test: cts-tradefed run cts -m CtsSecurityTestCases -t android.security.cts.StagefrightTest#testStagefright_bug_68664359
    Test: cts-tradefed run cts -m CtsSecurityTestCases -t android.security.cts.StagefrightTest#testStagefright_bug_110435401

    Change-Id: Icff96fcaa76a5871e7f175b0384d47d5dca7313f
    Merged-In: If1322524fcfebc6c5f139288f044b0189da66c1b

commit 149cf6a4cecb2a165b550735fee3034d8c99b4bb
Author: Phil Burk <philburk@google.com>
Date:   Mon Jun 25 11:20:47 2018 -0700

    MediaExtractor: stop rendering when an error occurs

    Bug: 68664359
    Bug: 110435401
    Test: Try to play a bogus OTA file. See bug for details.
    Change-Id: If1322524fcfebc6c5f139288f044b0189da66c1b

commit 3cf5fcdafb90a1a1d727dc115dda2192b3811613
Merge: 390f884e9 0224c487d
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 28 03:32:15 2018 +0000

    Merge "Snap for 4866883 from e8924ce00fe33ebdb3aaf9f485a4a28684a5acd6 to pi-dr1-release" into pi-dr1-release

commit 0224c487df4bf7932a089654bd2d2aef60493341
Merge: 23f58f019 e8924ce00
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 28 03:18:14 2018 +0000

    Snap for 4866883 from e8924ce00fe33ebdb3aaf9f485a4a28684a5acd6 to pi-dr1-release

    Change-Id: I7a7b5cd57dd1c2f364c79f17e8758a5959b1779e

commit 390f884e9f2352e9916fcc64e0da731bd2119085
Merge: 23f58f019 e8924ce00
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 28 03:11:11 2018 +0000

    Snap for 4866863 from e8924ce00fe33ebdb3aaf9f485a4a28684a5acd6 to pi-dr1-release

    Change-Id: I9e424e900cf6bd284383257e5146fa823918c734

commit e8924ce00fe33ebdb3aaf9f485a4a28684a5acd6
Merge: fcde24577 b131f4a7c
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Jun 27 22:08:27 2018 +0000

    Merge "Camera: Use default focal length in template to derive FOV" into pi-dev

commit 23f58f019d586678937a00fbbaeea723f4131787
Merge: 53ef7a818 0c045cf5e
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 27 21:45:12 2018 +0000

    Merge "Snap for 4866033 from fcde24577690a9c205266b72c51d498ced71b214 to pi-dr1-release" into pi-dr1-release

commit 0c045cf5ec643aa75a3fbc26753d61261b569f5a
Merge: 28f6c8c52 fcde24577
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 27 21:35:25 2018 +0000

    Snap for 4866033 from fcde24577690a9c205266b72c51d498ced71b214 to pi-dr1-release

    Change-Id: Ib694e63a42f03bbf3e0bfa1b680650d1b992713f

commit 53ef7a81870568c99c2a7483110d058ce711169c
Merge: 28f6c8c52 fcde24577
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 27 21:28:17 2018 +0000

    Snap for 4866033 from fcde24577690a9c205266b72c51d498ced71b214 to pi-dr1-release

    Change-Id: I66ef5095eb039d53ff801b1a2dea7f2414fa2a8b

commit fcde24577690a9c205266b72c51d498ced71b214
Merge: 53eea85dc 3bdcdff8c
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Jun 27 19:26:42 2018 +0000

    Merge "Camera: Set inverse display transform if needed" into pi-dev

commit b131f4a7c8bcce698a4299434ffd9460dc30e9cf
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Thu Jun 21 18:19:11 2018 -0700

    Camera: Use default focal length in template to derive FOV

    This is consistent with the default focal length set by the API1-HAL3
    shim.

    Test: Camera CTS, FOV test for CtsVerifier
    Bug: 110445633
    Change-Id: I4ecfb32c7cecdd9c56e04b25cf4d92a86122b2cb

commit 28f6c8c52c7608661a2241fdd02273f5a0621878
Merge: 05ed08144 53eea85dc
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 27 03:09:36 2018 +0000

    Snap for 4864428 from 53eea85dcbdd3377c4c34e5f5b0eba8dbf6b5b29 to pi-dr1-release

    Change-Id: Id56b6e883248fe20229b2b737ea8a7b53f60c7e9

commit 3bdcdff8ce05ddc04e9feb6e09393d328b7bf318
Author: Emilian Peev <epeev@google.com>
Date:   Mon Jun 25 14:37:29 2018 +0100

    Camera: Set inverse display transform if needed

    Shared surface outputs currently re-use the transformation
    from the input queue directly. However the inverse display
    flag will get reset by the queue logic and needs to be set
    again before the incoming buffers are sent to the registered
    outputs.

    Bug: 110641448
    Test: Manual using application,
    Camera CTS
    Change-Id: I36859eb41ccab8459bbd97bad3ea0b6a8575489c

commit 77c35f6caca40daa67842842575796e74fff758b
Merge: 91abb3dac 301a0078a
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:12 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8

    Change-Id: I6983d28e45c047ffb3b7db9a6d02240c5746eec3

commit 301a0078a8c9eb39f41c55043b09511f1b8f2aef
Merge: ac5986c05 e5d3086f3
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:10 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b

    Change-Id: I7c847f620deb25930874f676b81c09d34d5f5f72

commit e5d3086f3b22ebb478e453003711915b9ec690a0
Merge: 5eb714ea0 1ff39c654
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:08 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a

    Change-Id: I9a6766cd10724fd73e97ac633c835d70b07fdb4d

commit 1ff39c654ab9d594a807f6327e1a28c67517173d
Merge: 3d634e647 e8d5d152b
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:06 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf

    Change-Id: Ibd4d21d5826d9a072b5ab04ece651291c73e98de

commit e8d5d152bf4862007f87f1d7732fc6f6e3671b77
Merge: fe26fc144 25e9dff25
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:03 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c

    Change-Id: I1152e6a6052862f54489fc48be76bde57120068d

commit 25e9dff25cb89ab290834320243d77643b052256
Merge: cc5d25bbc fc7a3a56f
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:01 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9

    Change-Id: I9e321e4bd090b976dda07829bec093008ac59966

commit fc7a3a56f9d623ae33e8a26e02eae4a9b0883032
Merge: 7ad36b07d ad0ec9b3a
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:01:59 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af

    Change-Id: Ia83dfb602b091c512653eb83d7aa43b1c6e44cf2

commit ad0ec9b3af078e24f0eda395a137466e20d0ec6d
Merge: 1d382c6b7 dce12d183
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:01:57 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a

    Change-Id: I8aa8cb36c18fea386753f1f5160f7b7499358cac

commit dce12d183ad3234b918595669b684fd2a1c10dac
Merge: 9c5774045 fe3708f7b
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:01:55 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba

    Change-Id: I6b438d3fd0cdbf8d4f85a7e2c053be1c5cbd5e82

commit fe3708f7baa75b37e7b1ac30f88acb33df3f5360
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jun 20 16:05:45 2018 -0700

    Fix a race condition in OMXNodeInstance

    When it frees the buffers, there might be pending events in
    OMX::CallbackDispatcher and these event can be handled after
    the component frees the buffers. To prevent the UAF case, this
    change invalidates the buffers in the client side first before
    calling OMX_FreeBuffer.

    Test: run poc with and without the patch
    Test: cts-tradefed run cts-dev --module CtsMediaTestCases
          --compatibility:module-arg CtsMediaTestCases:include-annotation:
          android.platform.test.annotations.RequiresDevice
    Bug: 77474014
    Change-Id: I0b7c4291967564f697e7f6a5ecbc31d4dae3cbcd

commit 53eea85dcbdd3377c4c34e5f5b0eba8dbf6b5b29
Author: Emilian Peev <epeev@google.com>
Date:   Wed Jun 20 14:13:14 2018 +0100

    Camera: Use face priority scene as default

    Clients using the legacy API translation layer will
    default to face priority scene in case this mode is
    supported by the camera device.

    Bug: 110259811
    Test: Manual using application,
    Camera CTS

    Change-Id: I370f222c73ea6e133bb6cb334ced2e33a26bb8c5

commit 05ed08144463b91178c274fe66dba2f41cd01d14
Merge: 2be5ce733 a1caa67b7
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 20 03:07:02 2018 +0000

    Snap for 4850855 from a1caa67b77959d558fc90e6bf4ec0ed8f6caa85e to pi-dr1-release

    Change-Id: I4e38461655157ee064fd4bd8e5506ea6e2fc92fe

commit a1caa67b77959d558fc90e6bf4ec0ed8f6caa85e
Merge: d62d30773 9fa929b6b
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Tue Jun 19 20:19:38 2018 +0000

    Merge "Camera: NDK codegen doc update" into pi-dev

commit 2be5ce733d4f1254820a8458c832166f5a839f6d
Merge: bcfc3af31 d62d30773
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jun 19 03:01:45 2018 +0000

    Snap for 4848184 from d62d30773decf3cd44cbd2a4edc8f0daf7c0ca5b to pi-dr1-release

    Change-Id: Ied6e12b519a5f96aecd809ae5d6b9cdf51186840

commit 9fa929b6b6449864030d491ff6c9da5111eba210
Author: Yin-Chia Yeh <yinchiayeh@google.com>
Date:   Fri Jun 15 15:38:34 2018 -0700

    Camera: NDK codegen doc update

    Test: N/A. Doc update
    Bug: 109666939
    Change-Id: I19bef18c164dae47c7b18e90d7c5d972dc02fd95

commit d62d30773decf3cd44cbd2a4edc8f0daf7c0ca5b
Author: Chong Zhang <chz@google.com>
Date:   Thu Jun 14 12:28:32 2018 -0700

    stagefright: send EOS to encoder for thumbnail extraction

    Decoders might hold on to decoded frames for certain streams,
    send EOS after last sample so that we get all output frames.

    bug: 110116757
    bug: 110226430

    Test: CTS HeifWriterTest; MediaMetadataRetrieverTest
    Change-Id: I0f8e7f1607857297325594adad8ca4fbff16e5e9

commit bcfc3af3190377dbbaae43c25bcac4889a774b80
Merge: 6e8b1a18a 70c2e5ea6
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 13 03:12:38 2018 +0000

    Snap for 4836998 from 70c2e5ea61daffd458fd0e57be8376036281f737 to pi-dr1-release

    Change-Id: Ifc4e57cfff26edc10b5c1e2018d1168c569fbb5a

commit 70c2e5ea61daffd458fd0e57be8376036281f737
Merge: 63a0662d0 484e927cf
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jun 12 23:42:31 2018 +0000

    Merge "audiopolicy: fix VoIP and system sound routing concurrency" into pi-dev

commit 6e8b1a18a0cf5a327456ab60eb91ca9a4b01337e
Merge: fa2914b4d 63a0662d0
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sun Jun 10 03:02:19 2018 +0000

    Snap for 4832091 from 63a0662d03791460a6ba882851e95b3e9eaf8b3b to pi-dr1-release

    Change-Id: I98065d07920cc95c6832f02ecad1bd047558cae4

commit 484e927cf9e9bdd91f21796d52ea23c8fe49f670
Author: Eric Laurent <elaurent@google.com>
Date:   Thu Jun 7 17:29:23 2018 -0700

    audiopolicy: fix VoIP and system sound routing concurrency

    On platforms with dedicated output profiles for VoIP, activity on
    all output streams should be considered when use case priority is
    evaluated while selecting current device on a given output stream.

    For now, implement a simple rule taking only into account output streams
    attached to the same audio HAL module and limited to voice call use
    case.
    This should be extended to all use cases with a refined rule
    considering mutually exclusive devices (using same backend) as opposed
    to all streams on the same audio HAL module.

    Bug: 109640706
    Test: repro steps in b/109640706
    Change-Id: I2cea35911a6121980f128a3a3d694699364854eb

commit fa2914b4d4cf57c48c293d18fa0f673036997bed
Merge: c92143dc5 bebb9d118
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 7 03:07:49 2018 +0000

    Snap for 4826407 from bebb9d118340d2ce7b518539eba23f877b6fd8ad to pi-dr1-release

    Change-Id: I9901f3e4702dc04ad655671d979b616b1dc7fed9

commit c92143dc5bb81e99e1817155b29800c31cf165b9
Merge: 64c17e9f7 cf568f699
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 6 03:06:45 2018 +0000

    Snap for 4823496 from cf568f6991526d45cdb00d4fa0dc1553dd340f2a to pi-dr1-release

    Change-Id: Iea9f8226912e1fefd4a051e0743bf7f84270d6cd

commit ac5986c05629bb1087923a464b39185989a03c53
Merge: 5673ef3ec 9cae8be44
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-mr2-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0 am: 8aeab2cad9 am: b04ca4cb26
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0 am: 8aeab2cad9
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 5eb714ea02451944dfde142bf4220544a9d83325
Merge: e143e026c b04ca4cb2
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into cw-f-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0 am: 8aeab2cad9
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 3d634e64725dd3d2c98baa8b045d1e764f2305e9
Merge: b5029cb71 8aeab2cad
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-mr1-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit fe26fc14478921665ae6034063d6c77c87730f62
Merge: a333901a9 19d1113bb
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-dr1-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit cc5d25bbcd124ec3aa8a0e0366c518e7e5c26d0b
Merge: cc3897e95 bad0533d2
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 7ad36b07d4f4a66756c32a6e3003f4f7ee93f12e
Merge: 6fac86e8f 4cdd5c3af
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into mnc-dr1.5-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 1d382c6b797253ee363bd8d391561bce94795217
Merge: 9500a5c89 1c7bb87a4
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into cw-e-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 9c5774045a3f12dc6e95eb91726fe7a5e332961a
Merge: 042483b6a ecc92a1a8
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into mnc-dr-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit ed3f73e92a9aee279b60e174b443fd08bac2b847
Merge: 26e236bd4 3762e0615
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge "Fix possible out of bounds read" into mnc-dev

commit 64c17e9f7e9f1cb7e84aa02c8971a5902273ed4f
Merge: 4ed61f3f1 82f153c15
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jun 5 03:07:14 2018 +0000

    Snap for 4820872 from 82f153c157ef85f49ff36acd063574eacddf7ad1 to pi-dr1-release

    Change-Id: I61120de91cb2403faab12cdded238e8a7df9bd67

Change-Id: I86928bc08bfdc115fa0d4bc18b47855898e2956b
---
 camera/cameraserver/cameraserver.rc           |   1 +
 .../include/camera/NdkCameraMetadataTags.h    | 193 ++++++++++++++----
 cmds/screenrecord/screenrecord.cpp            |  80 +++++---
 .../nuplayer/NuPlayer.cpp                     |  42 ++--
 .../libmediaplayerservice/nuplayer/NuPlayer.h |   2 +-
 media/libstagefright/CameraSource.cpp         |   9 +-
 media/libstagefright/FrameDecoder.cpp         |   5 +-
 media/libstagefright/MediaCodec.cpp           |  24 ++-
 media/libstagefright/VideoFrameScheduler.cpp  |   9 +
 .../codecs/xaacdec/SoftXAAC.cpp               |   7 +-
 .../include/media/stagefright/CameraSource.h  |   1 +
 .../include/media/stagefright/MediaCodec.h    |   2 +-
 media/libstagefright/omx/OMXNodeInstance.cpp  |   5 +-
 .../managerdefinitions/src/SessionRoute.cpp   |  10 +-
 .../managerdefault/AudioPolicyManager.cpp     |  20 +-
 .../managerdefault/AudioPolicyManager.h       |   4 +
 .../libcameraservice/api1/Camera2Client.cpp   |   3 +-
 .../api1/client2/Parameters.cpp               | 119 ++++++-----
 .../api1/client2/Parameters.h                 |  14 +-
 .../device3/Camera3Device.cpp                 |  27 ++-
 .../device3/Camera3OutputStream.cpp           |   2 +-
 .../device3/Camera3Stream.cpp                 |   9 +-
 .../libcameraservice/device3/Camera3Stream.h  |   1 +
 .../device3/Camera3StreamSplitter.cpp         |   4 +
 24 files changed, 414 insertions(+), 179 deletions(-)

diff --git a/camera/cameraserver/cameraserver.rc b/camera/cameraserver/cameraserver.rc
index fea5a1d5c..a9aae0b15 100644
--- a/camera/cameraserver/cameraserver.rc
+++ b/camera/cameraserver/cameraserver.rc
@@ -4,3 +4,4 @@ service cameraserver /system/bin/cameraserver
     group audio camera input drmrpc
     ioprio rt 4
     writepid /dev/cpuset/camera-daemon/tasks /dev/stune/top-app/tasks
+    rlimit rtprio 10 10
diff --git a/camera/ndk/include/camera/NdkCameraMetadataTags.h b/camera/ndk/include/camera/NdkCameraMetadataTags.h
index 3010646af..05010060e 100644
--- a/camera/ndk/include/camera/NdkCameraMetadataTags.h
+++ b/camera/ndk/include/camera/NdkCameraMetadataTags.h
@@ -479,11 +479,26 @@ typedef enum acamera_metadata_tag {
      * Otherwise will always be present.</p>
      * <p>The maximum number of regions supported by the device is determined by the value
      * of android.control.maxRegionsAe.</p>
-     * <p>The coordinate system is based on the active pixel array,
-     * with (0,0) being the top-left pixel in the active pixel array, and
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with (0,0) being
+     * the top-left pixel in the active pixel array, and
      * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the
-     * bottom-right pixel in the active pixel array.</p>
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array, and
+     * (ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right
+     * pixel in the pre-correction active pixel array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array, and
+     * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
      * <p>The weight must be within <code>[0, 1000]</code>, and represents a weight
      * for every pixel in the area. This means that a large metering area
      * with the same weight as a smaller area will have more effect in
@@ -504,8 +519,10 @@ typedef enum acamera_metadata_tag {
      * The rectangle is defined to be inclusive on xmin and ymin, but exclusive on xmax and
      * ymax.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_CONTROL_AE_REGIONS =                                // int32[5*area_count]
             ACAMERA_CONTROL_START + 4,
@@ -641,11 +658,26 @@ typedef enum acamera_metadata_tag {
      * Otherwise will always be present.</p>
      * <p>The maximum number of focus areas supported by the device is determined by the value
      * of android.control.maxRegionsAf.</p>
-     * <p>The coordinate system is based on the active pixel array,
-     * with (0,0) being the top-left pixel in the active pixel array, and
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with (0,0) being
+     * the top-left pixel in the active pixel array, and
      * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the
-     * bottom-right pixel in the active pixel array.</p>
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array, and
+     * (ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right
+     * pixel in the pre-correction active pixel array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array, and
+     * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
      * <p>The weight must be within <code>[0, 1000]</code>, and represents a weight
      * for every pixel in the area. This means that a large metering area
      * with the same weight as a smaller area will have more effect in
@@ -667,8 +699,10 @@ typedef enum acamera_metadata_tag {
      * The rectangle is defined to be inclusive on xmin and ymin, but exclusive on xmax and
      * ymax.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_CONTROL_AF_REGIONS =                                // int32[5*area_count]
             ACAMERA_CONTROL_START + 8,
@@ -800,11 +834,26 @@ typedef enum acamera_metadata_tag {
      * Otherwise will always be present.</p>
      * <p>The maximum number of regions supported by the device is determined by the value
      * of android.control.maxRegionsAwb.</p>
-     * <p>The coordinate system is based on the active pixel array,
-     * with (0,0) being the top-left pixel in the active pixel array, and
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with (0,0) being
+     * the top-left pixel in the active pixel array, and
      * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the
-     * bottom-right pixel in the active pixel array.</p>
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array, and
+     * (ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right
+     * pixel in the pre-correction active pixel array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array, and
+     * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
      * <p>The weight must range from 0 to 1000, and represents a weight
      * for every pixel in the area. This means that a large metering area
      * with the same weight as a smaller area will have more effect in
@@ -825,8 +874,10 @@ typedef enum acamera_metadata_tag {
      * The rectangle is defined to be inclusive on xmin and ymin, but exclusive on xmax and
      * ymax.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_CONTROL_AWB_REGIONS =                               // int32[5*area_count]
             ACAMERA_CONTROL_START + 12,
@@ -2979,9 +3030,17 @@ typedef enum acamera_metadata_tag {
      * </ul></p>
      *
      * <p>This control can be used to implement digital zoom.</p>
-     * <p>The crop region coordinate system is based off
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being the
-     * top-left corner of the sensor active array.</p>
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being
+     * the top-left pixel of the active array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array.</p>
      * <p>Output streams use this rectangle to produce their output,
      * cropping to a smaller region if necessary to maintain the
      * stream's aspect ratio, then scaling the sensor input to
@@ -3000,18 +3059,26 @@ typedef enum acamera_metadata_tag {
      * outputs will crop horizontally (pillarbox), and 16:9
      * streams will match exactly. These additional crops will
      * be centered within the crop region.</p>
-     * <p>The width and height of the crop region cannot
-     * be set to be smaller than
+     * <p>If the coordinate system is android.sensor.info.activeArraysSize, the width and height
+     * of the crop region cannot be set to be smaller than
      * <code>floor( activeArraySize.width / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code> and
      * <code>floor( activeArraySize.height / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code>, respectively.</p>
+     * <p>If the coordinate system is ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, the width
+     * and height of the crop region cannot be set to be smaller than
+     * <code>floor( preCorrectionActiveArraySize.width / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code>
+     * and
+     * <code>floor( preCorrectionActiveArraySize.height / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code>,
+     * respectively.</p>
      * <p>The camera device may adjust the crop region to account
      * for rounding and other hardware requirements; the final
      * crop region used will be included in the output capture
      * result.</p>
      * <p>The data representation is int[4], which maps to (left, top, width, height).</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_SCALER_CROP_REGION =                                // int32[4]
             ACAMERA_SCALER_START,
@@ -3977,12 +4044,24 @@ typedef enum acamera_metadata_tag {
      * ACAMERA_SCALER_CROP_REGION, is defined relative to the active array rectangle given in
      * this field, with <code>(0, 0)</code> being the top-left of this rectangle.</p>
      * <p>The active array may be smaller than the full pixel array, since the full array may
-     * include black calibration pixels or other inactive regions, and geometric correction
-     * resulting in scaling or cropping may have been applied.</p>
+     * include black calibration pixels or other inactive regions.</p>
+     * <p>For devices that do not support ACAMERA_DISTORTION_CORRECTION_MODE control, the active
+     * array must be the same as ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.</p>
+     * <p>For devices that support ACAMERA_DISTORTION_CORRECTION_MODE control, the active array must
+     * be enclosed by ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE. The difference between
+     * pre-correction active array and active array accounts for scaling or cropping caused
+     * by lens geometric distortion correction.</p>
+     * <p>In general, application should always refer to active array size for controls like
+     * metering regions or crop region. Two exceptions are when the application is dealing with
+     * RAW image buffers (RAW_SENSOR, RAW10, RAW12 etc), or when application explicitly set
+     * ACAMERA_DISTORTION_CORRECTION_MODE to OFF. In these cases, application should refer
+     * to ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.</p>
      * <p>The data representation is <code>int[4]</code>, which maps to <code>(left, top, width, height)</code>.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_PIXEL_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE =                     // int32[4]
             ACAMERA_SENSOR_INFO_START,
@@ -4224,9 +4303,9 @@ typedef enum acamera_metadata_tag {
      * <ol>
      * <li>ACAMERA_LENS_DISTORTION.</li>
      * </ol>
-     * <p>If all of the geometric distortion fields are no-ops, this rectangle will be the same
-     * as the post-distortion-corrected rectangle given in
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.</p>
+     * <p>If the camera device doesn't support geometric distortion correction, or all of the
+     * geometric distortion fields are no-ops, this rectangle will be the same as the
+     * post-distortion-corrected rectangle given in ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.</p>
      * <p>This rectangle is defined relative to the full pixel array; (0,0) is the top-left of
      * the full pixel array, and the size of the full pixel array is given by
      * ACAMERA_SENSOR_INFO_PIXEL_ARRAY_SIZE.</p>
@@ -4372,11 +4451,22 @@ typedef enum acamera_metadata_tag {
      *   <li>ACameraMetadata from ACameraCaptureSession_captureCallback_result callbacks</li>
      * </ul></p>
      *
-     * <p>The coordinate system is that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being
+     * the top-left pixel of the active array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
      * <code>(0, 0)</code> being the top-left pixel of the active array.</p>
      * <p>Only available if ACAMERA_STATISTICS_FACE_DETECT_MODE == FULL</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      * @see ACAMERA_STATISTICS_FACE_DETECT_MODE
      */
     ACAMERA_STATISTICS_FACE_LANDMARKS =                         // int32[n*6]
@@ -4392,12 +4482,23 @@ typedef enum acamera_metadata_tag {
      *   <li>ACameraMetadata from ACameraCaptureSession_captureCallback_result callbacks</li>
      * </ul></p>
      *
-     * <p>The coordinate system is that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being
+     * the top-left pixel of the active array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
      * <code>(0, 0)</code> being the top-left pixel of the active array.</p>
      * <p>Only available if ACAMERA_STATISTICS_FACE_DETECT_MODE != OFF
-     * The data representation is <code>int[4]</code>, which maps to <code>(left, top, width, height)</code>.</p>
+     * The data representation is <code>int[4]</code>, which maps to <code>(left, top, right, bottom)</code>.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      * @see ACAMERA_STATISTICS_FACE_DETECT_MODE
      */
     ACAMERA_STATISTICS_FACE_RECTANGLES =                        // int32[n*4]
@@ -4993,12 +5094,26 @@ typedef enum acamera_metadata_tag {
      * the following code snippet can be used:</p>
      * <pre><code>// Returns true if the device supports the required hardware level, or better.
      * boolean isHardwareLevelSupported(CameraCharacteristics c, int requiredLevel) {
+     *     final int[] sortedHwLevels = {
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_LEGACY,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_EXTERNAL,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_LIMITED,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_FULL,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_3
+     *     };
      *     int deviceLevel = c.get(CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL);
-     *     if (deviceLevel == CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_LEGACY) {
-     *         return requiredLevel == deviceLevel;
+     *     if (requiredLevel == deviceLevel) {
+     *         return true;
+     *     }
+     *
+     *     for (int sortedlevel : sortedHwLevels) {
+     *         if (sortedlevel == requiredLevel) {
+     *             return true;
+     *         } else if (sortedlevel == deviceLevel) {
+     *             return false;
+     *         }
      *     }
-     *     // deviceLevel is not LEGACY, can use numerical sort
-     *     return requiredLevel &lt;= deviceLevel;
+     *     return false; // Should never reach here
      * }
      * </code></pre>
      * <p>At a high level, the levels are:</p>
@@ -5012,6 +5127,8 @@ typedef enum acamera_metadata_tag {
      *   post-processing settings, and image capture at a high rate.</li>
      * <li><code>LEVEL_3</code> devices additionally support YUV reprocessing and RAW image capture, along
      *   with additional output stream configurations.</li>
+     * <li><code>EXTERNAL</code> devices are similar to <code>LIMITED</code> devices with exceptions like some sensor or
+     *   lens information not reorted or less stable framerates.</li>
      * </ul>
      * <p>See the individual level enums for full descriptions of the supported capabilities.  The
      * ACAMERA_REQUEST_AVAILABLE_CAPABILITIES entry describes the device's capabilities at a
@@ -5315,18 +5432,18 @@ typedef enum acamera_metadata_tag {
      * any correction at all would slow down capture rate.  Every output stream will have a
      * similar amount of enhancement applied.</p>
      * <p>The correction only applies to processed outputs such as YUV, JPEG, or DEPTH16; it is not
-     * applied to any RAW output.  Metadata coordinates such as face rectangles or metering
+     * applied to any RAW output. Metadata coordinates such as face rectangles or metering
      * regions are also not affected by correction.</p>
-     * <p>Applications enabling distortion correction need to pay extra attention when converting
-     * image coordinates between corrected output buffers and the sensor array. For example, if
-     * the app supports tap-to-focus and enables correction, it then has to apply the distortion
-     * model described in ACAMERA_LENS_DISTORTION to the image buffer tap coordinates to properly
-     * calculate the tap position on the sensor active array to be used with
-     * ACAMERA_CONTROL_AF_REGIONS. The same applies in reverse to detected face rectangles if
-     * they need to be drawn on top of the corrected output buffers.</p>
+     * <p>This control will be on by default on devices that support this control. Applications
+     * disabling distortion correction need to pay extra attention with the coordinate system of
+     * metering regions, crop region, and face rectangles. When distortion correction is OFF,
+     * metadata coordinates follow the coordinate system of
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE. When distortion is not OFF, metadata
+     * coordinates follow the coordinate system of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.</p>
      *
-     * @see ACAMERA_CONTROL_AF_REGIONS
      * @see ACAMERA_LENS_DISTORTION
+     * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_DISTORTION_CORRECTION_MODE =                        // byte (acamera_metadata_enum_android_distortion_correction_mode_t)
             ACAMERA_DISTORTION_CORRECTION_START,
diff --git a/cmds/screenrecord/screenrecord.cpp b/cmds/screenrecord/screenrecord.cpp
index 46035159e..d1859d142 100644
--- a/cmds/screenrecord/screenrecord.cpp
+++ b/cmds/screenrecord/screenrecord.cpp
@@ -139,14 +139,6 @@ static status_t configureSignals() {
     return NO_ERROR;
 }
 
-/*
- * Returns "true" if the device is rotated 90 degrees.
- */
-static bool isDeviceRotated(int orientation) {
-    return orientation != DISPLAY_ORIENTATION_0 &&
-            orientation != DISPLAY_ORIENTATION_180;
-}
-
 /*
  * Configures and starts the MediaCodec encoder.  Obtains an input surface
  * from the codec.
@@ -242,22 +234,11 @@ static status_t setDisplayProjection(
         const DisplayInfo& mainDpyInfo) {
 
     // Set the region of the layer stack we're interested in, which in our
-    // case is "all of it".  If the app is rotated (so that the width of the
-    // app is based on the height of the display), reverse width/height.
-    bool deviceRotated = isDeviceRotated(mainDpyInfo.orientation);
-    uint32_t sourceWidth, sourceHeight;
-    if (!deviceRotated) {
-        sourceWidth = mainDpyInfo.w;
-        sourceHeight = mainDpyInfo.h;
-    } else {
-        ALOGV("using rotated width/height");
-        sourceHeight = mainDpyInfo.w;
-        sourceWidth = mainDpyInfo.h;
-    }
-    Rect layerStackRect(sourceWidth, sourceHeight);
+    // case is "all of it".
+    Rect layerStackRect(mainDpyInfo.w, mainDpyInfo.h);
 
     // We need to preserve the aspect ratio of the display.
-    float displayAspect = (float) sourceHeight / (float) sourceWidth;
+    float displayAspect = (float) mainDpyInfo.h / (float) mainDpyInfo.w;
 
 
     // Set the way we map the output onto the display surface (which will
@@ -333,6 +314,22 @@ static status_t prepareVirtualDisplay(const DisplayInfo& mainDpyInfo,
     return NO_ERROR;
 }
 
+/*
+ * Set the main display width and height to the actual width and height
+ */
+static status_t getActualDisplaySize(const sp<IBinder>& mainDpy, DisplayInfo* mainDpyInfo) {
+    Rect viewport;
+    status_t err = SurfaceComposerClient::getDisplayViewport(mainDpy, &viewport);
+    if (err != NO_ERROR) {
+        fprintf(stderr, "ERROR: unable to get display viewport\n");
+        return err;
+    }
+    mainDpyInfo->w = viewport.width();
+    mainDpyInfo->h = viewport.height();
+
+    return NO_ERROR;
+}
+
 /*
  * Runs the MediaCodec encoder, sending the output to the MediaMuxer.  The
  * input frames are coming from the virtual display as fast as SurfaceFlinger
@@ -403,14 +400,22 @@ static status_t runEncoder(const sp<MediaCodec>& encoder,
                     // useful stuff is hard to get at without a Dalvik VM.
                     err = SurfaceComposerClient::getDisplayInfo(mainDpy,
                             &mainDpyInfo);
-                    if (err != NO_ERROR) {
+                    if (err == NO_ERROR) {
+                        err = getActualDisplaySize(mainDpy, &mainDpyInfo);
+                        if (err != NO_ERROR) {
+                            fprintf(stderr, "ERROR: unable to set actual display size\n");
+                            return err;
+                        }
+
+                        if (orientation != mainDpyInfo.orientation) {
+                            ALOGD("orientation changed, now %d", mainDpyInfo.orientation);
+                            SurfaceComposerClient::Transaction t;
+                            setDisplayProjection(t, virtualDpy, mainDpyInfo);
+                            t.apply();
+                            orientation = mainDpyInfo.orientation;
+                        }
+                    } else {
                         ALOGW("getDisplayInfo(main) failed: %d", err);
-                    } else if (orientation != mainDpyInfo.orientation) {
-                        ALOGD("orientation changed, now %d", mainDpyInfo.orientation);
-                        SurfaceComposerClient::Transaction t;
-                        setDisplayProjection(t, virtualDpy, mainDpyInfo);
-                        t.apply();
-                        orientation = mainDpyInfo.orientation;
                     }
                 }
 
@@ -552,6 +557,10 @@ static FILE* prepareRawOutput(const char* fileName) {
     return rawFp;
 }
 
+static inline uint32_t floorToEven(uint32_t num) {
+    return num & ~1;
+}
+
 /*
  * Main "do work" start point.
  *
@@ -579,6 +588,13 @@ static status_t recordScreen(const char* fileName) {
         fprintf(stderr, "ERROR: unable to get display characteristics\n");
         return err;
     }
+
+    err = getActualDisplaySize(mainDpy, &mainDpyInfo);
+    if (err != NO_ERROR) {
+        fprintf(stderr, "ERROR: unable to set actual display size\n");
+        return err;
+    }
+
     if (gVerbose) {
         printf("Main display is %dx%d @%.2ffps (orientation=%u)\n",
                 mainDpyInfo.w, mainDpyInfo.h, mainDpyInfo.fps,
@@ -586,12 +602,12 @@ static status_t recordScreen(const char* fileName) {
         fflush(stdout);
     }
 
-    bool rotated = isDeviceRotated(mainDpyInfo.orientation);
+    // Encoder can't take odd number as config
     if (gVideoWidth == 0) {
-        gVideoWidth = rotated ? mainDpyInfo.h : mainDpyInfo.w;
+        gVideoWidth = floorToEven(mainDpyInfo.w);
     }
     if (gVideoHeight == 0) {
-        gVideoHeight = rotated ? mainDpyInfo.w : mainDpyInfo.h;
+        gVideoHeight = floorToEven(mainDpyInfo.h);
     }
 
     // Configure and start the encoder.
diff --git a/media/libmediaplayerservice/nuplayer/NuPlayer.cpp b/media/libmediaplayerservice/nuplayer/NuPlayer.cpp
index 3ece28b5e..027a4f9fd 100644
--- a/media/libmediaplayerservice/nuplayer/NuPlayer.cpp
+++ b/media/libmediaplayerservice/nuplayer/NuPlayer.cpp
@@ -1120,6 +1120,7 @@ void NuPlayer::onMessageReceived(const sp<AMessage> &msg) {
             } else if (what == DecoderBase::kWhatShutdownCompleted) {
                 ALOGV("%s shutdown completed", audio ? "audio" : "video");
                 if (audio) {
+                    Mutex::Autolock autoLock(mDecoderLock);
                     mAudioDecoder.clear();
                     mAudioDecoderError = false;
                     ++mAudioDecoderGeneration;
@@ -1127,6 +1128,7 @@ void NuPlayer::onMessageReceived(const sp<AMessage> &msg) {
                     CHECK_EQ((int)mFlushingAudio, (int)SHUTTING_DOWN_DECODER);
                     mFlushingAudio = SHUT_DOWN;
                 } else {
+                    Mutex::Autolock autoLock(mDecoderLock);
                     mVideoDecoder.clear();
                     mVideoDecoderError = false;
                     ++mVideoDecoderGeneration;
@@ -1447,29 +1449,6 @@ void NuPlayer::onMessageReceived(const sp<AMessage> &msg) {
             break;
         }
 
-        case kWhatGetStats:
-        {
-            ALOGV("kWhatGetStats");
-
-            Vector<sp<AMessage>> *trackStats;
-            CHECK(msg->findPointer("trackstats", (void**)&trackStats));
-
-            trackStats->clear();
-            if (mVideoDecoder != NULL) {
-                trackStats->push_back(mVideoDecoder->getStats());
-            }
-            if (mAudioDecoder != NULL) {
-                trackStats->push_back(mAudioDecoder->getStats());
-            }
-
-            // respond for synchronization
-            sp<AMessage> response = new AMessage;
-            sp<AReplyToken> replyID;
-            CHECK(msg->senderAwaitsResponse(&replyID));
-            response->postReply(replyID);
-            break;
-        }
-
         default:
             TRESPASS();
             break;
@@ -1817,6 +1796,7 @@ void NuPlayer::restartAudio(
           (long long)currentPositionUs, forceNonOffload, needsToCreateAudioDecoder);
     if (mAudioDecoder != NULL) {
         mAudioDecoder->pause();
+        Mutex::Autolock autoLock(mDecoderLock);
         mAudioDecoder.clear();
         mAudioDecoderError = false;
         ++mAudioDecoderGeneration;
@@ -1935,6 +1915,8 @@ status_t NuPlayer::instantiateDecoder(
         }
     }
 
+    Mutex::Autolock autoLock(mDecoderLock);
+
     if (audio) {
         sp<AMessage> notify = new AMessage(kWhatAudioNotify, this);
         ++mAudioDecoderGeneration;
@@ -2236,13 +2218,15 @@ status_t NuPlayer::getCurrentPosition(int64_t *mediaUs) {
 void NuPlayer::getStats(Vector<sp<AMessage> > *trackStats) {
     CHECK(trackStats != NULL);
 
-    ALOGV("NuPlayer::getStats()");
-    sp<AMessage> msg = new AMessage(kWhatGetStats, this);
-    msg->setPointer("trackstats", trackStats);
+    trackStats->clear();
 
-    sp<AMessage> response;
-    (void) msg->postAndAwaitResponse(&response);
-    // response is for synchronization, ignore contents
+    Mutex::Autolock autoLock(mDecoderLock);
+    if (mVideoDecoder != NULL) {
+        trackStats->push_back(mVideoDecoder->getStats());
+    }
+    if (mAudioDecoder != NULL) {
+        trackStats->push_back(mAudioDecoder->getStats());
+    }
 }
 
 sp<MetaData> NuPlayer::getFileMeta() {
diff --git a/media/libmediaplayerservice/nuplayer/NuPlayer.h b/media/libmediaplayerservice/nuplayer/NuPlayer.h
index e400d161a..9f5be06d7 100644
--- a/media/libmediaplayerservice/nuplayer/NuPlayer.h
+++ b/media/libmediaplayerservice/nuplayer/NuPlayer.h
@@ -159,7 +159,6 @@ private:
         kWhatPrepareDrm                 = 'pDrm',
         kWhatReleaseDrm                 = 'rDrm',
         kWhatMediaClockNotify           = 'mckN',
-        kWhatGetStats                   = 'gSts',
     };
 
     wp<NuPlayerDriver> mDriver;
@@ -175,6 +174,7 @@ private:
     sp<DecoderBase> mVideoDecoder;
     bool mOffloadAudio;
     sp<DecoderBase> mAudioDecoder;
+    Mutex mDecoderLock;  // guard |mAudioDecoder| and |mVideoDecoder|.
     sp<CCDecoder> mCCDecoder;
     sp<Renderer> mRenderer;
     sp<ALooper> mRendererLooper;
diff --git a/media/libstagefright/CameraSource.cpp b/media/libstagefright/CameraSource.cpp
index 429e3a8bd..b5954b696 100644
--- a/media/libstagefright/CameraSource.cpp
+++ b/media/libstagefright/CameraSource.cpp
@@ -221,6 +221,7 @@ CameraSource::CameraSource(
       mNumFramesReceived(0),
       mLastFrameTimestampUs(0),
       mStarted(false),
+      mEos(false),
       mNumFramesEncoded(0),
       mTimeBetweenFrameCaptureUs(0),
       mFirstFrameTimeUs(0),
@@ -884,6 +885,7 @@ status_t CameraSource::reset() {
     {
         Mutex::Autolock autoLock(mLock);
         mStarted = false;
+        mEos = false;
         mStopSystemTimeUs = -1;
         mFrameAvailableCondition.signal();
 
@@ -1079,7 +1081,7 @@ status_t CameraSource::read(
 
     {
         Mutex::Autolock autoLock(mLock);
-        while (mStarted && mFramesReceived.empty()) {
+        while (mStarted && !mEos && mFramesReceived.empty()) {
             if (NO_ERROR !=
                 mFrameAvailableCondition.waitRelative(mLock,
                     mTimeBetweenFrameCaptureUs * 1000LL + CAMERA_SOURCE_TIMEOUT_NS)) {
@@ -1095,6 +1097,9 @@ status_t CameraSource::read(
         if (!mStarted) {
             return OK;
         }
+        if (mFramesReceived.empty()) {
+            return ERROR_END_OF_STREAM;
+        }
         frame = *mFramesReceived.begin();
         mFramesReceived.erase(mFramesReceived.begin());
 
@@ -1133,6 +1138,8 @@ bool CameraSource::shouldSkipFrameLocked(int64_t timestampUs) {
     if (mStopSystemTimeUs != -1 && timestampUs >= mStopSystemTimeUs) {
         ALOGV("Drop Camera frame at %lld  stop time: %lld us",
                 (long long)timestampUs, (long long)mStopSystemTimeUs);
+        mEos = true;
+        mFrameAvailableCondition.signal();
         return true;
     }
 
diff --git a/media/libstagefright/FrameDecoder.cpp b/media/libstagefright/FrameDecoder.cpp
index 29a219f5f..6e94517a3 100644
--- a/media/libstagefright/FrameDecoder.cpp
+++ b/media/libstagefright/FrameDecoder.cpp
@@ -301,10 +301,13 @@ status_t FrameDecoder::extractInternal() {
             err = mSource->read(&mediaBuffer, &mReadOptions);
             mReadOptions.clearSeekTo();
             if (err != OK) {
-                ALOGW("Input Error or EOS");
                 mHaveMoreInputs = false;
                 if (!mFirstSample && err == ERROR_END_OF_STREAM) {
+                    (void)mDecoder->queueInputBuffer(
+                            index, 0, 0, 0, MediaCodec::BUFFER_FLAG_EOS);
                     err = OK;
+                } else {
+                    ALOGW("Input Error: err=%d", err);
                 }
                 break;
             }
diff --git a/media/libstagefright/MediaCodec.cpp b/media/libstagefright/MediaCodec.cpp
index 72eff946c..353e40702 100644
--- a/media/libstagefright/MediaCodec.cpp
+++ b/media/libstagefright/MediaCodec.cpp
@@ -860,7 +860,15 @@ static CodecBase *CreateCCodec() {
 }
 
 //static
-sp<CodecBase> MediaCodec::GetCodecBase(const AString &name) {
+sp<CodecBase> MediaCodec::GetCodecBase(const AString &name, const char *owner) {
+    if (owner) {
+        if (strncmp(owner, "default", 8) == 0) {
+            return new ACodec;
+        } else if (strncmp(owner, "codec2", 7) == 0) {
+            return CreateCCodec();
+        }
+    }
+
     if (name.startsWithIgnoreCase("c2.")) {
         return CreateCCodec();
     } else if (name.startsWithIgnoreCase("omx.")) {
@@ -884,11 +892,6 @@ status_t MediaCodec::init(const AString &name) {
     // we need to invest in an extra looper to free the main event
     // queue.
 
-    mCodec = GetCodecBase(name);
-    if (mCodec == NULL) {
-        return NAME_NOT_FOUND;
-    }
-
     mCodecInfo.clear();
 
     bool secureCodec = false;
@@ -922,6 +925,11 @@ status_t MediaCodec::init(const AString &name) {
         return NAME_NOT_FOUND;
     }
 
+    mCodec = GetCodecBase(name, mCodecInfo->getOwnerName());
+    if (mCodec == NULL) {
+        return NAME_NOT_FOUND;
+    }
+
     if (mIsVideo) {
         // video codec needs dedicated looper
         if (mCodecLooper == NULL) {
@@ -1935,7 +1943,9 @@ void MediaCodec::onMessageReceived(const sp<AMessage> &msg) {
                         mAnalyticsItem->setCString(kCodecCodec, mComponentName.c_str());
                     }
 
-                    if (mComponentName.startsWith("OMX.google.")) {
+                    const char *owner = mCodecInfo->getOwnerName();
+                    if (mComponentName.startsWith("OMX.google.")
+                            && (owner == nullptr || strncmp(owner, "default", 8) == 0)) {
                         mFlags |= kFlagUsesSoftwareRenderer;
                     } else {
                         mFlags &= ~kFlagUsesSoftwareRenderer;
diff --git a/media/libstagefright/VideoFrameScheduler.cpp b/media/libstagefright/VideoFrameScheduler.cpp
index 6819bba40..9020fc1aa 100644
--- a/media/libstagefright/VideoFrameScheduler.cpp
+++ b/media/libstagefright/VideoFrameScheduler.cpp
@@ -475,7 +475,16 @@ nsecs_t VideoFrameScheduler::schedule(nsecs_t renderTime) {
                 nextVsyncTime += mVsyncPeriod;
                 if (vsyncsForLastFrame < ULONG_MAX)
                     ++vsyncsForLastFrame;
+            } else if (mTimeCorrection < -correctionLimit * 2
+                    || mTimeCorrection > correctionLimit * 2) {
+                ALOGW("correction beyond limit: %lld vs %lld (vsyncs for last frame: %zu, min: %zu)"
+                        " restarting. render=%lld",
+                        (long long)mTimeCorrection, (long long)correctionLimit,
+                        vsyncsForLastFrame, minVsyncsPerFrame, (long long)origRenderTime);
+                restart();
+                return origRenderTime;
             }
+
             ATRACE_INT("FRAME_VSYNCS", vsyncsForLastFrame);
         }
         mLastVsyncTime = nextVsyncTime;
diff --git a/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp b/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp
index f173e0fba..06b15b3e5 100644
--- a/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp
+++ b/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp
@@ -689,7 +689,6 @@ void SoftXAAC::onQueueFilled(OMX_U32 /* portIndex */) {
                     notify(OMX_EventError, OMX_ErrorUndefined, err_code, NULL);
                     return;
                 }
-                mIsCodecConfigFlushRequired = true;
             }
 
             if (!mSampFreq || !mNumChannels) {
@@ -713,10 +712,14 @@ void SoftXAAC::onQueueFilled(OMX_U32 /* portIndex */) {
             signed int bytesConsumed = 0;
             int errorCode = 0;
             if (mIsCodecInitialized) {
+                mIsCodecConfigFlushRequired = true;
                 errorCode =
                     decodeXAACStream(inBuffer, inBufferLength, &bytesConsumed, &numOutBytes);
-            } else {
+            } else if (!mIsCodecConfigFlushRequired) {
                 ALOGW("Assumption that first frame after header initializes decoder failed!");
+                mSignalledError = true;
+                notify(OMX_EventError, OMX_ErrorUndefined, -1, NULL);
+                return;
             }
             inHeader->nFilledLen -= bytesConsumed;
             inHeader->nOffset += bytesConsumed;
diff --git a/media/libstagefright/include/media/stagefright/CameraSource.h b/media/libstagefright/include/media/stagefright/CameraSource.h
index 475976b6e..3037b72ff 100644
--- a/media/libstagefright/include/media/stagefright/CameraSource.h
+++ b/media/libstagefright/include/media/stagefright/CameraSource.h
@@ -204,6 +204,7 @@ protected:
     int32_t mNumFramesReceived;
     int64_t mLastFrameTimestampUs;
     bool mStarted;
+    bool mEos;
     int32_t mNumFramesEncoded;
 
     // Time between capture of two frames.
diff --git a/media/libstagefright/include/media/stagefright/MediaCodec.h b/media/libstagefright/include/media/stagefright/MediaCodec.h
index ad02004aa..7f6aae628 100644
--- a/media/libstagefright/include/media/stagefright/MediaCodec.h
+++ b/media/libstagefright/include/media/stagefright/MediaCodec.h
@@ -377,7 +377,7 @@ private:
 
     MediaCodec(const sp<ALooper> &looper, pid_t pid, uid_t uid);
 
-    static sp<CodecBase> GetCodecBase(const AString &name);
+    static sp<CodecBase> GetCodecBase(const AString &name, const char *owner = nullptr);
 
     static status_t PostAndAwaitResponse(
             const sp<AMessage> &msg, sp<AMessage> *response);
diff --git a/media/libstagefright/omx/OMXNodeInstance.cpp b/media/libstagefright/omx/OMXNodeInstance.cpp
index a68f9c75f..cfab2dac9 100644
--- a/media/libstagefright/omx/OMXNodeInstance.cpp
+++ b/media/libstagefright/omx/OMXNodeInstance.cpp
@@ -1613,12 +1613,15 @@ status_t OMXNodeInstance::freeBuffer(
     }
     BufferMeta *buffer_meta = static_cast<BufferMeta *>(header->pAppPrivate);
 
+    // Invalidate buffers in the client side first before calling OMX_FreeBuffer.
+    // If not, pending events in the client side might access the buffers after free.
+    invalidateBufferID(buffer);
+
     OMX_ERRORTYPE err = OMX_FreeBuffer(mHandle, portIndex, header);
     CLOG_IF_ERROR(freeBuffer, err, "%s:%u %#x", portString(portIndex), portIndex, buffer);
 
     delete buffer_meta;
     buffer_meta = NULL;
-    invalidateBufferID(buffer);
 
     return StatusFromOMXError(err);
 }
diff --git a/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp b/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp
index d34214b72..22065262a 100644
--- a/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp
+++ b/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-#define LOG_TAG "APM::SessionRoute"
+#define LOG_TAG "APM_SessionRoute"
 //#define LOG_NDEBUG 0
 
 #include "SessionRoute.h"
@@ -122,19 +122,17 @@ void SessionRouteMap::addRoute(audio_session_t session,
 audio_devices_t SessionRouteMap::getActiveDeviceForStream(audio_stream_type_t streamType,
                                                           const DeviceVector& availableDevices)
 {
-    audio_devices_t device = AUDIO_DEVICE_NONE;
-
     for (size_t index = 0; index < size(); index++) {
         sp<SessionRoute> route = valueAt(index);
         if (streamType == route->mStreamType && route->isActiveOrChanged()
                 && route->mDeviceDescriptor != 0) {
-            device = route->mDeviceDescriptor->type();
+            audio_devices_t device = route->mDeviceDescriptor->type();
             if (!availableDevices.getDevicesFromType(device).isEmpty()) {
-                break;
+                return device;
             }
         }
     }
-    return device;
+    return AUDIO_DEVICE_NONE;
 }
 
 } // namespace android
diff --git a/services/audiopolicy/managerdefault/AudioPolicyManager.cpp b/services/audiopolicy/managerdefault/AudioPolicyManager.cpp
index 97e75bd67..51654e838 100644
--- a/services/audiopolicy/managerdefault/AudioPolicyManager.cpp
+++ b/services/audiopolicy/managerdefault/AudioPolicyManager.cpp
@@ -4882,11 +4882,15 @@ audio_devices_t AudioPolicyManager::getNewOutputDevice(const sp<AudioOutputDescr
     //      use device for strategy DTMF
     // 9: the strategy for beacon, a.k.a. "transmitted through speaker" is active on the output:
     //      use device for strategy t-t-s
+
+    // FIXME: extend use of isStrategyActiveOnSameModule() to all strategies
+    // with a refined rule considering mutually exclusive devices (using same backend)
+    // as opposed to all streams on the same audio HAL module.
     if (isStrategyActive(outputDesc, STRATEGY_ENFORCED_AUDIBLE) &&
         mEngine->getForceUse(AUDIO_POLICY_FORCE_FOR_SYSTEM) == AUDIO_POLICY_FORCE_SYSTEM_ENFORCED) {
         device = getDeviceForStrategy(STRATEGY_ENFORCED_AUDIBLE, fromCache);
     } else if (isInCall() ||
-                    isStrategyActive(outputDesc, STRATEGY_PHONE)) {
+               isStrategyActiveOnSameModule(outputDesc, STRATEGY_PHONE)) {
         device = getDeviceForStrategy(STRATEGY_PHONE, fromCache);
     } else if (isStrategyActive(outputDesc, STRATEGY_SONIFICATION)) {
         device = getDeviceForStrategy(STRATEGY_SONIFICATION, fromCache);
@@ -5894,6 +5898,20 @@ bool AudioPolicyManager::isStrategyActive(const sp<AudioOutputDescriptor>& outpu
     return false;
 }
 
+bool AudioPolicyManager::isStrategyActiveOnSameModule(const sp<AudioOutputDescriptor>& outputDesc,
+                                          routing_strategy strategy, uint32_t inPastMs,
+                                          nsecs_t sysTime) const
+{
+    for (size_t i = 0; i < mOutputs.size(); i++) {
+        sp<SwAudioOutputDescriptor> desc = mOutputs.valueAt(i);
+        if (outputDesc->sharesHwModuleWith(desc)
+            && isStrategyActive(desc, strategy, inPastMs, sysTime)) {
+            return true;
+        }
+    }
+    return false;
+}
+
 audio_policy_forced_cfg_t AudioPolicyManager::getForceUse(audio_policy_force_use_t usage)
 {
     return mEngine->getForceUse(usage);
diff --git a/services/audiopolicy/managerdefault/AudioPolicyManager.h b/services/audiopolicy/managerdefault/AudioPolicyManager.h
index f3d333a4a..a44a0bdfb 100644
--- a/services/audiopolicy/managerdefault/AudioPolicyManager.h
+++ b/services/audiopolicy/managerdefault/AudioPolicyManager.h
@@ -321,6 +321,10 @@ protected:
         bool isStrategyActive(const sp<AudioOutputDescriptor>& outputDesc, routing_strategy strategy,
                               uint32_t inPastMs = 0, nsecs_t sysTime = 0) const;
 
+        bool isStrategyActiveOnSameModule(const sp<AudioOutputDescriptor>& outputDesc,
+                                                  routing_strategy strategy, uint32_t inPastMs = 0,
+                                                  nsecs_t sysTime = 0) const;
+
         // change the route of the specified output. Returns the number of ms we have slept to
         // allow new routing to take effect in certain cases.
         virtual uint32_t setOutputDevice(const sp<AudioOutputDescriptor>& outputDesc,
diff --git a/services/camera/libcameraservice/api1/Camera2Client.cpp b/services/camera/libcameraservice/api1/Camera2Client.cpp
index 65faac94b..d59b31328 100644
--- a/services/camera/libcameraservice/api1/Camera2Client.cpp
+++ b/services/camera/libcameraservice/api1/Camera2Client.cpp
@@ -102,7 +102,7 @@ status_t Camera2Client::initializeImpl(TProviderPtr providerPtr, const String8&
     {
         SharedParameters::Lock l(mParameters);
 
-        res = l.mParameters.initialize(&(mDevice->info()), mDeviceVersion);
+        res = l.mParameters.initialize(mDevice.get(), mDeviceVersion);
         if (res != OK) {
             ALOGE("%s: Camera %d: unable to build defaults: %s (%d)",
                     __FUNCTION__, mCameraId, strerror(-res), res);
@@ -250,6 +250,7 @@ status_t Camera2Client::dumpClient(int fd, const Vector<String16>& args) {
     switch (p.sceneMode) {
         case ANDROID_CONTROL_SCENE_MODE_DISABLED:
             result.append("AUTO\n"); break;
+        CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_FACE_PRIORITY)
         CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_ACTION)
         CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_PORTRAIT)
         CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_LANDSCAPE)
diff --git a/services/camera/libcameraservice/api1/client2/Parameters.cpp b/services/camera/libcameraservice/api1/client2/Parameters.cpp
index d66dec49e..28d186abb 100644
--- a/services/camera/libcameraservice/api1/client2/Parameters.cpp
+++ b/services/camera/libcameraservice/api1/client2/Parameters.cpp
@@ -41,23 +41,29 @@ Parameters::Parameters(int cameraId,
         int cameraFacing) :
         cameraId(cameraId),
         cameraFacing(cameraFacing),
-        info(NULL) {
+        info(NULL),
+        mDefaultSceneMode(ANDROID_CONTROL_SCENE_MODE_DISABLED) {
 }
 
 Parameters::~Parameters() {
 }
 
-status_t Parameters::initialize(const CameraMetadata *info, int deviceVersion) {
+status_t Parameters::initialize(CameraDeviceBase *device, int deviceVersion) {
     status_t res;
+    if (device == nullptr) {
+        ALOGE("%s: device is null!", __FUNCTION__);
+        return BAD_VALUE;
+    }
 
-    if (info->entryCount() == 0) {
+    const CameraMetadata& info = device->info();
+    if (info.entryCount() == 0) {
         ALOGE("%s: No static information provided!", __FUNCTION__);
         return BAD_VALUE;
     }
-    Parameters::info = info;
+    Parameters::info = &info;
     mDeviceVersion = deviceVersion;
 
-    res = buildFastInfo();
+    res = buildFastInfo(device);
     if (res != OK) return res;
 
     res = buildQuirks();
@@ -557,6 +563,10 @@ status_t Parameters::initialize(const CameraMetadata *info, int deviceVersion) {
                     noSceneModes = true;
                     break;
                 case ANDROID_CONTROL_SCENE_MODE_FACE_PRIORITY:
+                    // Face priority can be used as alternate default if supported.
+                    // Per API contract it shouldn't override the user set flash,
+                    // white balance and focus modes.
+                    mDefaultSceneMode = availableSceneModes.data.u8[i];
                     // Not in old API
                     addComma = false;
                     break;
@@ -761,17 +771,7 @@ status_t Parameters::initialize(const CameraMetadata *info, int deviceVersion) {
     focusingAreas.clear();
     focusingAreas.add(Parameters::Area(0,0,0,0,0));
 
-    if (fastInfo.isExternalCamera) {
-        params.setFloat(CameraParameters::KEY_FOCAL_LENGTH, -1.0);
-    } else {
-        camera_metadata_ro_entry_t availableFocalLengths =
-            staticInfo(ANDROID_LENS_INFO_AVAILABLE_FOCAL_LENGTHS, 0, 0, false);
-        if (!availableFocalLengths.count) return NO_INIT;
-
-        float minFocalLength = availableFocalLengths.data.f[0];
-        params.setFloat(CameraParameters::KEY_FOCAL_LENGTH, minFocalLength);
-    }
-
+    params.setFloat(CameraParameters::KEY_FOCAL_LENGTH, fastInfo.defaultFocalLength);
 
     float horizFov, vertFov;
     res = calculatePictureFovs(&horizFov, &vertFov);
@@ -993,7 +993,7 @@ String8 Parameters::get() const {
     return paramsFlattened;
 }
 
-status_t Parameters::buildFastInfo() {
+status_t Parameters::buildFastInfo(CameraDeviceBase *device) {
 
     camera_metadata_ro_entry_t activeArraySize =
         staticInfo(ANDROID_SENSOR_INFO_ACTIVE_ARRAY_SIZE, 2, 4);
@@ -1109,20 +1109,12 @@ status_t Parameters::buildFastInfo() {
             focusDistanceCalibration.data.u8[0] !=
             ANDROID_LENS_INFO_FOCUS_DISTANCE_CALIBRATION_UNCALIBRATED);
 
-
-    camera_metadata_ro_entry_t hwLevel = staticInfo(ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL);
-    if (!hwLevel.count) return NO_INIT;
-    fastInfo.isExternalCamera =
-            hwLevel.data.u8[0] == ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL_EXTERNAL;
-
-    camera_metadata_ro_entry_t availableFocalLengths =
-        staticInfo(ANDROID_LENS_INFO_AVAILABLE_FOCAL_LENGTHS, 0, 0, /*required*/false);
-    if (!availableFocalLengths.count && !fastInfo.isExternalCamera) return NO_INIT;
+    res = getDefaultFocalLength(device);
+    if (res != OK) return res;
 
     SortedVector<int32_t> availableFormats = getAvailableOutputFormats();
     if (!availableFormats.size()) return NO_INIT;
 
-
     if (sceneModeOverrides.count > 0) {
         // sceneModeOverrides is defined to have 3 entries for each scene mode,
         // which are AE, AWB, and AF override modes the HAL wants for that scene
@@ -1200,19 +1192,6 @@ status_t Parameters::buildFastInfo() {
     fastInfo.bestFaceDetectMode = bestFaceDetectMode;
     fastInfo.maxFaces = maxFaces;
 
-    // Find smallest (widest-angle) focal length to use as basis of still
-    // picture FOV reporting.
-    if (fastInfo.isExternalCamera) {
-        fastInfo.minFocalLength = -1.0;
-    } else {
-        fastInfo.minFocalLength = availableFocalLengths.data.f[0];
-        for (size_t i = 1; i < availableFocalLengths.count; i++) {
-            if (fastInfo.minFocalLength > availableFocalLengths.data.f[i]) {
-                fastInfo.minFocalLength = availableFocalLengths.data.f[i];
-            }
-        }
-    }
-
     // Check if the HAL supports HAL_PIXEL_FORMAT_YCbCr_420_888
     fastInfo.useFlexibleYuv = false;
     for (size_t i = 0; i < availableFormats.size(); i++) {
@@ -1760,7 +1739,7 @@ status_t Parameters::set(const String8& paramString) {
 
     // SCENE_MODE
     validatedParams.sceneMode = sceneModeStringToEnum(
-        newParams.get(CameraParameters::KEY_SCENE_MODE) );
+        newParams.get(CameraParameters::KEY_SCENE_MODE), mDefaultSceneMode);
     if (validatedParams.sceneMode != sceneMode &&
             validatedParams.sceneMode !=
             ANDROID_CONTROL_SCENE_MODE_DISABLED) {
@@ -1778,7 +1757,7 @@ status_t Parameters::set(const String8& paramString) {
         }
     }
     bool sceneModeSet =
-            validatedParams.sceneMode != ANDROID_CONTROL_SCENE_MODE_DISABLED;
+            validatedParams.sceneMode != mDefaultSceneMode;
 
     // FLASH_MODE
     if (sceneModeSet) {
@@ -2157,7 +2136,7 @@ status_t Parameters::updateRequest(CameraMetadata *request) const {
     uint8_t reqSceneMode =
             sceneModeActive ? sceneMode :
             enableFaceDetect ? (uint8_t)ANDROID_CONTROL_SCENE_MODE_FACE_PRIORITY :
-            (uint8_t)ANDROID_CONTROL_SCENE_MODE_DISABLED;
+            mDefaultSceneMode;
     res = request->update(ANDROID_CONTROL_SCENE_MODE,
             &reqSceneMode, 1);
     if (res != OK) return res;
@@ -2446,6 +2425,50 @@ bool Parameters::useZeroShutterLag() const {
     return true;
 }
 
+status_t Parameters::getDefaultFocalLength(CameraDeviceBase *device) {
+    if (device == nullptr) {
+        ALOGE("%s: Camera device is nullptr", __FUNCTION__);
+        return BAD_VALUE;
+    }
+
+    camera_metadata_ro_entry_t hwLevel = staticInfo(ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL);
+    if (!hwLevel.count) return NO_INIT;
+    fastInfo.isExternalCamera =
+            hwLevel.data.u8[0] == ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL_EXTERNAL;
+
+    camera_metadata_ro_entry_t availableFocalLengths =
+        staticInfo(ANDROID_LENS_INFO_AVAILABLE_FOCAL_LENGTHS, 0, 0, /*required*/false);
+    if (!availableFocalLengths.count && !fastInfo.isExternalCamera) return NO_INIT;
+
+    // Find focal length in PREVIEW template to use as default focal length.
+    if (fastInfo.isExternalCamera) {
+        fastInfo.defaultFocalLength = -1.0;
+    } else {
+        // Find smallest (widest-angle) focal length to use as basis of still
+        // picture FOV reporting.
+        fastInfo.defaultFocalLength = availableFocalLengths.data.f[0];
+        for (size_t i = 1; i < availableFocalLengths.count; i++) {
+            if (fastInfo.defaultFocalLength > availableFocalLengths.data.f[i]) {
+                fastInfo.defaultFocalLength = availableFocalLengths.data.f[i];
+            }
+        }
+
+        // Use focal length in preview template if it exists
+        CameraMetadata previewTemplate;
+        status_t res = device->createDefaultRequest(CAMERA3_TEMPLATE_PREVIEW, &previewTemplate);
+        if (res != OK) {
+            ALOGE("%s: Failed to create default PREVIEW request: %s (%d)",
+                    __FUNCTION__, strerror(-res), res);
+            return res;
+        }
+        camera_metadata_entry entry = previewTemplate.find(ANDROID_LENS_FOCAL_LENGTH);
+        if (entry.count != 0) {
+            fastInfo.defaultFocalLength = entry.data.f[0];
+        }
+    }
+    return OK;
+}
+
 const char* Parameters::getStateName(State state) {
 #define CASE_ENUM_TO_CHAR(x) case x: return(#x); break;
     switch(state) {
@@ -2589,12 +2612,12 @@ int Parameters::abModeStringToEnum(const char *abMode) {
         -1;
 }
 
-int Parameters::sceneModeStringToEnum(const char *sceneMode) {
+int Parameters::sceneModeStringToEnum(const char *sceneMode, uint8_t defaultSceneMode) {
     return
         !sceneMode ?
-            ANDROID_CONTROL_SCENE_MODE_DISABLED :
+            defaultSceneMode :
         !strcmp(sceneMode, CameraParameters::SCENE_MODE_AUTO) ?
-            ANDROID_CONTROL_SCENE_MODE_DISABLED :
+            defaultSceneMode :
         !strcmp(sceneMode, CameraParameters::SCENE_MODE_ACTION) ?
             ANDROID_CONTROL_SCENE_MODE_ACTION :
         !strcmp(sceneMode, CameraParameters::SCENE_MODE_PORTRAIT) ?
@@ -3241,12 +3264,12 @@ status_t Parameters::calculatePictureFovs(float *horizFov, float *vertFov)
     if (horizFov != NULL) {
         *horizFov = 180 / M_PI * 2 *
                 atanf(horizCropFactor * sensorSize.data.f[0] /
-                        (2 * fastInfo.minFocalLength));
+                        (2 * fastInfo.defaultFocalLength));
     }
     if (vertFov != NULL) {
         *vertFov = 180 / M_PI * 2 *
                 atanf(vertCropFactor * sensorSize.data.f[1] /
-                        (2 * fastInfo.minFocalLength));
+                        (2 * fastInfo.defaultFocalLength));
     }
     return OK;
 }
diff --git a/services/camera/libcameraservice/api1/client2/Parameters.h b/services/camera/libcameraservice/api1/client2/Parameters.h
index 97f8ea7f3..42e7a47c8 100644
--- a/services/camera/libcameraservice/api1/client2/Parameters.h
+++ b/services/camera/libcameraservice/api1/client2/Parameters.h
@@ -30,6 +30,8 @@
 #include <camera/CameraParameters2.h>
 #include <camera/CameraMetadata.h>
 
+#include "common/CameraDeviceBase.h"
+
 namespace android {
 namespace camera2 {
 
@@ -241,7 +243,7 @@ struct Parameters {
         };
         DefaultKeyedVector<uint8_t, OverrideModes> sceneModeOverrides;
         bool isExternalCamera;
-        float minFocalLength;
+        float defaultFocalLength;
         bool useFlexibleYuv;
         Size maxJpegSize;
         Size maxZslSize;
@@ -264,10 +266,10 @@ struct Parameters {
     ~Parameters();
 
     // Sets up default parameters
-    status_t initialize(const CameraMetadata *info, int deviceVersion);
+    status_t initialize(CameraDeviceBase *device, int deviceVersion);
 
     // Build fast-access device static info from static info
-    status_t buildFastInfo();
+    status_t buildFastInfo(CameraDeviceBase *device);
     // Query for quirks from static info
     status_t buildQuirks();
 
@@ -300,6 +302,9 @@ struct Parameters {
     // whether zero shutter lag should be used for non-recording operation
     bool useZeroShutterLag() const;
 
+    // Get default focal length
+    status_t getDefaultFocalLength(CameraDeviceBase *camera);
+
     // Calculate the crop region rectangle, either tightly about the preview
     // resolution, or a region just based on the active array; both take
     // into account the current zoom level.
@@ -326,7 +331,7 @@ struct Parameters {
     static const char* wbModeEnumToString(uint8_t wbMode);
     static int effectModeStringToEnum(const char *effectMode);
     static int abModeStringToEnum(const char *abMode);
-    static int sceneModeStringToEnum(const char *sceneMode);
+    static int sceneModeStringToEnum(const char *sceneMode, uint8_t defaultScene);
     static flashMode_t flashModeStringToEnum(const char *flashMode);
     static const char* flashModeEnumToString(flashMode_t flashMode);
     static focusMode_t focusModeStringToEnum(const char *focusMode);
@@ -434,6 +439,7 @@ private:
     Size getMaxSize(const Vector<Size>& sizes);
 
     int mDeviceVersion;
+    uint8_t mDefaultSceneMode;
 };
 
 // This class encapsulates the Parameters class so that it can only be accessed
diff --git a/services/camera/libcameraservice/device3/Camera3Device.cpp b/services/camera/libcameraservice/device3/Camera3Device.cpp
index 908fe43cd..79911fc18 100644
--- a/services/camera/libcameraservice/device3/Camera3Device.cpp
+++ b/services/camera/libcameraservice/device3/Camera3Device.cpp
@@ -2147,8 +2147,14 @@ status_t Camera3Device::setConsumerSurfaces(int streamId,
 
         res = stream->finishConfiguration();
         if (res != OK) {
-            SET_ERR_L("Can't finish configuring output stream %d: %s (%d)",
-                   stream->getId(), strerror(-res), res);
+            // If finishConfiguration fails due to abandoned surface, do not set
+            // device to error state.
+            bool isSurfaceAbandoned =
+                    (res == NO_INIT || res == DEAD_OBJECT) && stream->isAbandoned();
+            if (!isSurfaceAbandoned) {
+                SET_ERR_L("Can't finish configuring output stream %d: %s (%d)",
+                        stream->getId(), strerror(-res), res);
+            }
             return res;
         }
     }
@@ -2365,9 +2371,16 @@ bool Camera3Device::reconfigureCamera(const CameraMetadata& sessionParams) {
             //present streams end up with outstanding buffers that will
             //not get drained.
             internalUpdateStatusLocked(STATUS_ACTIVE);
+        } else if (rc == DEAD_OBJECT) {
+            // DEAD_OBJECT can be returned if either the consumer surface is
+            // abandoned, or the HAL has died.
+            // - If the HAL has died, configureStreamsLocked call will set
+            // device to error state,
+            // - If surface is abandoned, we should not set device to error
+            // state.
+            ALOGE("Failed to re-configure camera due to abandoned surface");
         } else {
-            setErrorStateLocked("%s: Failed to re-configure camera: %d",
-                    __FUNCTION__, rc);
+            SET_ERR_L("Failed to re-configure camera: %d", rc);
         }
     } else {
         ALOGE("%s: Failed to pause streaming: %d", __FUNCTION__, rc);
@@ -2501,6 +2514,9 @@ status_t Camera3Device::configureStreamsLocked(int operatingMode,
             CLOGE("Can't finish configuring input stream %d: %s (%d)",
                     mInputStream->getId(), strerror(-res), res);
             cancelStreamsConfigurationLocked();
+            if ((res == NO_INIT || res == DEAD_OBJECT) && mInputStream->isAbandoned()) {
+                return DEAD_OBJECT;
+            }
             return BAD_VALUE;
         }
     }
@@ -2514,6 +2530,9 @@ status_t Camera3Device::configureStreamsLocked(int operatingMode,
                 CLOGE("Can't finish configuring output stream %d: %s (%d)",
                         outputStream->getId(), strerror(-res), res);
                 cancelStreamsConfigurationLocked();
+                if ((res == NO_INIT || res == DEAD_OBJECT) && outputStream->isAbandoned()) {
+                    return DEAD_OBJECT;
+                }
                 return BAD_VALUE;
             }
         }
diff --git a/services/camera/libcameraservice/device3/Camera3OutputStream.cpp b/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
index b3c3717c3..2c020a279 100644
--- a/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
+++ b/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
@@ -564,7 +564,7 @@ status_t Camera3OutputStream::getBufferLockedCommon(ANativeWindowBuffer** anb, i
 
             // Only transition to STATE_ABANDONED from STATE_CONFIGURED. (If it is STATE_PREPARING,
             // let prepareNextBuffer handle the error.)
-            if (res == NO_INIT && mState == STATE_CONFIGURED) {
+            if ((res == NO_INIT || res == DEAD_OBJECT) && mState == STATE_CONFIGURED) {
                 mState = STATE_ABANDONED;
             }
 
diff --git a/services/camera/libcameraservice/device3/Camera3Stream.cpp b/services/camera/libcameraservice/device3/Camera3Stream.cpp
index 87476612a..6154301b7 100644
--- a/services/camera/libcameraservice/device3/Camera3Stream.cpp
+++ b/services/camera/libcameraservice/device3/Camera3Stream.cpp
@@ -331,7 +331,14 @@ status_t Camera3Stream::finishConfiguration() {
 
     status_t res;
     res = configureQueueLocked();
-    if (res != OK) {
+    // configureQueueLocked could return error in case of abandoned surface.
+    // Treat as non-fatal error.
+    if (res == NO_INIT || res == DEAD_OBJECT) {
+        ALOGE("%s: Unable to configure stream %d queue (non-fatal): %s (%d)",
+                __FUNCTION__, mId, strerror(-res), res);
+        mState = STATE_ABANDONED;
+        return res;
+    } else if (res != OK) {
         ALOGE("%s: Unable to configure stream %d queue: %s (%d)",
                 __FUNCTION__, mId, strerror(-res), res);
         mState = STATE_ERROR;
diff --git a/services/camera/libcameraservice/device3/Camera3Stream.h b/services/camera/libcameraservice/device3/Camera3Stream.h
index e6fb7f9f4..1af939c0a 100644
--- a/services/camera/libcameraservice/device3/Camera3Stream.h
+++ b/services/camera/libcameraservice/device3/Camera3Stream.h
@@ -483,6 +483,7 @@ class Camera3Stream :
     // after the HAL has provided usage and max_buffers values. After this call,
     // the stream must be ready to produce all buffers for registration with
     // HAL.
+    // Returns NO_INIT or DEAD_OBJECT if the queue has been abandoned.
     virtual status_t configureQueueLocked() = 0;
 
     // Get the total number of buffers in the queue
diff --git a/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp b/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp
index a0be60803..8bc208dfa 100644
--- a/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp
+++ b/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp
@@ -500,6 +500,10 @@ void Camera3StreamSplitter::onFrameAvailable(const BufferItem& /*item*/) {
     SP_LOGV("acquired buffer %" PRId64 " from input at slot %d",
             bufferItem.mGraphicBuffer->getId(), bufferItem.mSlot);
 
+    if (bufferItem.mTransformToDisplayInverse) {
+        bufferItem.mTransform |= NATIVE_WINDOW_TRANSFORM_INVERSE_DISPLAY;
+    }
+
     // Attach and queue the buffer to each of the outputs
     BufferTracker& tracker = *(mBuffers[bufferId]);
 
-- 
2.17.1

