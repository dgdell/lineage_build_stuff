From 72066735132aad2b4e30c4da1f1798be79a3b995 Mon Sep 17 00:00:00 2001
From: Sampath Vangaveti <sampathv@codeaurora.org>
Date: Mon, 17 Apr 2017 12:15:11 +0530
Subject: [PATCH 07/11] Camera2Client: Add support for enabling QTI DIS feature

Add support for enabling/disabling QTI specific DIS feature.

Change-Id: I8457e3252dd832d44be28c886a2aa6542cda6845
---
 .../api1/qticlient2/QTIParameters.cpp         | 35 +++++++++++++++++++
 1 file changed, 35 insertions(+)

diff --git a/services/camera/libcameraservice/api1/qticlient2/QTIParameters.cpp b/services/camera/libcameraservice/api1/qticlient2/QTIParameters.cpp
index 79a5c126f..b6aae2340 100644
--- a/services/camera/libcameraservice/api1/qticlient2/QTIParameters.cpp
+++ b/services/camera/libcameraservice/api1/qticlient2/QTIParameters.cpp
@@ -167,6 +167,10 @@ const char KEY_QTI_SUPPORTED_HFR_SIZES[] = "hfr-size-values";
 const char KEY_QTI_SUPPORTED_HDR_NEED_1X[] = "hdr-need-1x-values";
 const char KEY_QTI_HDR_NEED_1X[] = "hdr-need-1x";
 
+// DIS
+const char KEY_QTI_SUPPORTED_DIS_MODES[] = "dis-values";
+const char KEY_QTI_DIS[] = "dis";
+
 status_t QTIParameters::initialize(void *parametersParent,
             sp<CameraDeviceBase> device, sp<CameraProviderManager> manager) {
     status_t res = OK;
@@ -466,6 +470,20 @@ status_t QTIParameters::initialize(void *parametersParent,
         ParentParams->params.set(KEY_QTI_VIDEO_HIGH_FRAME_RATE, "off");
 
     }
+
+    // Video stabilization, DIS
+    camera_metadata_ro_entry_t availableVideoStabilizationModes =
+        ParentParams->staticInfo(ANDROID_CONTROL_AVAILABLE_VIDEO_STABILIZATION_MODES, 0, 0,
+                false);
+
+    if (availableVideoStabilizationModes.count > 1) {
+        ParentParams->params.set(KEY_QTI_SUPPORTED_DIS_MODES,"disable,enable");
+    } else {
+        ParentParams->params.set(KEY_QTI_SUPPORTED_DIS_MODES,"disable");
+    }
+    // Default
+    ParentParams->params.set(KEY_QTI_DIS, "disable");
+
     return res;
 }
 
@@ -674,6 +692,23 @@ status_t QTIParameters::set(CameraParameters2& newParams, void *parametersParent
         newParams.set("num-snaps-per-shutter", String8::format("%d", burstCount));
     }
 
+    // VIDEO_STABILIZATION, DIS
+    const char *disValue = newParams.get(KEY_QTI_DIS);
+    if (disValue != NULL && !strcmp(disValue, "enable")) {
+        ParentParams->videoStabilization = true;
+    } else {
+        ParentParams->videoStabilization = false;
+    }
+
+    camera_metadata_ro_entry_t availableVideoStabilizationModes =
+        ParentParams->staticInfo(ANDROID_CONTROL_AVAILABLE_VIDEO_STABILIZATION_MODES, 0, 0,
+                false);
+    if (ParentParams->videoStabilization &&
+            availableVideoStabilizationModes.count == 1) {
+        ALOGE("%s: Video stabilization not supported", __FUNCTION__);
+        ParentParams->videoStabilization = false;
+    }
+
     return res;
 }
 
-- 
2.17.1

