From 8ed2ae4f2f0fdb73e2e8327c3fd6e667b01bd74b Mon Sep 17 00:00:00 2001
From: Michael W <baddaemon87@gmail.com>
Date: Mon, 23 Apr 2018 18:58:38 +0200
Subject: [PATCH 10/12] PhoneWindowManager: Don't timeout when taking a partial
 screenshot

* A partial screenshot shouldn't timeout when the user might still be
  adjusting the rectangle

BUGBASH-1500

Change-Id: Ifb06173dc712667db3bfb3c6f945b9bddb2a85fa
---
 .../src/com/android/systemui/globalactions/GlobalActionsDialog.java   | 4 +++-
 services/core/java/com/android/server/policy/PhoneWindowManager.java  | 4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialog.java b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialog.java
index f99c2ff582a..2951c622929 100644
--- a/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialog.java
+++ b/packages/SystemUI/src/com/android/systemui/globalactions/GlobalActionsDialog.java
@@ -993,7 +993,9 @@ class GlobalActionsDialog implements DialogInterface.OnDismissListener, DialogIn
             if (mContext.bindServiceAsUser(
                         intent, conn, Context.BIND_AUTO_CREATE, UserHandle.CURRENT)) {
                 mScreenshotConnection = conn;
-                mHandler.postDelayed(mScreenshotTimeout, 10000);
+                if (!partial) {
+                    mHandler.postDelayed(mScreenshotTimeout, 10000);
+                }
             }
         }
     }
diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index 949d7306b97..6b14632d5b7 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -6474,7 +6474,9 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                     Context.BIND_AUTO_CREATE | Context.BIND_FOREGROUND_SERVICE_WHILE_AWAKE,
                     UserHandle.CURRENT)) {
                 mScreenshotConnection = conn;
-                mHandler.postDelayed(mScreenshotTimeout, 10000);
+                if (screenshotType != WindowManager.TAKE_SCREENSHOT_SELECTED_REGION) {
+                    mHandler.postDelayed(mScreenshotTimeout, 10000);
+                }
             }
         }
     }
-- 
2.15.1

