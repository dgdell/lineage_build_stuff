From a48831663f70cf3c40764cff4ea8639c97ddcd56 Mon Sep 17 00:00:00 2001
From: Paul Keith <javelinanddart@gmail.com>
Date: Mon, 28 May 2018 04:23:30 +0200
Subject: [PATCH 13/21] SignalClusterView: Hide signal icons for disabled SIMs

Change-Id: If79814cb6bd77150640f977764dfd59b87448c64
---
 packages/SystemUI/Android.mk                  |  2 +-
 .../systemui/statusbar/SignalClusterView.java | 31 +++++++++++++++++--
 2 files changed, 30 insertions(+), 3 deletions(-)

diff --git a/packages/SystemUI/Android.mk b/packages/SystemUI/Android.mk
index 0e25717a099..63c6b566e6a 100644
--- a/packages/SystemUI/Android.mk
+++ b/packages/SystemUI/Android.mk
@@ -45,7 +45,7 @@ LOCAL_STATIC_JAVA_LIBRARIES := \
     SystemUI-proto \
     org.lineageos.platform.internal
 
-LOCAL_JAVA_LIBRARIES := telephony-common
+LOCAL_JAVA_LIBRARIES := telephony-common telephony-ext
 LOCAL_JAVA_LIBRARIES += android.car
 LOCAL_FULL_LIBS_MANIFEST_FILES := $(LOCAL_PATH)/LineageManifest.xml
 
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java b/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java
index 274244ef267..164dd647ee6 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java
@@ -24,6 +24,7 @@ import android.graphics.Color;
 import android.graphics.Rect;
 import android.graphics.drawable.Drawable;
 import android.telephony.SubscriptionInfo;
+import android.telephony.SubscriptionManager;
 import android.util.ArraySet;
 import android.util.AttributeSet;
 import android.util.Log;
@@ -49,6 +50,9 @@ import com.android.systemui.statusbar.policy.SecurityController;
 import com.android.systemui.tuner.TunerService;
 import com.android.systemui.tuner.TunerService.Tunable;
 
+import org.lineageos.internal.util.TelephonyExtUtils;
+import org.lineageos.internal.util.TelephonyExtUtils.ProvisioningChangedListener;
+
 import java.util.ArrayList;
 import java.util.List;
 import java.util.Objects;
@@ -56,7 +60,7 @@ import java.util.Objects;
 // Intimately tied to the design of res/layout/signal_cluster_view.xml
 public class SignalClusterView extends LinearLayout implements NetworkControllerImpl.SignalCallback,
         SecurityController.SecurityControllerCallback, Tunable,
-        DarkReceiver {
+        DarkReceiver, ProvisioningChangedListener {
 
     static final String TAG = "SignalClusterView";
     static final boolean DEBUG = Log.isLoggable(TAG, Log.DEBUG);
@@ -149,6 +153,25 @@ public class SignalClusterView extends LinearLayout implements NetworkController
         mNetworkController = Dependency.get(NetworkController.class);
         mSecurityController = Dependency.get(SecurityController.class);
         updateActivityEnabled();
+
+        if (!TelephonyExtUtils.hasService(context)) {
+            TelephonyExtUtils.addListener(this);
+        }
+    }
+
+    @Override
+    public void onProvisioningChanged(int slotId, boolean isProvisioned) {
+        int[] subId = SubscriptionManager.getSubId(slotId);
+        if (subId != null) {
+            PhoneState state = getState(subId[0]);
+            if (state != null) {
+                state.mProvisioned = isProvisioned;
+                if (!isProvisioned) {
+                    state.mMobileVisible = false;
+                }
+            }
+            apply();
+        }
     }
 
     public void setForceBlockWifi() {
@@ -304,7 +327,7 @@ public class SignalClusterView extends LinearLayout implements NetworkController
         if (state == null) {
             return;
         }
-        state.mMobileVisible = statusIcon.visible && !mBlockMobile;
+        state.mMobileVisible = statusIcon.visible && !mBlockMobile && state.mProvisioned;
         state.mMobileStrengthId = statusIcon.icon;
         state.mMobileTypeId = statusType;
         state.mMobileDescription = statusIcon.contentDescription;
@@ -641,6 +664,7 @@ public class SignalClusterView extends LinearLayout implements NetworkController
     private class PhoneState {
         private final int mSubId;
         private boolean mMobileVisible = false;
+        private boolean mProvisioned = true;
         private int mMobileStrengthId = 0, mMobileTypeId = 0;
         private int mLastMobileStrengthId = -1;
         private int mLastMobileTypeId = -1;
@@ -660,6 +684,9 @@ public class SignalClusterView extends LinearLayout implements NetworkController
                     .inflate(R.layout.mobile_signal_group, null);
             setViews(root);
             mSubId = subId;
+            if (TelephonyExtUtils.hasService(context)) {
+                mProvisioned = TelephonyExtUtils.isSubProvisioned(subId);
+            }
         }
 
         public void setViews(ViewGroup root) {
-- 
2.17.1

