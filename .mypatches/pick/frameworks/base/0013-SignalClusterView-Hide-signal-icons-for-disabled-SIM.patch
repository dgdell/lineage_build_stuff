From 2b9aed64ca8d42b2752ebb9a71fe8e95d09cc602 Mon Sep 17 00:00:00 2001
From: Paul Keith <javelinanddart@gmail.com>
Date: Mon, 28 May 2018 04:23:30 +0200
Subject: [PATCH 13/19] SignalClusterView: Hide signal icons for disabled SIMs

Change-Id: If79814cb6bd77150640f977764dfd59b87448c64
---
 packages/SystemUI/Android.mk                  |  2 +-
 .../systemui/statusbar/SignalClusterView.java | 70 ++++++++++++++++++-
 2 files changed, 70 insertions(+), 2 deletions(-)

diff --git a/packages/SystemUI/Android.mk b/packages/SystemUI/Android.mk
index 0e25717a099..63c6b566e6a 100644
--- a/packages/SystemUI/Android.mk
+++ b/packages/SystemUI/Android.mk
@@ -45,7 +45,7 @@ LOCAL_STATIC_JAVA_LIBRARIES := \
     SystemUI-proto \
     org.lineageos.platform.internal
 
-LOCAL_JAVA_LIBRARIES := telephony-common
+LOCAL_JAVA_LIBRARIES := telephony-common telephony-ext
 LOCAL_JAVA_LIBRARIES += android.car
 LOCAL_FULL_LIBS_MANIFEST_FILES := $(LOCAL_PATH)/LineageManifest.xml
 
diff --git a/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java b/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java
index 274244ef267..906fc88c1df 100644
--- a/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java
+++ b/packages/SystemUI/src/com/android/systemui/statusbar/SignalClusterView.java
@@ -17,13 +17,19 @@
 package com.android.systemui.statusbar;
 
 import android.annotation.DrawableRes;
+import android.content.BroadcastReceiver;
 import android.content.Context;
+import android.content.Intent;
+import android.content.IntentFilter;
 import android.content.res.ColorStateList;
 import android.content.res.Resources;
 import android.graphics.Color;
 import android.graphics.Rect;
 import android.graphics.drawable.Drawable;
+import android.os.RemoteException;
+import android.os.ServiceManager;
 import android.telephony.SubscriptionInfo;
+import android.telephony.SubscriptionManager;
 import android.util.ArraySet;
 import android.util.AttributeSet;
 import android.util.Log;
@@ -35,6 +41,7 @@ import android.view.accessibility.AccessibilityEvent;
 import android.widget.ImageView;
 import android.widget.LinearLayout;
 
+import com.android.internal.telephony.PhoneConstants;
 import com.android.systemui.Dependency;
 import com.android.systemui.R;
 import com.android.systemui.statusbar.phone.SignalDrawable;
@@ -49,6 +56,9 @@ import com.android.systemui.statusbar.policy.SecurityController;
 import com.android.systemui.tuner.TunerService;
 import com.android.systemui.tuner.TunerService.Tunable;
 
+import org.codeaurora.internal.IExtTelephony;
+
+import java.lang.NoClassDefFoundError;
 import java.util.ArrayList;
 import java.util.List;
 import java.util.Objects;
@@ -67,6 +77,17 @@ public class SignalClusterView extends LinearLayout implements NetworkController
     private static final String SLOT_ETHERNET = "ethernet";
     private static final String SLOT_VPN = "vpn";
 
+    private static final String ACTION_UICC_MANUAL_PROVISION_STATUS_CHANGED =
+            "org.codeaurora.intent.action.ACTION_UICC_MANUAL_PROVISION_STATUS_CHANGED";
+    private static final String EXTRA_NEW_PROVISION_STATE = "newProvisionState";
+
+    private static final int PROVISIONED = 1;
+    private static final int NOT_PROVISIONED = 0;
+
+    private IExtTelephony mExtTelephony;
+
+    private BroadcastReceiver mReceiver;
+
     private final NetworkController mNetworkController;
     private final SecurityController mSecurityController;
 
@@ -149,6 +170,41 @@ public class SignalClusterView extends LinearLayout implements NetworkController
         mNetworkController = Dependency.get(NetworkController.class);
         mSecurityController = Dependency.get(SecurityController.class);
         updateActivityEnabled();
+
+        try {
+            mExtTelephony = IExtTelephony.Stub.asInterface(ServiceManager.getService("extphone"));
+        } catch (NoClassDefFoundError ex) {
+            // Device does not compile telephony-ext, so ignore the exception
+            // and also skip initializing and registering the broadcast receiver.
+            return;
+        }
+
+        mReceiver = new BroadcastReceiver() {
+            @Override
+            public void onReceive(Context context, Intent intent) {
+                String action = intent.getAction();
+                if (ACTION_UICC_MANUAL_PROVISION_STATUS_CHANGED.equals(action)) {
+                    int phoneId = intent.getIntExtra(PhoneConstants.PHONE_KEY,
+                            SubscriptionManager.INVALID_SUBSCRIPTION_ID);
+                    int newProvisionedState = intent.getIntExtra(EXTRA_NEW_PROVISION_STATE,
+                            NOT_PROVISIONED);
+                    int[] subId = SubscriptionManager.getSubId(phoneId);
+                    if (subId != null) {
+                        PhoneState state = getState(subId[0]);
+                        if (state != null) {
+                            state.mProvisioned = newProvisionedState == PROVISIONED;
+                            if (!state.mProvisioned) {
+                                state.mMobileVisible = false;
+                            }
+                        }
+                        apply();
+                    }
+                }
+            }
+        };
+
+        IntentFilter intentFilter = new IntentFilter(ACTION_UICC_MANUAL_PROVISION_STATUS_CHANGED);
+        context.registerReceiver(mReceiver, intentFilter);
     }
 
     public void setForceBlockWifi() {
@@ -304,7 +360,7 @@ public class SignalClusterView extends LinearLayout implements NetworkController
         if (state == null) {
             return;
         }
-        state.mMobileVisible = statusIcon.visible && !mBlockMobile;
+        state.mMobileVisible = statusIcon.visible && !mBlockMobile && state.mProvisioned;
         state.mMobileStrengthId = statusIcon.icon;
         state.mMobileTypeId = statusType;
         state.mMobileDescription = statusIcon.contentDescription;
@@ -641,6 +697,7 @@ public class SignalClusterView extends LinearLayout implements NetworkController
     private class PhoneState {
         private final int mSubId;
         private boolean mMobileVisible = false;
+        private boolean mProvisioned = true;
         private int mMobileStrengthId = 0, mMobileTypeId = 0;
         private int mLastMobileStrengthId = -1;
         private int mLastMobileTypeId = -1;
@@ -660,6 +717,17 @@ public class SignalClusterView extends LinearLayout implements NetworkController
                     .inflate(R.layout.mobile_signal_group, null);
             setViews(root);
             mSubId = subId;
+            if (mExtTelephony != null) {
+                int slotId = SubscriptionManager.getSlotIndex(subId);
+                if (slotId != SubscriptionManager.INVALID_SIM_SLOT_INDEX) {
+                    try {
+                        mProvisioned = mExtTelephony.getCurrentUiccCardProvisioningStatus(
+                                slotId) == PROVISIONED;
+                    } catch (RemoteException ex) {
+                        // ignore, fall back to default.
+                    }
+                }
+            }
         }
 
         public void setViews(ViewGroup root) {
-- 
2.17.0

