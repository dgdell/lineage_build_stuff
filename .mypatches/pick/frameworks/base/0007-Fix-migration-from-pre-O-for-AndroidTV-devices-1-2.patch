From 97feaad4e18fe90a6e5862e0d8f22c14bbfb0826 Mon Sep 17 00:00:00 2001
From: Abhisek Devkota <ciwrl@lineageos.org>
Date: Tue, 17 Apr 2018 09:42:21 -0700
Subject: [PATCH 07/11] Fix migration from pre-O for AndroidTV devices (1/2)

Change-Id: I934331ae8c91a6a11e7a620e28ddb6db92a03040
---
 .../res/values/lineage_defaults.xml                 |  1 +
 .../providers/settings/SettingsProvider.java        | 13 +++++++++++++
 2 files changed, 14 insertions(+)

diff --git a/packages/SettingsProvider/res/values/lineage_defaults.xml b/packages/SettingsProvider/res/values/lineage_defaults.xml
index 62b8fe66e8c..53d0a5b6848 100644
--- a/packages/SettingsProvider/res/values/lineage_defaults.xml
+++ b/packages/SettingsProvider/res/values/lineage_defaults.xml
@@ -23,4 +23,5 @@
 <resources>
     <!-- Time format,default value is 24 : 24 format,other value is 12 format -->
     <string name="def_time_format" translatable="false"></string>
+    <string name="def_tv_user_setup_complete" translatable="false"></string>
 </resources>
diff --git a/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java b/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
index e471b144e1d..a9b957bf037 100644
--- a/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
+++ b/packages/SettingsProvider/src/com/android/providers/settings/SettingsProvider.java
@@ -213,6 +213,7 @@ public class SettingsProvider extends ContentProvider {
     private static final Set<String> CRITICAL_SECURE_SETTINGS = new ArraySet<>();
     static {
         CRITICAL_SECURE_SETTINGS.add(Settings.Secure.USER_SETUP_COMPLETE);
+        CRITICAL_SECURE_SETTINGS.add(Settings.Secure.TV_USER_SETUP_COMPLETE);
     }
 
     // Per user secure settings that moved to the for all users global settings.
@@ -3394,6 +3395,18 @@ public class SettingsProvider extends ContentProvider {
 
                 if (currentVersion == 144) {
                     // Version 145: Removed
+                    // Repurpose for AndroidTV devices coming from N
+                    final SettingsState secureSettings = getSecureSettingsLocked(userId);
+                    String defaultTvSetupSetting = (getContext().getResources().getString(
+                            R.string.def_tv_user_setup_complete));
+                    String currentUserSetupSetting = secureSettings.getSettingLocked(
+                            Settings.Secure.USER_SETUP_COMPLETE).getValue();
+                    if (defaultTvSetupSetting != null && !defaultTvSetupSetting.isEmpty() &&
+                        currentUserSetupSetting == "1") {
+                        secureSettings.insertSettingLocked(
+                                Settings.Secure.TV_USER_SETUP_COMPLETE, "1",
+                                null, true, SettingsState.SYSTEM_PACKAGE_NAME);
+                    }
                     currentVersion = 145;
                 }
 
-- 
2.17.0

