From 1d5e274beb67b39b110d9e1963fa6732a7c3e08a Mon Sep 17 00:00:00 2001
From: Sam Mortimer <sam@mortimer.me.uk>
Date: Wed, 22 Aug 2018 23:23:37 -0700
Subject: [PATCH 06/51] [TEMP]: Revert "OMS: harden permission checks"
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This reverts commit f28bec4150dc3c4e85c5991f2ea97cc3b2419032.

Author: MÃ¥rten Kongstad <marten.kongstad@sony.com>
Date:   Thu Nov 16 13:07:30 2017 +0100
    OMS: harden permission checks
    The IOverlayManager.aidl interface is protected by certain permissions.
    The overlay manager implements the permission checks by calling
    enforceCallingOrSelfPermission, but this method needlessly includes the
    permissions of system_server in the check.
    Harden the permission checks by switching from
    enforceCallingOrSelfPermission to enforceCallingPermission.
    Bug: 78809702
    Test: atest OverlayHostTests OverlayDeviceTests
    Change-Id: I5851dd1683adf644ea8e5a58dce4d7377664342e

Change-Id: I270aa3a035c8f1e5ac8725a47b174e3ff854f577
---
 .../java/com/android/server/om/OverlayManagerService.java    | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/services/core/java/com/android/server/om/OverlayManagerService.java b/services/core/java/com/android/server/om/OverlayManagerService.java
index f082271ab09..a0da1526ac0 100644
--- a/services/core/java/com/android/server/om/OverlayManagerService.java
+++ b/services/core/java/com/android/server/om/OverlayManagerService.java
@@ -675,7 +675,7 @@ public final class OverlayManagerService extends SystemService {
          * @throws SecurityException if the permission check fails
          */
         private void enforceChangeOverlayPackagesPermission(@NonNull final String message) {
-            getContext().enforceCallingPermission(
+            getContext().enforceCallingOrSelfPermission(
                     android.Manifest.permission.CHANGE_OVERLAY_PACKAGES, message);
         }
 
@@ -686,7 +686,8 @@ public final class OverlayManagerService extends SystemService {
          * @throws SecurityException if the permission check fails
          */
         private void enforceDumpPermission(@NonNull final String message) {
-            getContext().enforceCallingPermission(android.Manifest.permission.DUMP, message);
+            getContext().enforceCallingOrSelfPermission(android.Manifest.permission.DUMP,
+                    message);
         }
     };
 
-- 
2.17.1

