From f4a4ca0861d34f758183aaa8a3c59715022d5302 Mon Sep 17 00:00:00 2001
From: Bruno Martins <bgcngm@gmail.com>
Date: Sat, 18 Aug 2018 00:46:15 +0100
Subject: [PATCH 10/10] [DNM][TEMP] services: Avoid NPE if KeyguargManager is
 not yet available

Change-Id: I67d9cf78a9b01ae1b072de48b26051456424513e
---
 services/core/java/com/android/server/StorageManagerService.java | 1 +
 services/usb/java/com/android/server/usb/UsbDeviceManager.java   | 1 +
 2 files changed, 2 insertions(+)

diff --git a/services/core/java/com/android/server/StorageManagerService.java b/services/core/java/com/android/server/StorageManagerService.java
index 183be9b9875..faa78cb9267 100644
--- a/services/core/java/com/android/server/StorageManagerService.java
+++ b/services/core/java/com/android/server/StorageManagerService.java
@@ -933,6 +933,7 @@ class StorageManagerService extends IStorageManager.Stub
 
     @Override
     public void onKeyguardStateChanged(boolean isShowing) {
+        if (mContext.getSystemService(KeyguardManager.class) == null) return;
         // Push down current secure keyguard status so that we ignore malicious
         // USB devices while locked.
         mSecureKeyguardShowing = isShowing
diff --git a/services/usb/java/com/android/server/usb/UsbDeviceManager.java b/services/usb/java/com/android/server/usb/UsbDeviceManager.java
index 9f8042c844d..6fc44389ed2 100644
--- a/services/usb/java/com/android/server/usb/UsbDeviceManager.java
+++ b/services/usb/java/com/android/server/usb/UsbDeviceManager.java
@@ -233,6 +233,7 @@ public class UsbDeviceManager implements ActivityManagerInternal.ScreenObserver
 
     @Override
     public void onKeyguardStateChanged(boolean isShowing) {
+        if (mContext.getSystemService(KeyguardManager.class) == null) return;
         int userHandle = ActivityManager.getCurrentUser();
         boolean secure = mContext.getSystemService(KeyguardManager.class)
                 .isDeviceSecure(userHandle);
-- 
2.17.1

