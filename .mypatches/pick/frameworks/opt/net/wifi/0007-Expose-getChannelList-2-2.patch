From c165ea8a84b2147afe9f2d6b0e80e99a21661bda Mon Sep 17 00:00:00 2001
From: Aaron Kling <webgeek1234@gmail.com>
Date: Tue, 7 Nov 2017 13:58:14 -0600
Subject: [PATCH 07/11] Expose getChannelList [2/2]

Change-Id: I7d0608f2c5debc89168093355135e5ff909880ac
---
 .../android/server/wifi/WifiServiceImpl.java  | 14 ++++++++++
 .../android/server/wifi/WifiStateMachine.java | 28 +++++++++++++++++++
 2 files changed, 42 insertions(+)

diff --git a/service/java/com/android/server/wifi/WifiServiceImpl.java b/service/java/com/android/server/wifi/WifiServiceImpl.java
index 404a659c4..ea724510e 100644
--- a/service/java/com/android/server/wifi/WifiServiceImpl.java
+++ b/service/java/com/android/server/wifi/WifiServiceImpl.java
@@ -66,6 +66,7 @@ import android.net.wifi.IWifiManager;
 import android.net.wifi.ScanResult;
 import android.net.wifi.ScanSettings;
 import android.net.wifi.WifiActivityEnergyInfo;
+import android.net.wifi.WifiChannel;
 import android.net.wifi.WifiConfiguration;
 import android.net.wifi.WifiConnectionStatistics;
 import android.net.wifi.WifiInfo;
@@ -85,6 +86,7 @@ import android.os.IBinder;
 import android.os.Looper;
 import android.os.Message;
 import android.os.Messenger;
+import android.os.Parcel;
 import android.os.PowerManager;
 import android.os.Process;
 import android.os.RemoteException;
@@ -2767,4 +2769,16 @@ public class WifiServiceImpl extends IWifiManager.Stub {
     public int setAppProperty(String key, String value) {
         return mNvWifi.setAppProperty(key, value, mWifiStateMachineChannel);
     }
+
+    @Override
+    public List<WifiChannel> getChannelList() {
+        enforceAccessPermission();
+
+        if (mWifiStateMachineChannel == null) {
+            Slog.e(TAG, "mWifiStateMachineChannel is not initialized");
+            return null;
+        }
+
+        return mWifiStateMachine.syncGetChannelList(this.mWifiStateMachineChannel);
+    }
 }
diff --git a/service/java/com/android/server/wifi/WifiStateMachine.java b/service/java/com/android/server/wifi/WifiStateMachine.java
index 6dcfb5084..a931e5948 100644
--- a/service/java/com/android/server/wifi/WifiStateMachine.java
+++ b/service/java/com/android/server/wifi/WifiStateMachine.java
@@ -1373,6 +1373,34 @@ public class WifiStateMachine extends StateMachine implements WifiNative.WifiRss
         return new Messenger(getHandler());
     }
 
+    public List<WifiChannel> syncGetChannelList(AsyncChannel channel) {
+        String resultMsg = mNvWifi.getFreqCapability();
+        List<WifiChannel> list = null;
+        if (resultMsg != null) {
+            list = new ArrayList();
+            String freqs = resultMsg;
+            for (String line : resultMsg.split("\n")) {
+                if (line.contains("MHz")) {
+                    WifiChannel c = new WifiChannel();
+                    String[] prop = line.split(" ");
+                    if (prop.length >= 5) {
+                        try {
+                            c.channelNum = Integer.parseInt(prop[1]);
+                            c.freqMHz = Integer.parseInt(prop[3]);
+                        } catch (NumberFormatException e) {
+                        }
+                        c.isDFS = line.contains("(DFS)");
+                        c.isRestricted = line.contains("(NO_IBSS)");
+                        list.add(c);
+                    }
+                } else if (line.contains("Mode[B] Channels:")) {
+                    break;
+                }
+            }
+        }
+        return (list == null || list.size() <= 0) ? null : list;
+    }
+
     /**
      * Initiate a wifi scan. If workSource is not null, blame is given to it, otherwise blame is
      * given to callingUid.
-- 
2.17.1

