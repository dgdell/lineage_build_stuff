From f878882e35bfdc3bcc1d6e4d460301a4a7aacb79 Mon Sep 17 00:00:00 2001
From: Aaron Kling <webgeek1234@gmail.com>
Date: Fri, 7 Apr 2017 13:22:44 -0500
Subject: [PATCH 03/11] Better track autonomous group creation

Change-Id: I8d89a054a981973a70c5af244933b80e6def28e1
---
 .../android/server/wifi/p2p/WifiP2pServiceImpl.java   | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java b/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java
index 0e8f2d445..aa3360664 100644
--- a/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java
+++ b/service/java/com/android/server/wifi/p2p/WifiP2pServiceImpl.java
@@ -199,6 +199,10 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
     // is invoked
     private boolean mAutonomousGroup;
 
+    // Even if creation of the group fails, we need to know if the interface
+    // exists
+    private boolean mAutonomousGroupCreated = false;
+
     // Invitation to join an existing p2p group
     private boolean mJoinExistingGroup;
 
@@ -2165,6 +2169,7 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
                 // after a client joins. For autonomous, send now
                 if (mAutonomousGroup) {
                     sendP2pConnectionChangedBroadcast();
+                    mAutonomousGroupCreated = true;
                 }
             }
 
@@ -2262,6 +2267,8 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
                     case WifiP2pManager.REMOVE_GROUP:
                         if (DBG) logd(getName() + " remove group");
                         if (mWifiNative.p2pGroupRemove(mGroup.getInterface())) {
+                            mAutonomousGroup = false;
+                            mAutonomousGroupCreated = false;
                             transitionTo(mOngoingGroupRemovalState);
                             replyToMessage(message, WifiP2pManager.REMOVE_GROUP_SUCCEEDED);
                         } else {
@@ -3055,6 +3062,8 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
         }
 
         private void handleGroupCreationFailure() {
+            mAutonomousGroup = false;
+            mAutonomousGroupCreated = false;
             resetWifiP2pInfo();
             mNetworkInfo.setDetailedState(NetworkInfo.DetailedState.FAILED, null, null);
             sendP2pConnectionChangedBroadcast();
@@ -3076,6 +3085,8 @@ public class WifiP2pServiceImpl extends IWifiP2pManager.Stub {
         }
 
         private void handleGroupRemoved() {
+            mAutonomousGroup = false;
+            mAutonomousGroupCreated = false;
             if (mGroup.isGroupOwner()) {
                 stopDhcpServer(mGroup.getInterface());
             } else {
-- 
2.17.1

