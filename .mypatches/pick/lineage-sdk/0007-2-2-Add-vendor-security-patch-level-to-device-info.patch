From 84f52e4fade67824b57c89d01606a44ed22959fe Mon Sep 17 00:00:00 2001
From: Tobias Tefke <tobias.tefke@tutanota.com>
Date: Wed, 13 Jun 2018 11:29:33 +0200
Subject: [PATCH 07/10] [2/2] Add vendor security patch level to device info

Change-Id: Ic65290aa2c5fa159512e16a3781bc407876b9e5a
---
 lineage/res/res/values/strings.xml            |  5 ++
 lineage/res/res/values/symbols.xml            |  4 +
 .../LineageVendorSecurityPatchPreference.java | 83 +++++++++++++++++++
 3 files changed, 92 insertions(+)
 create mode 100644 sdk/src/java/org/lineageos/internal/preference/deviceinfo/LineageVendorSecurityPatchPreference.java

diff --git a/lineage/res/res/values/strings.xml b/lineage/res/res/values/strings.xml
index fdd759e..284577b 100644
--- a/lineage/res/res/values/strings.xml
+++ b/lineage/res/res/values/strings.xml
@@ -152,10 +152,15 @@
     <string name="lineage_updates">LineageOS updates</string>
     <!-- About device screen, LineageOS version -->
     <string name="lineage_version">LineageOS version</string>
+    <!-- About device screen, vendor security patch -->
+    <string name="lineage_vendor_security_patch">Vendor security patch level</string>
 
     <!-- General purpose use "unknown" string -->
     <string name="unknown">Unknown</string>
 
+    <!-- General purpose use "not available" string -->
+    <string name="not_available">Not available</string>
+
     <!-- Long-press back kill application -->
     <string name="app_killed_message">Application killed</string>
 
diff --git a/lineage/res/res/values/symbols.xml b/lineage/res/res/values/symbols.xml
index fec21ea..f6a6d22 100644
--- a/lineage/res/res/values/symbols.xml
+++ b/lineage/res/res/values/symbols.xml
@@ -122,10 +122,14 @@
     <java-symbol type="string" name="lineage_api_level" />
     <java-symbol type="string" name="lineage_updates" />
     <java-symbol type="string" name="lineage_version" />
+    <java-symbol type="string" name="lineage_vendor_security_patch" />
 
     <!-- General purpose use "unknown" string -->
     <java-symbol type="string" name="unknown" />
 
+    <!-- General purpose use "not available" string -->
+    <java-symbol type="string" name="not_available" />
+
     <!-- Last app switch animations -->
     <java-symbol type="anim" name="last_app_in" />
     <java-symbol type="anim" name="last_app_out" />
diff --git a/sdk/src/java/org/lineageos/internal/preference/deviceinfo/LineageVendorSecurityPatchPreference.java b/sdk/src/java/org/lineageos/internal/preference/deviceinfo/LineageVendorSecurityPatchPreference.java
new file mode 100644
index 0000000..a1b1b7f
--- /dev/null
+++ b/sdk/src/java/org/lineageos/internal/preference/deviceinfo/LineageVendorSecurityPatchPreference.java
@@ -0,0 +1,83 @@
+/*
+ * Copyright (C) 2015 The Android Open Source Project
+ * Copyright (C) 2017-2018 The LineageOS Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.lineageos.internal.preference.deviceinfo;
+
+import android.content.Context;
+import android.os.SystemProperties;
+import android.text.format.DateFormat;
+import android.util.AttributeSet;
+
+import lineageos.preference.SelfRemovingPreference;
+
+import org.lineageos.platform.internal.R;
+
+import java.text.ParseException;
+import java.text.SimpleDateFormat;
+import java.util.Date;
+import java.util.Locale;
+
+public class LineageVendorSecurityPatchPreference extends SelfRemovingPreference {
+    private static final String KEY_AOSP_VENDOR_SECURITY_PATCH =
+            "ro.vendor.build.security_patch";
+
+    private static final String KEY_LINEAGE_VENDOR_SECURITY_PATCH =
+            "ro.lineage.build.vendor_security_patch";
+
+    public LineageVendorSecurityPatchPreference(Context context, AttributeSet attrs,
+            int defStyle) {
+        super(context, attrs, defStyle);
+    }
+
+    public LineageVendorSecurityPatchPreference(Context context, AttributeSet attrs) {
+        super(context, attrs);
+    }
+
+    public LineageVendorSecurityPatchPreference(Context context) {
+        super(context);
+    }
+
+    @Override
+    public void onAttached() {
+        super.onAttached();
+
+        setTitle(R.string.lineage_vendor_security_patch);
+        setSummary(getVendorSecurityPatchLevel());
+    }
+
+    private String getVendorSecurityPatchLevel() {
+        String na = getContext().getResources().getString(R.string.not_available);
+        String patch = SystemProperties.get(KEY_AOSP_VENDOR_SECURITY_PATCH, na);
+
+        if (na.equals(patch)) {
+            patch = SystemProperties.get(KEY_LINEAGE_VENDOR_SECURITY_PATCH, na);
+        }
+
+        if (!na.equals(patch)) {
+            try {
+                SimpleDateFormat template = new SimpleDateFormat("yyyy-MM-dd");
+                Date patchDate = template.parse(patch);
+                String format = DateFormat.getBestDateTimePattern(Locale.getDefault(),
+                        "dMMMMyyyy");
+                patch = DateFormat.format(format, patchDate).toString();
+            } catch (ParseException e) {
+                // parsing failed, use raw string
+            }
+        }
+        return patch;
+    }
+}
-- 
2.17.1

