From c39a363ffdc1ec5ff87281b09c0a6f5e51db7d5b Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Thu, 27 Sep 2018 12:15:06 +0200
Subject: [PATCH 4/5] sdk: Update default clock position

* Also migrate users using right clock so
  that they get the new default setting.

Change-Id: I2e38a16af46d77ff92ada268b8fc0927b0c4806c
---
 .../res/values/defaults.xml                   |  2 +-
 .../LineageDatabaseHelper.java                | 38 ++++++++++++++++++-
 2 files changed, 38 insertions(+), 2 deletions(-)

diff --git a/packages/LineageSettingsProvider/res/values/defaults.xml b/packages/LineageSettingsProvider/res/values/defaults.xml
index 46be97e..caeff09 100644
--- a/packages/LineageSettingsProvider/res/values/defaults.xml
+++ b/packages/LineageSettingsProvider/res/values/defaults.xml
@@ -118,6 +118,6 @@
          * 1: show the clock in the center
          * 2: show the clock in the left position (LTR)
     -->
-    <integer name="def_clock_position">0</integer>
+    <integer name="def_clock_position">2</integer>
 
 </resources>
diff --git a/packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java b/packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java
index 22af6aa..fab0984 100644
--- a/packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java
+++ b/packages/LineageSettingsProvider/src/org/lineageos/lineagesettings/LineageDatabaseHelper.java
@@ -51,7 +51,11 @@ public class LineageDatabaseHelper extends SQLiteOpenHelper{
     private static final boolean LOCAL_LOGV = false;
 
     private static final String DATABASE_NAME = "lineagesettings.db";
+<<<<<<< HEAD
     private static final int DATABASE_VERSION = 11;
+=======
+    private static final int DATABASE_VERSION = 10;
+>>>>>>> c6580dc... sdk: Update default clock position
 
     private static final String DATABASE_NAME_OLD = "cmsettings.db";
 
@@ -336,8 +340,27 @@ public class LineageDatabaseHelper extends SQLiteOpenHelper{
                     db.setTransactionSuccessful();
                 } finally {
                     if (stmt != null) stmt.close();
-                    db.endTransaction();
                 }
+
+                stmt = null;
+                try {
+                    stmt = db.compileStatement("SELECT value FROM system WHERE name=?");
+                    stmt.bindString(1, LineageSettings.System.STATUS_BAR_CLOCK);
+                    long value = stmt.simpleQueryForLong();
+
+                    if (value == 0) {
+                        stmt = db.compileStatement("UPDATE system SET value=? WHERE name=?");
+                        stmt.bindLong(1, 2);
+                        stmt.bindString(2, LineageSettings.System.STATUS_BAR_CLOCK);
+                        stmt.execute();
+                    }
+                    db.setTransactionSuccessful();
+                } catch (SQLiteDoneException ex) {
+                    // LineageSettings.System.STATUS_BAR_CLOCK is not set
+                    if (stmt != null) stmt.close();
+                }
+
+                db.endTransaction();
             }
             upgradeVersion = 10;
         }
@@ -368,6 +391,19 @@ public class LineageDatabaseHelper extends SQLiteOpenHelper{
                     db.setTransactionSuccessful();
                 } catch (SQLiteDoneException ex) {
                     // LineageSettings.System.STATUS_BAR_BATTERY_STYLE is not set
+                    stmt = db.compileStatement("SELECT value FROM system WHERE name=?");
+                    stmt.bindString(1, LineageSettings.System.STATUS_BAR_CLOCK);
+                    long value = stmt.simpleQueryForLong();
+
+                    if (value == 0) {
+                        stmt = db.compileStatement("UPDATE system SET value=? WHERE name=?");
+                        stmt.bindLong(1, 2);
+                        stmt.bindString(2, LineageSettings.System.STATUS_BAR_CLOCK);
+                        stmt.execute();
+                    }
+                    db.setTransactionSuccessful();
+                } catch (SQLiteDoneException ex) {
+                    // LineageSettings.System.STATUS_BAR_CLOCK is not set
                 } finally {
                     if (stmt != null) stmt.close();
                     db.endTransaction();
-- 
2.17.1

