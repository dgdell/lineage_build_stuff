From 9553f907161aa3b06ce7fa6d878b66de6d0ef926 Mon Sep 17 00:00:00 2001
From: Bruno Martins <bgcngm@gmail.com>
Date: Mon, 19 Mar 2018 10:32:41 +0000
Subject: [PATCH 1/2] vibrator: Implement new 1.1 HAL function

 * This adds new perform_1_1 function for supporting tick effect.

Change-Id: I5c8094e39aeef0b533fb8ae7412dfdf02ba83984
---
 vibrator/{1.0-lineage => 1.1-lineage}/Android.bp   |  7 +-
 vibrator/{1.0-lineage => 1.1-lineage}/Vibrator.cpp | 76 ++++++++++++++--------
 vibrator/{1.0-lineage => 1.1-lineage}/Vibrator.h   | 22 +++++--
 ...droid.hardware.vibrator@1.1-service.lineage.rc} |  2 +-
 vibrator/{1.0-lineage => 1.1-lineage}/service.cpp  |  8 +--
 vibrator/Android.bp                                |  2 +-
 6 files changed, 73 insertions(+), 44 deletions(-)
 rename vibrator/{1.0-lineage => 1.1-lineage}/Android.bp (80%)
 rename vibrator/{1.0-lineage => 1.1-lineage}/Vibrator.cpp (68%)
 rename vibrator/{1.0-lineage => 1.1-lineage}/Vibrator.h (61%)
 rename vibrator/{1.0-lineage/android.hardware.vibrator@1.0-service.lineage.rc => 1.1-lineage/android.hardware.vibrator@1.1-service.lineage.rc} (85%)
 rename vibrator/{1.0-lineage => 1.1-lineage}/service.cpp (84%)

diff --git a/vibrator/1.0-lineage/Android.bp b/vibrator/1.1-lineage/Android.bp
similarity index 80%
rename from vibrator/1.0-lineage/Android.bp
rename to vibrator/1.1-lineage/Android.bp
index 2151e68..25d1db2 100644
--- a/vibrator/1.0-lineage/Android.bp
+++ b/vibrator/1.1-lineage/Android.bp
@@ -1,5 +1,5 @@
 //
-// Copyright (C) 2017 The LineageOS Project
+// Copyright (C) 2017-2018 The LineageOS Project
 //
 // Licensed under the Apache License, Version 2.0 (the "License");
 // you may not use this file except in compliance with the License.
@@ -14,9 +14,9 @@
 // limitations under the License.
 
 cc_binary {
-    name: "android.hardware.vibrator@1.0-service.lineage",
+    name: "android.hardware.vibrator@1.1-service.lineage",
     relative_install_path: "hw",
-    init_rc: ["android.hardware.vibrator@1.0-service.lineage.rc"],
+    init_rc: ["android.hardware.vibrator@1.1-service.lineage.rc"],
     srcs: ["service.cpp", "Vibrator.cpp"],
     shared_libs: [
         "libhidlbase",
@@ -26,6 +26,7 @@ cc_binary {
         "libutils",
         "libhardware",
         "android.hardware.vibrator@1.0",
+        "android.hardware.vibrator@1.1",
     ],
     proprietary: true,
 }
diff --git a/vibrator/1.0-lineage/Vibrator.cpp b/vibrator/1.1-lineage/Vibrator.cpp
similarity index 68%
rename from vibrator/1.0-lineage/Vibrator.cpp
rename to vibrator/1.1-lineage/Vibrator.cpp
index 50ca82e..44a030e 100644
--- a/vibrator/1.0-lineage/Vibrator.cpp
+++ b/vibrator/1.1-lineage/Vibrator.cpp
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2017 The LineageOS Project
+ * Copyright (C) 2017-2018 The LineageOS Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -26,7 +26,7 @@
 namespace android {
 namespace hardware {
 namespace vibrator {
-namespace V1_0 {
+namespace V1_1 {
 namespace implementation {
 
 #define VIBRATOR "/sys/devices/virtual/timed_output/vibrator/"
@@ -36,11 +36,15 @@ namespace implementation {
 #define VTG_MIN     "vtg_min"
 #define VTG_MAX     "vtg_max"
 
-#define CLICK_TIMING_MS 20
+#define CLICK_TIMING_MS 40
+#define TICK_TIMING_MS 20
 
 #define DEFAULT_MIN_VTG 0
 #define DEFAULT_MAX_VTG 255
 
+using Status = ::android::hardware::vibrator::V1_0::Status;
+using EffectStrength = ::android::hardware::vibrator::V1_0::EffectStrength;
+
 static int get(std::string path, int defaultValue) {
     int value = defaultValue;
     std::ifstream file(path);
@@ -82,6 +86,7 @@ Vibrator::Vibrator() {
     maxVoltage = get(VIBRATOR VTG_MAX, DEFAULT_MAX_VTG);
 }
 
+// Methods from ::android::hardware::vibrator::V1_0::IVibrator follow.
 Return<Status> Vibrator::on(uint32_t timeout_ms) {
     if (set(VIBRATOR ENABLE, timeout_ms)) {
         return Status::UNKNOWN_ERROR;
@@ -123,40 +128,55 @@ Return<Status> Vibrator::setAmplitude(uint8_t amplitude) {
     return Status::OK;
 }
 
-Return<void> Vibrator::perform(Effect effect, EffectStrength strength, perform_cb _hidl_cb) {
-    switch (effect) {
-    case Effect::CLICK:
-        uint8_t amplitude;
-
-        switch (strength) {
-        case EffectStrength::LIGHT:
-            amplitude = 36;
-            break;
-        case EffectStrength::MEDIUM:
-            amplitude = 128;
-            break;
-        case EffectStrength::STRONG:
-            amplitude = 255;
-            break;
-        default:
-            _hidl_cb(Status::UNSUPPORTED_OPERATION, 0);
-            return Void();
-        }
+static uint8_t convertEffectStrength(EffectStrength strength) {
+    uint8_t amplitude;
 
-        on(CLICK_TIMING_MS);
-        setAmplitude(amplitude);
-        _hidl_cb(Status::OK, CLICK_TIMING_MS);
+    switch (strength) {
+    case EffectStrength::LIGHT:
+        amplitude = 36;
+        break;
+    case EffectStrength::MEDIUM:
+        amplitude = 128;
         break;
     default:
-        _hidl_cb(Status::UNSUPPORTED_OPERATION, 0);
+    case EffectStrength::STRONG:
+        amplitude = 255;
         break;
     }
 
+    return amplitude;
+}
+
+Return<void> Vibrator::perform(Effect effect, EffectStrength strength,
+        perform_cb _hidl_cb) {
+    if (effect == Effect::CLICK) {
+        on(CLICK_TIMING_MS);
+        setAmplitude(convertEffectStrength(strength));
+        _hidl_cb(Status::OK, CLICK_TIMING_MS);
+    } else {
+        _hidl_cb(Status::UNSUPPORTED_OPERATION, 0);
+    }
     return Void();
 }
 
-} // namespace implementation
-}  // namespace V1_0
+// Methods from ::android::hardware::vibrator::V1_1::IVibrator follow.
+Return<void> Vibrator::perform_1_1(Effect_1_1 effect, EffectStrength strength,
+        perform_cb _hidl_cb) {
+    if (effect == Effect_1_1::TICK) {
+        on(TICK_TIMING_MS);
+        setAmplitude(convertEffectStrength(strength));
+        _hidl_cb(Status::OK, TICK_TIMING_MS);
+        return Void();
+    } else if (effect < Effect_1_1::TICK) {
+        return perform(static_cast<Effect>(effect), strength, _hidl_cb);
+    } else {
+        _hidl_cb(Status::UNSUPPORTED_OPERATION, 0);
+        return Void();
+    }
+}
+
+}  // namespace implementation
+}  // namespace V1_1
 }  // namespace vibrator
 }  // namespace hardware
 }  // namespace android
diff --git a/vibrator/1.0-lineage/Vibrator.h b/vibrator/1.1-lineage/Vibrator.h
similarity index 61%
rename from vibrator/1.0-lineage/Vibrator.h
rename to vibrator/1.1-lineage/Vibrator.h
index 7624917..bb1f2ad 100644
--- a/vibrator/1.0-lineage/Vibrator.h
+++ b/vibrator/1.1-lineage/Vibrator.h
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2017 The LineageOS Project
+ * Copyright (C) 2017-2018 The LineageOS Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -13,37 +13,45 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-#ifndef ANDROID_HARDWARE_VIBRATOR_V1_0_VIBRATOR_H
-#define ANDROID_HARDWARE_VIBRATOR_V1_0_VIBRATOR_H
+#ifndef ANDROID_HARDWARE_VIBRATOR_V1_1_VIBRATOR_H
+#define ANDROID_HARDWARE_VIBRATOR_V1_1_VIBRATOR_H
 
-#include <android/hardware/vibrator/1.0/IVibrator.h>
+#include <android/hardware/vibrator/1.1/IVibrator.h>
 #include <hidl/Status.h>
 
 namespace android {
 namespace hardware {
 namespace vibrator {
-namespace V1_0 {
+namespace V1_1 {
 namespace implementation {
 
 class Vibrator : public IVibrator {
 public:
   Vibrator();
 
+  // Methods from ::android::hardware::vibrator::V1_0::IVibrator follow.
+  using Status = ::android::hardware::vibrator::V1_0::Status;
   Return<Status> on(uint32_t timeoutMs) override;
   Return<Status> off() override;
   Return<bool> supportsAmplitudeControl() override;
   Return<Status> setAmplitude(uint8_t amplitude) override;
+
+  using EffectStrength = ::android::hardware::vibrator::V1_0::EffectStrength;
+  using Effect = ::android::hardware::vibrator::V1_0::Effect;
   Return<void> perform(Effect effect, EffectStrength strength, perform_cb _hidl_cb) override;
 
+  // Methods from ::android::hardware::vibrator::V1_0::IVibrator follow.
+  Return<void> perform_1_1(Effect_1_1 effect, EffectStrength strength, perform_cb _hidl_cb) override;
+
 private:
   uint32_t minVoltage;
   uint32_t maxVoltage;
 };
 
 }  // namespace implementation
-}  // namespace V1_0
+}  // namespace V1_1
 }  // namespace vibrator
 }  // namespace hardware
 }  // namespace android
 
-#endif  // ANDROID_HARDWARE_VIBRATOR_V1_0_VIBRATOR_H
+#endif  // ANDROID_HARDWARE_VIBRATOR_V1_1_VIBRATOR_H
diff --git a/vibrator/1.0-lineage/android.hardware.vibrator@1.0-service.lineage.rc b/vibrator/1.1-lineage/android.hardware.vibrator@1.1-service.lineage.rc
similarity index 85%
rename from vibrator/1.0-lineage/android.hardware.vibrator@1.0-service.lineage.rc
rename to vibrator/1.1-lineage/android.hardware.vibrator@1.1-service.lineage.rc
index 5cbf4b4..5fd3c64 100644
--- a/vibrator/1.0-lineage/android.hardware.vibrator@1.0-service.lineage.rc
+++ b/vibrator/1.1-lineage/android.hardware.vibrator@1.1-service.lineage.rc
@@ -6,7 +6,7 @@ on early-boot
     chmod 0444 /sys/devices/virtual/timed_output/vibrator/vtg_max
     chmod 0444 /sys/devices/virtual/timed_output/vibrator/vtg_min
 
-service vibrator-1-0 /vendor/bin/hw/android.hardware.vibrator@1.0-service.lineage
+service vibrator-1-1 /vendor/bin/hw/android.hardware.vibrator@1.1-service.lineage
     class hal
     user system
     group system
diff --git a/vibrator/1.0-lineage/service.cpp b/vibrator/1.1-lineage/service.cpp
similarity index 84%
rename from vibrator/1.0-lineage/service.cpp
rename to vibrator/1.1-lineage/service.cpp
index 9772726..3901785 100644
--- a/vibrator/1.0-lineage/service.cpp
+++ b/vibrator/1.1-lineage/service.cpp
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2017 The LineageOS Project
+ * Copyright (C) 2017-2018 The LineageOS Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -13,7 +13,7 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-#define LOG_TAG "android.hardware.vibrator@1.0-service.lineage"
+#define LOG_TAG "android.hardware.vibrator@1.1-service.lineage"
 
 #include <hidl/HidlTransportSupport.h>
 
@@ -22,8 +22,8 @@
 using android::hardware::configureRpcThreadpool;
 using android::hardware::joinRpcThreadpool;
 
-using android::hardware::vibrator::V1_0::IVibrator;
-using android::hardware::vibrator::V1_0::implementation::Vibrator;
+using android::hardware::vibrator::V1_1::IVibrator;
+using android::hardware::vibrator::V1_1::implementation::Vibrator;
 
 using android::OK;
 using android::sp;
diff --git a/vibrator/Android.bp b/vibrator/Android.bp
index 8dbb698..3a5762e 100644
--- a/vibrator/Android.bp
+++ b/vibrator/Android.bp
@@ -1,4 +1,4 @@
 // This is an autogenerated file, do not edit.
 subdirs = [
-    "1.0-lineage",
+    "1.1-lineage",
 ]
-- 
2.15.1

