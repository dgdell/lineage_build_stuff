From b512a5e9b59c9fade4b68018d45f676a332d1915 Mon Sep 17 00:00:00 2001
From: dianlujitao <dianlujitao@lineageos.org>
Date: Wed, 24 Jan 2018 10:23:19 +0800
Subject: [PATCH 2/2] lineage/interfaces: power: Add default passthrough
 implementation

Change-Id: I85f33b53b06681eda8f3e384c594871ae946f88f
---
 power/1.0/default/Android.bp                       | 61 ++++++++++++++++++
 power/1.0/default/LineagePower.cpp                 | 75 ++++++++++++++++++++++
 power/1.0/default/LineagePower.h                   | 49 ++++++++++++++
 power/1.0/default/service.cpp                      | 27 ++++++++
 .../default/vendor.lineage.power@1.0-service.rc    |  4 ++
 power/Android.bp                                   |  1 +
 6 files changed, 217 insertions(+)
 create mode 100644 power/1.0/default/Android.bp
 create mode 100644 power/1.0/default/LineagePower.cpp
 create mode 100644 power/1.0/default/LineagePower.h
 create mode 100644 power/1.0/default/service.cpp
 create mode 100644 power/1.0/default/vendor.lineage.power@1.0-service.rc

diff --git a/power/1.0/default/Android.bp b/power/1.0/default/Android.bp
new file mode 100644
index 0000000..ed7d757
--- /dev/null
+++ b/power/1.0/default/Android.bp
@@ -0,0 +1,61 @@
+// Copyright (C) 2018 The LineageOS Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+cc_library_shared {
+    name: "vendor.lineage.power@1.0-impl",
+    defaults: ["hidl_defaults"],
+    proprietary: true,
+    relative_install_path: "hw",
+    srcs: ["LineagePower.cpp"],
+
+    cflags: [
+        "-Wall",
+        "-Werror",
+    ],
+
+    shared_libs: [
+        "liblog",
+        "libhardware",
+        "libhidlbase",
+        "libhidltransport",
+        "libutils",
+        "vendor.lineage.power@1.0",
+    ],
+
+}
+
+cc_binary {
+    proprietary: true,
+    defaults: ["hidl_defaults"],
+    relative_install_path: "hw",
+    name: "vendor.lineage.power@1.0-service",
+    init_rc: ["vendor.lineage.power@1.0-service.rc"],
+    srcs: ["service.cpp"],
+
+    cflags: [
+        "-Wall",
+        "-Werror",
+    ],
+
+    shared_libs: [
+        "liblog",
+        "libdl",
+        "libutils",
+        "libhardware",
+        "libhidlbase",
+        "libhidltransport",
+        "vendor.lineage.power@1.0",
+    ],
+
+}
diff --git a/power/1.0/default/LineagePower.cpp b/power/1.0/default/LineagePower.cpp
new file mode 100644
index 0000000..ce4dd07
--- /dev/null
+++ b/power/1.0/default/LineagePower.cpp
@@ -0,0 +1,75 @@
+/*
+ * Copyright (C) 2018 The LineageOS Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#define LOG_TAG "vendor.lineage.power@1.0-impl"
+
+#include <log/log.h>
+
+#include <hardware/hardware.h>
+#include <hardware/power.h>
+
+#include "LineagePower.h"
+
+namespace vendor {
+namespace lineage {
+namespace power {
+namespace V1_0 {
+namespace implementation {
+
+LineagePower::LineagePower(power_module_t *module) : mModule(module) {
+    if (mModule)
+        mModule->init(mModule);
+}
+
+LineagePower::~LineagePower() {
+    delete(mModule);
+}
+
+Return<int32_t> LineagePower::getFeature(LineageFeature feature)  {
+    if (mModule->getFeature)
+        return mModule->getFeature(mModule, static_cast<feature_t>(feature));
+    return -1;
+}
+
+ILineagePower* HIDL_FETCH_ILineagePower(const char* /* name */) {
+    const hw_module_t* hw_module = nullptr;
+    power_module_t* power_module = nullptr;
+    int err = hw_get_module(POWER_HARDWARE_MODULE_ID, &hw_module);
+    if (err) {
+        ALOGE("hw_get_module %s failed: %d", POWER_HARDWARE_MODULE_ID, err);
+        return nullptr;
+    }
+
+    if (!hw_module->methods || !hw_module->methods->open) {
+        power_module = reinterpret_cast<power_module_t*>(
+            const_cast<hw_module_t*>(hw_module));
+    } else {
+        err = hw_module->methods->open(
+            hw_module, POWER_HARDWARE_MODULE_ID,
+            reinterpret_cast<hw_device_t**>(&power_module));
+        if (err) {
+            ALOGE("Passthrough failed to load legacy HAL.");
+            return nullptr;
+        }
+    }
+    return new LineagePower(power_module);
+}
+
+} // namespace implementation
+}  // namespace V1_0
+}  // namespace power
+}  // namespace lineage
+}  // namespace vendor
diff --git a/power/1.0/default/LineagePower.h b/power/1.0/default/LineagePower.h
new file mode 100644
index 0000000..1404710
--- /dev/null
+++ b/power/1.0/default/LineagePower.h
@@ -0,0 +1,49 @@
+/*
+ * Copyright (C) 2018 The LineageOS Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#ifndef VENDOR_LINEAGE_POWER_V1_0_POWER_H
+#define VENDOR_LINEAGE_POWER_V1_0_POWER_H
+
+#include <vendor/lineage/power/1.0/ILineagePower.h>
+
+namespace vendor {
+namespace lineage {
+namespace power {
+namespace V1_0 {
+namespace implementation {
+
+using ::vendor::lineage::power::V1_0::ILineagePower;
+using ::vendor::lineage::power::V1_0::LineageFeature;
+using ::android::hardware::Return;
+
+struct LineagePower : public ILineagePower {
+    LineagePower(power_module_t* module);
+    ~LineagePower();
+    Return<int32_t> getFeature(LineageFeature feature)  override;
+
+  private:
+    power_module_t* mModule;
+};
+
+extern "C" ILineagePower* HIDL_FETCH_ILineagePower(const char* name);
+
+}  // namespace implementation
+}  // namespace V1_0
+}  // namespace power
+}  // namespace lineage
+}  // namespace vendor
+
+#endif  // VENDOR_LINEAGE_POWER_V1_0_POWER_H
diff --git a/power/1.0/default/service.cpp b/power/1.0/default/service.cpp
new file mode 100644
index 0000000..6f90353
--- /dev/null
+++ b/power/1.0/default/service.cpp
@@ -0,0 +1,27 @@
+/*
+ * Copyright (C) 2018 The LineageOS Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#define LOG_TAG "vendor.lineage.power@1.0-service"
+
+#include <vendor/lineage/power/1.0/ILineagePower.h>
+#include <hidl/LegacySupport.h>
+
+using vendor::lineage::power::V1_0::ILineagePower;
+using android::hardware::defaultPassthroughServiceImplementation;
+
+int main() {
+    return defaultPassthroughServiceImplementation<ILineagePower>();
+}
diff --git a/power/1.0/default/vendor.lineage.power@1.0-service.rc b/power/1.0/default/vendor.lineage.power@1.0-service.rc
new file mode 100644
index 0000000..bb38bfc
--- /dev/null
+++ b/power/1.0/default/vendor.lineage.power@1.0-service.rc
@@ -0,0 +1,4 @@
+service lineage-power-hal-1-0 /vendor/bin/hw/vendor.lineage.power@1.0-service
+    class hal
+    user system
+    group system
diff --git a/power/Android.bp b/power/Android.bp
index bbb3e4b..ba90f2c 100644
--- a/power/Android.bp
+++ b/power/Android.bp
@@ -1,4 +1,5 @@
 // This is an autogenerated file, do not edit.
 subdirs = [
     "1.0",
+    "1.0/default",
 ]
-- 
2.7.4

