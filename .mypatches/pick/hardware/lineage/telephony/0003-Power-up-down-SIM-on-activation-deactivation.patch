From 07a3078632897e41a1227ad59d8c38d03d738f6c Mon Sep 17 00:00:00 2001
From: Paul Keith <javelinanddart@gmail.com>
Date: Fri, 13 Jul 2018 04:37:12 +0200
Subject: [PATCH 3/3] Power up/down SIM on activation/deactivation

Change-Id: I411dafc97deca43ff949cf6f0f9eac75b90179f7
---
 .../qti/internal/telephony/LineageExtTelephony.java    | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/com/qualcomm/qti/internal/telephony/LineageExtTelephony.java b/src/com/qualcomm/qti/internal/telephony/LineageExtTelephony.java
index f3956d2..046c6b2 100644
--- a/src/com/qualcomm/qti/internal/telephony/LineageExtTelephony.java
+++ b/src/com/qualcomm/qti/internal/telephony/LineageExtTelephony.java
@@ -45,6 +45,9 @@ import java.util.Iterator;
 
 import static android.telephony.SubscriptionManager.INVALID_SUBSCRIPTION_ID;
 
+import static android.telephony.TelephonyManager.CARD_POWER_DOWN;
+import static android.telephony.TelephonyManager.CARD_POWER_UP;
+
 import static android.telephony.TelephonyManager.SIM_ACTIVATION_STATE_ACTIVATED;
 import static android.telephony.TelephonyManager.SIM_ACTIVATION_STATE_DEACTIVATED;
 
@@ -188,6 +191,11 @@ public class LineageExtTelephony extends IExtTelephony.Stub {
         broadcastUiccActivation(slotId);
     }
 
+    private void setPowerState(int slotId, boolean activate) {
+        sCommandsInterfaces[slotId].setSimCardPower(
+                activate ? CARD_POWER_UP : CARD_POWER_DOWN, null);
+    }
+
     private void setUiccActivation(int slotId, boolean activate) {
         UiccCard card = sPhones[slotId].getUiccCard();
 
@@ -266,6 +274,7 @@ public class LineageExtTelephony extends IExtTelephony.Stub {
 
         sUiccStatus[slotId].mStatus = PROVISIONED;
 
+        setPowerState(slotId, true);
         setUiccActivation(slotId, true);
         sPhones[slotId].setVoiceActivationState(SIM_ACTIVATION_STATE_ACTIVATED);
         sPhones[slotId].setDataActivationState(SIM_ACTIVATION_STATE_ACTIVATED);
@@ -331,6 +340,7 @@ public class LineageExtTelephony extends IExtTelephony.Stub {
         sPhones[slotId].setVoiceActivationState(SIM_ACTIVATION_STATE_DEACTIVATED);
         sPhones[slotId].setDataActivationState(SIM_ACTIVATION_STATE_DEACTIVATED);
         setUiccActivation(slotId, false);
+        setPowerState(slotId, false);
 
         sBusy = false;
 
-- 
2.17.1

