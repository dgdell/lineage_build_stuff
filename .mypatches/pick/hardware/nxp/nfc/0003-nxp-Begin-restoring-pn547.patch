From 6043bac77e332981f9cd0169c60e7fc7eaab7665 Mon Sep 17 00:00:00 2001
From: Rashed Abdel-Tawab <rashed@linux.com>
Date: Thu, 22 Mar 2018 11:41:41 -0400
Subject: [PATCH 3/3] nxp: Begin restoring pn547

Change-Id: If8acdeb0c0a945a89a4d6b47b644ed32b01b5bd6
---
 extns/impl/Nxp_Features.h  | 12 ++++++++++++
 halimpl/hal/phNxpNciHal.cc |  4 ++++
 halimpl/hal/phNxpNciHal.h  |  1 +
 3 files changed, 17 insertions(+)

diff --git a/extns/impl/Nxp_Features.h b/extns/impl/Nxp_Features.h
index 1a2bf41..55787e1 100755
--- a/extns/impl/Nxp_Features.h
+++ b/extns/impl/Nxp_Features.h
@@ -26,6 +26,7 @@
 #define FW_MOBILE_MAJOR_NUMBER_PN551 0x05
 #define FW_MOBILE_MAJOR_NUMBER_PN557 0x01
 #define FW_MOBILE_MAJOR_NUMBER_PN548AD 0x01
+#define FW_MOBILE_MAJOR_NUMBER_PN547 0x01
  using namespace std;
 typedef enum {
   unknown,
@@ -63,6 +64,8 @@ extern tNfc_featureList nfcFL;
       nfcFL.chipType = pn551;                                                \
     } else if (chipType == pn66T) {                                          \
       nfcFL.chipType = pn548C2;                                              \
+    } else if (chipType == pn65T) {                                          \
+      nfcFL.chipType = pn547C2;                                              \
     }                                                                        \
       CONFIGURE_FEATURELIST_NFCC(chipType)                                   \
   }
@@ -103,6 +106,15 @@ extern tNfc_featureList nfcFL;
       nfcFL._PHDNLDNFC_USERDATA_EEPROM_LEN = 0x0C00U;                       \
       nfcFL._FW_MOBILE_MAJOR_NUMBER = FW_MOBILE_MAJOR_NUMBER_PN548AD;       \
                                                                             \
+    } else if (chipType == pn547C2 || chipType == pn65T) {                  \
+                                                                            \
+      STRCPY_FW_LIB("libpn547_fw")                                          \
+      STRCPY_FW_BIN("pn547")                                                \
+                                                                            \
+      nfcFL._PHDNLDNFC_USERDATA_EEPROM_OFFSET = 0x023CU;                    \
+      nfcFL._PHDNLDNFC_USERDATA_EEPROM_LEN = 0x0C80U;                       \
+      nfcFL._FW_MOBILE_MAJOR_NUMBER = FW_MOBILE_MAJOR_NUMBER_PN547;         \
+                                                                            \
     }                                                                       \
   }
 #define STRCPY_FW_LIB(str) {                                                \
diff --git a/halimpl/hal/phNxpNciHal.cc b/halimpl/hal/phNxpNciHal.cc
index 2befdd3..33c1e03 100755
--- a/halimpl/hal/phNxpNciHal.cc
+++ b/halimpl/hal/phNxpNciHal.cc
@@ -827,6 +827,10 @@ int phNxpNciHal_fw_mw_ver_check() {
              (rom_version == FW_MOBILE_ROM_VERSION_PN548AD) &&
              (fw_maj_ver == 0x01)) {
     status = NFCSTATUS_SUCCESS;
+  } else if ((nfcFL.chipType == pn547C2) &&
+             (rom_version == FW_MOBILE_ROM_VERSION_PN547C2) &&
+             (fw_maj_ver == 0x01)) {
+    status = NFCSTATUS_SUCCESS;
   }
   return status;
 }
diff --git a/halimpl/hal/phNxpNciHal.h b/halimpl/hal/phNxpNciHal.h
index 79791f9..c16d325 100755
--- a/halimpl/hal/phNxpNciHal.h
+++ b/halimpl/hal/phNxpNciHal.h
@@ -33,6 +33,7 @@
 typedef void(phNxpNciHal_control_granted_callback_t)();
 
 /*ROM CODE VERSION FW*/
+#define FW_MOBILE_ROM_VERSION_PN547C2 0x08
 #define FW_MOBILE_ROM_VERSION_PN548AD 0x10
 #define FW_MOBILE_ROM_VERSION_PN551 0x10
 #define FW_MOBILE_ROM_VERSION_PN553 0x11
-- 
2.17.1

