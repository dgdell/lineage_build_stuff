From 9fc9a797b112370306bfb4833504b5d88f4ebfbf Mon Sep 17 00:00:00 2001
From: Alessandro Astone <alessandro.astone@hotmail.com>
Date: Sun, 2 Sep 2018 02:07:53 +0200
Subject: [PATCH 7/7] libbt: Make sure that we don't load pre-patch when
 looking for patch

 * hw_config_findpatch logic allowed for pre-patch files
   to be loaded in place of patch files.
   Check that the filename is not the pre-patch name.

Change-Id: I19cdf10af21d7d741dcbea42e5a4966d94349d95
---
 src/hardware.c | 50 ++++++++++++++++++++++++++++++--------------------
 1 file changed, 30 insertions(+), 20 deletions(-)

diff --git a/src/hardware.c b/src/hardware.c
index 1e748be..5f24ee7 100644
--- a/src/hardware.c
+++ b/src/hardware.c
@@ -498,7 +498,7 @@ static uint8_t hw_config_findpatch(char *p_chip_id_str)
 {
     DIR *dirp;
     struct dirent *dp;
-    int filenamelen;
+    int filenamelen, idx, i;
     uint8_t retval = FALSE;
 
     BTHWDBG("Target name = [%s]", p_chip_id_str);
@@ -558,30 +558,40 @@ static uint8_t hw_config_findpatch(char *p_chip_id_str)
                           FW_PATCHFILE_EXTENSION_LEN) \
                      ) == 0))
                 {
-                    ALOGI("Found patchfile: %s/%s", \
-                        fw_patchfile_path, dp->d_name);
 
-                    /* Make sure length does not exceed maximum */
-                    if ((filenamelen + strlen(fw_patchfile_path)) > \
-                         FW_PATCHFILE_PATH_MAXLEN)
-                    {
-                        ALOGE("Invalid patchfile name (too long)");
-                    }
-                    else
+                    /* Make sure it's not the prepatch */
+                    idx = 0;
+                    for(i = 0; fw_prepatch_name[i] != '\0'; i++)
+                        if(fw_prepatch_name[i] == '/')
+                            idx = i;
+
+                    if(strcmp(&fw_prepatch_name[idx+1], dp->d_name))
                     {
-                        memset(p_chip_id_str, 0, FW_PATCHFILE_PATH_MAXLEN);
-                        /* Found patchfile. Store location and name */
-                        strcpy(p_chip_id_str, fw_patchfile_path);
-                        if (fw_patchfile_path[ \
-                            strlen(fw_patchfile_path)- 1 \
-                            ] != '/')
+                        ALOGI("Found patchfile: %s/%s", \
+                            fw_patchfile_path, dp->d_name);
+
+                        /* Make sure length does not exceed maximum */
+                        if ((filenamelen + strlen(fw_patchfile_path)) > \
+                             FW_PATCHFILE_PATH_MAXLEN)
                         {
-                            strcat(p_chip_id_str, "/");
+                            ALOGE("Invalid patchfile name (too long)");
                         }
-                        strcat(p_chip_id_str, dp->d_name);
-                        retval = TRUE;
+                        else
+                        {
+                            memset(p_chip_id_str, 0, FW_PATCHFILE_PATH_MAXLEN);
+                            /* Found patchfile. Store location and name */
+                            strcpy(p_chip_id_str, fw_patchfile_path);
+                            if (fw_patchfile_path[ \
+                                strlen(fw_patchfile_path)- 1 \
+                                ] != '/')
+                            {
+                                strcat(p_chip_id_str, "/");
+                            }
+                            strcat(p_chip_id_str, dp->d_name);
+                            retval = TRUE;
+                        }
+                        break;
                     }
-                    break;
                 }
             }
         }
-- 
2.17.1

