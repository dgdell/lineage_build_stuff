From 44210af8d1b5a7af281003eb959aba79db477fed Mon Sep 17 00:00:00 2001
From: Arne Coucheron <arco68@gmail.com>
Date: Sun, 21 Oct 2018 00:27:58 +0200
Subject: [PATCH] media: Use generated kernel headers

Change-Id: I2f848353e2e8d1ba0b233c1d0b271e0595ff9a79
---
 libc2dcolorconvert/Android.mk      |  6 ++----
 mm-video-v4l2/vidc/vdec/Android.mk | 15 ++++++++++-----
 mm-video-v4l2/vidc/venc/Android.mk | 13 +++++++------
 3 files changed, 19 insertions(+), 15 deletions(-)

diff --git a/libc2dcolorconvert/Android.mk b/libc2dcolorconvert/Android.mk
index b6610989e..2bec1fed1 100644
--- a/libc2dcolorconvert/Android.mk
+++ b/libc2dcolorconvert/Android.mk
@@ -11,16 +11,14 @@ LOCAL_C_INCLUDES := \
     $(TOP)/$(call project-path-for,qcom-display)/libcopybit \
     $(TARGET_OUT_HEADERS)/qcom/display/
 
-LOCAL_C_INCLUDES += $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr/include
-
 LOCAL_SHARED_LIBRARIES := libutils liblog libdl
 
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_MODULE_TAGS := optional
 
 LOCAL_MODULE := libc2dcolorconvert
 
-LOCAL_ADDITIONAL_DEPENDENCIES := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
-
 LOCAL_VENDOR_MODULE := true
 
 include $(BUILD_SHARED_LIBRARY)
diff --git a/mm-video-v4l2/vidc/vdec/Android.mk b/mm-video-v4l2/vidc/vdec/Android.mk
index b745c099b..d428a5a5d 100755
--- a/mm-video-v4l2/vidc/vdec/Android.mk
+++ b/mm-video-v4l2/vidc/vdec/Android.mk
@@ -84,7 +84,7 @@ ifneq ($(call is-platform-sdk-version-at-least,18),true)
 libOmxVdec-def += -DANDROID_JELLYBEAN_MR1=1
 endif
 
-vdec-inc          = $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr/include
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
 
 ifeq ($(call is-platform-sdk-version-at-least, 22),true)
 # This feature is enabled for Android LMR1
@@ -141,6 +141,8 @@ LOCAL_HEADER_LIBRARIES := \
     libhardware_headers \
     media_plugin_headers \
 
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_PRELINK_MODULE    := false
 LOCAL_SHARED_LIBRARIES  := libui libhardware liblog libutils libbinder \
                            libcutils libdl
@@ -157,7 +159,6 @@ endif
 
 LOCAL_SRC_FILES         += ../common/src/extra_data_handler.cpp
 LOCAL_SRC_FILES         += ../common/src/vidc_color_converter.cpp
-LOCAL_ADDITIONAL_DEPENDENCIES  := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
 
 # omx_vdec_msm8974.cpp:9375:16: address of array 'extra->data' will always evaluate to 'true'
 LOCAL_CLANG_CFLAGS      += -Wno-pointer-bool-conversion
@@ -183,6 +184,8 @@ LOCAL_VENDOR_MODULE             := true
 LOCAL_CFLAGS                    := $(libOmxVdec-def)
 LOCAL_C_INCLUDES                += $(libmm-vdec-inc)
 
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_PRELINK_MODULE    := false
 LOCAL_SHARED_LIBRARIES  := liblog libutils libbinder libcutils libdl
 
@@ -204,7 +207,6 @@ LOCAL_SRC_FILES         += src/hevc_utils.cpp
 
 LOCAL_SRC_FILES         += ../common/src/extra_data_handler.cpp
 LOCAL_SRC_FILES         += ../common/src/vidc_color_converter.cpp
-LOCAL_ADDITIONAL_DEPENDENCIES  := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
 
 include $(BUILD_SHARED_LIBRARY)
 
@@ -226,12 +228,13 @@ LOCAL_VENDOR_MODULE             := true
 LOCAL_CFLAGS                    := $(libOmxVdec-def)
 LOCAL_C_INCLUDES                := $(mm-vdec-test-inc)
 
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_PRELINK_MODULE      := false
 LOCAL_SHARED_LIBRARIES    := libutils libOmxCore libOmxVdec libbinder libcutils
 
 LOCAL_SRC_FILES           := src/queue.c
 LOCAL_SRC_FILES           += test/omx_vdec_test.cpp
-LOCAL_ADDITIONAL_DEPENDENCIES  := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
 
 include $(BUILD_EXECUTABLE)
 
@@ -249,11 +252,13 @@ LOCAL_MODULE_TAGS               := optional
 LOCAL_VENDOR_MODULE             := true
 LOCAL_CFLAGS                    := $(libOmxVdec-def)
 LOCAL_C_INCLUDES                := $(mm-vdec-drv-test-inc)
+
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_PRELINK_MODULE            := false
 
 LOCAL_SRC_FILES                 := src/message_queue.c
 LOCAL_SRC_FILES                 += test/decoder_driver_test.c
-LOCAL_ADDITIONAL_DEPENDENCIES  := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
 
 include $(BUILD_EXECUTABLE)
 
diff --git a/mm-video-v4l2/vidc/venc/Android.mk b/mm-video-v4l2/vidc/venc/Android.mk
index d81f1a28b..38552c0d3 100644
--- a/mm-video-v4l2/vidc/venc/Android.mk
+++ b/mm-video-v4l2/vidc/venc/Android.mk
@@ -68,7 +68,7 @@ ifeq ($(TARGET_USES_ION),true)
 libmm-venc-def += -DUSE_ION
 endif
 
-venc-inc       = $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr/include
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
 
 ifeq ($(TARGET_USES_MEDIA_EXTENSIONS),true)
 libmm-venc-def += -DUSE_NATIVE_HANDLE_SOURCE
@@ -100,6 +100,8 @@ libmm-venc-inc      += $(venc-inc)
 LOCAL_HEADER_LIBRARIES := \
         media_plugin_headers
 
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_MODULE                    := libOmxVenc
 LOCAL_MODULE_TAGS               := optional
 LOCAL_VENDOR_MODULE             := true
@@ -119,8 +121,6 @@ else
 LOCAL_SRC_FILES   += src/video_encoder_device.cpp
 endif
 
-LOCAL_ADDITIONAL_DEPENDENCIES  := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
-
 LOCAL_SRC_FILES   += ../common/src/extra_data_handler.cpp
 
 include $(BUILD_SHARED_LIBRARY)
@@ -141,12 +141,13 @@ mm-venc-test720p-inc            += $(venc-inc)
 LOCAL_HEADER_LIBRARIES := \
         media_plugin_headers
 
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_MODULE                    := mm-venc-omx-test720p
 LOCAL_MODULE_TAGS               := optional
 LOCAL_VENDOR_MODULE             := true
 LOCAL_CFLAGS                    := $(libmm-venc-def)
 LOCAL_C_INCLUDES                := $(mm-venc-test720p-inc)
-LOCAL_ADDITIONAL_DEPENDENCIES   := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
 LOCAL_PRELINK_MODULE            := false
 LOCAL_SHARED_LIBRARIES          := libmm-omxcore libOmxVenc libbinder liblog
 
@@ -170,13 +171,13 @@ venc-test-inc                   += $(venc-inc)
 LOCAL_HEADER_LIBRARIES := \
         media_plugin_headers
 
+LOCAL_HEADER_LIBRARIES := generated_kernel_headers
+
 LOCAL_MODULE                    := mm-video-encdrv-test
 LOCAL_MODULE_TAGS               := optional
 LOCAL_VENDOR_MODULE             := true
 LOCAL_C_INCLUDES                := $(venc-test-inc)
 LOCAL_C_INCLUDES                += $(call project-path-for,qcom-media)/mm-core/inc
-
-LOCAL_ADDITIONAL_DEPENDENCIES   := $(TARGET_OUT_INTERMEDIATES)/KERNEL_OBJ/usr
 LOCAL_PRELINK_MODULE            := false
 
 LOCAL_SRC_FILES                 := test/video_encoder_test.c
-- 
2.17.1

