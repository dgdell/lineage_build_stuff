From 0487e5e36f590995936f1caa162cc47b806acee7 Mon Sep 17 00:00:00 2001
From: Michael Bestas <mkbestas@lineageos.org>
Date: Mon, 26 Mar 2018 01:00:20 +0300
Subject: [PATCH 1/2] power: Compile with -Wall -Wextra -Werror

* And fix the build errors

Change-Id: I183203edfd92d4672893d74aa7428bc9f5e17772
---
 Android.mk     |  2 ++
 Power.cpp      |  3 ++-
 power-660.c    |  9 ++------
 power-845.c    |  2 +-
 power-8909.c   |  1 -
 power-8953.c   |  9 ++------
 power-helper.c | 69 +++++++++++++++++++++++++++++++---------------------------
 7 files changed, 46 insertions(+), 49 deletions(-)

diff --git a/Android.mk b/Android.mk
index 12563ea..594db00 100644
--- a/Android.mk
+++ b/Android.mk
@@ -45,6 +45,8 @@ LOCAL_SRC_FILES := \
 LOCAL_C_INCLUDES := external/libxml2/include \
                     external/icu/icu4c/source/common
 
+LOCAL_CFLAGS += -Wall -Wextra -Werror
+
 ifneq ($(BOARD_POWER_CUSTOM_BOARD_LIB),)
     LOCAL_WHOLE_STATIC_LIBRARIES += $(BOARD_POWER_CUSTOM_BOARD_LIB)
 else
diff --git a/Power.cpp b/Power.cpp
index f45bf67..f857041 100644
--- a/Power.cpp
+++ b/Power.cpp
@@ -53,7 +53,6 @@ using ::android::hardware::power::V1_1::PowerStateSubsystem;
 using ::android::hardware::hidl_vec;
 using ::android::hardware::Return;
 using ::android::hardware::Void;
-using ::android::hardware::power::V1_0::Feature;
 
 Power::Power() {
     power_init();
@@ -78,7 +77,9 @@ Return<void> Power::setFeature(Feature feature, bool activate)  {
 Return<void> Power::getPlatformLowPowerStats(getPlatformLowPowerStats_cb _hidl_cb) {
     hidl_vec<PowerStatePlatformSleepState> states;
     uint64_t stats[MAX_PLATFORM_STATS * MAX_RPM_PARAMS] = {0};
+#ifndef LEGACY_STATS
     uint64_t *values;
+#endif
     struct PowerStatePlatformSleepState *state;
     int ret;
 
diff --git a/power-660.c b/power-660.c
index 2453286..76ee891 100644
--- a/power-660.c
+++ b/power-660.c
@@ -51,11 +51,9 @@
 #define MIN_VAL(X,Y) ((X>Y)?(Y):(X))
 
 static int video_encode_hint_sent;
-static int cam_preview_hint_sent;
 
 static int camera_hint_ref_count;
 static void process_video_encode_hint(void *metadata);
-//static void process_cam_preview_hint(void *metadata);
 
 /**
  * If target is SDM630:
@@ -86,6 +84,8 @@ int  power_hint_override(power_hint_t hint, void *data)
             process_video_encode_hint(data);
             return HINT_HANDLED;
         }
+        default:
+            break;
     }
     return HINT_NONE;
 }
@@ -93,11 +93,8 @@ int  power_hint_override(power_hint_t hint, void *data)
 int  set_interactive_override(int on)
 {
     char governor[80];
-    char tmp_str[NODE_MAX];
     int resource_values[20];
     int num_resources;
-    struct video_encode_metadata_t video_encode_metadata;
-    int rc;
 
     ALOGI("Got set_interactive hint");
 
@@ -263,5 +260,3 @@ static void process_video_encode_hint(void *metadata)
     }
     return;
 }
-
-
diff --git a/power-845.c b/power-845.c
index 46511cc..1bc290f 100644
--- a/power-845.c
+++ b/power-845.c
@@ -51,7 +51,7 @@
 static int display_fd;
 #define SYS_DISPLAY_PWR "/sys/kernel/hbtp/display_pwr"
 
-int power_hint_override(power_hint_t hint, void *data)
+int power_hint_override(power_hint_t hint, void *UNUSED(data))
 {
     int ret_val = HINT_NONE;
     switch(hint) {
diff --git a/power-8909.c b/power-8909.c
index 4d67f25..a5c4994 100644
--- a/power-8909.c
+++ b/power-8909.c
@@ -52,7 +52,6 @@ static void process_video_encode_hint(void *metadata)
 {
     char governor[80];
     struct video_encode_metadata_t video_encode_metadata;
-    char tmp_str[NODE_MAX];
 
     if (get_scaling_governor(governor, sizeof(governor)) == -1) {
         ALOGE("Can't obtain scaling governor.");
diff --git a/power-8953.c b/power-8953.c
index 7c305f2..cacf98b 100644
--- a/power-8953.c
+++ b/power-8953.c
@@ -49,11 +49,9 @@
 #include "power-common.h"
 
 static int video_encode_hint_sent;
-static int cam_preview_hint_sent;
 
 static int camera_hint_ref_count;
 static void process_video_encode_hint(void *metadata);
-//static void process_cam_preview_hint(void *metadata);
 
 int  power_hint_override(power_hint_t hint, void *data)
 {
@@ -66,6 +64,8 @@ int  power_hint_override(power_hint_t hint, void *data)
             process_video_encode_hint(data);
             return HINT_HANDLED;
         }
+        default:
+            break;
     }
     return HINT_NONE;
 }
@@ -73,9 +73,6 @@ int  power_hint_override(power_hint_t hint, void *data)
 int  set_interactive_override(int on)
 {
     char governor[80];
-    char tmp_str[NODE_MAX];
-    struct video_encode_metadata_t video_encode_metadata;
-    int rc;
 
     ALOGI("Got set_interactive hint");
 
@@ -177,5 +174,3 @@ static void process_video_encode_hint(void *metadata)
     }
     return;
 }
-
-
diff --git a/power-helper.c b/power-helper.c
index 6885617..f037be7 100644
--- a/power-helper.c
+++ b/power-helper.c
@@ -103,12 +103,14 @@ static const char *rpm_master_param_names[] = {
     "xo_count"
 };
 
+#ifndef V1_0_HAL
 static const char *wlan_param_names[] = {
     "cumulative_sleep_time_ms",
     "cumulative_total_on_time_ms",
     "deep_sleep_enter_counter",
     "last_deep_sleep_enter_tstamp_ms"
 };
+#endif
 #else
 /* Use these stats on nougat kernels and forward */
 const char *rpm_stat_params[MAX_RPM_PARAMS] = {
@@ -316,7 +318,6 @@ void power_set_interactive(int on)
 {
     char governor[80];
     char tmp_str[NODE_MAX];
-    struct video_encode_metadata_t video_encode_metadata;
     int rc = 0;
 
     if (!on) {
@@ -536,37 +537,6 @@ void set_feature(feature_t feature, int state)
     set_device_specific_feature(feature, state);
 }
 
-static int parse_stats(const char **params, size_t params_size,
-                       uint64_t *list, FILE *fp) {
-    ssize_t nread;
-    size_t len = LINE_SIZE;
-    char *line;
-    size_t params_read = 0;
-    size_t i;
-    line = malloc(len);
-    if (!line) {
-        ALOGE("%s: no memory to hold line", __func__);
-        return -ENOMEM;
-    }
-    while ((params_read < params_size) &&
-        (nread = getline(&line, &len, fp) > 0)) {
-        char *key = line + strspn(line, " \t");
-        char *value = strchr(key, ':');
-        if (!value || (value > (line + len)))
-            continue;
-        *value++ = '\0';
-        for (i = 0; i < params_size; i++) {
-            if (!strcmp(key, params[i])) {
-                list[i] = strtoull(value, NULL, 0);
-                params_read++;
-                break;
-            }
-        }
-    }
-    free(line);
-    return 0;
-}
-
 #ifdef LEGACY_STATS
 static int extract_stats(uint64_t *list, char *file, const char**param_names,
                          unsigned int num_parameters, int isHex) {
@@ -645,6 +615,41 @@ int extract_wlan_stats(uint64_t *list) {
 #endif
 #else
 
+static int parse_stats(const char **params, size_t params_size,
+                       uint64_t *list, FILE *fp) {
+    ssize_t nread;
+    size_t len = LINE_SIZE;
+    char *line;
+    size_t params_read = 0;
+    size_t i;
+
+    line = malloc(len);
+    if (!line) {
+        ALOGE("%s: no memory to hold line", __func__);
+        return -ENOMEM;
+    }
+
+    while ((params_read < params_size) &&
+        (nread = getline(&line, &len, fp) > 0)) {
+        char *key = line + strspn(line, " \t");
+        char *value = strchr(key, ':');
+        if (!value || (value > (line + len)))
+            continue;
+        *value++ = '\0';
+
+        for (i = 0; i < params_size; i++) {
+            if (!strcmp(key, params[i])) {
+                list[i] = strtoull(value, NULL, 0);
+                params_read++;
+                break;
+            }
+        }
+    }
+    free(line);
+
+    return 0;
+}
+
 static int extract_stats(uint64_t *list, char *file,
                          struct stat_pair *map, size_t map_size) {
     FILE *fp;
-- 
2.15.1

