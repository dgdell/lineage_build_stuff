From 9816bc58461f88296b23828f6c86a56b7075d9e6 Mon Sep 17 00:00:00 2001
From: Steve Kondik <steve@cyngn.com>
Date: Fri, 16 Oct 2015 21:15:20 -0700
Subject: [PATCH 05/10] wcnss_service: Deal with mdm-detect too

Change-Id: I1f6ad7502bb23fd59f182c1fe86ba92cb47470b7
---
 wcnss-service/Android.mk      | 2 +-
 wcnss-service/wcnss_service.c | 8 +++++++-
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/wcnss-service/Android.mk b/wcnss-service/Android.mk
index 850bbe3..f644110 100644
--- a/wcnss-service/Android.mk
+++ b/wcnss-service/Android.mk
@@ -23,7 +23,7 @@ ifeq ($(TARGET_USES_WCNSS_MAC_ADDR_REV),true)
 LOCAL_CFLAGS += -DWCNSS_QMI_MAC_ADDR_REV
 endif
 ifneq ($(QCPATH),)
-LOCAL_CFLAGS += -DWCNSS_QMI
+LOCAL_CFLAGS += -DWCNSS_QMI -DMDM_DETECT
 LOCAL_SHARED_LIBRARIES += libwcnss_qmi
 else
 LOCAL_CFLAGS += -DWCNSS_QMI_OSS
diff --git a/wcnss-service/wcnss_service.c b/wcnss-service/wcnss_service.c
index 37a9361..1f7a494 100644
--- a/wcnss-service/wcnss_service.c
+++ b/wcnss-service/wcnss_service.c
@@ -42,8 +42,10 @@ ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 #include <cutils/properties.h>
 #ifdef WCNSS_QMI
 #include "wcnss_qmi_client.h"
+#ifdef MDM_DETECT
 #include "mdm_detect.h"
 #endif
+#endif
 #ifdef WCNSS_QMI_OSS
 #include <dlfcn.h>
 #endif
@@ -514,7 +516,7 @@ void setup_wlan_driver_ath_prop()
 	property_set("wlan.driver.ath", WLAN_DRIVER_ATH_DEFAULT_VAL);
 }
 
-#ifdef WCNSS_QMI
+#ifdef MDM_DETECT
 int check_modem_compatability(struct dev_info *mdm_detect_info)
 {
 	char args[MODEM_BASEBAND_PROPERTY_SIZE] = {0};
@@ -796,8 +798,10 @@ int main(int argc, char *argv[])
 	int fd_dev, ret_cal;
 #if defined(WCNSS_QMI) || defined(WCNSS_QMI_OSS)
 	int nv_mac_addr = FAILED;
+#ifdef MDM_DETECT
 	struct dev_info mdm_detect_info;
 	int nom = 0;
+#endif
 #endif
 
 	setup_wlan_config_file();
@@ -825,6 +829,7 @@ int main(int argc, char *argv[])
 	}
 #endif
 #ifdef WCNSS_QMI
+#ifdef MDM_DETECT
 	/* Call ESOC API to get the number of modems.
 	   If the number of modems is not zero, only then proceed
 	   with the eap_proxy intialization.*/
@@ -846,6 +851,7 @@ int main(int argc, char *argv[])
 		ALOGE("wcnss_service: Target does not have external modem");
 		goto nomodem;
 	}
+#endif
 
 	/* initialize the DMS client and request the wlan mac address */
 
-- 
2.17.1

