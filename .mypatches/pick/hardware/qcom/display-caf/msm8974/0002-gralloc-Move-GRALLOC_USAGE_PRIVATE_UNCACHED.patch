From f20a38a15775cbdba3ae69b22ec6ac30f79617f8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?D=2E=20Andrei=20M=C4=83ce=C8=99?=
 <andrei@unlegacy-android.org>
Date: Sat, 1 Sep 2018 21:33:33 +0300
Subject: [PATCH 2/4] gralloc: Move GRALLOC_USAGE_PRIVATE_UNCACHED
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change I7f4174581e24e361577640b9263514a168ed482d in frameworks/native
introduces validation for Gralloc usage bits, which blocks arbitrary
private usage flags, such as GRALLOC_USAGE_PRIVATE_UNCACHED (1 << 25).

E Gralloc2: buffer descriptor contains invalid usage bits 0x2000000

While Gralloc1 has many more GRALLOC1_CONSUMER_USAGE_PRIVATE_[4-19], we
are pretty limited with our Gralloc0 headers, and 32-bit usage flags.
However, 1 << 2, 1 << 3, 1 << 6, and 1 << 7 seem to be available,
and fall under GRALLOC_USAGE_SW_{READ,WRITE}_MASK, so use them.

Change-Id: I39ffb14e4b67191f1c12501cd02350fb2eac31a6
Signed-off-by: D. Andrei Măceș <andrei@unlegacy-android.org>
---
 libgralloc/gralloc_priv.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/libgralloc/gralloc_priv.h b/libgralloc/gralloc_priv.h
index 7a021c6c5..1c04467e8 100644
--- a/libgralloc/gralloc_priv.h
+++ b/libgralloc/gralloc_priv.h
@@ -52,7 +52,7 @@ enum {
 
     /* Set this for allocating uncached memory (using O_DSYNC)
      * cannot be used with noncontiguous heaps */
-    GRALLOC_USAGE_PRIVATE_UNCACHED        =       0x02000000,
+    GRALLOC_USAGE_PRIVATE_UNCACHED        =       0x00000004,
 
     /* Buffer content should be displayed on an primary display only */
     GRALLOC_USAGE_PRIVATE_INTERNAL_ONLY   =       0x04000000,
-- 
2.17.1

