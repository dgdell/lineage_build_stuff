From fd8cdb3c9897344e512242a9ff82d5dfb2b2c467 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Fri, 19 Oct 2018 12:03:29 +0200
Subject: [PATCH 4/4] Merge android-9.0.0_r12

commit 22459518c3e5b6f89589347d64983bec648f8e9e
Merge: 534f70171 a67e0dd43
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sat Aug 4 01:30:38 2018 +0000

    Merge cherrypicks of [4691303, 4690277, 4694738, 4689486, 4694439, 4694440, 4689487] into pi-dr1-release

    Change-Id: Ib3d18ce7403888d3b391da93e81e7ec813e8ae97

commit a67e0dd438c6d45bd9cc6a4e594ddaa4d7b672fc
Author: Yin-Chia Yeh <yinchiayeh@google.com>
Date:   Fri Aug 3 11:50:47 2018 -0700

    Legacy camera shim: add option to free buffers earlier

    This option allows HAL to opt in for the behavior that will free
    cached buffers earlier if the libhardware HAL implementation
    doesn't cache/reference the cached buffers internally.

    Test: buffers are freed earlier when the property is set
    Bug: 111850884
    Change-Id: I3a10b288c7160c86dc7d3a30d04b5c4903917731
    (cherry picked from commit 7d1fdecea5bfa16ab7af3b0b98db1973c1775abd)

commit 534f70171a0d892176f40103dcaac5819e9e34fb
Merge: 121cabf78 ed35fab10
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Aug 1 00:22:28 2018 +0000

    Merge cherrypicks of [4663458, 4663322, 4662823, 4662824, 4663505, 4663506, 4663507, 4663508, 4663509, 4662787, 4662788, 4662790, 4663781, 4663801, 4662825, 4662826] into pi-dr1-release

    Change-Id: I51f610165f3d7d6502c0f16323efc562e11ac287

commit ed35fab10b8b7b5268e45e5f1115f4dfc6821e1b
Author: Jeff Tinker <jtinker@google.com>
Date:   Thu Jul 19 16:31:56 2018 -0700

    Fix failing drm 1.0 vts tests

    The shared library path was incorrectly set based on
    the drm.64bit.enabled flag. It should be set based
    on whether the drm service is running as 32-bit or
    64-bit.

    Test: vts-tradefed run commandAndExit vts -m VtsHalDrmV1_0Target

    bug:111289939
    Change-Id: I388dc87bd4566211dc2901feccf1e6e1c90bfe67
    (cherry picked from commit b065c9d8b7f926c57a7ec59e50e979a8c6e38e7f)

commit 121cabf78c116265d1d14e49287fcf747c3baae0
Merge: 9e2436d88 30ce0f81c
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jul 24 19:04:55 2018 +0000

    Merge cherrypicks of [4617311, 4617354, 4617355, 4617241, 4611726, 4611727, 4611683, 4611768, 4612064, 4612065, 4617374, 4617376, 4616313] into pi-dr1-release

    Change-Id: Ic6bd8b2fb35a234d8ae2ea018c8c3a3a76071048

commit 30ce0f81c0492fa9d25c1e70ac7fcc7e915e753f
Author: nagendra modadugu <ngm@google.com>
Date:   Mon Jul 23 10:32:28 2018 -0700

    keymaster: skip SHA2 digest tests for strongbox

    Strongbox is not required to support SHA-2 digests,
    so skip the related tests.

    Bug: 109771020
    Change-Id: I5f877b2a1ac66026a876e145416ba078d486e4b5
    (cherry picked from commit 8cec80be1fc3d2d30fe095fa009dfa83cb7651ce)

commit 9e2436d888a6fa6c0b97cdab834e77524e1defa8
Merge: 364abda56 80abca52d
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Fri Jul 20 23:57:08 2018 +0000

    Snap for 4905103 from 80abca52dea74b8a53659fcb33c5448bf697312f to pi-dr1-release

    Change-Id: Id38eee018b02bfa46fa6eff0863cc93c013b0ace

commit 80abca52dea74b8a53659fcb33c5448bf697312f
Merge: cccd5bf1d f06d4203a
Author: Kevin Rocard <krocard@google.com>
Date:   Fri Jul 20 07:18:32 2018 -0700

    Effect VTS: Allow an effect proxy as pre/post processing am: 0f0328fc4e
    am: f06d4203ac

    Change-Id: I1e3b1296c0943f65c57b448d25bcbe4c2bd95239

commit f06d4203accc96302c5c6e7287bea5fd7a563f08
Merge: bb6bc7809 0f0328fc4
Author: Kevin Rocard <krocard@google.com>
Date:   Fri Jul 20 07:15:11 2018 -0700

    Effect VTS: Allow an effect proxy as pre/post processing
    am: 0f0328fc4e

    Change-Id: I9dd308618084d4c4328812d3c7b8acb9086ea5a4

commit cccd5bf1dd32c49ac6e10d870829b1ae40d19580
Author: Hsin-Yi Chen <hsinyichen@google.com>
Date:   Fri Jul 20 12:52:20 2018 +0800

    Fix ICameraDeviceCallback version in VTS test

    Test: ./VtsHalCameraProviderV2_4TargetTest --gtest_filter=CameraHidlTest.constructDefaultRequestSettings
    Bug: 111625570
    Change-Id: I8ad02afb0e9c2131c240999c4a8c78a1f770e847

commit 0f0328fc4eb9218e627b3aba13bd40b1feef1da4
Author: Kevin Rocard <krocard@google.com>
Date:   Thu Jul 19 09:04:21 2018 -0700

    Effect VTS: Allow an effect proxy as pre/post processing

    Effect proxy were previously mistakenly forbidden as post
    or pre processing effects.

    An effect being a proxy or not should not affect where
    it can be use in the effect framework.

    Bug: 111421676
    Test: xmllint --noout --schema hardware/interfaces/audio/effect/2.0/xml/audio_effects_conf_V2_0.xsd $(find -name audio_effects.xml)
    Change-Id: Iad1c1467226b86a2935a36dd90cf2e32f7f753b0
    Signed-off-by: Kevin Rocard <krocard@google.com>

commit 364abda56d3d58bf68ed8c843c56c7cd415384ae
Merge: 4eb0e9f7c 8f7677d13
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jul 19 03:01:19 2018 +0000

    Snap for 4900918 from 8f7677d1317b022b92b415f4b5c3edba0638ae08 to pi-dr1-release

    Change-Id: I78e040fbcc8cd2f2058a967293dc69061b49ebf0

commit 8f7677d1317b022b92b415f4b5c3edba0638ae08
Merge: f4f52c707 bb6bc7809
Author: sqian <shuoq@google.com>
Date:   Tue Jul 17 20:29:22 2018 -0700

    [automerger skipped] resolve merge conflicts of eb0f7cdcbfc7235978247ae62bfd07675cdf8c67 to oc-dr1-dev am: 6a85d76a9e
    am: bb6bc7809b  -s ours

    Change-Id: If2ddcff91d7f17f7b211ab24b61953868e90a3a9

commit bb6bc7809be7481115b5b41ddf80a2fe181ea1e8
Merge: 61ba46d76 6a85d76a9
Author: sqian <shuoq@google.com>
Date:   Tue Jul 17 20:26:00 2018 -0700

    resolve merge conflicts of eb0f7cdcbfc7235978247ae62bfd07675cdf8c67 to oc-dr1-dev
    am: 6a85d76a9e

    Change-Id: I94776398e7f93c89c1966944bc7b9dd133f588eb

commit 4eb0e9f7cc5fdc80683705441aa8d6dce107cf06
Merge: f2d62952e f4f52c707
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jul 18 03:14:28 2018 +0000

    Snap for 4899218 from f4f52c70750dd0d58025bbde7ff1f9fc5b94c5ec to pi-dr1-release

    Change-Id: I31075876b4150c1fd1dd93d2a1a623bde023f966

commit 6a85d76a9e1faf6262b91ebc999d29fe71996acb
Merge: ea4ab32f9 eb0f7cdcb
Author: sqian <shuoq@google.com>
Date:   Tue Jul 17 15:40:09 2018 -0700

    resolve merge conflicts of eb0f7cdcbfc7235978247ae62bfd07675cdf8c67 to oc-dr1-dev

    Test: I solemnly swear I tested this conflict resolution.
    Bug: 72075328
    Change-Id: I58b1bb905b0126297ba651e9ecff65878f6d49c7
    Merged-In: I8c993cd2fa95c961dc7f976b5bd85a2826b42889

commit f4f52c70750dd0d58025bbde7ff1f9fc5b94c5ec
Merge: df6d0cae1 61ba46d76
Author: Pawin Vongmasa <pawin@google.com>
Date:   Tue Jul 17 15:36:16 2018 -0700

    Disable tests for secure audio decoders am: b92f1d2e1b am: 2108362a2e am: ea4ab32f97
    am: 61ba46d766

    Change-Id: I92f1b26d217a846dd391ee9f2ffc1a8755355fea

commit df6d0cae127f4ed39aa64cfc42ddf941a6f9a3ee
Merge: 3ce3c9127 61d91f9de
Author: Kevin Rocard <krocard@google.com>
Date:   Tue Jul 17 15:35:48 2018 -0700

    [automerger skipped] Audio VTS: run tear-down hooks in LIFO instead of FIFO am: 01ead7c96b am: 6bd9139909  -s ours am: b32043a615  -s ours
    am: 61d91f9deb  -s ours

    Change-Id: I09c83e8d20ea827ada0a143d24a4661121fa902f

commit 61ba46d7669fad4ebcefb8e6aabc69fdeff95b38
Merge: 61d91f9de ea4ab32f9
Author: Pawin Vongmasa <pawin@google.com>
Date:   Tue Jul 17 15:30:04 2018 -0700

    Disable tests for secure audio decoders am: b92f1d2e1b am: 2108362a2e
    am: ea4ab32f97

    Change-Id: I12b6c26605f05c058c3f0e7cffb1122e37bebb74

commit 61d91f9debf9d13b64a94200f8fa5b8cb49676ea
Merge: ccda8d629 b32043a61
Author: Kevin Rocard <krocard@google.com>
Date:   Tue Jul 17 15:29:40 2018 -0700

    [automerger skipped] Audio VTS: run tear-down hooks in LIFO instead of FIFO am: 01ead7c96b am: 6bd9139909  -s ours
    am: b32043a615  -s ours

    Change-Id: I0d4f9e8dd06d452054a875e5add10e605a11ab85

commit ea4ab32f97f38941b15d3267c44e1aa1be07bce7
Merge: b32043a61 2108362a2
Author: Pawin Vongmasa <pawin@google.com>
Date:   Tue Jul 17 15:24:54 2018 -0700

    Disable tests for secure audio decoders am: b92f1d2e1b
    am: 2108362a2e

    Change-Id: Iac2d962dd3b6926888618c1489addf223e599e10

commit b32043a615f4bc953eb644caf8e25d28be6aa19d
Merge: ea34bd6a0 6bd913990
Author: Kevin Rocard <krocard@google.com>
Date:   Tue Jul 17 15:24:39 2018 -0700

    [automerger skipped] Audio VTS: run tear-down hooks in LIFO instead of FIFO am: 01ead7c96b
    am: 6bd9139909  -s ours

    Change-Id: Iad839f5681a69e65dc194d60a22532ec8bd2bca4

commit 3ce3c9127af475de88356908c44e2246ac59e307
Merge: 57c9e5fc3 8284636fe
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jul 17 20:58:49 2018 +0000

    Merge "audio: add wakelock capability for audiohalservice" into pi-dev

commit f2d62952e4d3b938aa0e7ac4e3dcc99337dd9e7b
Merge: dd0ae9b47 57c9e5fc3
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jul 17 03:05:52 2018 +0000

    Snap for 4896779 from 57c9e5fc377fe854d48ddbec249a7bc2c7ae634e to pi-dr1-release

    Change-Id: Ibe20e5f333f1727b463272469b1c37a8c6deae0a

commit 57c9e5fc377fe854d48ddbec249a7bc2c7ae634e
Merge: 375ff6a3a ccda8d629
Author: sqian <shuoq@google.com>
Date:   Mon Jul 16 10:04:49 2018 -0700

    resolve merge conflicts of ccda8d62963b62e80fe1e303c16e75ee9fa274d8 to pi-dev

    Test: I solemnly swear I tested this conflict resolution.
    Bug: 72075328
    Change-Id: I8c993cd2fa95c961dc7f976b5bd85a2826b42889

commit ccda8d62963b62e80fe1e303c16e75ee9fa274d8
Merge: fedde0ea5 898d05a71
Author: sqian <shuoq@google.com>
Date:   Mon Jul 16 09:49:17 2018 -0700

    resolve merge conflicts of dfa79a6292a42dd8609053febd8df7d5e7d48fbf to oreo-mr1-vts-dev
    am: 898d05a713

    Change-Id: Ib6c454c7e5e81ac2b82ecae24d8293497d36211e

commit 898d05a713a693670cd450ff3f50156fed2f4567
Merge: c0243f2ff dfa79a629
Author: sqian <shuoq@google.com>
Date:   Mon Jul 16 08:36:50 2018 -0700

    resolve merge conflicts of dfa79a6292a42dd8609053febd8df7d5e7d48fbf to oreo-mr1-vts-dev

    Test: I solemnly swear I tested this conflict resolution.
    Bug: None
    Change-Id: I10919718b841fdb33ab0e873d1b4bbd787fafcd2

commit eb0f7cdcbfc7235978247ae62bfd07675cdf8c67
Merge: 2108362a2 dfa79a629
Author: sqian <shuoq@google.com>
Date:   Mon Jul 16 08:30:07 2018 -0700

    Merge "Add NONE for LceService" into oreo-vts-dev
    am: dfa79a6292

    Change-Id: I53cd38ba31b1f19860f7d67396a1ce130c4a3375

commit dfa79a6292a42dd8609053febd8df7d5e7d48fbf
Merge: b92f1d2e1 70805cffd
Author: Treehugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jul 16 15:19:43 2018 +0000

    Merge "Add NONE for LceService" into oreo-vts-dev

commit dd0ae9b4707f53fc4abd8e2e735339e8c88baeae
Merge: adc2c02d4 375ff6a3a
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sun Jul 15 03:05:24 2018 +0000

    Snap for 4894342 from 375ff6a3a7a0e2d60360fc68e4900535f2422ec7 to pi-dr1-release

    Change-Id: Ibd492602ee79760a48ebb396ec25866dcec27f77

commit 70805cffdd6ebfb98fc355620ffe2402ec377094
Author: sqian <shuoq@google.com>
Date:   Wed Jul 11 15:19:02 2018 -0700

    Add NONE for LceService

    "Allow startLceService to succeed even in the
    SIM_ABSENT case. The original RIL documentation
    states that SUCCESS is valid for all LCE
    operations, and there is no logical reason why
    one of these operations must fail in a no-SIM
    case (though a vendor may choose not to support
    that configuration). Thus, a call to
    startLceService should permit NONE when requested
    in the no-SIM case for 1.0 VTS.

    In addition, a successful call to startLceService
    should also permit a successful call to
    pullLceData, so also allow RadioError::NONE for
    the pull operation. Ideally the tests would only
    allow NONE for pull if startLceService also
    returns NONE, but that's out of scope for now."

    Bug: 110181475
    Bug: 72075328
    Test: confirmed in the discussion; compilation

commit 375ff6a3a7a0e2d60360fc68e4900535f2422ec7
Merge: c0a06f34c fedde0ea5
Author: Pawin Vongmasa <pawin@google.com>
Date:   Fri Jul 13 01:45:43 2018 -0700

    resolve merge conflicts of b92f1d2e1be35b331b18589a8cde81d51ddd31d6 to oreo-mr1-vts-dev am: c0243f2ff8
    am: fedde0ea52

    Change-Id: I52c92c4cd9a68a5a57ba652e0284f495e912ea37

commit fedde0ea526dfb5d5b280ecf20fe7be94aaf2dbd
Merge: 54eb2c126 c0243f2ff
Author: Pawin Vongmasa <pawin@google.com>
Date:   Fri Jul 13 01:40:58 2018 -0700

    resolve merge conflicts of b92f1d2e1be35b331b18589a8cde81d51ddd31d6 to oreo-mr1-vts-dev
    am: c0243f2ff8

    Change-Id: Ic39fb2e88c6d0d1c1185dae1fab6d9c42a624187

commit 8284636fecaf9d679646416988762ce4b3ca685b
Author: Carter Hsu <carterhsu@google.com>
Date:   Fri Jul 13 10:41:29 2018 +0800

    audio: add wakelock capability for audiohalservice

    1. wake_lock group
    2. BLOCK_SUSPEND capability

    int pm_wake_lock(const char *buf)
    {
    	const char *str = buf;
    	struct wakelock *wl;
    	u64 timeout_ns = 0;
    	size_t len;
    	int ret = 0;

    	if (!capable(CAP_BLOCK_SUSPEND))
    		return -EPERM;
    Bug: 111018819
    Test: manual
    Change-Id: I1283e4b1ab2b95e4e94df045240001485593f1ab
    Signed-off-by: Carter Hsu <carterhsu@google.com>

commit c0a06f34c88cf9dc017be6178113b35c3c7fc67e
Author: sqian <shuoq@google.com>
Date:   Thu Jul 12 16:30:24 2018 -0700

    Add REQUEST_NOT_SUPPORTED for pin and pin2 Icc VTS

    Bug: 111222834
    Test: sanity
    Change-Id: Ia3b96e83d6173c2c80bdbf7763a876883b167af9

commit bef00fe1af7e9fde15d4235e64b9c483c780e523
Merge: 062047339 4ed0a216a
Author: Shuo Qian <shuoq@google.com>
Date:   Thu Jul 12 23:10:45 2018 +0000

    Merge "Add SIM_PUK2 for Icc VTS tests" into pi-dev

commit 4ed0a216adc3bc9460d11d302ba53db9707ded44
Author: sqian <shuoq@google.com>
Date:   Mon Jul 9 14:45:12 2018 -0700

    Add SIM_PUK2 for Icc VTS tests

    Add SIM_PUK2 for supplyIccPin2ForApp and changeIccPin2ForApp if sim
    card is in the puk2 state.

    Bug: 111211929
    Test: sanity
    Change-Id: I80d924cc4a61565887cbd2a65ee5927a42ad656e

commit c0243f2ff85d3d8d897f34d063177169e736a500
Merge: 70d13c2ad b92f1d2e1
Author: Pawin Vongmasa <pawin@google.com>
Date:   Wed Jul 11 23:22:17 2018 -0700

    resolve merge conflicts of b92f1d2e1be35b331b18589a8cde81d51ddd31d6 to oreo-mr1-vts-dev

    Test: make vts -j123 && vts-tradefed run commandAndExit vts \
    --skip-all-system-status-check \
    --skip-preconditions -m VtsHalMediaOmxV1_0Host \
    -l INFO

    Bug: 70933963
    Change-Id: I38f6309b638e604403dba15fa1fe1022b298c5b2

commit 2108362a2ed7938043c381acfb6f21dd90ed47f2
Merge: 6bd913990 b92f1d2e1
Author: Pawin Vongmasa <pawin@google.com>
Date:   Wed Jul 11 22:57:50 2018 -0700

    Disable tests for secure audio decoders
    am: b92f1d2e1b

    Change-Id: I0170a99924c56200d428ea2e0bc78e97831aa51c

commit 062047339b0e54b4b4147a892ce58a82067d7a21
Merge: 03f16e442 54eb2c126
Author: Kevin Rocard <krocard@google.com>
Date:   Wed Jul 11 21:25:19 2018 -0700

    [automerger skipped] Audio VTS: run tear-down hooks in LIFO instead of FIFO am: 01ead7c96b  -s ours am: 70d13c2ad3  -s ours
    am: 54eb2c126d  -s ours

    Change-Id: I4892ee3009773e4090f0dd480c7ce56f9e674254

commit 54eb2c126d1595eb92ed05415cddb0d1c1535a02
Merge: 4595c66a1 70d13c2ad
Author: Kevin Rocard <krocard@google.com>
Date:   Wed Jul 11 19:20:14 2018 -0700

    [automerger skipped] Audio VTS: run tear-down hooks in LIFO instead of FIFO am: 01ead7c96b  -s ours
    am: 70d13c2ad3  -s ours

    Change-Id: I9239953a3dd7af8b4bac5098199ea9bb9190b75d

commit 6bd91399094571651af0ecc11ebf400486743d76
Merge: d88330667 01ead7c96
Author: Kevin Rocard <krocard@google.com>
Date:   Wed Jul 11 18:09:36 2018 -0700

    Audio VTS: run tear-down hooks in LIFO instead of FIFO
    am: 01ead7c96b

    Change-Id: Ifbfafaacac3eb30d20890f98ec3f1ff7f7b493f2

commit b92f1d2e1be35b331b18589a8cde81d51ddd31d6
Author: Pawin Vongmasa <pawin@google.com>
Date:   Thu May 10 19:05:09 2018 -0700

    Disable tests for secure audio decoders

    Test: make vts -j123 && vts-tradefed run commandAndExit vts \
    --skip-all-system-status-check \
    --skip-preconditions -m VtsHalMediaOmxV1_0Host \
    -l INFO

    Bug: 70933963
    Change-Id: Iaaf3b7d382e7df4374dd7e03e5cc7b2ae6861fad

commit 70d13c2ad31cf8e9bcf2d9c81e0161ba3295cc1e
Merge: cfab8dac2 01ead7c96
Author: Kevin Rocard <krocard@google.com>
Date:   Wed Jul 11 17:56:31 2018 -0700

    [automerger skipped] Audio VTS: run tear-down hooks in LIFO instead of FIFO
    am: 01ead7c96b  -s ours

    Change-Id: I827c0bd5011129a704d35cdcd2df9f9bbe7eadfe

commit adc2c02d4b0c053ecfba46b1215040c375ed7a97
Merge: 17c39cc2e 03f16e442
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jul 11 03:11:38 2018 +0000

    Snap for 4885249 from 03f16e442af2c1bf1f47c77c9ef71477c8da1398 to pi-dr1-release

    Change-Id: Idf3602c31efcb1f3042e830b8e1d937444a3c978

commit 03f16e442af2c1bf1f47c77c9ef71477c8da1398
Merge: 366c0abba ec233bf69
Author: Hsin-Yi Chen <hsinyichen@google.com>
Date:   Tue Jul 10 04:58:13 2018 +0000

    Merge "Fix IUsb version number in vts test" into pi-dev

commit ec233bf692435c6cc1472bd2677bdf46d4befa94
Author: Hsin-Yi Chen <hsinyichen@google.com>
Date:   Wed Jul 4 10:35:01 2018 +0800

    Fix IUsb version number in vts test

    Bug: 110913709
    Test: vts-tradefed run vts -m VtsHalUsbV1_1Target
    Change-Id: I9ae6add2fe8ff7138e07797c3a191b6dfe611948
    Merged-In: I9ae6add2fe8ff7138e07797c3a191b6dfe611948
    (cherry picked from commit b4193b855c745da6772607d32f5351300ac826e1)

commit 17c39cc2e5ace81782c155bbbc05277213ffa0c8
Merge: ce6db7245 366c0abba
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jul 3 03:04:14 2018 +0000

    Snap for 4874588 from 366c0abba49abdd3039ec5f6762952143bda2e36 to pi-dr1-release

    Change-Id: Ib234049d04a3e46d00250e8403f50082f4d2078a

commit 366c0abba49abdd3039ec5f6762952143bda2e36
Merge: 75aca3976 91cc8f483
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jul 2 21:53:29 2018 +0000

    Merge "Tolerate 1 sv status in GNSS blacklist VTS test" into pi-dev

commit 75aca397636e5986918fa6b11779673aba8d01a6
Merge: 812607cf1 ec5aa6af4
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jul 2 21:46:40 2018 +0000

    Merge "Secure_element: vts: Modify openBasicChannel as per OMAPI standard" into pi-dev

commit ec5aa6af4d8b330af6c8599830942e29294aa688
Author: Ruchi Kandoi <kandoiruchi@google.com>
Date:   Mon Jul 2 13:20:34 2018 -0700

    Secure_element: vts: Modify openBasicChannel as per OMAPI standard

    CHANNEL_NOT_AVAILABLE should be returned when opening basic channel
    is not permitted on the secure element

    Test: Test with SIM1 HAL
    Bug: 110945797
    Merged-In: I2dd4eafaf4c534b49a37690a9baadcc5ac93190c
    Change-Id: I2dd4eafaf4c534b49a37690a9baadcc5ac93190c

commit 812607cf13d9ee4c604915d624428a7d7b512036
Merge: 6c72c271a 5ea5dda2c
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jul 2 21:27:55 2018 +0000

    Merge "Improve VTS GNSS 1.1 reliability." into pi-dev

commit 6c72c271ad006155dd7e0470d80f992d3be921b2
Merge: 8d555ac0a 84cff99b2
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jul 2 21:27:16 2018 +0000

    Merge "Delete time/position in InjectDelete instead of Delete_all" into pi-dev

commit 91cc8f4832882e8fa9baa04d717184636a57314d
Author: Yu-Han Yang <yuhany@google.com>
Date:   Mon Jul 2 10:48:08 2018 -0700

    Tolerate 1 sv status in GNSS blacklist VTS test

    Bug: 110969497
    Test: run VTS test on device.
    Change-Id: I26345bb62513da8530cb48672e5f59a915817cb4

commit 5ea5dda2c33f9d2f1db77d6b4493f0eb356c2937
Author: WyattRiley <wyattriley@google.com>
Date:   Thu Jun 28 15:05:14 2018 -0700

    Improve VTS GNSS 1.1 reliability.

    Allow VTS test for low power mode to handle
    certain vendor issues that supply one extra location
    at the start of low power mode.

    Allow more time for GNSS first fix, and warmup as
    needed given limited VTS access to AGPS.

    Bug: 110626730
    Bug: 110987651
    Test: (TODO) Passes on device.
    Change-Id: Ieeefd7fcd45890b03dffbbee965e1d9b17805c4c

commit 8d555ac0a46b37da5314f9fe8d7ae12143a02726
Merge: 714ddf05d bb372e598
Author: Yu-Han Yang <yuhany@google.com>
Date:   Mon Jul 2 18:08:37 2018 +0000

    Merge "Inject last location in InjectBestLocation VTS test" into pi-dev

commit 84cff99b2fcae8757704b0384552aebe290165ed
Author: Yu-Han Yang <yuhany@google.com>
Date:   Mon Jul 2 10:41:28 2018 -0700

    Delete time/position in InjectDelete instead of Delete_all

    - DELETE_ALL will delete XTRA.

    Bug: 110626730
    Test: run VTS test on device.
    Change-Id: I4f01430f24f92238193d3de6b6fbb31e81e9f006

commit ce6db72455968ae54f7cd5440370333cd6fef397
Merge: 3ccfb998b 714ddf05d
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sun Jul 1 03:04:03 2018 +0000

    Snap for 4872253 from 714ddf05d738e498054d4bdcb6eb25dd679b1319 to pi-dr1-release

    Change-Id: If67f590bd8b82ca3699739ed08d8b76d7d5cbb9b

commit bb372e5984a612cb6972e837662d64a90785fbd8
Author: Yu-Han Yang <yuhany@google.com>
Date:   Fri Jun 29 16:21:32 2018 -0700

    Inject last location in InjectBestLocation VTS test

    Bug: 110626730
    Test: run VTS on device.
    Change-Id: I6f57dd7f9164dacf011f25412e55fcd22821aca0

commit 714ddf05d738e498054d4bdcb6eb25dd679b1319
Merge: 8216f3df0 4595c66a1
Author: Kevin Rocard <krocard@google.com>
Date:   Fri Jun 29 14:36:14 2018 -0700

    Audio VTS: run tear-down hooks in LIFO instead of FIFO am: cfab8dac2b
    am: 4595c66a1e

    Change-Id: Idb84f4a8259683b825a02051264d0a6a89af24c5

commit 4595c66a1e5b5e36da2ea112b1af70f23057fd9e
Merge: 2d6e23863 cfab8dac2
Author: Kevin Rocard <krocard@google.com>
Date:   Fri Jun 29 14:12:07 2018 -0700

    Audio VTS: run tear-down hooks in LIFO instead of FIFO
    am: cfab8dac2b

    Change-Id: I10b15c6973b65229728151f5c47322ef167ae0e7

commit 01ead7c96b67f230425e8c131258d5ff9b8aa3ff
Author: Kevin Rocard <krocard@google.com>
Date:   Thu Jun 28 17:34:11 2018 -0700

    Audio VTS: run tear-down hooks in LIFO instead of FIFO

    The audio tests use a static cache of some HAL objects for
    performance reasons (speed up by 10x on Pixel).
    Those object are destroy during the test environment tear-down.

    This tear-down was destroying the objects in a FIFO instead of LIFO
    order. Thus the DeficesFactory was destroyed before the Device it
    created.

    Bug: 79889318
    Test: vts-tradefed run commandAndExit vts --module VtsHalAudioV2_0Target
          check that the device destructor is called before the
          devicesFactory one.
    Change-Id: I1b4345158139ba14a8779a9508f7ebdc41129d1d
    Merged-In: I1b4345158139ba14a8779a9508f7ebdc41129d1d
    Signed-off-by: Kevin Rocard <krocard@google.com>

commit cfab8dac2b83a3bb50f0ac7cb5a34690c818b0ef
Author: Kevin Rocard <krocard@google.com>
Date:   Thu Jun 28 17:34:11 2018 -0700

    Audio VTS: run tear-down hooks in LIFO instead of FIFO

    The audio tests use a static cache of some HAL objects for
    performance reasons (speed up by 10x on Pixel).
    Those object are destroy during the test environment tear-down.

    This tear-down was destroying the objects in a FIFO instead of LIFO
    order. Thus the DeficesFactory was destroyed before the Device it
    created.

    Bug: 79889318
    Test: vts-tradefed run commandAndExit vts --module VtsHalAudioV2_0Target
          check that the device destructor is called before the
          devicesFactory one.
    Change-Id: I1b4345158139ba14a8779a9508f7ebdc41129d1d
    Signed-off-by: Kevin Rocard <krocard@google.com>

commit 8216f3df076b3db4c6b5e0de3b2acb1b4cebeadb
Merge: 897b56e2a 0fdd7cdc0
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Fri Jun 29 15:00:41 2018 +0000

    Merge "Camera: Allow 3% ISO tolerance during ISO burst VTS" into pi-dev

commit 897b56e2a8c21ad8df5bf191f7cce76cb7c27c21
Merge: 72641e7ad ae8da1b70
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Fri Jun 29 10:57:17 2018 +0000

    Merge "Fixing Keymaster documentation." into pi-dev

commit 72641e7ad014a011562c3fd16444b919d32aeb63
Author: Kevin Rocard <krocard@google.com>
Date:   Thu Jun 28 18:00:05 2018 -0700

    Audio VTS was testing wrong uninitialized variable due to typo

    The test was testing a uninitialized variable instead of testing
    the result of the tested method.

    Bug: 110963314
    Test: vts-tradefed run commandAndExit vts --module VtsHalAudioV2_0Target
    Change-Id: I9a212eef690ae627fd7f7dbfaf4a0b4047c491b3
    Signed-off-by: Kevin Rocard <krocard@google.com>

commit 3ccfb998b098988e6a64d24b89c2b77bf9c5a228
Merge: 6734efb7f 6558989b5
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 28 03:32:16 2018 +0000

    Merge "Snap for 4866883 from 518b8253b03e42ce2bd8bbeeb9b5411ee509ab0b to pi-dr1-release" into pi-dr1-release

commit 6558989b560dca779b34ab6334a95fefecbad736
Merge: 66d92fb0d 518b8253b
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 28 03:24:07 2018 +0000

    Snap for 4866883 from 518b8253b03e42ce2bd8bbeeb9b5411ee509ab0b to pi-dr1-release

    Change-Id: If2b6ae31e366395992fffe6c4bf03dbedb638b89

commit 6734efb7fd0ea91f5581f64646dc98fed48d68c1
Merge: 66d92fb0d 518b8253b
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 28 03:12:46 2018 +0000

    Snap for 4866863 from 518b8253b03e42ce2bd8bbeeb9b5411ee509ab0b to pi-dr1-release

    Change-Id: I44999d0b19f063952696a1cc2793550a3b3e40d9

commit 518b8253b03e42ce2bd8bbeeb9b5411ee509ab0b
Merge: be8beb8c0 529d2fffa
Author: Nathan Harold <nharold@google.com>
Date:   Wed Jun 27 22:26:25 2018 +0000

    Merge "Add docs for setSignalStrengthReportingCriteria" into pi-dev

commit be8beb8c0a0d725c1192fa765831eb33e28634c8
Merge: 01e286d5a c0e2e2b07
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Jun 27 22:12:19 2018 +0000

    Merge "Fix missed refactor of serial" into pi-dev

commit c0e2e2b071df5cdff10193556163e2975f0b682c
Author: sqian <shuoq@google.com>
Date:   Wed Jun 27 12:12:26 2018 -0700

    Fix missed refactor of serial

    Bug: 109822806
    Test: run vts
    Change-Id: If88384699dbb4c2ddd1c580d2b35be38afd0f8e8

commit 66d92fb0d6385b8cc98b015fedef12a68ad826df
Merge: cb68242ff 01e286d5a
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 27 03:15:58 2018 +0000

    Snap for 4864428 from 01e286d5a71fd7a99ff40c44b16086f340adf7d3 to pi-dr1-release

    Change-Id: I27c2ddee55a26a94e3558342fc10d989e8f3fb1e

commit 01e286d5a71fd7a99ff40c44b16086f340adf7d3
Merge: 409b5fd5f 0215d11cf
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Jun 27 01:51:07 2018 +0000

    Merge "Revert "Handle radio API in low version VTS for high version service"" into pi-dev

commit 0215d11cf266219245e27234d65e8f9eeac9f6c0
Author: Shuo Qian <shuoq@google.com>
Date:   Wed Jun 27 00:33:10 2018 +0000

    Revert "Handle radio API in low version VTS for high version service"

    This reverts commit cabe101cd2dc945b6b4ef4295f4fa650077d0c62.

    Bug: 109839239

    Reason for revert: Treble/VTS backward compatibility

    Change-Id: Ibef1d91261fe6318c65fd617a2bee7f5d69bebae

commit 409b5fd5fbba6b59217e691db7c6e8dcd5bcc837
Merge: 1e757749f 7b75f015a
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jun 26 23:57:01 2018 +0000

    Merge "keymaster: spec does not require that update produce output" into pi-dev

commit 7b75f015a7a7ebc40722fd4f36c9ca70e7e58e59
Author: nagendra modadugu <ngm@google.com>
Date:   Mon Jun 25 19:56:35 2018 -0700

    keymaster: spec does not require that update produce output

    Remove out of spec enforcement on the amount of data returned
    by update, as this is not specified in the HAL.

    Bug: 109771020
    Test: yes it is
    Change-Id: Ic41afbd01d51faf48d3c0fe090409ebcd257cc1e

commit 1e757749fbb770fc3cfcb17cf171832b5093a8a7
Merge: 9d114dbf8 cabe101cd
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jun 26 20:08:32 2018 +0000

    Merge "Handle radio API in low version VTS for high version service" into pi-dev

commit 9d114dbf88a53127372ab18726ed95b6bba18461
Merge: e4722f92d 6c9c6e62c
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jun 26 19:15:33 2018 +0000

    Merge "Allow getCapturePosition to return 0 frames for unprepared streams" into pi-dev

commit cabe101cd2dc945b6b4ef4295f4fa650077d0c62
Author: sqian <shuoq@google.com>
Date:   Wed Jun 6 20:55:15 2018 -0700

    Handle radio API in low version VTS for high version service

    There are some request/response pair that could be replaced in
    higher-version hal. Radio service need to handle
    these request/response pair specific to version number. For example,
    e.g. getVoiceRegistrationStateResponse_1_2 replaces
    getVoiceRegistrationStateResponse for getVoiceRegistrationState
    in 1.2 radio service. We need to add util and update version number
    of IRadio service to check the version for testing the correct
    behavior.

    Bug: 109839239
    Test: run vts
    Change-Id: I291690e77ea0e6e37fe75219e550f79fa44fb840

commit 6c9c6e62c193461ed0de4666d0995631ba39e009
Author: Kevin Rocard <krocard@google.com>
Date:   Thu Jun 21 14:10:58 2018 -0700

    Allow getCapturePosition to return 0 frames for unprepared streams

    For device supporting getCapturePosition,
    VTS only allowed unprepared stream to return INVALID_STATE.
    Now also allow for the stream to return 0 frames similarly to the other
    non started states.

    Test: vts-tradefed run commandAndExit vts --module VtsHalAudioV2_0Target
    Bug: 110367728
    Cherry-piked from: d01dc3edac9e92981e7ae419d0e7622f753acf94
    Change-Id: Ibdf8df8cb8809e98c40a50035371df6893fe4da4
    Signed-off-by: Kevin Rocard <krocard@google.com>

commit 0fdd7cdc0eab249e0f0615fad1034231c09987dd
Author: Emilian Peev <epeev@google.com>
Date:   Tue Jun 26 09:17:33 2018 +0100

    Camera: Allow 3% ISO tolerance during ISO burst VTS

    The advertised ISO ranges may not be entirely supported on
    some devices. Expect a 3% tolerance when comparing the applied
    results versus the expected ISO value.

    Bug: 80025874
    Test: run vts --skip-all-system-status-check --skip-preconditions
    --primary-abi-only --module VtsHalCameraProviderV2_4Target -l INFO

    Change-Id: Ibd2758e48a0924e81877e35dd27433669274fdb3

commit cb68242ff51afaa23270f01596881264bc93a089
Merge: 3345669a9 e4722f92d
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jun 26 03:16:41 2018 +0000

    Snap for 4861493 from e4722f92ddbe325a14882f226d5e752d558d1b24 to pi-dr1-release

    Change-Id: I1d77689c7e9355a178860d8806fce90b97099fe1

commit e4722f92ddbe325a14882f226d5e752d558d1b24
Merge: be04f192e c7896501d
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jun 26 00:05:19 2018 +0000

    Merge "Allow NOT_SUPPORTED for setLinkCapacityReportingCriteria on GERAN." into pi-dev

commit be04f192e96c854c18828d194996ef85eea9bb05
Merge: 7dab610c3 d898d0a42
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jun 25 23:40:02 2018 +0000

    Merge "Fix attestation test." into pi-dev

commit c7896501db413c9a0fa44d2697da4079610075d8
Author: Amit Mahajan <amitmahajan@google.com>
Date:   Mon Jun 25 14:16:37 2018 -0700

    Allow NOT_SUPPORTED for setLinkCapacityReportingCriteria on GERAN.

    Test: run vts -m VtsHalRadioV1_2Target
    Bug: 110716988
    Change-Id: I9a5f014d498db00d818870cbd73e119f66562ef1

commit 7dab610c3612f6a939da765fc458f4215951002d
Merge: a0ff82f78 2bb626a29
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jun 25 20:52:42 2018 +0000

    Merge "Call notify for voiceReg and dataReg VTS tests" into pi-dev

commit a0ff82f781bde09acef6b804a200d7dd558d132e
Merge: d33b77a19 0ff41b94b
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jun 25 20:06:25 2018 +0000

    Merge "Add setIndicationFilter response notification in 1.2 VTS" into pi-dev

commit 529d2fffa02451406f013b354fd7c07164f619b1
Author: Nathan Harold <nharold@google.com>
Date:   Thu Jun 21 11:46:42 2018 -0700

    Add docs for setSignalStrengthReportingCriteria

    Because setSignalStrengthReportingCriteria only
    supports a single measurement quantity, provide
    further clarification on the applicability of the
    API and how it may be used in various situations.

    Bug: 110121199
    Test: compilation - docstring-only change
    Merged-In: If4236070fbc03368e5a78b0cf502cdc4a529a6ed
    Change-Id: If4236070fbc03368e5a78b0cf502cdc4a529a6ed

commit d898d0a4223df75225cfdf23e6f184166933cdb3
Author: Shawn Willden <swillden@google.com>
Date:   Tue Jun 19 22:10:03 2018 -0600

    Fix attestation test.

    Bug: 77588764
    Test: VtsHalKeymasterV4_0TargetTest
    Change-Id: Ibe264d08ae7b3333a6949761a92759f5305b3fcb

commit 3345669a9ee67f5822e4769b2877b14c07cb92c9
Merge: 65a3e35fe d33b77a19
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sun Jun 24 03:01:48 2018 +0000

    Snap for 4859140 from d33b77a1942bb86b4c63859c0b1c70618111599c to pi-dr1-release

    Change-Id: I26b3e16088c475556fa928d5830bdab4552e1bbf

commit d33b77a1942bb86b4c63859c0b1c70618111599c
Merge: 2aae65f84 431eb118f
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Fri Jun 22 23:53:09 2018 +0000

    Merge "Fixed VTS failure in no SIM case" into pi-dev

commit 2aae65f84453c31160f02fcf53ccc26e3625018a
Merge: d8725d152 e3ff41fc1
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Fri Jun 22 23:45:38 2018 +0000

    Merge "Add VTS test to verify scheduling capability" into pi-dev

commit d8725d1521b97c3a0a6c5b7e8e9e1cb9b7ead1d8
Merge: dfe1131c9 07eabef42
Author: Peiyong Lin <lpy@google.com>
Date:   Fri Jun 22 23:40:28 2018 +0000

    Merge "Update power HAL to version 1.3." into pi-dev

commit dfe1131c973479cbd5d7e0612da0706d9d86475d
Merge: ab0704aed 7470cbd04
Author: Shuo Qian <shuoq@google.com>
Date:   Fri Jun 22 23:29:14 2018 +0000

    Merge "Add REQUEST_NOT_SUPPORTED for changeIccPinForApp and changeIccPin2ForApp" into pi-dev

commit 431eb118f84de14c94ec18f887197944ec17e712
Author: Jack Yu <jackyu@google.com>
Date:   Fri Jun 22 13:31:09 2018 -0700

    Fixed VTS failure in no SIM case

    Added RadioError::NONE as a possible return value for data call
    setup API. The data call could be setup for emergency purposes
    when no SIM inserted.

    Test: VTS
    Bug: 109767888
    Change-Id: I4469c371f999b99d35f4078df000f05ee1f3c84d

commit 07eabef427ce8851f91a24ff29a4ab98e18ceff2
Author: Michael Wright <michaelwr@google.com>
Date:   Thu Jun 21 02:42:31 2018 +0100

    Update power HAL to version 1.3.

    Adds new EXPENSIVE_RENDERING power hint.

    This adds a new library which does not affect any pre-existing
    targets unless they create and add a new binary which uses this.

    BUG: 110112323
    Test: adb shell /data/nativetest/VtsHalPowerV1_3TargetTest/VtsHalPowerV1_3TargetTest
    Change-Id: I5fb33abbbe4c4958882a106dfa400ad74013e40d

commit ab0704aed2e96f80a48f2125e84325e00e4043cb
Merge: b6093dccf a7587b5a7
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Thu Jun 21 20:25:00 2018 +0000

    Merge "Allow REQUEST_NOT_SUPPORTED as an error for startNetworkScan" into pi-dev

commit ae8da1b70ad563edb79f4f7429b704b54c1a9e19
Author: Eran Messeri <eranm@google.com>
Date:   Tue Jun 19 17:12:04 2018 +0100

    Fixing Keymaster documentation.

    Keymaster HAL documentation documents the bootPatchLevel as having
    tag 718, while types.hal indicates the tag value for it is actually
    719.

    Test: N/A
    Bug: 78104779
    Change-Id: I0dde0b3c863081f2594e20466d8e82866a5f2d2e

commit 65a3e35fe08c0bc252b9d0b4d4a20ea4759d1a03
Merge: 6b21c7705 b6093dccf
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 21 03:03:17 2018 +0000

    Snap for 4853718 from b6093dccf01c6bd5fbcb6123b8930266ea1a3fda to pi-dr1-release

    Change-Id: Ibf23253830e402cbe4583573f885039897f33891

commit a7587b5a7fdace0d193ad333e6f5cda8b995570b
Author: Amit Mahajan <amitmahajan@google.com>
Date:   Fri Jun 15 11:16:28 2018 -0700

    Allow REQUEST_NOT_SUPPORTED as an error for startNetworkScan

    We are trying to tighten the APIs. However for this case since the
    documentation was not updated, we are allowing NOT_SUPPORTED for
    now and will be cleaned up in a later release.

    Test: run vts -m VtsHalRadioV1_2Target
    Bug: 110118713
    Change-Id: Id9dd3d7bac99bed36ceb9c906189f1fea78d5a2c

commit b6093dccf01c6bd5fbcb6123b8930266ea1a3fda
Merge: f053b3de2 a1c4e0ec5
Author: Janis Danisevskis <jdanis@google.com>
Date:   Wed Jun 20 22:32:13 2018 +0000

    Merge "Relax HMAC computation check" into pi-dev

commit a1c4e0ec5deaf3c6c4e8694afd67eb5a24bd0fa5
Author: Janis Danisevskis <jdanis@google.com>
Date:   Tue Jun 19 19:08:15 2018 -0700

    Relax HMAC computation check

    This KM4 key agreement check is causing some pain on early units
    that aren't completely provisioned in both locked and non-Green
    (unlocked) states.

    This doesn't impact KM3 devices (Pixel 2016/2017 etc.)

    Bug: 110301629
    Change-Id: I5a737ac8a335863b1099c29cf3c0496adeb41e15

commit 6b21c7705c7dd69b751fea4b31cbc81ff73c8ee9
Merge: 05f29744a f053b3de2
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 20 03:05:56 2018 +0000

    Snap for 4850855 from f053b3de23ed63f1401cb61317d596e9330d35a1 to pi-dr1-release

    Change-Id: I945cbd9bc8bf4b033ac8398ab3e6494e89282c5d

commit f053b3de23ed63f1401cb61317d596e9330d35a1
Merge: 4f0d19ebf 76fa88e7a
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Jun 20 00:05:56 2018 +0000

    Merge "Add hwcomposer to the system-background cpuset for hal v2.2" into pi-dev

commit 4f0d19ebff1f4a3eb565d8432f44b561ebd4abe2
Author: Yu-Han Yang <yuhany@google.com>
Date:   Thu Jun 14 14:17:58 2018 -0700

    Set the floor value of time estimate as 2017 Jan 01 00:00:00 GMT

    - The VTS test checks if the time estimate is a sane value. Thus, any
    arbitrary sane value is acceptable. Here we make it consistent to
    IGnssDebug.hal, where a comment mentions 2017 Jan 1 as an example of
    the value.

    Bug: 110094003
    Test: make vts, and tested on device.
    Merged-In: Ic4f6b597a718ea3e98a67c7939f9e6930d44d224
    Change-Id: Ic4f6b597a718ea3e98a67c7939f9e6930d44d224
    (cherry picked from commit 5fa43c83e90ccd0f852c89feb0e071aad195d7b2)

commit 7470cbd04dbb90ec4a6481d08db54c6a8c5f2efd
Author: sqian <shuoq@google.com>
Date:   Fri Jun 15 14:24:31 2018 -0700

    Add REQUEST_NOT_SUPPORTED for changeIccPinForApp and changeIccPin2ForApp

    Bug: 110037298
    Test: run vts -m VtsHalRadioV1_0Target
    Change-Id: Iaba800814c5a6950d086a2f105714d01fdaa14a4

commit 05f29744aa30d7363ebc200b51bc3db6ae9f22be
Merge: 68b0fbb24 db94365e7
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jun 19 03:06:29 2018 +0000

    Snap for 4848184 from db94365e732de859fadeaa2e7b422b1ecbe66d6b to pi-dr1-release

    Change-Id: I1e917c61fff7da3752a299a59ed63f602bddc997

commit 76fa88e7a01a5a0cb3588710dae7e35b002de124
Author: Carmen Jackson <carmenjackson@google.com>
Date:   Thu Jun 14 14:53:14 2018 -0700

    Add hwcomposer to the system-background cpuset for hal v2.2

    This change was made for hal v2.1 but not cross-ported to 2.2.

    Bug: 110167043
    Test: $ adb shell ps -A | grep composer
    system  630 ...  android.hardware.graphics.composer@2.2-service
    $ adb shell cat /proc/630/cpuset
    /system-background

    Change-Id: I40b8a0386a7cf67fe64b1e0e40d81b78891faaca

commit db94365e732de859fadeaa2e7b422b1ecbe66d6b
Merge: e70531a92 eb159af99
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jun 18 23:35:25 2018 +0000

    Merge "health: Update README to remove .override [DO NOT MERGE]" into pi-dev

commit eb159af99494bd26a3c6d41b88614eb0b832ba04
Author: Yifan Hong <elsk@google.com>
Date:   Mon Jun 18 14:39:01 2018 -0700

    health: Update README to remove .override [DO NOT MERGE]

    The .override module does not have correct rc and
    sepolicy file_contexts configured, so let's allow
    OEMs to keep healthd. If an OEM does want to remove
    healthd they can provide a device-specific
    health service impl.

    Test: none
    Bug: 110228707
    Change-Id: I9ba32ae366df4ba58994ef0e3f9eb57cab5626f7

commit e70531a92e0318e61a28903a043892e09c9f2d93
Merge: 6e7870938 2d6e23863
Author: sqian <shuoq@google.com>
Date:   Mon Jun 18 14:33:01 2018 -0700

    Fix setBandMode. am: ab2b8bf919 am: d88330667d am: ea34bd6a05
    am: 2d6e238637

    Change-Id: Ieb380a674df9d73fac14a30dc084251c7db3f3e9

commit 6e787093817847e59b2374bae9eb7153083e0141
Merge: 17be71d39 b24e51a89
Author: sqian <shuoq@google.com>
Date:   Mon Jun 18 14:28:31 2018 -0700

    [automerger skipped] Fix setBandMode. am: ab2b8bf919  -s ours am: d1e489c94c
    am: b24e51a892

    Change-Id: Ia2929b679bd5f6d0244876a725e4ea334355835c

commit 2d6e238637114af07a3bd8b04ee39b5faa9bcdfa
Merge: b24e51a89 ea34bd6a0
Author: sqian <shuoq@google.com>
Date:   Mon Jun 18 14:28:30 2018 -0700

    Fix setBandMode. am: ab2b8bf919 am: d88330667d
    am: ea34bd6a05

    Change-Id: I58bf1b67184a14f70d49b46c5da8c225406ed1ed

commit b24e51a89233395eb95093acfaba2e1d9603ee08
Merge: 006436f92 d1e489c94
Author: sqian <shuoq@google.com>
Date:   Mon Jun 18 14:24:00 2018 -0700

    [automerger skipped] Fix setBandMode. am: ab2b8bf919  -s ours
    am: d1e489c94c

    Change-Id: I26809cbc6614c4dc71dfe76e5df24ac06ed8946a

commit ea34bd6a052082253fd9d907141870b7fabaf03d
Merge: e0c3d0c3f d88330667
Author: sqian <shuoq@google.com>
Date:   Mon Jun 18 14:23:56 2018 -0700

    Fix setBandMode. am: ab2b8bf919
    am: d88330667d

    Change-Id: Ibf1c624c097956ec0a769f98a3cf5abe74ecc020

commit d88330667d1e285b4590ca9d34d409642fb2d7d1
Merge: 5de1ae23f ab2b8bf91
Author: sqian <shuoq@google.com>
Date:   Mon Jun 18 14:20:24 2018 -0700

    Fix setBandMode.
    am: ab2b8bf919

    Change-Id: Ie8bbd67d2d0ffe1af57672fd4990cfabb751ef7a

commit d1e489c94caa6338fe3486438274fbaa2bf21a2d
Merge: 9886d749d ab2b8bf91
Author: sqian <shuoq@google.com>
Date:   Mon Jun 18 14:10:59 2018 -0700

    [automerger skipped] Fix setBandMode.
    am: ab2b8bf919  -s ours

    Change-Id: Ibbdfad48f943c35419a91ccf8b3d4651bfab88f1

commit 17be71d3971114cd4ed1e33ba7835187a01a23c5
Merge: f3d1d3aed 3a7e2cade
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jun 18 17:26:22 2018 +0000

    Merge "Respect limited requirements for Strongbox KM implementations" into pi-dev

commit ab2b8bf9193364c42fef1007b1744c49641a97fb
Author: sqian <shuoq@google.com>
Date:   Mon Jun 11 18:37:13 2018 -0700

    Fix setBandMode.

    Bug: 67834975
    Test: sanity

    Merged-In: Ie907cdb464a44d92be47d898151d71eb2d83a11c

commit 3a7e2cade3305d59f861c21206b5862de9d05d5c
Author: nagendra modadugu <ngm@google.com>
Date:   Tue Jun 5 11:05:19 2018 -0700

    Respect limited requirements for Strongbox KM implementations

    With this patch the KM VTS test apply the restricted requirements on
    supported key sizes, EC curves, and Digests to Strongbox keymaster
    implementations.

    Also amend tests to use Update().

    Test: Yes it is
    Bug: 74519020
    Change-Id: Ibec9c3398671f81dbc0ecf78e554726276160579

commit 68b0fbb2421da4dd017700cacfee82d2f9448a39
Merge: 1f5acee33 f3d1d3aed
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sun Jun 17 03:05:21 2018 +0000

    Snap for 4845430 from f3d1d3aed3e689db34e06450dd8914d056fb4107 to pi-dr1-release

    Change-Id: Ia94a2d5a163104b05bde6ba76ab20c329dfe36c6

commit e3ff41fc12fb7a80ee533e4459035ef4545c174d
Author: Vishal Agarwal <agarwalvishal@google.com>
Date:   Tue Jun 5 18:42:01 2018 -0700

    Add VTS test to verify scheduling capability

    2018+ devices must support GNSS capability scheduling
    Test results: go/vts-review-bucket/pi-dev/4267645

    Bug: 109642198
    Test: atest VtsHalGnssV1_0TargetTest
    Change-Id: I7394674abca8f8c40ab30403be6b41bbbb279956

commit f3d1d3aed3e689db34e06450dd8914d056fb4107
Merge: 79db3ec84 817848e59
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Thu Jun 14 17:16:03 2018 +0000

    Merge "Allow general errors for getImsiForApp()." into pi-dev

commit 817848e59e18334a30f623ef143cf182716fd3fa
Author: Amit Mahajan <amitmahajan@google.com>
Date:   Tue Jun 12 15:23:39 2018 -0700

    Allow general errors for getImsiForApp().

    This is to match it with other 1.0 tests where general errors are
    allowed. For newer tests we have decided to not allow these errors,
    but a failure for this old test is reported when run with SIM
    present.

    Test: run vts -m VtsHalRadioV1_0Target
    Bug: 109889468
    Change-Id: If36083b7832706a50805932e8ba08e4eb397f3fe

commit 1f5acee33203729f3cfdaef6b06d1f3cbdf07545
Merge: 0f8bc5ab4 79db3ec84
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jun 12 03:05:28 2018 +0000

    Snap for 4834273 from 79db3ec849c5f1142a0802dccfff6cbef564ff76 to pi-dr1-release

    Change-Id: I8a931401754c32491f75996c4e9b5b93f10d1935

commit 0f8bc5ab42ab271b6b44ce5ded03dcf56732c012
Merge: b6bd92ae1 2c82288f4
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Sun Jun 10 03:03:53 2018 +0000

    Snap for 4832091 from 2c82288f49d865c516fcd6d83bcd819e28b9a221 to pi-dr1-release

    Change-Id: I0ca6dfae5c6b04fcc19daa915793d803bd939680

commit 79db3ec849c5f1142a0802dccfff6cbef564ff76
Author: Hung-ying Tyan <tyanh@google.com>
Date:   Fri Jun 8 17:53:48 2018 +0800

    Fix free() in keymaster VTS

    The buffer is allocated by OPENSSL_malloc() in X509_NAME_oneline(name, nullptr, 0).
    Should be reclaimed by OPENSSL_free() instead of free().

    The patch is provided by vink.shen@mediatek.corp-partner.google.com

    Bug: 109708231
    Test: build pass
    Change-Id: I66a864e3e28905eebac2e7d3a4517d4d5aaa39df

commit 0ff41b94b30a0db0ce4a6a5b29600ced5853a762
Author: sqian <shuoq@google.com>
Date:   Wed Jun 6 22:35:20 2018 -0700

    Add setIndicationFilter response notification in 1.2 VTS

    Test: compile
    Bug: 109822806
    Change-Id: I95102a148a26cab80235cc68ad83143a9bb6eb39

commit b6bd92ae147004a503c9f705179e3b6b7e53d8fc
Merge: 8dda23cf5 0be954949
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Jun 7 03:04:26 2018 +0000

    Snap for 4826407 from 0be954949ddf098fb9ab28c523b04aceeb575323 to pi-dr1-release

    Change-Id: Ia0e21aa14b23b1f31d9d48f750742d4a4ad75c78

commit 2bb626a2975ef3398adbcb12fe50804cf71efc39
Author: Eric Schwarzenbach <easchwar@google.com>
Date:   Wed Jun 6 16:09:58 2018 -0700

    Call notify for voiceReg and dataReg VTS tests

    Bug: 80554443
    Test: vts
    Change-Id: I19f7131f7b65323065f3c283a89668ff761815e3

commit 8dda23cf520a5c1f0cf633fb477cb177637f46de
Merge: 3e44949a3 3b50bd927
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Jun 6 03:07:24 2018 +0000

    Snap for 4823496 from 3b50bd927b7c494d04657383d486aa0b862b3fe5 to pi-dr1-release

    Change-Id: I7df22cde173c961e76ef3c2c814aa860a8e702b7

commit 3e44949a3b001adbb894cd4b537f5eb77a4b261e
Merge: c495cdbe2 62fd03d8e
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jun 5 03:02:14 2018 +0000

    Snap for 4820872 from 62fd03d8e64f368fadce4a972ead88404f94b21d to pi-dr1-release

    Change-Id: I8f5b0e2ba78ae01fd66aefbd1e4df0418a50570e

Change-Id: Id684b597f56cf1ee9a9bada464b6dc6d76fad4a7
---
 .../android.hardware.audio@2.0-service.rc     |   3 +-
 .../include/utility/EnvironmentTearDown.h     |   2 +-
 .../functional/AudioPrimaryHidlHalTest.cpp    |  17 ++-
 .../2.0/xml/audio_effects_conf_V2_0.xsd       |   2 +-
 .../3.2/default/CameraDeviceSession.cpp       |  50 ++++++-
 .../device/3.2/default/CameraDeviceSession.h  |   5 +
 .../3.3/default/CameraDeviceSession.cpp       |   2 +
 .../3.4/default/CameraDeviceSession.cpp       |  43 +++++-
 .../device_v3_4_impl/CameraDeviceSession.h    |   2 +
 .../VtsHalCameraProviderV2_4TargetTest.cpp    |  14 +-
 .../compatibility_matrix.3.xml                |   2 +-
 current.txt                                   |   8 +-
 drm/1.0/default/DrmFactory.cpp                |   2 +-
 drm/1.0/default/LegacyPluginPath.cpp          |  16 ++-
 drm/1.0/default/include/PluginLoader.h        |   5 +-
 .../functional/VtsHalGnssV1_0TargetTest.cpp   |  16 ++-
 gnss/1.1/vts/functional/gnss_hal_test.cpp     |  11 +-
 gnss/1.1/vts/functional/gnss_hal_test.h       |   9 +-
 .../vts/functional/gnss_hal_test_cases.cpp    |  77 +++++-----
 ....hardware.graphics.composer@2.2-service.rc |   1 +
 health/2.0/README                             |   7 +-
 keymaster/4.0/IKeymasterDevice.hal            |   2 +-
 keymaster/4.0/support/Keymaster.cpp           |   8 +-
 keymaster/4.0/support/attestation_record.cpp  |  29 +++-
 .../include/keymasterV4_0/key_param_output.h  |   4 +
 .../include/keymasterV4_0/keymaster_tags.h    |   6 +-
 .../vts/functional/VerificationTokenTest.cpp  |   5 +-
 .../functional/keymaster_hidl_hal_test.cpp    | 134 ++++++++++--------
 .../VtsHalMediaOmxV1_0TargetAudioDecTest.cpp  |  10 ++
 power/1.3/Android.bp                          |  21 +++
 power/1.3/IPower.hal                          |  33 +++++
 power/1.3/types.hal                           |  28 ++++
 power/1.3/vts/functional/Android.bp           |  27 ++++
 .../functional/VtsHalPowerV1_3TargetTest.cpp  |  64 +++++++++
 radio/1.0/IRadioResponse.hal                  |   2 +
 .../1.0/vts/functional/radio_hidl_hal_icc.cpp |  19 ++-
 .../vts/functional/radio_hidl_hal_misc.cpp    |  15 +-
 radio/1.2/IRadio.hal                          |  23 ++-
 .../1.2/vts/functional/radio_hidl_hal_api.cpp |  70 ++++++---
 radio/1.2/vts/functional/radio_response.cpp   |   4 +-
 .../VtsHalSecureElementV1_0TargetTest.cpp     |   2 +-
 .../functional/VtsHalUsbV1_1TargetTest.cpp    |   2 +-
 42 files changed, 618 insertions(+), 184 deletions(-)
 create mode 100644 power/1.3/Android.bp
 create mode 100644 power/1.3/IPower.hal
 create mode 100644 power/1.3/types.hal
 create mode 100644 power/1.3/vts/functional/Android.bp
 create mode 100644 power/1.3/vts/functional/VtsHalPowerV1_3TargetTest.cpp

diff --git a/audio/common/all-versions/default/service/android.hardware.audio@2.0-service.rc b/audio/common/all-versions/default/service/android.hardware.audio@2.0-service.rc
index 8217b946..6e91bccb 100644
--- a/audio/common/all-versions/default/service/android.hardware.audio@2.0-service.rc
+++ b/audio/common/all-versions/default/service/android.hardware.audio@2.0-service.rc
@@ -2,7 +2,8 @@ service vendor.audio-hal-2-0 /vendor/bin/hw/android.hardware.audio@2.0-service
     class hal
     user audioserver
     # media gid needed for /dev/fm (radio) and for /data/misc/media (tee)
-    group audio camera drmrpc inet media mediadrm net_bt net_bt_admin net_bw_acct
+    group audio camera drmrpc inet media mediadrm net_bt net_bt_admin net_bw_acct wakelock
+    capabilities BLOCK_SUSPEND
     ioprio rt 4
     writepid /dev/cpuset/foreground/tasks /dev/stune/foreground/tasks
     # audioflinger restarts itself when it loses connection with the hal
diff --git a/audio/common/all-versions/test/utility/include/utility/EnvironmentTearDown.h b/audio/common/all-versions/test/utility/include/utility/EnvironmentTearDown.h
index a96d06e0..7a08a54f 100644
--- a/audio/common/all-versions/test/utility/include/utility/EnvironmentTearDown.h
+++ b/audio/common/all-versions/test/utility/include/utility/EnvironmentTearDown.h
@@ -37,7 +37,7 @@ namespace utility {
 class Environment : public ::testing::VtsHalHidlTargetTestEnvBase {
    public:
     using TearDownFunc = std::function<void()>;
-    void registerTearDown(TearDownFunc&& tearDown) { tearDowns.push_back(std::move(tearDown)); }
+    void registerTearDown(TearDownFunc&& tearDown) { tearDowns.push_front(std::move(tearDown)); }
 
    private:
     void HidlTearDown() override {
diff --git a/audio/core/4.0/vts/functional/AudioPrimaryHidlHalTest.cpp b/audio/core/4.0/vts/functional/AudioPrimaryHidlHalTest.cpp
index c764ea62..0f8996fc 100644
--- a/audio/core/4.0/vts/functional/AudioPrimaryHidlHalTest.cpp
+++ b/audio/core/4.0/vts/functional/AudioPrimaryHidlHalTest.cpp
@@ -106,7 +106,10 @@ using namespace ::android::hardware::audio::common::test::utility;
 static auto okOrNotSupported = {Result::OK, Result::NOT_SUPPORTED};
 static auto okOrNotSupportedOrInvalidArgs = {Result::OK, Result::NOT_SUPPORTED,
                                              Result::INVALID_ARGUMENTS};
+static auto okOrInvalidStateOrNotSupported = {Result::OK, Result::INVALID_STATE,
+                                              Result::NOT_SUPPORTED};
 static auto invalidArgsOrNotSupported = {Result::INVALID_ARGUMENTS, Result::NOT_SUPPORTED};
+static auto invalidStateOrNotSupported = {Result::INVALID_STATE, Result::NOT_SUPPORTED};
 
 class AudioHidlTestEnvironment : public ::Environment {
    public:
@@ -555,11 +558,11 @@ TEST_F(AudioPrimaryHidlTest, SetConnectedState) {
             address.device = deviceType;
             auto ret = device->setConnectedState(address, state);
             ASSERT_TRUE(ret.isOk());
-            if (res == Result::NOT_SUPPORTED) {
+            if (ret == Result::NOT_SUPPORTED) {
                 doc::partialTest("setConnectedState is not supported");
                 return;
             }
-            ASSERT_OK(res);
+            ASSERT_OK(ret);
         }
     }
 }
@@ -949,8 +952,6 @@ TEST_IO_STREAM(RemoveNonExistingEffect, "Removing a non existing effect should f
 TEST_IO_STREAM(standby, "Make sure the stream can be put in stanby",
                ASSERT_OK(stream->standby()))  // can not fail
 
-static constexpr auto invalidStateOrNotSupported = {Result::INVALID_STATE, Result::NOT_SUPPORTED};
-
 TEST_IO_STREAM(startNoMmap, "Starting a mmaped stream before mapping it should fail",
                ASSERT_RESULT(invalidStateOrNotSupported, stream->start()))
 
@@ -1070,11 +1071,15 @@ TEST_P(InputStreamTest, GetInputFramesLost) {
 TEST_P(InputStreamTest, getCapturePosition) {
     doc::test(
         "The capture position of a non prepared stream should not be "
-        "retrievable");
+        "retrievable or 0");
     uint64_t frames;
     uint64_t time;
     ASSERT_OK(stream->getCapturePosition(returnIn(res, frames, time)));
-    ASSERT_RESULT(invalidStateOrNotSupported, res);
+    ASSERT_RESULT(okOrInvalidStateOrNotSupported, res);
+    if (res == Result::OK) {
+        ASSERT_EQ(0U, frames);
+        ASSERT_LE(0U, time);
+    }
 }
 
 TEST_P(InputStreamTest, updateSinkMetadata) {
diff --git a/audio/effect/2.0/xml/audio_effects_conf_V2_0.xsd b/audio/effect/2.0/xml/audio_effects_conf_V2_0.xsd
index ca6a7dc6..df281b32 100644
--- a/audio/effect/2.0/xml/audio_effects_conf_V2_0.xsd
+++ b/audio/effect/2.0/xml/audio_effects_conf_V2_0.xsd
@@ -234,7 +234,7 @@
       <xs:field xpath="@library"/>
     </xs:keyref>
     <xs:key name="effectName">
-      <xs:selector xpath="aec:effects/aec:effect"/>
+      <xs:selector xpath="aec:effects/aec:effect|aec:effects/aec:effectProxy"/>
       <xs:field xpath="@name"/>
     </xs:key>
     <xs:keyref name="effectNamePreRef" refer="aec:effectName">
diff --git a/camera/device/3.2/default/CameraDeviceSession.cpp b/camera/device/3.2/default/CameraDeviceSession.cpp
index 69f85356..fd785df1 100644
--- a/camera/device/3.2/default/CameraDeviceSession.cpp
+++ b/camera/device/3.2/default/CameraDeviceSession.cpp
@@ -53,6 +53,7 @@ CameraDeviceSession::CameraDeviceSession(
         camera3_callback_ops({&sProcessCaptureResult, &sNotify}),
         mDevice(device),
         mDeviceVersion(device->common.version),
+        mFreeBufEarly(shouldFreeBufEarly()),
         mIsAELockAvailable(false),
         mDerivePostRawSensKey(false),
         mNumPartialResults(1),
@@ -129,6 +130,10 @@ bool CameraDeviceSession::initialize() {
     return false;
 }
 
+bool CameraDeviceSession::shouldFreeBufEarly() {
+    return property_get_bool("ro.vendor.camera.free_buf_early", 0) == 1;
+}
+
 CameraDeviceSession::~CameraDeviceSession() {
     if (!isClosed()) {
         ALOGE("CameraDeviceSession deleted before close!");
@@ -887,6 +892,24 @@ bool CameraDeviceSession::preProcessConfigurationLocked(
         (*streams)[i] = &mStreamMap[id];
     }
 
+    if (mFreeBufEarly) {
+        // Remove buffers of deleted streams
+        for(auto it = mStreamMap.begin(); it != mStreamMap.end(); it++) {
+            int id = it->first;
+            bool found = false;
+            for (const auto& stream : requestedConfiguration.streams) {
+                if (id == stream.id) {
+                    found = true;
+                    break;
+                }
+            }
+            if (!found) {
+                // Unmap all buffers of deleted stream
+                cleanupBuffersLocked(id);
+            }
+        }
+    }
+
     return true;
 }
 
@@ -908,7 +931,9 @@ void CameraDeviceSession::postProcessConfigurationLocked(
             // Unmap all buffers of deleted stream
             // in case the configuration call succeeds and HAL
             // is able to release the corresponding resources too.
-            cleanupBuffersLocked(id);
+            if (!mFreeBufEarly) {
+                cleanupBuffersLocked(id);
+            }
             it = mStreamMap.erase(it);
         } else {
             ++it;
@@ -927,6 +952,27 @@ void CameraDeviceSession::postProcessConfigurationLocked(
     mResultBatcher.setBatchedStreams(mVideoStreamIds);
 }
 
+
+void CameraDeviceSession::postProcessConfigurationFailureLocked(
+        const StreamConfiguration& requestedConfiguration) {
+    if (mFreeBufEarly) {
+        // Re-build the buf cache entry for deleted streams
+        for(auto it = mStreamMap.begin(); it != mStreamMap.end(); it++) {
+            int id = it->first;
+            bool found = false;
+            for (const auto& stream : requestedConfiguration.streams) {
+                if (id == stream.id) {
+                    found = true;
+                    break;
+                }
+            }
+            if (!found) {
+                mCirculatingBuffers.emplace(id, CirculatingBuffers{});
+            }
+        }
+    }
+}
+
 Return<void> CameraDeviceSession::configureStreams(
         const StreamConfiguration& requestedConfiguration,
         ICameraDeviceSession::configureStreams_cb _hidl_cb)  {
@@ -979,6 +1025,8 @@ Return<void> CameraDeviceSession::configureStreams(
     // the corresponding resources of the deleted streams.
     if (ret == OK) {
         postProcessConfigurationLocked(requestedConfiguration);
+    } else {
+        postProcessConfigurationFailureLocked(requestedConfiguration);
     }
 
     if (ret == -EINVAL) {
diff --git a/camera/device/3.2/default/CameraDeviceSession.h b/camera/device/3.2/default/CameraDeviceSession.h
index af90e5a0..bcee259f 100644
--- a/camera/device/3.2/default/CameraDeviceSession.h
+++ b/camera/device/3.2/default/CameraDeviceSession.h
@@ -120,6 +120,8 @@ protected:
             hidl_vec<camera3_stream_t*> *streams /*out*/);
     void postProcessConfigurationLocked(const StreamConfiguration& requestedConfiguration);
 
+    void postProcessConfigurationFailureLocked(const StreamConfiguration& requestedConfiguration);
+
 protected:
 
     // protecting mClosed/mDisconnected/mInitFail
@@ -142,6 +144,7 @@ protected:
 
     camera3_device_t* mDevice;
     const uint32_t mDeviceVersion;
+    const bool mFreeBufEarly;
     bool mIsAELockAvailable;
     bool mDerivePostRawSensKey;
     uint32_t mNumPartialResults;
@@ -293,6 +296,8 @@ protected:
 
     bool initialize();
 
+    static bool shouldFreeBufEarly();
+
     Status initStatus() const;
 
     // Validate and import request's input buffer and acquire fence
diff --git a/camera/device/3.3/default/CameraDeviceSession.cpp b/camera/device/3.3/default/CameraDeviceSession.cpp
index d36e9ed4..60174fb9 100644
--- a/camera/device/3.3/default/CameraDeviceSession.cpp
+++ b/camera/device/3.3/default/CameraDeviceSession.cpp
@@ -92,6 +92,8 @@ Return<void> CameraDeviceSession::configureStreams_3_3(
     // the corresponding resources of the deleted streams.
     if (ret == OK) {
         postProcessConfigurationLocked(requestedConfiguration);
+    } else {
+        postProcessConfigurationFailureLocked(requestedConfiguration);
     }
 
     if (ret == -EINVAL) {
diff --git a/camera/device/3.4/default/CameraDeviceSession.cpp b/camera/device/3.4/default/CameraDeviceSession.cpp
index 6a18161f..f2e031c6 100644
--- a/camera/device/3.4/default/CameraDeviceSession.cpp
+++ b/camera/device/3.4/default/CameraDeviceSession.cpp
@@ -154,6 +154,8 @@ Return<void> CameraDeviceSession::configureStreams_3_4(
     // the corresponding resources of the deleted streams.
     if (ret == OK) {
         postProcessConfigurationLocked_3_4(requestedConfiguration);
+    } else {
+        postProcessConfigurationFailureLocked_3_4(requestedConfiguration);
     }
 
     if (ret == -EINVAL) {
@@ -215,6 +217,23 @@ bool CameraDeviceSession::preProcessConfigurationLocked_3_4(
         (*streams)[i] = &mStreamMap[id];
     }
 
+    if (mFreeBufEarly) {
+        // Remove buffers of deleted streams
+        for(auto it = mStreamMap.begin(); it != mStreamMap.end(); it++) {
+            int id = it->first;
+            bool found = false;
+            for (const auto& stream : requestedConfiguration.streams) {
+                if (id == stream.v3_2.id) {
+                    found = true;
+                    break;
+                }
+            }
+            if (!found) {
+                // Unmap all buffers of deleted stream
+                cleanupBuffersLocked(id);
+            }
+        }
+    }
     return true;
 }
 
@@ -236,7 +255,9 @@ void CameraDeviceSession::postProcessConfigurationLocked_3_4(
             // Unmap all buffers of deleted stream
             // in case the configuration call succeeds and HAL
             // is able to release the corresponding resources too.
-            cleanupBuffersLocked(id);
+            if (!mFreeBufEarly) {
+                cleanupBuffersLocked(id);
+            }
             it = mStreamMap.erase(it);
         } else {
             ++it;
@@ -255,6 +276,26 @@ void CameraDeviceSession::postProcessConfigurationLocked_3_4(
     mResultBatcher_3_4.setBatchedStreams(mVideoStreamIds);
 }
 
+void CameraDeviceSession::postProcessConfigurationFailureLocked_3_4(
+        const StreamConfiguration& requestedConfiguration) {
+    if (mFreeBufEarly) {
+        // Re-build the buf cache entry for deleted streams
+        for(auto it = mStreamMap.begin(); it != mStreamMap.end(); it++) {
+            int id = it->first;
+            bool found = false;
+            for (const auto& stream : requestedConfiguration.streams) {
+                if (id == stream.v3_2.id) {
+                    found = true;
+                    break;
+                }
+            }
+            if (!found) {
+                mCirculatingBuffers.emplace(id, CirculatingBuffers{});
+            }
+        }
+    }
+}
+
 Return<void> CameraDeviceSession::processCaptureRequest_3_4(
         const hidl_vec<V3_4::CaptureRequest>& requests,
         const hidl_vec<V3_2::BufferCache>& cachesToRemove,
diff --git a/camera/device/3.4/default/include/device_v3_4_impl/CameraDeviceSession.h b/camera/device/3.4/default/include/device_v3_4_impl/CameraDeviceSession.h
index 5d6a112e..fdc8a5af 100644
--- a/camera/device/3.4/default/include/device_v3_4_impl/CameraDeviceSession.h
+++ b/camera/device/3.4/default/include/device_v3_4_impl/CameraDeviceSession.h
@@ -84,6 +84,8 @@ protected:
             camera3_stream_configuration_t *stream_list /*out*/,
             hidl_vec<camera3_stream_t*> *streams /*out*/);
     void postProcessConfigurationLocked_3_4(const StreamConfiguration& requestedConfiguration);
+    void postProcessConfigurationFailureLocked_3_4(
+            const StreamConfiguration& requestedConfiguration);
 
     Return<void> processCaptureRequest_3_4(
             const hidl_vec<V3_4::CaptureRequest>& requests,
diff --git a/camera/provider/2.4/vts/functional/VtsHalCameraProviderV2_4TargetTest.cpp b/camera/provider/2.4/vts/functional/VtsHalCameraProviderV2_4TargetTest.cpp
index 95c7167c..1a245c46 100644
--- a/camera/provider/2.4/vts/functional/VtsHalCameraProviderV2_4TargetTest.cpp
+++ b/camera/provider/2.4/vts/functional/VtsHalCameraProviderV2_4TargetTest.cpp
@@ -87,7 +87,6 @@ using ::android::hardware::camera::device::V3_2::ICameraDevice;
 using ::android::hardware::camera::device::V3_2::BufferCache;
 using ::android::hardware::camera::device::V3_2::CaptureRequest;
 using ::android::hardware::camera::device::V3_2::CaptureResult;
-using ::android::hardware::camera::device::V3_2::ICameraDeviceCallback;
 using ::android::hardware::camera::device::V3_2::ICameraDeviceSession;
 using ::android::hardware::camera::device::V3_2::NotifyMsg;
 using ::android::hardware::camera::device::V3_2::RequestTemplate;
@@ -532,7 +531,7 @@ public:
 
  hidl_vec<hidl_string> getCameraDeviceNames(sp<ICameraProvider> provider);
 
- struct EmptyDeviceCb : public ICameraDeviceCallback {
+ struct EmptyDeviceCb : public V3_4::ICameraDeviceCallback {
      virtual Return<void> processCaptureResult(
          const hidl_vec<CaptureResult>& /*results*/) override {
          ALOGI("processCaptureResult callback");
@@ -540,6 +539,13 @@ public:
          return Void();
      }
 
+     virtual Return<void> processCaptureResult_3_4(
+         const hidl_vec<V3_4::CaptureResult>& /*results*/) override {
+         ALOGI("processCaptureResult_3_4 callback");
+         ADD_FAILURE();  // Empty callback should not reach here
+         return Void();
+     }
+
      virtual Return<void> notify(const hidl_vec<NotifyMsg>& /*msgs*/) override {
          ALOGI("notify callback");
          ADD_FAILURE();  // Empty callback should not reach here
@@ -3643,6 +3649,7 @@ TEST_F(CameraHidlTest, processCaptureRequestBurstISO) {
                                         static_cast<int32_t>(PixelFormat::IMPLEMENTATION_DEFINED)};
     uint64_t bufferId = 1;
     uint32_t frameNumber = 1;
+    float isoTol = .03f;
     ::android::hardware::hidl_vec<uint8_t> settings;
 
     for (const auto& name : cameraDeviceNames) {
@@ -3772,7 +3779,8 @@ TEST_F(CameraHidlTest, processCaptureRequestBurstISO) {
             ASSERT_TRUE(inflightReqs[i].collectedResult.exists(ANDROID_SENSOR_SENSITIVITY));
             camera_metadata_entry_t isoResult = inflightReqs[i].collectedResult.find(
                     ANDROID_SENSOR_SENSITIVITY);
-            ASSERT_TRUE(isoResult.data.i32[0] == isoValues[i]);
+            ASSERT_TRUE(std::abs(isoResult.data.i32[0] - isoValues[i]) <=
+                        std::round(isoValues[i]*isoTol));
         }
 
         ret = session->close();
diff --git a/compatibility_matrices/compatibility_matrix.3.xml b/compatibility_matrices/compatibility_matrix.3.xml
index f271642f..9c6b12ad 100644
--- a/compatibility_matrices/compatibility_matrix.3.xml
+++ b/compatibility_matrices/compatibility_matrix.3.xml
@@ -290,7 +290,7 @@
     </hal>
     <hal format="hidl" optional="true">
         <name>android.hardware.power</name>
-        <version>1.0-2</version>
+        <version>1.0-3</version>
         <interface>
             <name>IPower</name>
             <instance>default</instance>
diff --git a/current.txt b/current.txt
index cc15322b..33cf9346 100644
--- a/current.txt
+++ b/current.txt
@@ -335,7 +335,7 @@ dd83be076b6b3f10ed62ab34d8c8b95f2415961fb785200eb842e7bfb2b0ee92 android.hardwar
 675682dd3007805c985eaaec91612abc88f4c25b3431fb84070b7584a1a741fb android.hardware.health@2.0::IHealth
 434c4c32c00b0e54bb05e40c79503208b40f786a318029a2a4f66e34f10f2a76 android.hardware.health@2.0::IHealthInfoCallback
 c9e498f1ade5e26f00d290b4763a9671ec6720f915e7d592844b62e8cb1f9b5c android.hardware.health@2.0::types
-201f9723353fdbd40bf3705537fb7e015e4c399879425e68688fe0f43606ea4d android.hardware.keymaster@4.0::IKeymasterDevice
+6122abe9bc2e7868463d3787db2991c1e47cc01fe3e4cfb7293c5ba421ff8ad9 android.hardware.keymaster@4.0::IKeymasterDevice
 1b7d2090c0a28b229d37c4b96160796b1f0d703950ac6ccc163fccd280830503 android.hardware.keymaster@4.0::types
 6d5c646a83538f0f9d8438c259932509f4353410c6c76e56db0d6ca98b69c3bb android.hardware.media.bufferpool@1.0::IAccessor
 b8c7ed58aa8740361e63d0ce9e7c94227572a629f356958840b34809d2393a7c android.hardware.media.bufferpool@1.0::IClientManager
@@ -348,6 +348,8 @@ e85f566698d2a2c28100e264fcf2c691a066756ddf8dd341d009ff50cfe10614 android.hardwar
 5e278fcaa3287d397d8eebe1c22aaa28150f5caae1cf9381cd6dc32cb37899c5 android.hardware.nfc@1.1::types
 163e115e833fc1d77cdd4a8cf0c833bb8b8d74fe35c880fe693101d17774926f android.hardware.power@1.2::IPower
 7899b9305587b2d5cd74a3cc87e9090f58bf4ae74256ce3ee36e7ec011822840 android.hardware.power@1.2::types
+5a464e6db53fad223986d655028a18185b73db8e2bfa9663f9042c9623eb0aa0 android.hardware.power@1.3::IPower
+a54a28d39b892d27a3cb06829181c038edcdd9e8eef359543b01e4313ae59aa0 android.hardware.power@1.3::types
 ab132c990a62f0aca35871c092c22fb9c85d478e22124ef6a4d0a2302da76a9f android.hardware.radio@1.2::IRadio
 cda752aeabaabc20486a82ac57a3dd107785c006094a349bc5e224e8aa22a17c android.hardware.radio@1.2::IRadioIndication
 da8c6ae991c6a4b284cc6e445332e064e28ee8a09482ed5afff9d159ec6694b7 android.hardware.radio@1.2::IRadioResponse
@@ -380,3 +382,7 @@ e362203b941f18bd4cba29a62adfa02453ed00d6be5b72cdb6c4d7e0bf394a40 android.hardwar
 21757d0e5dd4b7e4bd981a4a20531bca3c32271ad9777b17b74eb5a1ea508384 android.hardware.wifi.supplicant@1.1::ISupplicantStaIface
 cd4330c3196bda1d642a32abfe23a7d64ebfbda721940643af6867af3b3f0aa9 android.hardware.wifi.supplicant@1.1::ISupplicantStaIfaceCallback
 10ff2fae516346b86121368ce5790d5accdfcb73983246b813f3d488b66db45a android.hardware.wifi.supplicant@1.1::ISupplicantStaNetwork
+
+# ABI preserving changes to HALs after Android P
+1d19720d4fd38b1095f0f555a4bd92b3b12c9b1d0f560b0e9a474cd6dcc20db6 android.hardware.radio@1.2::IRadio
+1d4a5776614c08b5d794a5ec5ab04697260cbd4b3441d5935cd53ee71d19da02 android.hardware.radio@1.0::IRadioResponse
diff --git a/drm/1.0/default/DrmFactory.cpp b/drm/1.0/default/DrmFactory.cpp
index 7e5d998e..05951d7c 100644
--- a/drm/1.0/default/DrmFactory.cpp
+++ b/drm/1.0/default/DrmFactory.cpp
@@ -1,6 +1,6 @@
 /*
  * Copyright (C) 2016 The Android Open Source Project
-` *
+ *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
diff --git a/drm/1.0/default/LegacyPluginPath.cpp b/drm/1.0/default/LegacyPluginPath.cpp
index 369059d2..d0a8f90a 100644
--- a/drm/1.0/default/LegacyPluginPath.cpp
+++ b/drm/1.0/default/LegacyPluginPath.cpp
@@ -16,6 +16,8 @@
 
 #include "LegacyPluginPath.h"
 
+#include <unistd.h>
+
 #include <cutils/properties.h>
 
 namespace android {
@@ -24,12 +26,16 @@ namespace drm {
 namespace V1_0 {
 namespace implementation {
 
+// 64-bit DRM depends on OEM libraries that aren't
+// provided for all devices. If the drm hal service
+// is running as 64-bit use the 64-bit libs, otherwise
+// use the 32-bit libs.
 const char* getDrmPluginPath() {
-    if (property_get_bool("drm.64bit.enabled", false)) {
-        return "/vendor/lib64/mediadrm";
-    } else {
-        return "/vendor/lib/mediadrm";
-    }
+#if defined(__LP64__)
+    return "/vendor/lib64/mediadrm";
+#else
+    return "/vendor/lib/mediadrm";
+#endif
 }
 
 }  // namespace implementation
diff --git a/drm/1.0/default/include/PluginLoader.h b/drm/1.0/default/include/PluginLoader.h
index f387b3cb..0c45fb3e 100644
--- a/drm/1.0/default/include/PluginLoader.h
+++ b/drm/1.0/default/include/PluginLoader.h
@@ -85,7 +85,10 @@ class PluginLoader {
                 libraries.push(library);
                 T* result = createFactoryFunc();
                 return  result;
-           }
+            } else {
+                ALOGE("Failed to lookup symbol %s in library %s: %s",
+                        entry, path, library->lastError());
+            }
         }
         return NULL;
     }
diff --git a/gnss/1.0/vts/functional/VtsHalGnssV1_0TargetTest.cpp b/gnss/1.0/vts/functional/VtsHalGnssV1_0TargetTest.cpp
index 010a46db..c26f60a7 100644
--- a/gnss/1.0/vts/functional/VtsHalGnssV1_0TargetTest.cpp
+++ b/gnss/1.0/vts/functional/VtsHalGnssV1_0TargetTest.cpp
@@ -404,7 +404,11 @@ TEST_F(GnssHalTest, InjectDelete) {
   ASSERT_TRUE(result.isOk());
   EXPECT_TRUE(result);
 
-  auto resultVoid = gnss_hal_->deleteAidingData(IGnss::GnssAidingData::DELETE_ALL);
+  auto resultVoid = gnss_hal_->deleteAidingData(IGnss::GnssAidingData::DELETE_POSITION);
+
+  ASSERT_TRUE(resultVoid.isOk());
+
+  resultVoid = gnss_hal_->deleteAidingData(IGnss::GnssAidingData::DELETE_TIME);
 
   ASSERT_TRUE(resultVoid.isOk());
 
@@ -472,6 +476,16 @@ TEST_F(GnssHalTest, MeasurementCapabilites) {
   }
 }
 
+/*
+ * SchedulingCapabilities:
+ * Verifies that 2018+ hardware supports Scheduling capabilities.
+ */
+TEST_F(GnssHalTest, SchedulingCapabilities) {
+    if (info_called_count_ > 0 && last_info_.yearOfHw >= 2018) {
+        EXPECT_TRUE(last_capabilities_ & IGnssCallback::Capabilities::SCHEDULING);
+    }
+}
+
 int main(int argc, char** argv) {
   ::testing::AddGlobalTestEnvironment(GnssHidlEnvironment::Instance());
   ::testing::InitGoogleTest(&argc, argv);
diff --git a/gnss/1.1/vts/functional/gnss_hal_test.cpp b/gnss/1.1/vts/functional/gnss_hal_test.cpp
index 46d61e54..433f5cb4 100644
--- a/gnss/1.1/vts/functional/gnss_hal_test.cpp
+++ b/gnss/1.1/vts/functional/gnss_hal_test.cpp
@@ -83,6 +83,7 @@ void GnssHalTest::StopAndClearLocations() {
      */
     while (wait(TIMEOUT_SEC) == std::cv_status::no_timeout) {
     }
+    location_called_count_ = 0;
 }
 
 void GnssHalTest::SetPositionMode(const int min_interval_msec, const bool low_power_mode) {
@@ -97,17 +98,17 @@ void GnssHalTest::SetPositionMode(const int min_interval_msec, const bool low_po
     EXPECT_TRUE(result);
 }
 
-bool GnssHalTest::StartAndGetSingleLocation() {
+bool GnssHalTest::StartAndCheckFirstLocation() {
     auto result = gnss_hal_->start();
 
     EXPECT_TRUE(result.isOk());
     EXPECT_TRUE(result);
 
     /*
-     * GPS signals initially optional for this test, so don't expect fast fix,
-     * or no timeout, unless signal is present
+     * GnssLocationProvider support of AGPS SUPL & XtraDownloader is not available in VTS,
+     * so allow time to demodulate ephemeris over the air.
      */
-    const int kFirstGnssLocationTimeoutSeconds = 15;
+    const int kFirstGnssLocationTimeoutSeconds = 75;
 
     wait(kFirstGnssLocationTimeoutSeconds);
     EXPECT_EQ(location_called_count_, 1);
@@ -195,7 +196,7 @@ void GnssHalTest::StartAndCheckLocations(int count) {
 
     SetPositionMode(kMinIntervalMsec, kLowPowerMode);
 
-    EXPECT_TRUE(StartAndGetSingleLocation());
+    EXPECT_TRUE(StartAndCheckFirstLocation());
 
     for (int i = 1; i < count; i++) {
         EXPECT_EQ(std::cv_status::no_timeout, wait(kLocationTimeoutSubsequentSec));
diff --git a/gnss/1.1/vts/functional/gnss_hal_test.h b/gnss/1.1/vts/functional/gnss_hal_test.h
index 269366a9..64478b5b 100644
--- a/gnss/1.1/vts/functional/gnss_hal_test.h
+++ b/gnss/1.1/vts/functional/gnss_hal_test.h
@@ -107,12 +107,15 @@ class GnssHalTest : public ::testing::VtsHalHidlTargetTestBase {
     void SetUpGnssCallback();
 
     /*
-     * StartAndGetSingleLocation:
-     * Helper function to get one Location and check fields
+     * StartAndCheckFirstLocation:
+     *   Helper function to start location, and check the first one.
+     *
+     *   <p> Note this leaves the Location request active, to enable Stop call vs. other call
+     *   reordering tests.
      *
      * returns  true if a location was successfully generated
      */
-    bool StartAndGetSingleLocation();
+    bool StartAndCheckFirstLocation();
 
     /*
      * CheckLocation:
diff --git a/gnss/1.1/vts/functional/gnss_hal_test_cases.cpp b/gnss/1.1/vts/functional/gnss_hal_test_cases.cpp
index cce46f18..c9f840e3 100644
--- a/gnss/1.1/vts/functional/gnss_hal_test_cases.cpp
+++ b/gnss/1.1/vts/functional/gnss_hal_test_cases.cpp
@@ -60,24 +60,46 @@ TEST_F(GnssHalTest, TestGnssMeasurementCallback) {
  */
 TEST_F(GnssHalTest, GetLocationLowPower) {
     const int kMinIntervalMsec = 5000;
-    const int kLocationTimeoutSubsequentSec = (kMinIntervalMsec / 1000) + 1;
-    const int kNoLocationPeriodSec = 2;
+    const int kLocationTimeoutSubsequentSec = (kMinIntervalMsec / 1000) * 2;
+    const int kNoLocationPeriodSec = (kMinIntervalMsec / 1000) / 2;
     const int kLocationsToCheck = 5;
     const bool kLowPowerMode = true;
 
+    // Warmup period - VTS doesn't have AGPS access via GnssLocationProvider
+    StartAndCheckLocations(5);
+    StopAndClearLocations();
+
+    // Start of Low Power Mode test
     SetPositionMode(kMinIntervalMsec, kLowPowerMode);
 
-    EXPECT_TRUE(StartAndGetSingleLocation());
+    // Don't expect true - as without AGPS access
+    if (!StartAndCheckFirstLocation()) {
+        ALOGW("GetLocationLowPower test - no first low power location received.");
+    }
 
     for (int i = 1; i < kLocationsToCheck; i++) {
         // Verify that kMinIntervalMsec is respected by waiting kNoLocationPeriodSec and
         // ensure that no location is received yet
+
         wait(kNoLocationPeriodSec);
-        EXPECT_EQ(location_called_count_, i);
-        EXPECT_EQ(std::cv_status::no_timeout,
-                  wait(kLocationTimeoutSubsequentSec - kNoLocationPeriodSec));
-        EXPECT_EQ(location_called_count_, i + 1);
-        CheckLocation(last_location_, true);
+        // Tolerate (ignore) one extra location right after the first one
+        // to handle startup edge case scheduling limitations in some implementations
+        if ((i == 1) && (location_called_count_ == 2)) {
+            CheckLocation(last_location_, true);
+            continue;  // restart the quiet wait period after this too-fast location
+        }
+        EXPECT_LE(location_called_count_, i);
+        if (location_called_count_ != i) {
+            ALOGW("GetLocationLowPower test - not enough locations received. %d vs. %d expected ",
+                  location_called_count_, i);
+        }
+
+        if (std::cv_status::no_timeout !=
+            wait(kLocationTimeoutSubsequentSec - kNoLocationPeriodSec)) {
+            ALOGW("GetLocationLowPower test - timeout awaiting location %d", i);
+        } else {
+            CheckLocation(last_location_, true);
+        }
     }
 
     StopAndClearLocations();
@@ -177,7 +199,8 @@ TEST_F(GnssHalTest, BlacklistIndividualSatellites) {
 
     StartAndCheckLocations(kLocationsToAwait);
 
-    EXPECT_GE((int)list_gnss_sv_status_.size(), kLocationsToAwait);
+    // Tolerate 1 less sv status to handle edge cases in reporting.
+    EXPECT_GE((int)list_gnss_sv_status_.size() + 1, kLocationsToAwait);
     ALOGD("Observed %d GnssSvStatus, while awaiting %d Locations", (int)list_gnss_sv_status_.size(),
           kLocationsToAwait);
 
@@ -217,7 +240,8 @@ TEST_F(GnssHalTest, BlacklistIndividualSatellites) {
     location_called_count_ = 0;
     StartAndCheckLocations(kLocationsToAwait);
 
-    EXPECT_GE((int)list_gnss_sv_status_.size(), kLocationsToAwait);
+    // Tolerate 1 less sv status to handle edge cases in reporting.
+    EXPECT_GE((int)list_gnss_sv_status_.size() + 1, kLocationsToAwait);
     ALOGD("Observed %d GnssSvStatus, while awaiting %d Locations", (int)list_gnss_sv_status_.size(),
           kLocationsToAwait);
     for (const auto& gnss_sv_status : list_gnss_sv_status_) {
@@ -236,13 +260,13 @@ TEST_F(GnssHalTest, BlacklistIndividualSatellites) {
     ASSERT_TRUE(result.isOk());
     EXPECT_TRUE(result);
 
-    location_called_count_ = 0;
     StopAndClearLocations();
     list_gnss_sv_status_.clear();
 
     StartAndCheckLocations(kLocationsToAwait);
 
-    EXPECT_GE((int)list_gnss_sv_status_.size(), kLocationsToAwait);
+    // Tolerate 1 less sv status to handle edge cases in reporting.
+    EXPECT_GE((int)list_gnss_sv_status_.size() + 1, kLocationsToAwait);
     ALOGD("Observed %d GnssSvStatus, while awaiting %d Locations", (int)list_gnss_sv_status_.size(),
           kLocationsToAwait);
 
@@ -278,7 +302,8 @@ TEST_F(GnssHalTest, BlacklistConstellation) {
 
     StartAndCheckLocations(kLocationsToAwait);
 
-    EXPECT_GE((int)list_gnss_sv_status_.size(), kLocationsToAwait);
+    // Tolerate 1 less sv status to handle edge cases in reporting.
+    EXPECT_GE((int)list_gnss_sv_status_.size() + 1, kLocationsToAwait);
     ALOGD("Observed %d GnssSvStatus, while awaiting %d Locations", (int)list_gnss_sv_status_.size(),
           kLocationsToAwait);
 
@@ -328,7 +353,8 @@ TEST_F(GnssHalTest, BlacklistConstellation) {
     location_called_count_ = 0;
     StartAndCheckLocations(kLocationsToAwait);
 
-    EXPECT_GE((int)list_gnss_sv_status_.size(), kLocationsToAwait);
+    // Tolerate 1 less sv status to handle edge cases in reporting.
+    EXPECT_GE((int)list_gnss_sv_status_.size() + 1, kLocationsToAwait);
     ALOGD("Observed %d GnssSvStatus, while awaiting %d Locations", (int)list_gnss_sv_status_.size(),
           kLocationsToAwait);
     for (const auto& gnss_sv_status : list_gnss_sv_status_) {
@@ -353,23 +379,8 @@ TEST_F(GnssHalTest, BlacklistConstellation) {
  * Ensure successfully injecting a location.
  */
 TEST_F(GnssHalTest, InjectBestLocation) {
-    GnssLocation gnssLocation = {.gnssLocationFlags = 0,  // set below
-                                 .latitudeDegrees = 43.0,
-                                 .longitudeDegrees = -180,
-                                 .altitudeMeters = 1000,
-                                 .speedMetersPerSec = 0,
-                                 .bearingDegrees = 0,
-                                 .horizontalAccuracyMeters = 0.1,
-                                 .verticalAccuracyMeters = 0.1,
-                                 .speedAccuracyMetersPerSecond = 0.1,
-                                 .bearingAccuracyDegrees = 0.1,
-                                 .timestamp = 1534567890123L};
-    gnssLocation.gnssLocationFlags |=
-        GnssLocationFlags::HAS_LAT_LONG | GnssLocationFlags::HAS_ALTITUDE |
-        GnssLocationFlags::HAS_SPEED | GnssLocationFlags::HAS_HORIZONTAL_ACCURACY |
-        GnssLocationFlags::HAS_VERTICAL_ACCURACY | GnssLocationFlags::HAS_SPEED_ACCURACY |
-        GnssLocationFlags::HAS_BEARING | GnssLocationFlags::HAS_BEARING_ACCURACY;
-
+    StartAndCheckLocations(1);
+    GnssLocation gnssLocation = last_location_;
     CheckLocation(gnssLocation, true);
 
     auto result = gnss_hal_->injectBestLocation(gnssLocation);
@@ -377,7 +388,7 @@ TEST_F(GnssHalTest, InjectBestLocation) {
     ASSERT_TRUE(result.isOk());
     EXPECT_TRUE(result);
 
-    auto resultVoid = gnss_hal_->deleteAidingData(IGnss::GnssAidingData::DELETE_ALL);
+    auto resultVoid = gnss_hal_->deleteAidingData(IGnss::GnssAidingData::DELETE_POSITION);
 
     ASSERT_TRUE(resultVoid.isOk());
 }
@@ -428,7 +439,7 @@ TEST_F(GnssHalTest, GnssDebugValuesSanityTest) {
             EXPECT_GE(data.position.ageSeconds, 0);
         }
 
-        EXPECT_GE(data.time.timeEstimate, 1514764800000);  // Jan 01 2018 00:00:00
+        EXPECT_GE(data.time.timeEstimate, 1483228800000);  // Jan 01 2017 00:00:00 GMT.
 
         EXPECT_GT(data.time.timeUncertaintyNs, 0);
 
diff --git a/graphics/composer/2.2/default/android.hardware.graphics.composer@2.2-service.rc b/graphics/composer/2.2/default/android.hardware.graphics.composer@2.2-service.rc
index a41d902c..efe6dadb 100644
--- a/graphics/composer/2.2/default/android.hardware.graphics.composer@2.2-service.rc
+++ b/graphics/composer/2.2/default/android.hardware.graphics.composer@2.2-service.rc
@@ -4,3 +4,4 @@ service vendor.hwcomposer-2-2 /vendor/bin/hw/android.hardware.graphics.composer@
     group graphics drmrpc
     capabilities SYS_NICE
     onrestart restart surfaceflinger
+    writepid /dev/cpuset/system-background/tasks
diff --git a/health/2.0/README b/health/2.0/README
index 11e6a7aa..dfd965aa 100644
--- a/health/2.0/README
+++ b/health/2.0/README
@@ -6,12 +6,7 @@ Upgrading from health@1.0 HAL
 1. If the device does not have a vendor-specific libhealthd AND does not
    implement storage-related APIs, just do the following:
 
-    1.1 (recommended) To remove healthd from the build,
-        PRODUCT_PACKAGES += android.hardware.health@2.0-service.override
-        DEVICE_FRAMEWORK_MANIFEST_FILE += \
-            system/libhidl/vintfdata/manifest_healthd_exclude.xml
-    1.2 To keep healthd in the build,
-        PRODUCT_PACKAGES += android.hardware.health@2.0-service
+    PRODUCT_PACKAGES += android.hardware.health@2.0-service
 
    Otherwise, continue to Step 2.
 
diff --git a/keymaster/4.0/IKeymasterDevice.hal b/keymaster/4.0/IKeymasterDevice.hal
index 74d13d8b..85a25c6d 100644
--- a/keymaster/4.0/IKeymasterDevice.hal
+++ b/keymaster/4.0/IKeymasterDevice.hal
@@ -753,7 +753,7 @@ interface IKeymasterDevice {
      *     attestationIdManufacturer  [716] EXPLICIT OCTET_STRING OPTIONAL,
      *     attestationIdModel         [717] EXPLICIT OCTET_STRING OPTIONAL,
      *     vendorPatchLevel           [718] EXPLICIT INTEGER OPTIONAL,
-     *     bootPatchLevel             [718] EXPLICIT INTEGER OPTIONAL,
+     *     bootPatchLevel             [719] EXPLICIT INTEGER OPTIONAL,
      * }
      *
      * The above schema is mostly a straightforward translation of the IKeymasterDevice tag/value
diff --git a/keymaster/4.0/support/Keymaster.cpp b/keymaster/4.0/support/Keymaster.cpp
index 444298b5..9325cc06 100644
--- a/keymaster/4.0/support/Keymaster.cpp
+++ b/keymaster/4.0/support/Keymaster.cpp
@@ -164,10 +164,10 @@ static void computeHmac(const Keymaster::KeymasterSet& keymasters,
                     sharingCheck = curSharingCheck;
                     firstKeymaster = false;
                 }
-                CHECK(curSharingCheck == sharingCheck)
-                    << "HMAC computation failed for " << *keymaster  //
-                    << " Expected: " << sharingCheck                 //
-                    << " got: " << curSharingCheck;
+                if (curSharingCheck != sharingCheck)
+                    LOG(WARNING) << "HMAC computation failed for " << *keymaster  //
+                                 << " Expected: " << sharingCheck                 //
+                                 << " got: " << curSharingCheck;
             });
         CHECK(rc.isOk()) << "Failed to communicate with " << *keymaster
                          << " error: " << rc.description();
diff --git a/keymaster/4.0/support/attestation_record.cpp b/keymaster/4.0/support/attestation_record.cpp
index 8f37d9c8..6de0c1c6 100644
--- a/keymaster/4.0/support/attestation_record.cpp
+++ b/keymaster/4.0/support/attestation_record.cpp
@@ -49,12 +49,14 @@ typedef struct km_root_of_trust {
     ASN1_OCTET_STRING* verified_boot_key;
     ASN1_BOOLEAN* device_locked;
     ASN1_ENUMERATED* verified_boot_state;
+    ASN1_OCTET_STRING* verified_boot_hash;
 } KM_ROOT_OF_TRUST;
 
 ASN1_SEQUENCE(KM_ROOT_OF_TRUST) = {
     ASN1_SIMPLE(KM_ROOT_OF_TRUST, verified_boot_key, ASN1_OCTET_STRING),
     ASN1_SIMPLE(KM_ROOT_OF_TRUST, device_locked, ASN1_BOOLEAN),
     ASN1_SIMPLE(KM_ROOT_OF_TRUST, verified_boot_state, ASN1_ENUMERATED),
+    ASN1_SIMPLE(KM_ROOT_OF_TRUST, verified_boot_hash, ASN1_OCTET_STRING),
 } ASN1_SEQUENCE_END(KM_ROOT_OF_TRUST);
 IMPLEMENT_ASN1_FUNCTIONS(KM_ROOT_OF_TRUST);
 
@@ -77,11 +79,16 @@ typedef struct km_auth_list {
     ASN1_OCTET_STRING* application_id;
     ASN1_INTEGER* creation_date_time;
     ASN1_INTEGER* origin;
-    ASN1_NULL* rollback_resistant;
+    ASN1_NULL* rollback_resistance;
     KM_ROOT_OF_TRUST* root_of_trust;
     ASN1_INTEGER* os_version;
     ASN1_INTEGER* os_patchlevel;
     ASN1_OCTET_STRING* attestation_application_id;
+    ASN1_NULL* trusted_user_presence_required;
+    ASN1_NULL* trusted_confirmation_required;
+    ASN1_NULL* unlocked_device_required;
+    ASN1_INTEGER* vendor_patchlevel;
+    ASN1_INTEGER* boot_patchlevel;
 } KM_AUTH_LIST;
 
 ASN1_SEQUENCE(KM_AUTH_LIST) = {
@@ -93,6 +100,7 @@ ASN1_SEQUENCE(KM_AUTH_LIST) = {
     ASN1_EXP_OPT(KM_AUTH_LIST, ec_curve, ASN1_INTEGER, TAG_EC_CURVE.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, rsa_public_exponent, ASN1_INTEGER,
                  TAG_RSA_PUBLIC_EXPONENT.maskedTag()),
+    ASN1_EXP_OPT(KM_AUTH_LIST, rollback_resistance, ASN1_NULL, TAG_ROLLBACK_RESISTANCE.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, active_date_time, ASN1_INTEGER, TAG_ACTIVE_DATETIME.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, origination_expire_date_time, ASN1_INTEGER,
                  TAG_ORIGINATION_EXPIRE_DATETIME.maskedTag()),
@@ -102,13 +110,19 @@ ASN1_SEQUENCE(KM_AUTH_LIST) = {
     ASN1_EXP_OPT(KM_AUTH_LIST, user_auth_type, ASN1_INTEGER, TAG_USER_AUTH_TYPE.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, auth_timeout, ASN1_INTEGER, TAG_AUTH_TIMEOUT.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, allow_while_on_body, ASN1_NULL, TAG_ALLOW_WHILE_ON_BODY.maskedTag()),
-    ASN1_EXP_OPT(KM_AUTH_LIST, application_id, ASN1_OCTET_STRING, TAG_APPLICATION_ID.maskedTag()),
+    ASN1_EXP_OPT(KM_AUTH_LIST, trusted_user_presence_required, ASN1_NULL,
+                 TAG_TRUSTED_USER_PRESENCE_REQUIRED.maskedTag()),
+    ASN1_EXP_OPT(KM_AUTH_LIST, trusted_confirmation_required, ASN1_NULL,
+                 TAG_TRUSTED_CONFIRMATION_REQUIRED.maskedTag()),
+    ASN1_EXP_OPT(KM_AUTH_LIST, unlocked_device_required, ASN1_NULL,
+                 TAG_UNLOCKED_DEVICE_REQUIRED.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, creation_date_time, ASN1_INTEGER, TAG_CREATION_DATETIME.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, origin, ASN1_INTEGER, TAG_ORIGIN.maskedTag()),
-    ASN1_EXP_OPT(KM_AUTH_LIST, rollback_resistant, ASN1_NULL, TAG_ROLLBACK_RESISTANCE.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, root_of_trust, KM_ROOT_OF_TRUST, TAG_ROOT_OF_TRUST.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, os_version, ASN1_INTEGER, TAG_OS_VERSION.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, os_patchlevel, ASN1_INTEGER, TAG_OS_PATCHLEVEL.maskedTag()),
+    ASN1_EXP_OPT(KM_AUTH_LIST, vendor_patchlevel, ASN1_INTEGER, TAG_VENDOR_PATCHLEVEL.maskedTag()),
+    ASN1_EXP_OPT(KM_AUTH_LIST, boot_patchlevel, ASN1_INTEGER, TAG_BOOT_PATCHLEVEL.maskedTag()),
     ASN1_EXP_OPT(KM_AUTH_LIST, attestation_application_id, ASN1_OCTET_STRING,
                  TAG_ATTESTATION_APPLICATION_ID.maskedTag()),
 } ASN1_SEQUENCE_END(KM_AUTH_LIST);
@@ -237,11 +251,18 @@ static ErrorCode extract_auth_list(const KM_AUTH_LIST* record, AuthorizationSet*
     copyAuthTag(record->os_version, TAG_OS_VERSION, auth_list);
     copyAuthTag(record->padding, TAG_PADDING, auth_list);
     copyAuthTag(record->purpose, TAG_PURPOSE, auth_list);
-    copyAuthTag(record->rollback_resistant, TAG_ROLLBACK_RESISTANCE, auth_list);
+    copyAuthTag(record->rollback_resistance, TAG_ROLLBACK_RESISTANCE, auth_list);
     copyAuthTag(record->rsa_public_exponent, TAG_RSA_PUBLIC_EXPONENT, auth_list);
     copyAuthTag(record->usage_expire_date_time, TAG_USAGE_EXPIRE_DATETIME, auth_list);
     copyAuthTag(record->user_auth_type, TAG_USER_AUTH_TYPE, auth_list);
     copyAuthTag(record->attestation_application_id, TAG_ATTESTATION_APPLICATION_ID, auth_list);
+    copyAuthTag(record->vendor_patchlevel, TAG_VENDOR_PATCHLEVEL, auth_list);
+    copyAuthTag(record->boot_patchlevel, TAG_BOOT_PATCHLEVEL, auth_list);
+    copyAuthTag(record->trusted_user_presence_required, TAG_TRUSTED_USER_PRESENCE_REQUIRED,
+                auth_list);
+    copyAuthTag(record->trusted_confirmation_required, TAG_TRUSTED_CONFIRMATION_REQUIRED,
+                auth_list);
+    copyAuthTag(record->unlocked_device_required, TAG_UNLOCKED_DEVICE_REQUIRED, auth_list);
 
     return ErrorCode::OK;
 }
diff --git a/keymaster/4.0/support/include/keymasterV4_0/key_param_output.h b/keymaster/4.0/support/include/keymasterV4_0/key_param_output.h
index 74be3436..6e2b691c 100644
--- a/keymaster/4.0/support/include/keymasterV4_0/key_param_output.h
+++ b/keymaster/4.0/support/include/keymasterV4_0/key_param_output.h
@@ -53,6 +53,10 @@ inline ::std::ostream& operator<<(::std::ostream& os, PaddingMode value) {
     return os << toString(value);
 }
 
+inline ::std::ostream& operator<<(::std::ostream& os, SecurityLevel value) {
+    return os << toString(value);
+}
+
 template <typename ValueT>
 ::std::ostream& operator<<(::std::ostream& os, const NullOr<ValueT>& value) {
     if (!value.isOk()) {
diff --git a/keymaster/4.0/support/include/keymasterV4_0/keymaster_tags.h b/keymaster/4.0/support/include/keymasterV4_0/keymaster_tags.h
index 7c6b2895..0836e76d 100644
--- a/keymaster/4.0/support/include/keymasterV4_0/keymaster_tags.h
+++ b/keymaster/4.0/support/include/keymasterV4_0/keymaster_tags.h
@@ -119,6 +119,7 @@ DECLARE_TYPED_TAG(AUTH_TIMEOUT);
 DECLARE_TYPED_TAG(BLOB_USAGE_REQUIREMENTS);
 DECLARE_TYPED_TAG(BLOCK_MODE);
 DECLARE_TYPED_TAG(BOOTLOADER_ONLY);
+DECLARE_TYPED_TAG(BOOT_PATCHLEVEL);
 DECLARE_TYPED_TAG(CALLER_NONCE);
 DECLARE_TYPED_TAG(CONFIRMATION_TOKEN);
 DECLARE_TYPED_TAG(CREATION_DATETIME);
@@ -144,12 +145,14 @@ DECLARE_TYPED_TAG(ROLLBACK_RESISTANCE);
 DECLARE_TYPED_TAG(ROOT_OF_TRUST);
 DECLARE_TYPED_TAG(RSA_PUBLIC_EXPONENT);
 DECLARE_TYPED_TAG(TRUSTED_CONFIRMATION_REQUIRED);
+DECLARE_TYPED_TAG(TRUSTED_USER_PRESENCE_REQUIRED);
 DECLARE_TYPED_TAG(UNIQUE_ID);
 DECLARE_TYPED_TAG(UNLOCKED_DEVICE_REQUIRED);
 DECLARE_TYPED_TAG(USAGE_EXPIRE_DATETIME);
 DECLARE_TYPED_TAG(USER_AUTH_TYPE);
 DECLARE_TYPED_TAG(USER_ID);
 DECLARE_TYPED_TAG(USER_SECURE_ID);
+DECLARE_TYPED_TAG(VENDOR_PATCHLEVEL);
 
 template <typename... Elems>
 struct MetaList {};
@@ -166,7 +169,8 @@ using all_tags_t =
              TAG_OS_VERSION_t, TAG_OS_PATCHLEVEL_t, TAG_UNIQUE_ID_t, TAG_ATTESTATION_CHALLENGE_t,
              TAG_ATTESTATION_APPLICATION_ID_t, TAG_RESET_SINCE_ID_ROTATION_t, TAG_PURPOSE_t,
              TAG_ALGORITHM_t, TAG_BLOCK_MODE_t, TAG_DIGEST_t, TAG_PADDING_t,
-             TAG_BLOB_USAGE_REQUIREMENTS_t, TAG_ORIGIN_t, TAG_USER_AUTH_TYPE_t, TAG_EC_CURVE_t>;
+             TAG_BLOB_USAGE_REQUIREMENTS_t, TAG_ORIGIN_t, TAG_USER_AUTH_TYPE_t, TAG_EC_CURVE_t,
+             TAG_BOOT_PATCHLEVEL_t, TAG_VENDOR_PATCHLEVEL_t, TAG_TRUSTED_USER_PRESENCE_REQUIRED_t>;
 
 template <typename TypedTagType>
 struct TypedTag2ValueType;
diff --git a/keymaster/4.0/vts/functional/VerificationTokenTest.cpp b/keymaster/4.0/vts/functional/VerificationTokenTest.cpp
index 6afba0c4..3876b16f 100644
--- a/keymaster/4.0/vts/functional/VerificationTokenTest.cpp
+++ b/keymaster/4.0/vts/functional/VerificationTokenTest.cpp
@@ -111,8 +111,9 @@ TEST_F(VerificationTokenTest, TestCreation) {
 
     EXPECT_GE(host_time_delta, time_to_sleep)
         << "We slept for " << time_to_sleep << " ms, the clock must have advanced by that much";
-    EXPECT_LE(host_time_delta, time_to_sleep + 10)
-        << "The verifyAuthorization call took more than 10 ms?  That's awful!";
+    EXPECT_LE(host_time_delta, time_to_sleep + 20)
+        << "The verifyAuthorization call took " << (host_time_delta - time_to_sleep)
+        << " ms?  That's awful!";
 
     auto km_time_delta = result2.token.timestamp - result1.token.timestamp;
 
diff --git a/keymaster/4.0/vts/functional/keymaster_hidl_hal_test.cpp b/keymaster/4.0/vts/functional/keymaster_hidl_hal_test.cpp
index 450b3eb4..ccb51ecf 100644
--- a/keymaster/4.0/vts/functional/keymaster_hidl_hal_test.cpp
+++ b/keymaster/4.0/vts/functional/keymaster_hidl_hal_test.cpp
@@ -182,7 +182,7 @@ X509* parse_cert_blob(const hidl_vec<uint8_t>& blob) {
 }
 
 bool verify_chain(const hidl_vec<hidl_vec<uint8_t>>& chain) {
-    for (size_t i = 0; i < chain.size() - 1; ++i) {
+    for (size_t i = 0; i < chain.size(); ++i) {
         X509_Ptr key_cert(parse_cert_blob(chain[i]));
         X509_Ptr signing_cert;
         if (i < chain.size() - 1) {
@@ -198,7 +198,8 @@ bool verify_chain(const hidl_vec<hidl_vec<uint8_t>>& chain) {
         if (!signing_pubkey.get()) return false;
 
         EXPECT_EQ(1, X509_verify(key_cert.get(), signing_pubkey.get()))
-            << "Verification of certificate " << i << " failed";
+            << "Verification of certificate " << i << " failed "
+            << "OpenSSL error string: " << ERR_error_string(ERR_get_error(), NULL);
 
         char* cert_issuer =  //
             X509_NAME_oneline(X509_get_issuer_name(key_cert.get()), nullptr, 0);
@@ -246,8 +247,7 @@ bool tag_in_list(const KeyParameter& entry) {
     // Attestations don't contain everything in key authorization lists, so we need to filter
     // the key lists to produce the lists that we expect to match the attestations.
     auto tag_list = {
-        Tag::INCLUDE_UNIQUE_ID, Tag::BLOB_USAGE_REQUIREMENTS,
-        Tag::EC_CURVE /* Tag::EC_CURVE will be included by KM2 implementations */,
+        Tag::INCLUDE_UNIQUE_ID, Tag::BLOB_USAGE_REQUIREMENTS, Tag::EC_CURVE, Tag::HARDWARE_TYPE,
     };
     return std::find(tag_list.begin(), tag_list.end(), entry.tag) != tag_list.end();
 }
@@ -271,7 +271,7 @@ std::string make_string(const uint8_t (&a)[N]) {
 
 bool verify_attestation_record(const string& challenge, const string& app_id,
                                AuthorizationSet expected_sw_enforced,
-                               AuthorizationSet expected_tee_enforced,
+                               AuthorizationSet expected_tee_enforced, SecurityLevel security_level,
                                const hidl_vec<uint8_t>& attestation_cert) {
     X509_Ptr cert(parse_cert_blob(attestation_cert));
     EXPECT_TRUE(!!cert.get());
@@ -290,29 +290,27 @@ bool verify_attestation_record(const string& challenge, const string& app_id,
     HidlBuf att_challenge;
     HidlBuf att_unique_id;
     HidlBuf att_app_id;
-    EXPECT_EQ(ErrorCode::OK,
-              parse_attestation_record(attest_rec->data,                 //
-                                       attest_rec->length,               //
-                                       &att_attestation_version,         //
-                                       &att_attestation_security_level,  //
-                                       &att_keymaster_version,           //
-                                       &att_keymaster_security_level,    //
-                                       &att_challenge,                   //
-                                       &att_sw_enforced,                 //
-                                       &att_tee_enforced,                //
-                                       &att_unique_id));
-
-    EXPECT_TRUE(att_attestation_version == 1 || att_attestation_version == 2);
+
+    auto error = parse_attestation_record(attest_rec->data,                 //
+                                          attest_rec->length,               //
+                                          &att_attestation_version,         //
+                                          &att_attestation_security_level,  //
+                                          &att_keymaster_version,           //
+                                          &att_keymaster_security_level,    //
+                                          &att_challenge,                   //
+                                          &att_sw_enforced,                 //
+                                          &att_tee_enforced,                //
+                                          &att_unique_id);
+    EXPECT_EQ(ErrorCode::OK, error);
+    if (error != ErrorCode::OK) return false;
+
+    EXPECT_TRUE(att_attestation_version == 3);
 
     expected_sw_enforced.push_back(TAG_ATTESTATION_APPLICATION_ID, HidlBuf(app_id));
 
     EXPECT_GE(att_keymaster_version, 3U);
-    EXPECT_EQ(KeymasterHidlTest::IsSecure() ? SecurityLevel::TRUSTED_ENVIRONMENT
-                                            : SecurityLevel::SOFTWARE,
-              att_keymaster_security_level);
-    EXPECT_EQ(KeymasterHidlTest::IsSecure() ? SecurityLevel::TRUSTED_ENVIRONMENT
-                                            : SecurityLevel::SOFTWARE,
-              att_attestation_security_level);
+    EXPECT_EQ(security_level, att_keymaster_security_level);
+    EXPECT_EQ(security_level, att_attestation_security_level);
 
     EXPECT_EQ(challenge.length(), att_challenge.size());
     EXPECT_EQ(0, memcmp(challenge.data(), att_challenge.data(), challenge.length()));
@@ -538,10 +536,16 @@ TEST_F(NewKeyGenerationTest, EcdsaAllValidSizes) {
  * Verifies that keymaster does not support any curve designated as unsupported.
  */
 TEST_F(NewKeyGenerationTest, EcdsaAllValidCurves) {
+    Digest digest;
+    if (SecLevel() == SecurityLevel::STRONGBOX) {
+        digest = Digest::SHA_2_256;
+    } else {
+        digest = Digest::SHA_2_512;
+    }
     for (auto curve : ValidCurves()) {
         EXPECT_EQ(
             ErrorCode::OK,
-            GenerateKey(AuthorizationSetBuilder().EcdsaSigningKey(curve).Digest(Digest::SHA_2_512)))
+            GenerateKey(AuthorizationSetBuilder().EcdsaSigningKey(curve).Digest(digest)))
             << "Failed to generate key on curve: " << curve;
         CheckCharacteristics(key_blob_, key_characteristics_);
         CheckedDeleteKey();
@@ -831,6 +835,7 @@ TEST_F(SigningOperationsTest, RsaPkcs1NoDigestTooLong) {
  * 1024-bit key.
  */
 TEST_F(SigningOperationsTest, RsaPssSha512TooSmallKey) {
+    if (SecLevel() == SecurityLevel::STRONGBOX) return;
     ASSERT_EQ(ErrorCode::OK, GenerateKey(AuthorizationSetBuilder()
                                              .RsaSigningKey(1024, 65537)
                                              .Digest(Digest::SHA_2_512)
@@ -1188,10 +1193,12 @@ TEST_F(SigningOperationsTest, HmacRfc4231TestCase3) {
         0xbe, 0xe8, 0x94, 0x26, 0x74, 0x27, 0x88, 0x59, 0xe1, 0x32, 0x92, 0xfb,
     };
 
-    CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
     CheckHmacTestVector(key, message, Digest::SHA_2_256, make_string(sha_256_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    if (SecLevel() != SecurityLevel::STRONGBOX) {
+        CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    }
 }
 
 /*
@@ -1220,10 +1227,12 @@ TEST_F(SigningOperationsTest, HmacRfc4231TestCase5) {
         0x1d, 0x41, 0x79, 0xbc, 0x89, 0x1d, 0x87, 0xa6,
     };
 
-    CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
     CheckHmacTestVector(key, message, Digest::SHA_2_256, make_string(sha_256_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    if (SecLevel() != SecurityLevel::STRONGBOX) {
+        CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    }
 }
 
 /*
@@ -1258,10 +1267,12 @@ TEST_F(SigningOperationsTest, HmacRfc4231TestCase6) {
         0xf6, 0x3f, 0x0a, 0xec, 0x8b, 0x91, 0x5a, 0x98, 0x5d, 0x78, 0x65, 0x98,
     };
 
-    CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
     CheckHmacTestVector(key, message, Digest::SHA_2_256, make_string(sha_256_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    if (SecLevel() != SecurityLevel::STRONGBOX) {
+        CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    }
 }
 
 /*
@@ -1299,10 +1310,12 @@ TEST_F(SigningOperationsTest, HmacRfc4231TestCase7) {
         0x6d, 0xe0, 0x44, 0x60, 0x65, 0xc9, 0x74, 0x40, 0xfa, 0x8c, 0x6a, 0x58,
     };
 
-    CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
     CheckHmacTestVector(key, message, Digest::SHA_2_256, make_string(sha_256_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
-    CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    if (SecLevel() != SecurityLevel::STRONGBOX) {
+        CheckHmacTestVector(key, message, Digest::SHA_2_224, make_string(sha_224_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_384, make_string(sha_384_expected));
+        CheckHmacTestVector(key, message, Digest::SHA_2_512, make_string(sha_512_expected));
+    }
 }
 
 typedef KeymasterHidlTest VerificationOperationsTest;
@@ -1514,7 +1527,7 @@ TEST_F(VerificationOperationsTest, HmacSigningKeyCannotVerify) {
                             .Authorization(TAG_NO_AUTH_REQUIRED)
                             .Authorization(TAG_ALGORITHM, Algorithm::HMAC)
                             .Authorization(TAG_PURPOSE, KeyPurpose::SIGN)
-                            .Digest(Digest::SHA1)
+                            .Digest(Digest::SHA_2_256)
                             .Authorization(TAG_MIN_MAC_LENGTH, 160),
                         KeyFormat::RAW, key_material, &signing_key, &signing_key_chars));
     EXPECT_EQ(ErrorCode::OK,
@@ -1522,24 +1535,24 @@ TEST_F(VerificationOperationsTest, HmacSigningKeyCannotVerify) {
                             .Authorization(TAG_NO_AUTH_REQUIRED)
                             .Authorization(TAG_ALGORITHM, Algorithm::HMAC)
                             .Authorization(TAG_PURPOSE, KeyPurpose::VERIFY)
-                            .Digest(Digest::SHA1)
+                            .Digest(Digest::SHA_2_256)
                             .Authorization(TAG_MIN_MAC_LENGTH, 160),
                         KeyFormat::RAW, key_material, &verification_key, &verification_key_chars));
 
     string message = "This is a message.";
     string signature = SignMessage(
         signing_key, message,
-        AuthorizationSetBuilder().Digest(Digest::SHA1).Authorization(TAG_MAC_LENGTH, 160));
+        AuthorizationSetBuilder().Digest(Digest::SHA_2_256).Authorization(TAG_MAC_LENGTH, 160));
 
     // Signing key should not work.
     AuthorizationSet out_params;
     EXPECT_EQ(ErrorCode::INCOMPATIBLE_PURPOSE,
-              Begin(KeyPurpose::VERIFY, signing_key, AuthorizationSetBuilder().Digest(Digest::SHA1),
+              Begin(KeyPurpose::VERIFY, signing_key, AuthorizationSetBuilder().Digest(Digest::SHA_2_256),
                     &out_params, &op_handle_));
 
     // Verification key should work.
     VerifyMessage(verification_key, message, signature,
-                  AuthorizationSetBuilder().Digest(Digest::SHA1));
+                  AuthorizationSetBuilder().Digest(Digest::SHA_2_256));
 
     CheckedDeleteKey(&signing_key);
     CheckedDeleteKey(&verification_key);
@@ -1898,14 +1911,14 @@ class ImportWrappedKeyTest : public KeymasterHidlTest {};
 TEST_F(ImportWrappedKeyTest, Success) {
     auto wrapping_key_desc = AuthorizationSetBuilder()
                                  .RsaEncryptionKey(2048, 65537)
-                                 .Digest(Digest::SHA1)
+                                 .Digest(Digest::SHA_2_256)
                                  .Padding(PaddingMode::RSA_OAEP)
                                  .Authorization(TAG_PURPOSE, KeyPurpose::WRAP_KEY);
 
     ASSERT_EQ(ErrorCode::OK,
               ImportWrappedKey(
                   wrapped_key, wrapping_key, wrapping_key_desc, zero_masking_key,
-                  AuthorizationSetBuilder().Digest(Digest::SHA1).Padding(PaddingMode::RSA_OAEP)));
+                  AuthorizationSetBuilder().Digest(Digest::SHA_2_256).Padding(PaddingMode::RSA_OAEP)));
 
     string message = "Hello World!";
     auto params = AuthorizationSetBuilder().BlockMode(BlockMode::ECB).Padding(PaddingMode::PKCS7);
@@ -1917,39 +1930,39 @@ TEST_F(ImportWrappedKeyTest, Success) {
 TEST_F(ImportWrappedKeyTest, SuccessMasked) {
     auto wrapping_key_desc = AuthorizationSetBuilder()
                                  .RsaEncryptionKey(2048, 65537)
-                                 .Digest(Digest::SHA1)
+                                 .Digest(Digest::SHA_2_256)
                                  .Padding(PaddingMode::RSA_OAEP)
                                  .Authorization(TAG_PURPOSE, KeyPurpose::WRAP_KEY);
 
     ASSERT_EQ(ErrorCode::OK,
               ImportWrappedKey(
                   wrapped_key_masked, wrapping_key, wrapping_key_desc, masking_key,
-                  AuthorizationSetBuilder().Digest(Digest::SHA1).Padding(PaddingMode::RSA_OAEP)));
+                  AuthorizationSetBuilder().Digest(Digest::SHA_2_256).Padding(PaddingMode::RSA_OAEP)));
 }
 
 TEST_F(ImportWrappedKeyTest, WrongMask) {
     auto wrapping_key_desc = AuthorizationSetBuilder()
                                  .RsaEncryptionKey(2048, 65537)
-                                 .Digest(Digest::SHA1)
+                                 .Digest(Digest::SHA_2_256)
                                  .Padding(PaddingMode::RSA_OAEP)
                                  .Authorization(TAG_PURPOSE, KeyPurpose::WRAP_KEY);
 
     ASSERT_EQ(ErrorCode::VERIFICATION_FAILED,
               ImportWrappedKey(
                   wrapped_key_masked, wrapping_key, wrapping_key_desc, zero_masking_key,
-                  AuthorizationSetBuilder().Digest(Digest::SHA1).Padding(PaddingMode::RSA_OAEP)));
+                  AuthorizationSetBuilder().Digest(Digest::SHA_2_256).Padding(PaddingMode::RSA_OAEP)));
 }
 
 TEST_F(ImportWrappedKeyTest, WrongPurpose) {
     auto wrapping_key_desc = AuthorizationSetBuilder()
                                  .RsaEncryptionKey(2048, 65537)
-                                 .Digest(Digest::SHA1)
+                                 .Digest(Digest::SHA_2_256)
                                  .Padding(PaddingMode::RSA_OAEP);
 
     ASSERT_EQ(ErrorCode::INCOMPATIBLE_PURPOSE,
               ImportWrappedKey(
                   wrapped_key_masked, wrapping_key, wrapping_key_desc, zero_masking_key,
-                  AuthorizationSetBuilder().Digest(Digest::SHA1).Padding(PaddingMode::RSA_OAEP)));
+                  AuthorizationSetBuilder().Digest(Digest::SHA_2_256).Padding(PaddingMode::RSA_OAEP)));
 }
 
 typedef KeymasterHidlTest EncryptionOperationsTest;
@@ -2143,11 +2156,13 @@ TEST_F(EncryptionOperationsTest, RsaOaepInvalidDigest) {
  * different digest than was used to encrypt.
  */
 TEST_F(EncryptionOperationsTest, RsaOaepDecryptWithWrongDigest) {
+    if (SecLevel() == SecurityLevel::STRONGBOX) return;
+
     ASSERT_EQ(ErrorCode::OK, GenerateKey(AuthorizationSetBuilder()
                                              .Authorization(TAG_NO_AUTH_REQUIRED)
                                              .RsaEncryptionKey(1024, 65537)
                                              .Padding(PaddingMode::RSA_OAEP)
-                                             .Digest(Digest::SHA_2_256, Digest::SHA_2_224)));
+                                             .Digest(Digest::SHA_2_224, Digest::SHA_2_256)));
     string message = "Hello World!";
     string ciphertext = EncryptMessage(
         message,
@@ -2173,13 +2188,13 @@ TEST_F(EncryptionOperationsTest, RsaOaepTooLarge) {
                                              .Authorization(TAG_NO_AUTH_REQUIRED)
                                              .RsaEncryptionKey(1024, 65537)
                                              .Padding(PaddingMode::RSA_OAEP)
-                                             .Digest(Digest::SHA1)));
-    constexpr size_t digest_size = 160 /* SHA1 */ / 8;
+                                             .Digest(Digest::SHA_2_256)));
+    constexpr size_t digest_size = 256 /* SHA_2_256 */ / 8;
     constexpr size_t oaep_overhead = 2 * digest_size + 2;
     string message(1024 / 8 - oaep_overhead + 1, 'a');
     EXPECT_EQ(ErrorCode::OK,
               Begin(KeyPurpose::ENCRYPT,
-                    AuthorizationSetBuilder().Padding(PaddingMode::RSA_OAEP).Digest(Digest::SHA1)));
+                    AuthorizationSetBuilder().Padding(PaddingMode::RSA_OAEP).Digest(Digest::SHA_2_256)));
     string result;
     EXPECT_EQ(ErrorCode::INVALID_ARGUMENT, Finish(message, &result));
     EXPECT_EQ(0U, result.size());
@@ -3008,6 +3023,7 @@ TEST_F(EncryptionOperationsTest, AesGcmAadNoData) {
  * Verifies that AES GCM mode works when provided additional authenticated data in multiple chunks.
  */
 TEST_F(EncryptionOperationsTest, AesGcmMultiPartAad) {
+    const size_t tag_bits = 128;
     ASSERT_EQ(ErrorCode::OK, GenerateKey(AuthorizationSetBuilder()
                                              .Authorization(TAG_NO_AUTH_REQUIRED)
                                              .AesEncryptionKey(128)
@@ -3019,7 +3035,7 @@ TEST_F(EncryptionOperationsTest, AesGcmMultiPartAad) {
     auto begin_params = AuthorizationSetBuilder()
                             .BlockMode(BlockMode::GCM)
                             .Padding(PaddingMode::NONE)
-                            .Authorization(TAG_MAC_LENGTH, 128);
+                            .Authorization(TAG_MAC_LENGTH, tag_bits);
     AuthorizationSet begin_out_params;
 
     auto update_params =
@@ -3041,10 +3057,11 @@ TEST_F(EncryptionOperationsTest, AesGcmMultiPartAad) {
     EXPECT_EQ(ErrorCode::OK, Update(op_handle_, update_params, message, &update_out_params,
                                     &ciphertext, &input_consumed));
     EXPECT_EQ(message.size(), input_consumed);
-    EXPECT_EQ(message.size(), ciphertext.size());
     EXPECT_TRUE(update_out_params.empty());
 
     EXPECT_EQ(ErrorCode::OK, Finish("" /* input */, &ciphertext));
+    // Expect 128-bit (16-byte) tag appended to ciphertext.
+    EXPECT_EQ(message.size() + (tag_bits >> 3), ciphertext.size());
 
     // Grab nonce.
     begin_params.push_back(begin_out_params);
@@ -3100,7 +3117,6 @@ TEST_F(EncryptionOperationsTest, AesGcmAadOutOfOrder) {
     EXPECT_EQ(ErrorCode::OK, Update(op_handle_, update_params, message, &update_out_params,
                                     &ciphertext, &input_consumed));
     EXPECT_EQ(message.size(), input_consumed);
-    EXPECT_EQ(message.size(), ciphertext.size());
     EXPECT_TRUE(update_out_params.empty());
 
     // More AAD
@@ -3827,7 +3843,7 @@ TEST_F(AttestationTest, RsaAttestation) {
     EXPECT_TRUE(verify_attestation_record("challenge", "foo",                     //
                                           key_characteristics_.softwareEnforced,  //
                                           key_characteristics_.hardwareEnforced,  //
-                                          cert_chain[0]));
+                                          SecLevel(), cert_chain[0]));
 }
 
 /*
@@ -3874,7 +3890,7 @@ TEST_F(AttestationTest, EcAttestation) {
     EXPECT_TRUE(verify_attestation_record("challenge", "foo",                     //
                                           key_characteristics_.softwareEnforced,  //
                                           key_characteristics_.hardwareEnforced,  //
-                                          cert_chain[0]));
+                                          SecLevel(), cert_chain[0]));
 }
 
 /*
diff --git a/media/omx/1.0/vts/functional/audio/VtsHalMediaOmxV1_0TargetAudioDecTest.cpp b/media/omx/1.0/vts/functional/audio/VtsHalMediaOmxV1_0TargetAudioDecTest.cpp
index 725e2904..e851a7c1 100644
--- a/media/omx/1.0/vts/functional/audio/VtsHalMediaOmxV1_0TargetAudioDecTest.cpp
+++ b/media/omx/1.0/vts/functional/audio/VtsHalMediaOmxV1_0TargetAudioDecTest.cpp
@@ -151,6 +151,15 @@ class AudioDecHidlTest : public ::testing::VtsHalHidlTargetTestBase {
         framesReceived = 0;
         timestampUs = 0;
         timestampDevTest = false;
+        isSecure = false;
+        size_t suffixLen = strlen(".secure");
+        if (strlen(gEnv->getComponent().c_str()) >= suffixLen) {
+            isSecure =
+                !strcmp(gEnv->getComponent().c_str() +
+                            strlen(gEnv->getComponent().c_str()) - suffixLen,
+                        ".secure");
+        }
+        if (isSecure) disableTest = true;
         if (disableTest) std::cout << "[   WARN   ] Test Disabled \n";
     }
 
@@ -247,6 +256,7 @@ class AudioDecHidlTest : public ::testing::VtsHalHidlTargetTestBase {
     OMX_AUDIO_CODINGTYPE eEncoding;
     bool disableTest;
     bool eosFlag;
+    bool isSecure;
     uint32_t framesReceived;
     uint64_t timestampUs;
     ::android::List<uint64_t> timestampUslist;
diff --git a/power/1.3/Android.bp b/power/1.3/Android.bp
new file mode 100644
index 00000000..65b75977
--- /dev/null
+++ b/power/1.3/Android.bp
@@ -0,0 +1,21 @@
+// This file is autogenerated by hidl-gen -Landroidbp.
+
+hidl_interface {
+    name: "android.hardware.power@1.3",
+    root: "android.hardware",
+    srcs: [
+        "types.hal",
+        "IPower.hal",
+    ],
+    interfaces: [
+        "android.hardware.power@1.0",
+        "android.hardware.power@1.1",
+        "android.hardware.power@1.2",
+        "android.hidl.base@1.0",
+    ],
+    types: [
+        "PowerHint",
+    ],
+    gen_java: true,
+}
+
diff --git a/power/1.3/IPower.hal b/power/1.3/IPower.hal
new file mode 100644
index 00000000..18b00a30
--- /dev/null
+++ b/power/1.3/IPower.hal
@@ -0,0 +1,33 @@
+/*
+ * Copyright (C) 2018 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.hardware.power@1.3;
+
+import @1.2::IPower;
+
+interface IPower extends @1.2::IPower {
+    /**
+     * Called to pass hints on power requirements which
+     * may result in adjustment of power/performance parameters of the
+     * cpufreq governor and other controls.
+     *
+     * A particular platform may choose to ignore any hint.
+     *
+     * @param hint PowerHint which is passed
+     * @param data contains additional information about the hint
+     *     and is described along with the comments for each of the hints.
+     */
+    oneway powerHintAsync_1_3(PowerHint hint, int32_t data);
+};
diff --git a/power/1.3/types.hal b/power/1.3/types.hal
new file mode 100644
index 00000000..658495cf
--- /dev/null
+++ b/power/1.3/types.hal
@@ -0,0 +1,28 @@
+/*
+ * Copyright (C) 2018 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package android.hardware.power@1.3;
+
+import @1.2::PowerHint;
+
+/** Power hint identifiers passed to powerHintAsync_1_3() */
+enum PowerHint : @1.2::PowerHint {
+   /**
+    * This hint indicates that the device is about to enter a period of expensive rendering, and
+    * the GPU should be configured accordingly. The data parameter is always 1 when entering this
+    * state and 0 when leaving it.
+    */
+    EXPENSIVE_RENDERING,
+};
diff --git a/power/1.3/vts/functional/Android.bp b/power/1.3/vts/functional/Android.bp
new file mode 100644
index 00000000..34cdb607
--- /dev/null
+++ b/power/1.3/vts/functional/Android.bp
@@ -0,0 +1,27 @@
+//
+// Copyright (C) 2018 The Android Open Source Project
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+//
+
+cc_test {
+    name: "VtsHalPowerV1_3TargetTest",
+    defaults: ["VtsHalTargetTestDefaults"],
+    srcs: ["VtsHalPowerV1_3TargetTest.cpp"],
+    static_libs: [
+        "android.hardware.power@1.0",
+        "android.hardware.power@1.1",
+        "android.hardware.power@1.2",
+        "android.hardware.power@1.3",
+    ],
+}
diff --git a/power/1.3/vts/functional/VtsHalPowerV1_3TargetTest.cpp b/power/1.3/vts/functional/VtsHalPowerV1_3TargetTest.cpp
new file mode 100644
index 00000000..af1a1d86
--- /dev/null
+++ b/power/1.3/vts/functional/VtsHalPowerV1_3TargetTest.cpp
@@ -0,0 +1,64 @@
+/*
+ * Copyright (C) 2018 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+#define LOG_TAG "power_hidl_hal_test"
+#include <android-base/logging.h>
+#include <android/hardware/power/1.3/IPower.h>
+
+#include <VtsHalHidlTargetTestBase.h>
+#include <VtsHalHidlTargetTestEnvBase.h>
+
+using ::android::sp;
+using ::android::hardware::hidl_vec;
+using ::android::hardware::Return;
+using ::android::hardware::power::V1_3::IPower;
+using ::android::hardware::power::V1_3::PowerHint;
+
+// Test environment for Power HIDL HAL.
+class PowerHidlEnvironment : public ::testing::VtsHalHidlTargetTestEnvBase {
+   public:
+    // get the test environment singleton
+    static PowerHidlEnvironment* Instance() {
+        static PowerHidlEnvironment* instance = new PowerHidlEnvironment;
+        return instance;
+    }
+
+    virtual void registerTestServices() override { registerTestService<IPower>(); }
+};
+
+class PowerHidlTest : public ::testing::VtsHalHidlTargetTestBase {
+   public:
+    virtual void SetUp() override {
+        power = ::testing::VtsHalHidlTargetTestBase::getService<IPower>(
+            PowerHidlEnvironment::Instance()->getServiceName<IPower>());
+        ASSERT_NE(power, nullptr);
+    }
+
+    sp<IPower> power;
+};
+
+TEST_F(PowerHidlTest, PowerHintAsync_1_3) {
+    ASSERT_TRUE(power->powerHintAsync_1_3(PowerHint::EXPENSIVE_RENDERING, 0).isOk());
+}
+
+int main(int argc, char** argv) {
+    ::testing::AddGlobalTestEnvironment(PowerHidlEnvironment::Instance());
+    ::testing::InitGoogleTest(&argc, argv);
+    PowerHidlEnvironment::Instance()->init(&argc, argv);
+    int status = RUN_ALL_TESTS();
+    LOG(INFO) << "Test result = " << status;
+    return status;
+}
diff --git a/radio/1.0/IRadioResponse.hal b/radio/1.0/IRadioResponse.hal
index 27945cb0..c1b16b7b 100644
--- a/radio/1.0/IRadioResponse.hal
+++ b/radio/1.0/IRadioResponse.hal
@@ -88,6 +88,7 @@ interface IRadioResponse {
      *   RadioError:INVALID_ARGUMENTS
      *   RadioError:INVALID_SIM_STATE
      *   RadioError:REQUEST_NOT_SUPPORTED
+     *   RadioError:SIM_PUK2
      */
     oneway supplyIccPin2ForAppResponse(RadioResponseInfo info, int32_t remainingRetries);
 
@@ -141,6 +142,7 @@ interface IRadioResponse {
      *   RadioError:INVALID_ARGUMENTS
      *   RadioError:INVALID_SIM_STATE
      *   RadioError:REQUEST_NOT_SUPPORTED
+     *   RadioError:SIM_PUK2
      */
     oneway changeIccPin2ForAppResponse(RadioResponseInfo info, int32_t remainingRetries);
 
diff --git a/radio/1.0/vts/functional/radio_hidl_hal_icc.cpp b/radio/1.0/vts/functional/radio_hidl_hal_icc.cpp
index 73e26d2d..5042c071 100644
--- a/radio/1.0/vts/functional/radio_hidl_hal_icc.cpp
+++ b/radio/1.0/vts/functional/radio_hidl_hal_icc.cpp
@@ -44,7 +44,9 @@ TEST_F(RadioHidlTest, supplyIccPinForApp) {
             EXPECT_EQ(std::cv_status::no_timeout, wait());
             EXPECT_EQ(serial, radioRsp->rspInfo.serial);
             EXPECT_EQ(RadioResponseType::SOLICITED, radioRsp->rspInfo.type);
-            EXPECT_EQ(RadioError::PASSWORD_INCORRECT, radioRsp->rspInfo.error);
+            ASSERT_TRUE(CheckAnyOfErrors(
+                radioRsp->rspInfo.error,
+                {RadioError::PASSWORD_INCORRECT, RadioError::REQUEST_NOT_SUPPORTED}));
         }
     }
 }
@@ -90,7 +92,10 @@ TEST_F(RadioHidlTest, supplyIccPin2ForApp) {
             EXPECT_EQ(std::cv_status::no_timeout, wait());
             EXPECT_EQ(serial, radioRsp->rspInfo.serial);
             EXPECT_EQ(RadioResponseType::SOLICITED, radioRsp->rspInfo.type);
-            EXPECT_EQ(RadioError::PASSWORD_INCORRECT, radioRsp->rspInfo.error);
+            ASSERT_TRUE(
+                CheckAnyOfErrors(radioRsp->rspInfo.error,
+                                 {RadioError::PASSWORD_INCORRECT, RadioError::REQUEST_NOT_SUPPORTED,
+                                  RadioError::SIM_PUK2}));
         }
     }
 }
@@ -161,9 +166,10 @@ TEST_F(RadioHidlTest, changeIccPin2ForApp) {
             EXPECT_EQ(std::cv_status::no_timeout, wait());
             EXPECT_EQ(serial, radioRsp->rspInfo.serial);
             EXPECT_EQ(RadioResponseType::SOLICITED, radioRsp->rspInfo.type);
-            ASSERT_TRUE(CheckAnyOfErrors(
-                radioRsp->rspInfo.error,
-                {RadioError::PASSWORD_INCORRECT, RadioError::REQUEST_NOT_SUPPORTED}));
+            ASSERT_TRUE(
+                CheckAnyOfErrors(radioRsp->rspInfo.error,
+                                 {RadioError::PASSWORD_INCORRECT, RadioError::REQUEST_NOT_SUPPORTED,
+                                  RadioError::SIM_PUK2}));
         }
     }
 }
@@ -184,7 +190,8 @@ TEST_F(RadioHidlTest, getImsiForApp) {
             EXPECT_EQ(std::cv_status::no_timeout, wait());
             EXPECT_EQ(RadioResponseType::SOLICITED, radioRsp->rspInfo.type);
             EXPECT_EQ(serial, radioRsp->rspInfo.serial);
-            EXPECT_EQ(RadioError::NONE, radioRsp->rspInfo.error);
+            ASSERT_TRUE(
+                CheckAnyOfErrors(radioRsp->rspInfo.error, {RadioError::NONE}, CHECK_GENERAL_ERROR));
 
             // IMSI (MCC+MNC+MSIN) is at least 6 digits, but not more than 15
             if (radioRsp->rspInfo.error == RadioError::NONE) {
diff --git a/radio/1.0/vts/functional/radio_hidl_hal_misc.cpp b/radio/1.0/vts/functional/radio_hidl_hal_misc.cpp
index bc03cf19..24d99449 100644
--- a/radio/1.0/vts/functional/radio_hidl_hal_misc.cpp
+++ b/radio/1.0/vts/functional/radio_hidl_hal_misc.cpp
@@ -694,9 +694,10 @@ TEST_F(RadioHidlTest, startLceService) {
     EXPECT_EQ(serial, radioRsp->rspInfo.serial);
 
     if (cardStatus.cardState == CardState::ABSENT) {
-        ASSERT_TRUE(CheckAnyOfErrors(radioRsp->rspInfo.error,
-                                     {RadioError::INTERNAL_ERR, RadioError::LCE_NOT_SUPPORTED,
-                                      RadioError::RADIO_NOT_AVAILABLE, RadioError::SIM_ABSENT}));
+        ASSERT_TRUE(CheckAnyOfErrors(
+            radioRsp->rspInfo.error,
+            {RadioError::INTERNAL_ERR, RadioError::LCE_NOT_SUPPORTED,
+             RadioError::RADIO_NOT_AVAILABLE, RadioError::SIM_ABSENT, RadioError::NONE}));
     }
 }
 
@@ -730,10 +731,10 @@ TEST_F(RadioHidlTest, pullLceData) {
     EXPECT_EQ(serial, radioRsp->rspInfo.serial);
 
     if (cardStatus.cardState == CardState::ABSENT) {
-        ASSERT_TRUE(CheckAnyOfErrors(
-            radioRsp->rspInfo.error,
-            {RadioError::NONE, RadioError::INTERNAL_ERR, RadioError::RADIO_NOT_AVAILABLE},
-            CHECK_OEM_ERROR));
+        ASSERT_TRUE(CheckAnyOfErrors(radioRsp->rspInfo.error,
+                                     {RadioError::NONE, RadioError::INTERNAL_ERR,
+                                      RadioError::RADIO_NOT_AVAILABLE, RadioError::SIM_ABSENT},
+                                     CHECK_OEM_ERROR));
     }
 }
 
diff --git a/radio/1.2/IRadio.hal b/radio/1.2/IRadio.hal
index 6463b0fc..87b0add5 100644
--- a/radio/1.2/IRadio.hal
+++ b/radio/1.2/IRadio.hal
@@ -59,19 +59,30 @@ interface IRadio extends @1.1::IRadio {
     /**
      * Sets the signal strength reporting criteria.
      *
-     * The resulting reporting criteria are the AND of all the supplied criteria.
+     * The resulting reporting rules are the AND of all the supplied criteria. For each RAN
+     * The thresholdsDbm and hysteresisDb apply to only the following measured quantities:
+     * -GERAN    - RSSI
+     * -CDMA2000 - RSSI
+     * -UTRAN    - RSCP
+     * -EUTRAN   - RSRP
      *
-     * Note: Reporting criteria must be individually set for each RAN. If unset, reporting criteria
-     * for that RAN are implementation-defined.
+     * Note: Reporting criteria must be individually set for each RAN. For any unset reporting
+     * criteria, the value is implementation-defined.
      *
-     * Response callback is IRadioResponse.setSignalStrengthReportingCriteriaResponse().
+     * Note: As this mechanism generally only constrains reports based on one measured quantity per
+     * RAN, if multiple measured quantities must be used to trigger a report for a given RAN, the
+     * only valid field may be hysteresisMs: hysteresisDb and thresholdsDbm must be set to zero and
+     * length zero respectively. If either hysteresisDb or thresholdsDbm is set, then reports shall
+     * only be triggered by the respective measured quantity, subject to the applied constraints.
+     *
+     * Response callback is IRadioResponse.setSignalStrengthReportingCriteriaResponse()
      *
      * @param serial Serial number of request.
      * @param hysteresisMs A hysteresis time in milliseconds to prevent flapping. A value of 0
      *     disables hysteresis.
      * @param hysteresisDb An interval in dB defining the required magnitude change between reports.
-     *     hysteresisDb must be smaller than the smallest threshold delta. An
-     *     interval value of 0 disables hysteresis.
+     *     hysteresisDb must be smaller than the smallest threshold delta. An interval value of 0
+     *     disables hysteresis.
      * @param thresholdsDbm A vector of trigger thresholds in dBm. A vector size of 0 disables the
      *     use of thresholds for reporting.
      * @param accessNetwork The type of network for which to apply these thresholds.
diff --git a/radio/1.2/vts/functional/radio_hidl_hal_api.cpp b/radio/1.2/vts/functional/radio_hidl_hal_api.cpp
index 9284fd8f..a9865e53 100644
--- a/radio/1.2/vts/functional/radio_hidl_hal_api.cpp
+++ b/radio/1.2/vts/functional/radio_hidl_hal_api.cpp
@@ -43,7 +43,13 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan) {
     if (cardStatus.base.cardState == CardState::ABSENT) {
         ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::SIM_ABSENT}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
-        ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::NONE}));
+        // REQUEST_NOT_SUPPORTED should not be allowed as it is not an optional API. However, the
+        // comments in the hal were not updated to indicate that, hence allowing it as a valid
+        // error for now. This should be fixed correctly, possibly in a future version of the hal
+        // (b/110421924). This is being allowed because some vendors do not support
+        // this request on dual sim devices.
+        ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                                     {RadioError::NONE, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -69,7 +75,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_InvalidArgument) {
                                      {RadioError::SIM_ABSENT, RadioError::INVALID_ARGUMENTS}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(
-            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                             {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -105,7 +112,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_InvalidInterval1) {
                                      {RadioError::SIM_ABSENT, RadioError::INVALID_ARGUMENTS}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(
-            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                             {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -141,7 +149,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_InvalidInterval2) {
                                      {RadioError::SIM_ABSENT, RadioError::INVALID_ARGUMENTS}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(
-            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                             {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -177,7 +186,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_InvalidMaxSearchTime1) {
                                      {RadioError::SIM_ABSENT, RadioError::INVALID_ARGUMENTS}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(
-            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                             {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -213,7 +223,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_InvalidMaxSearchTime2) {
                                      {RadioError::SIM_ABSENT, RadioError::INVALID_ARGUMENTS}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(
-            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                             {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -249,7 +260,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_InvalidPeriodicity1) {
                                      {RadioError::SIM_ABSENT, RadioError::INVALID_ARGUMENTS}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(
-            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                             {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -285,7 +297,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_InvalidPeriodicity2) {
                                      {RadioError::SIM_ABSENT, RadioError::INVALID_ARGUMENTS}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(
-            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+            CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                             {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -320,7 +333,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_GoodRequest1) {
         ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
                                      {RadioError::NONE, RadioError::SIM_ABSENT}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
-        ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::NONE}));
+        ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                                     {RadioError::NONE, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -356,7 +370,8 @@ TEST_F(RadioHidlTest_v1_2, startNetworkScan_GoodRequest2) {
         ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
                                      {RadioError::NONE, RadioError::SIM_ABSENT}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
-        ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::NONE}));
+        ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                                     {RadioError::NONE, RadioError::REQUEST_NOT_SUPPORTED}));
     }
 }
 
@@ -510,7 +525,11 @@ TEST_F(RadioHidlTest_v1_2, setLinkCapacityReportingCriteria_invalidHysteresisDlK
 
     ALOGI("setLinkCapacityReportingCriteria_invalidHysteresisDlKbps, rspInfo.error = %s\n",
           toString(radioRsp_v1_2->rspInfo.error).c_str());
-    ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+    // Allow REQUEST_NOT_SUPPORTED as setLinkCapacityReportingCriteria() may not be supported for
+    // GERAN
+    ASSERT_TRUE(
+        CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                         {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
 }
 
 /*
@@ -531,7 +550,11 @@ TEST_F(RadioHidlTest_v1_2, setLinkCapacityReportingCriteria_invalidHysteresisUlK
 
     ALOGI("setLinkCapacityReportingCriteria_invalidHysteresisUlKbps, rspInfo.error = %s\n",
           toString(radioRsp_v1_2->rspInfo.error).c_str());
-    ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::INVALID_ARGUMENTS}));
+    // Allow REQUEST_NOT_SUPPORTED as setLinkCapacityReportingCriteria() may not be supported for
+    // GERAN
+    ASSERT_TRUE(
+        CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                         {RadioError::INVALID_ARGUMENTS, RadioError::REQUEST_NOT_SUPPORTED}));
 }
 
 /*
@@ -549,7 +572,10 @@ TEST_F(RadioHidlTest_v1_2, setLinkCapacityReportingCriteria_emptyParams) {
 
     ALOGI("setLinkCapacityReportingCriteria_emptyParams, rspInfo.error = %s\n",
           toString(radioRsp_v1_2->rspInfo.error).c_str());
-    ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::NONE}));
+    // Allow REQUEST_NOT_SUPPORTED as setLinkCapacityReportingCriteria() may not be supported for
+    // GERAN
+    ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                                 {RadioError::NONE, RadioError::REQUEST_NOT_SUPPORTED}));
 }
 
 /*
@@ -568,7 +594,10 @@ TEST_F(RadioHidlTest_v1_2, setLinkCapacityReportingCriteria_Geran) {
 
     ALOGI("setLinkCapacityReportingCriteria_invalidHysteresisUlKbps, rspInfo.error = %s\n",
           toString(radioRsp_v1_2->rspInfo.error).c_str());
-    ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error, {RadioError::NONE}));
+    // Allow REQUEST_NOT_SUPPORTED as setLinkCapacityReportingCriteria() may not be supported for
+    // GERAN
+    ASSERT_TRUE(CheckAnyOfErrors(radioRsp_v1_2->rspInfo.error,
+                                 {RadioError::NONE, RadioError::REQUEST_NOT_SUPPORTED}));
 }
 
 /*
@@ -621,8 +650,9 @@ TEST_F(RadioHidlTest_v1_2, setupDataCall_1_2) {
     if (cardStatus.base.cardState == CardState::ABSENT) {
         ASSERT_TRUE(CheckAnyOfErrors(
             radioRsp_v1_2->rspInfo.error,
-            {RadioError::SIM_ABSENT, RadioError::RADIO_NOT_AVAILABLE, RadioError::INVALID_ARGUMENTS,
-             RadioError::OP_NOT_ALLOWED_BEFORE_REG_TO_NW, RadioError::REQUEST_NOT_SUPPORTED}));
+            {RadioError::NONE, RadioError::SIM_ABSENT, RadioError::RADIO_NOT_AVAILABLE,
+             RadioError::INVALID_ARGUMENTS, RadioError::OP_NOT_ALLOWED_BEFORE_REG_TO_NW,
+             RadioError::REQUEST_NOT_SUPPORTED}));
     } else if (cardStatus.base.cardState == CardState::PRESENT) {
         ASSERT_TRUE(CheckAnyOfErrors(
             radioRsp_v1_2->rspInfo.error,
@@ -666,7 +696,7 @@ TEST_F(RadioHidlTest_v1_2, deactivateDataCall_1_2) {
  * Test IRadio.getCellInfoList() for the response returned.
  */
 TEST_F(RadioHidlTest_v1_2, getCellInfoList_1_2) {
-    int serial = GetRandomSerialNumber();
+    serial = GetRandomSerialNumber();
 
     Return<void> res = radio_v1_2->getCellInfoList(serial);
     ASSERT_OK(res);
@@ -684,7 +714,7 @@ TEST_F(RadioHidlTest_v1_2, getCellInfoList_1_2) {
  * Test IRadio.getVoiceRegistrationState() for the response returned.
  */
 TEST_F(RadioHidlTest_v1_2, getVoiceRegistrationState) {
-    int serial = GetRandomSerialNumber();
+    serial = GetRandomSerialNumber();
 
     Return<void> res = radio_v1_2->getVoiceRegistrationState(serial);
     ASSERT_OK(res);
@@ -702,7 +732,7 @@ TEST_F(RadioHidlTest_v1_2, getVoiceRegistrationState) {
  * Test IRadio.getDataRegistrationState() for the response returned.
  */
 TEST_F(RadioHidlTest_v1_2, getDataRegistrationState) {
-    int serial = GetRandomSerialNumber();
+    serial = GetRandomSerialNumber();
 
     Return<void> res = radio_v1_2->getDataRegistrationState(serial);
     ASSERT_OK(res);
@@ -721,7 +751,7 @@ TEST_F(RadioHidlTest_v1_2, getDataRegistrationState) {
  * Test IRadio.getAvailableBandModes() for the response returned.
  */
 TEST_F(RadioHidlTest_v1_2, getAvailableBandModes) {
-    int serial = GetRandomSerialNumber();
+    serial = GetRandomSerialNumber();
 
     Return<void> res = radio_v1_2->getAvailableBandModes(serial);
     ASSERT_OK(res);
diff --git a/radio/1.2/vts/functional/radio_response.cpp b/radio/1.2/vts/functional/radio_response.cpp
index dab63a35..c5c7b14f 100644
--- a/radio/1.2/vts/functional/radio_response.cpp
+++ b/radio/1.2/vts/functional/radio_response.cpp
@@ -653,7 +653,9 @@ Return<void> RadioResponse_v1_2::sendDeviceStateResponse(const RadioResponseInfo
     return Void();
 }
 
-Return<void> RadioResponse_v1_2::setIndicationFilterResponse(const RadioResponseInfo& /*info*/) {
+Return<void> RadioResponse_v1_2::setIndicationFilterResponse(const RadioResponseInfo& info) {
+    rspInfo = info;
+    parent_v1_2.notify(info.serial);
     return Void();
 }
 
diff --git a/secure_element/1.0/vts/functional/VtsHalSecureElementV1_0TargetTest.cpp b/secure_element/1.0/vts/functional/VtsHalSecureElementV1_0TargetTest.cpp
index 3ea3e8dc..671923a6 100644
--- a/secure_element/1.0/vts/functional/VtsHalSecureElementV1_0TargetTest.cpp
+++ b/secure_element/1.0/vts/functional/VtsHalSecureElementV1_0TargetTest.cpp
@@ -173,7 +173,7 @@ TEST_F(SecureElementHidlTest, openBasicChannel) {
         se_->closeChannel(0);
         return;
     }
-    EXPECT_EQ(SecureElementStatus::UNSUPPORTED_OPERATION, statusReturned);
+    EXPECT_EQ(SecureElementStatus::CHANNEL_NOT_AVAILABLE, statusReturned);
 }
 
 /*
diff --git a/usb/1.1/vts/functional/VtsHalUsbV1_1TargetTest.cpp b/usb/1.1/vts/functional/VtsHalUsbV1_1TargetTest.cpp
index c990b237..caf9c695 100644
--- a/usb/1.1/vts/functional/VtsHalUsbV1_1TargetTest.cpp
+++ b/usb/1.1/vts/functional/VtsHalUsbV1_1TargetTest.cpp
@@ -31,8 +31,8 @@
 #include <condition_variable>
 #include <mutex>
 
+using ::android::hardware::usb::V1_1::IUsb;
 using ::android::hardware::usb::V1_1::IUsbCallback;
-using ::android::hardware::usb::V1_0::IUsb;
 using ::android::hardware::usb::V1_0::PortDataRole;
 using ::android::hardware::usb::V1_0::PortMode;
 using ::android::hardware::usb::V1_1::PortMode_1_1;
-- 
2.17.1

