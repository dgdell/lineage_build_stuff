From 090d20e422006e5d88bffb5e11833ac0a41c8e96 Mon Sep 17 00:00:00 2001
From: Rashed Abdel-Tawab <rashed@linux.com>
Date: Sun, 28 Jan 2018 11:34:01 -0800
Subject: [PATCH 2/3] camera: Only link and use
 vendor.qti.hardware.camera.device on qcom devices

Change-Id: I74b178c2f685a2ffda3e91eb7ff6d05664eebaf6
---
 camera/device/1.0/default/Android.bp         |  9 ++++++++-
 camera/device/1.0/default/CameraDevice.cpp   |  7 ++++++-
 camera/device/1.0/default/CameraDevice_1_0.h |  6 ++++++
 camera/provider/2.4/default/Android.bp       | 18 ++++++++++++++++--
 4 files changed, 36 insertions(+), 4 deletions(-)

diff --git a/camera/device/1.0/default/Android.bp b/camera/device/1.0/default/Android.bp
index 56436ff..a35e8ef 100644
--- a/camera/device/1.0/default/Android.bp
+++ b/camera/device/1.0/default/Android.bp
@@ -12,7 +12,6 @@ cc_library_shared {
         "libhwbinder",
         "libutils",
         "android.hardware.camera.device@1.0",
-        "vendor.qti.hardware.camera.device@1.0_vendor",
         "android.hardware.camera.common@1.0",
         "android.hardware.graphics.allocator@2.0",
         "android.hardware.graphics.mapper@2.0",
@@ -33,6 +32,14 @@ cc_library_shared {
     include_dirs: [
         "frameworks/native/include/media/openmax"
     ],
+    product_variables: {
+        lineage: {
+            uses_qcom_hardware: {
+                cppflags: ["-DQCOM_HARDWARE"],
+                shared_libs: ["vendor.qti.hardware.camera.device@1.0_vendor"],
+            },
+        },
+    },
     export_include_dirs: ["."]
 }
 
diff --git a/camera/device/1.0/default/CameraDevice.cpp b/camera/device/1.0/default/CameraDevice.cpp
index 15fcd7c..aa57db9 100644
--- a/camera/device/1.0/default/CameraDevice.cpp
+++ b/camera/device/1.0/default/CameraDevice.cpp
@@ -428,6 +428,7 @@ void CameraDevice::sDataCb(int32_t msg_type, const camera_memory_t *data, unsign
              index, mem->mNumBufs);
         return;
     }
+#ifdef QCOM_HARDWARE
     if(object->mQDeviceCallback != nullptr) {
          vendor::qti::hardware::camera::device::V1_0::QCameraFrameMetadata hidlMetadata;
          if (metadata) {
@@ -464,8 +465,8 @@ void CameraDevice::sDataCb(int32_t msg_type, const camera_memory_t *data, unsign
          CameraHeapMemory* mem = static_cast<CameraHeapMemory *>(data->handle);
          object->mQDeviceCallback->QDataCallback(
                  (DataCallbackMsg) msg_type, mem->handle.mId, index, hidlMetadata);
- 
     } else {
+#endif
        if (object->mDeviceCallback != nullptr) {
            CameraFrameMetadata hidlMetadata;
            if (metadata) {
@@ -490,7 +491,9 @@ void CameraDevice::sDataCb(int32_t msg_type, const camera_memory_t *data, unsign
            CameraHeapMemory* mem = static_cast<CameraHeapMemory *>(data->handle);
            object->mDeviceCallback->dataCallback(
                    (DataCallbackMsg) msg_type, mem->handle.mId, index, hidlMetadata);
+#ifdef QCOM_HARDWARE
        }
+#endif
     }
 }
 
@@ -706,10 +709,12 @@ Return<Status> CameraDevice::open(const sp<ICameraDeviceCallback>& callback) {
 
     initHalPreviewWindow();
     mDeviceCallback = callback;
+#ifdef QCOM_HARDWARE
     mQDeviceCallback = vendor::qti::hardware::camera::device::V1_0::IQCameraDeviceCallback::castFrom(callback);
     if(mQDeviceCallback == nullptr) {
         ALOGI("could not cast ICameraDeviceCallback to IQCameraDeviceCallback");
     }
+#endif
 
     if (mDevice->ops->set_callbacks) {
         mDevice->ops->set_callbacks(mDevice,
diff --git a/camera/device/1.0/default/CameraDevice_1_0.h b/camera/device/1.0/default/CameraDevice_1_0.h
index e5a194e..9ccb474 100644
--- a/camera/device/1.0/default/CameraDevice_1_0.h
+++ b/camera/device/1.0/default/CameraDevice_1_0.h
@@ -24,7 +24,9 @@
 #include "HandleImporter.h"
 
 #include <android/hardware/camera/device/1.0/ICameraDevice.h>
+#ifdef QCOM_HARDWARE
 #include <vendor/qti/hardware/camera/device/1.0/IQCameraDeviceCallback.h>
+#endif
 #include <android/hidl/allocator/1.0/IAllocator.h>
 #include <android/hidl/memory/1.0/IMemory.h>
 #include <hidl/MQDescriptor.h>
@@ -45,7 +47,9 @@ using ::android::hardware::camera::common::V1_0::helper::HandleImporter;
 using ::android::hardware::camera::device::V1_0::CameraInfo;
 using ::android::hardware::camera::device::V1_0::CommandType;
 using ::android::hardware::camera::device::V1_0::ICameraDevice;
+#ifdef QCOM_HARDWARE
 using ::vendor::qti::hardware::camera::device::V1_0::IQCameraDeviceCallback;
+#endif
 using ::android::hardware::camera::device::V1_0::ICameraDeviceCallback;
 using ::android::hardware::camera::device::V1_0::ICameraDevicePreviewCallback;
 using ::android::hardware::camera::device::V1_0::MemoryId;
@@ -166,7 +170,9 @@ private:
     const SortedVector<std::pair<std::string, std::string>>& mCameraDeviceNames;
 
     sp<ICameraDeviceCallback> mDeviceCallback = nullptr;
+#ifdef QCOM_HARDWARE
     sp<IQCameraDeviceCallback> mQDeviceCallback = nullptr;
+#endif
 
     mutable Mutex mMemoryMapLock; // gating access to mMemoryMap
                                   // must not hold mLock after this lock is acquired
diff --git a/camera/provider/2.4/default/Android.bp b/camera/provider/2.4/default/Android.bp
index b82dc5d..e7394bd 100644
--- a/camera/provider/2.4/default/Android.bp
+++ b/camera/provider/2.4/default/Android.bp
@@ -10,7 +10,6 @@ cc_library_shared {
         "libutils",
         "libcutils",
         "android.hardware.camera.device@1.0",
-        "vendor.qti.hardware.camera.device@1.0_vendor",
         "android.hardware.camera.device@3.2",
         "android.hardware.camera.device@3.3",
         "camera.device@1.0-impl",
@@ -25,6 +24,14 @@ cc_library_shared {
         "libhardware",
         "libcamera_metadata"
     ],
+    product_variables: {
+        lineage: {
+            uses_qcom_hardware: {
+                cppflags: ["-DQCOM_HARDWARE"],
+                shared_libs: ["vendor.qti.hardware.camera.device@1.0_vendor"],
+            },
+        },
+    },
     static_libs: [
         "android.hardware.camera.common@1.0-helper"
     ]
@@ -45,10 +52,17 @@ cc_binary {
         "liblog",
         "libutils",
         "android.hardware.camera.device@1.0",
-        "vendor.qti.hardware.camera.device@1.0_vendor",
         "android.hardware.camera.device@3.2",
         "android.hardware.camera.device@3.3",
         "android.hardware.camera.provider@2.4",
         "android.hardware.camera.common@1.0",
     ],
+    product_variables: {
+        lineage: {
+            uses_qcom_hardware: {
+                cppflags: ["-DQCOM_HARDWARE"],
+                shared_libs: ["vendor.qti.hardware.camera.device@1.0_vendor"],
+            },
+        },
+    },
 }
-- 
2.7.4

