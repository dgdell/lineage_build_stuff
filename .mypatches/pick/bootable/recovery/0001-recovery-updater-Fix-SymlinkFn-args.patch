From 95465152ab519e738dad72e4b5a88988488c6b9a Mon Sep 17 00:00:00 2001
From: Stricted <info@stricted.net>
Date: Mon, 12 Mar 2018 18:11:56 +0100
Subject: [PATCH 1/4] recovery: updater: Fix SymlinkFn args

Change-Id: If2ba1b7a8b5ac471a2db84f352273fd0ea7c81a2
---
 updater/install.cpp | 16 +++++++++-------
 1 file changed, 9 insertions(+), 7 deletions(-)

diff --git a/updater/install.cpp b/updater/install.cpp
index d2287457..b594ed37 100644
--- a/updater/install.cpp
+++ b/updater/install.cpp
@@ -757,18 +757,20 @@ Value* SymlinkFn(const char* name, State* state, const std::vector<std::unique_p
   if (argv.size() == 0) {
     return ErrorAbort(state, kArgsParsingFailure, "%s() expects 1+ args, got %zu", name, argv.size());
   }
-  std::string target;
-  if (!Evaluate(state, argv[0], &target)) {
-    return nullptr;
-  }
 
-  std::vector<std::string> srcs;
-  if (!ReadArgs(state, argv, &srcs, 1, argv.size())) {
+  std::vector<std::string> args;
+  if (!ReadArgs(state, argv, &args)) {
     return ErrorAbort(state, kArgsParsingFailure, "%s(): Failed to parse the argument(s)", name);
   }
 
+  const auto& target = args[0];
+  if (target.empty()) {
+    return ErrorAbort(state, kArgsParsingFailure, "%s() target argument can't be empty", name);
+  }
+
   size_t bad = 0;
-  for (const auto& src : srcs) {
+  for (size_t i = 1; i < args.size(); ++i) {
+    const auto& src = args[i];
     if (unlink(src.c_str()) == -1 && errno != ENOENT) {
       PLOG(ERROR) << name << ": failed to remove " << src;
       ++bad;
-- 
2.17.1

