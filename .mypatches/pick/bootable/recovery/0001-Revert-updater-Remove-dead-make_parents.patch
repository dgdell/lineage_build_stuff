From 344d5da241f103ea817bc85020477d1b3d1adf5f Mon Sep 17 00:00:00 2001
From: Simon Shields <simon@lineageos.org>
Date: Thu, 9 Aug 2018 01:17:21 +1000
Subject: [PATCH 1/8] Revert "updater: Remove dead make_parents()."

This reverts commit 5902691764e041bfed8edbc66a72e0854d18dfda.

Change-Id: I69eadf1a091f6ecd45531789dedf72a178a055ba
---
 updater/install.cpp | 28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)

diff --git a/updater/install.cpp b/updater/install.cpp
index 9be7645f..1f734274 100644
--- a/updater/install.cpp
+++ b/updater/install.cpp
@@ -83,6 +83,34 @@ static void uiPrint(State* state, const std::string& buffer) {
   LOG(INFO) << buffer;
 }
 
+static bool is_dir(const std::string& dirpath) {
+  struct stat st;
+  return stat(dirpath.c_str(), &st) == 0 && S_ISDIR(st.st_mode);
+}
+
+// Create all parent directories of name, if necessary.
+static bool make_parents(const std::string& name) {
+  size_t prev_end = 0;
+  while (prev_end < name.size()) {
+    size_t next_end = name.find('/', prev_end + 1);
+    if (next_end == std::string::npos) {
+      break;
+    }
+    std::string dir_path = name.substr(0, next_end);
+    if (!is_dir(dir_path)) {
+      int result = mkdir(dir_path.c_str(), 0700);
+      if (result != 0) {
+        PLOG(ERROR) << "failed to mkdir " << dir_path << " when make parents for " << name;
+        return false;
+      }
+
+      LOG(INFO) << "created [" << dir_path << "]";
+    }
+    prev_end = next_end;
+  }
+  return true;
+}
+
 void uiPrintf(State* _Nonnull state, const char* _Nonnull format, ...) {
   std::string error_msg;
 
-- 
2.17.1

