From 7eeb8da1375872970e693389e82f6feb2660da93 Mon Sep 17 00:00:00 2001
From: Aaron Kling <webgeek1234@gmail.com>
Date: Sat, 11 Aug 2018 15:38:52 -0500
Subject: [PATCH 7/8] Skip BLKDISCARD if not supported by the device

Change-Id: Ic8265bbd8a4ec38c67eda4616854ea8b14280f1f
---
 updater/blockimg.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/updater/blockimg.cpp b/updater/blockimg.cpp
index e93196b2..043b52ec 100644
--- a/updater/blockimg.cpp
+++ b/updater/blockimg.cpp
@@ -208,7 +208,7 @@ static bool discard_blocks(int fd, off64_t offset, uint64_t size) {
   }
 
   uint64_t args[2] = { static_cast<uint64_t>(offset), size };
-  if (ioctl(fd, BLKDISCARD, &args) == -1) {
+  if (ioctl(fd, BLKDISCARD, &args) == -1 && errno != ENOTSUP) {
     PLOG(ERROR) << "BLKDISCARD ioctl failed";
     return false;
   }
@@ -1499,7 +1499,7 @@ static int PerformCommandErase(CommandParameters& params) {
       // length in bytes
       blocks[1] = (range.second - range.first) * static_cast<uint64_t>(BLOCKSIZE);
 
-      if (ioctl(params.fd, BLKDISCARD, &blocks) == -1) {
+      if (ioctl(params.fd, BLKDISCARD, &blocks) == -1 && errno != ENOTSUP) {
         PLOG(ERROR) << "BLKDISCARD ioctl failed";
         return -1;
       }
-- 
2.17.1

