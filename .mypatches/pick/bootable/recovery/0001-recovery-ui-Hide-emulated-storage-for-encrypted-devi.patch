From f0032095495cd6c13fdc7b072b1d70f060cf68f0 Mon Sep 17 00:00:00 2001
From: "Christopher N. Hesse" <raymanfx@gmail.com>
Date: Wed, 4 Apr 2018 12:15:13 +0200
Subject: [PATCH] recovery/ui: Hide emulated storage for encrypted devices

We do not support decryption of data partitions, so get
rid of the option in the UI.

Change-Id: Idcccba84ea0ba42c24f8a52b7f0994ed4545475d
---
 recovery.cpp | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/recovery.cpp b/recovery.cpp
index bbf1f174..bc623409 100644
--- a/recovery.cpp
+++ b/recovery.cpp
@@ -74,6 +74,8 @@
 #include "ui.h"
 #include "voldclient.h"
 
+#include "VolumeBase.h"
+
 // For e2fsprogs
 extern "C" {
 const char* program_name = "fstools";
@@ -1176,6 +1178,11 @@ refresh:
     items.push_back(MenuItem("Apply from ADB")); // Index 0
 
     for (auto& vol : volumes) {
+        // On devices where /data is encrypted (FDE or FBE), we cannot install from
+        // internal (aka emulated) storage because we do not support decryption.
+        if (vol.mState != (int)android::vold::VolumeBase::State::kMounted) {
+            continue;
+        }
         items.push_back(MenuItem("Choose from " + vol.mLabel));
     }
 
-- 
2.17.1

