From 7ad862649ec8e3ffae896515d6df1c0f7a2b57d7 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Thu, 11 Jan 2018 22:15:08 +0200
Subject: [PATCH 17/20] legacy: label per_mgr as a binder service

Change-Id: Iebebbb48f96e71bdd83f59b73470029adce1a503
---
 legacy-common/audioserver.te        | 1 +
 legacy-common/peripheral_manager.te | 2 ++
 legacy-common/rild.te               | 6 +++++-
 legacy-common/service.te            | 1 +
 legacy-common/service_contexts      | 1 +
 legacy-common/system_server.te      | 1 +
 6 files changed, 11 insertions(+), 1 deletion(-)
 create mode 100644 legacy-common/service_contexts

diff --git a/legacy-common/audioserver.te b/legacy-common/audioserver.te
index eff227b..d4abb5c 100644
--- a/legacy-common/audioserver.te
+++ b/legacy-common/audioserver.te
@@ -8,3 +8,4 @@ unix_socket_connect(audioserver, thermal, thermal-engine)
 
 # Allow communication with peripheral manager
 use_per_mgr(audioserver)
+allow audioserver binder_per_mgr_service:service_manager find;
diff --git a/legacy-common/peripheral_manager.te b/legacy-common/peripheral_manager.te
index 493adfc..8ebfd40 100644
--- a/legacy-common/peripheral_manager.te
+++ b/legacy-common/peripheral_manager.te
@@ -1,2 +1,4 @@
 binder_use(per_mgr)
 binder_service(per_mgr)
+
+allow per_mgr binder_per_mgr_service:service_manager { add find };
diff --git a/legacy-common/rild.te b/legacy-common/rild.te
index 3b0338d..b1dd5ba 100644
--- a/legacy-common/rild.te
+++ b/legacy-common/rild.te
@@ -1,5 +1,9 @@
 binder_use(rild)
-allow rild { mediaserver_service audioserver_service }:service_manager find;
+allow rild {
+	mediaserver_service
+	audioserver_service
+	binder_per_mgr_service
+}:service_manager find;
 
 # rild reads qcril.db linked to /system/etc/qcril.db
 allow rild radio_data_file:lnk_file read;
diff --git a/legacy-common/service.te b/legacy-common/service.te
index ee2e994..2f42fb3 100644
--- a/legacy-common/service.te
+++ b/legacy-common/service.te
@@ -1 +1,2 @@
+type binder_per_mgr_service, service_manager_type;
 type ims_service, system_api_service, service_manager_type;
diff --git a/legacy-common/service_contexts b/legacy-common/service_contexts
new file mode 100644
index 0000000..b0aa01a
--- /dev/null
+++ b/legacy-common/service_contexts
@@ -0,0 +1 @@
+vendor.qcom.PeripheralManager                  u:object_r:binder_per_mgr_service:s0
diff --git a/legacy-common/system_server.te b/legacy-common/system_server.te
index 11bb383..e0ae2cc 100644
--- a/legacy-common/system_server.te
+++ b/legacy-common/system_server.te
@@ -8,6 +8,7 @@ unix_socket_send(system_server, mpctl, perfd)
 netmgr_socket(system_server)
 qmux_socket(system_server)
 use_per_mgr(system_server)
+allow system_server binder_per_mgr_service:service_manager find;
 
 allow system_server sensors:unix_stream_socket sendto;
 allow system_server sensors_socket:sock_file r_file_perms;
-- 
2.7.4

