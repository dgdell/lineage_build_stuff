From 1fb5b0780cb4ed267973b8ae8158b7f6d49b6b35 Mon Sep 17 00:00:00 2001
From: Michael Bestas <mkbestas@lineageos.org>
Date: Tue, 8 Aug 2017 21:18:48 +0300
Subject: [PATCH 01/16] Use set_prop() macro for property sets

Change-Id: Id67a05f8ed718cad5856613c2700f4ce1e404cf0
---
 private/wfdservice.te             |  3 ---
 vendor/apq8084/qca1530.te         |  1 -
 vendor/apq8098_latv/init_shell.te |  2 +-
 vendor/common/fidodaemon.te       |  3 ---
 vendor/common/location.te         |  2 +-
 vendor/common/nqnfcinfo.te        |  2 +-
 vendor/common/qseecomd.te         |  2 --
 vendor/common/qseeproxy.te        |  3 ---
 vendor/common/qti_logkit_app.te   |  2 +-
 vendor/common/system_app.te       | 11 ++++-------
 vendor/common/system_server.te    | 12 +++++-------
 vendor/common/wifi_ftmd.te        |  2 +-
 vendor/common/zygote.te           |  3 ++-
 vendor/msm8916/init_shell.te      |  4 +---
 vendor/msm8952/init_shell.te      |  6 ++----
 vendor/msm8960/init_shell.te      |  4 +---
 vendor/msm8996/init_shell.te      |  2 +-
 vendor/msm8998/init_shell.te      |  2 +-
 vendor/sdm710/init_shell.te       |  4 +---
 vendor/test/fidotest.te           |  3 ---
 vendor/test/qseeproxysample.te    |  3 ---
 21 files changed, 23 insertions(+), 53 deletions(-)

diff --git a/private/wfdservice.te b/private/wfdservice.te
index c9d48257..6eb09435 100644
--- a/private/wfdservice.te
+++ b/private/wfdservice.te
@@ -68,9 +68,6 @@ allow wfdservice graphics_device:chr_file rw_file_perms;
 #Allow access to encoder for YUV statistics
 allow wfdservice gpu_device:chr_file rw_file_perms;
 
-#Allow communication with init over property server
-unix_socket_connect(wfdservice, property, init);
-
 #Allow access to /dev/video/* devices for encoding/decoding
 allow wfdservice video_device:chr_file rw_file_perms;
 allow wfdservice video_device:dir r_dir_perms;
diff --git a/vendor/apq8084/qca1530.te b/vendor/apq8084/qca1530.te
index 7593b9ef..6b328967 100644
--- a/vendor/apq8084/qca1530.te
+++ b/vendor/apq8084/qca1530.te
@@ -36,7 +36,6 @@ userdebug_or_eng(`
 
 qmux_socket(qca1530)
 wakelock_use(qca1530)
-unix_socket_connect(qca1530, property, init)
 
 # need to access sharemem log device for smem logs
 allow qca1530 smem_log_device:chr_file rw_file_perms;
diff --git a/vendor/apq8098_latv/init_shell.te b/vendor/apq8098_latv/init_shell.te
index 32fe1779..77a8fbb8 100644
--- a/vendor/apq8098_latv/init_shell.te
+++ b/vendor/apq8098_latv/init_shell.te
@@ -30,7 +30,7 @@ allow qti_init_shell regionalization_file:dir r_dir_perms;
 allow qti_init_shell regionalization_file:file create_file_perms;
 
 # For VR
-allow qti_init_shell ctl_qvrd_prop:property_service set;
+set_prop(qti_init_shell, ctl_qvrd_prop)
 allow qti_init_shell sysfs_cpu_boost:dir r_dir_perms;
 allow qti_init_shell sysfs_cpu_boost:file rw_file_perms;
 allow qti_init_shell sysfs_devfreq:lnk_file r_file_perms;
diff --git a/vendor/common/fidodaemon.te b/vendor/common/fidodaemon.te
index 79fb1515..a8f754d8 100644
--- a/vendor/common/fidodaemon.te
+++ b/vendor/common/fidodaemon.te
@@ -17,9 +17,6 @@ binder_call(fidodaemon, system_app)
 #Allow fidodaemon to be registered with service manager
 allow fidodaemon fidodaemon_service:service_manager add;
 
-#Allow communication with init over property server
-unix_socket_connect(fidodaemon, property, init);
-
 #Allow access to tee device
 allow fidodaemon tee_device:chr_file rw_file_perms;
 
diff --git a/vendor/common/location.te b/vendor/common/location.te
index 98ad52cc..89160071 100644
--- a/vendor/common/location.te
+++ b/vendor/common/location.te
@@ -64,7 +64,7 @@ allow location hal_gnss_qti:unix_dgram_socket sendto;
 netmgr_socket(location);
 
 #Allow access to properties
-set_prop(location, location_prop);
+set_prop(location, location_prop)
 
 #diag
 userdebug_or_eng(`
diff --git a/vendor/common/nqnfcinfo.te b/vendor/common/nqnfcinfo.te
index 814b2f51..fb5a6079 100644
--- a/vendor/common/nqnfcinfo.te
+++ b/vendor/common/nqnfcinfo.te
@@ -33,7 +33,7 @@ init_daemon_domain(nqnfcinfo)
 
 r_dir_file(nqnfcinfo, sysfs_socinfo);
 
-set_prop(nqnfcinfo, nfc_nq_prop);
+set_prop(nqnfcinfo, nfc_nq_prop)
 
 # Access device nodes inside /dev/nq-nci
 allow nqnfcinfo nfc_device:chr_file rw_file_perms;
diff --git a/vendor/common/qseecomd.te b/vendor/common/qseecomd.te
index fbad4609..7bb9d604 100644
--- a/vendor/common/qseecomd.te
+++ b/vendor/common/qseecomd.te
@@ -55,8 +55,6 @@ allow tee sysfs_securetouch:file rw_file_perms;
 binder_call(tee, surfaceflinger)
 #binder_use(tee)
 
-#allow tee system_app:unix_dgram_socket sendto;
-unix_socket_connect(tee, property, init)
 
 userdebug_or_eng(`
   allow tee su:unix_dgram_socket sendto;
diff --git a/vendor/common/qseeproxy.te b/vendor/common/qseeproxy.te
index 12517fb3..7008ba40 100644
--- a/vendor/common/qseeproxy.te
+++ b/vendor/common/qseeproxy.te
@@ -43,9 +43,6 @@ allow qseeproxy qseeproxy_service:service_manager add;
 #Allow qseeproxy to use system_server via binder to check caller identity
 binder_call(qseeproxy, system_server)
 
-#Allow communication with init over property server
-unix_socket_connect(qseeproxy, property, init);
-
 #Allow access to tee device
 allow qseeproxy tee_device:chr_file rw_file_perms;
 
diff --git a/vendor/common/qti_logkit_app.te b/vendor/common/qti_logkit_app.te
index f94c280c..52640a1f 100644
--- a/vendor/common/qti_logkit_app.te
+++ b/vendor/common/qti_logkit_app.te
@@ -71,7 +71,7 @@ allow qti_logkit_app qti_logkit_pub_data_file:file create_file_perms;
 allow qti_logkit_app wcnss_service_exec:file rx_file_perms;
 
 # bugreport
-allow qti_logkit_app ctl_dumpstate_prop:property_service set;
+set_prop(qti_logkit_app, ctl_dumpstate_prop)
 unix_socket_connect(qti_logkit_app, dumpstate, dumpstate)
 
 # ANR
diff --git a/vendor/common/system_app.te b/vendor/common/system_app.te
index 1a0da528..ad0bc5ec 100644
--- a/vendor/common/system_app.te
+++ b/vendor/common/system_app.te
@@ -28,10 +28,8 @@ allow system_app fm_radio_device:chr_file r_file_perms;
 r_dir_file(system_app, bluetooth_data_file);
 r_dir_file(system_app, bt_firmware_file);
 
-allow system_app {
-    fm_prop
-    usf_prop
-}:property_service set;
+set_prop(system_app, fm_prop)
+set_prop(system_app, usf_prop)
 
 allow system_app {
     atfwd_service
@@ -65,7 +63,7 @@ allow system_app bluetooth:unix_stream_socket ioctl;
 hal_client_domain(system_app, hal_hbtp)
 
 #access to wifi_ftmd
-allow system_app vendor_wifi_ftmd_prop:property_service set;
+set_prop(system_app, vendor_wifi_ftmd_prop)
 #unix_socket_send(system_app, wififtmd, wifi_ftmd)
 
 # allow system_app to interact with dtseagleservice
@@ -120,7 +118,7 @@ allow system_app qti_logkit_priv_socket:dir r_dir_perms;
 #allow system_app qti_logkit_priv_socket:sock_file r_file_perms;
 
 # bugreport
-allow system_app ctl_dumpstate_prop:property_service set;
+set_prop(system_app, ctl_dumpstate_prop)
 unix_socket_connect(system_app, dumpstate, dumpstate)
 
 # allow gba auth service to add itself as system service
@@ -186,7 +184,6 @@ userdebug_or_eng(`
 
 #allow system app to interact with the esepowermanager
 hal_client_domain(system_app, hal_esepowermanager)
-allow system_app fm_prop:file r_file_perms;
 
 #allow system_app access factory
 hal_client_domain(system_app, vendor_hal_factory_qti);
diff --git a/vendor/common/system_server.te b/vendor/common/system_server.te
index 6cf5b5e5..2f40d7e4 100644
--- a/vendor/common/system_server.te
+++ b/vendor/common/system_server.te
@@ -30,10 +30,8 @@ allow system_server {
 allow system_server qtitetherservice_service:service_manager find;
 
 #For ANT tty communication and to set wc_transport prop
-allow system_server {
-    vendor_bluetooth_prop
-    usf_prop
-}:property_service set;
+set_prop(system_server, vendor_bluetooth_prop)
+set_prop(system_server, usf_prop)
 
 # required for ANT App to connectto wcnss_filter sockets
 allow system_server bluetooth:unix_stream_socket connectto;
@@ -57,7 +55,7 @@ type_transition system_server location_data_file:sock_file location_socket "alar
 #For wifistatemachine
 allow system_server kernel:key search;
 allow system_server wlan_device:chr_file rw_file_perms;
-allow system_server vendor_softap_prop:property_service set;
+set_prop(system_server, vendor_softap_prop)
 allow system_server vendor_softap_prop:file r_file_perms;
 
 #For ssr
@@ -118,13 +116,13 @@ binder_call(system_server, fps_hal)
 allow system_server iqfp_service:service_manager find;
 
 # For shutdown animation
-allow system_server ctl_bootanim_prop:property_service set;
+set_prop(system_server, ctl_bootanim_prop)
 
 # allow tethering to access dhcp leases
 r_dir_file(system_server, dhcp_data_file)
 
 # Allow system server to access fst,wigig system properties
-allow system_server fst_prop:property_service set;
+set_prop(system_server, fst_prop)
 get_prop(system_server, fst_prop);
 set_prop(system_server, wigig_prop);
 
diff --git a/vendor/common/wifi_ftmd.te b/vendor/common/wifi_ftmd.te
index 2f61c08d..f80143fa 100644
--- a/vendor/common/wifi_ftmd.te
+++ b/vendor/common/wifi_ftmd.te
@@ -33,4 +33,4 @@ net_domain(wifi_ftmd)
 
 set_prop(wifi_ftmd,vendor_wifi_ftmd_prop);
 allow wifi_ftmd self:capability net_admin;
-allow wifi_ftmd vendor_wifi_ftmd_prop:property_service set;
+set_prop(wifi_ftmd, vendor_wifi_ftmd_prop)
diff --git a/vendor/common/zygote.te b/vendor/common/zygote.te
index 5cc8dd65..607bec8d 100644
--- a/vendor/common/zygote.te
+++ b/vendor/common/zygote.te
@@ -27,5 +27,6 @@
 
 typeattribute zygote system_writes_vendor_properties_violators;
 # persist.service.bdroid.bdaddr hw.cabl.level
-allow zygote { vendor_bluetooth_prop system_prop } :property_service set;
+set_prop(zygote, vendor_bluetooth_prop)
+set_prop(zygote, system_prop)
 get_prop(zygote, vendor_mpctl_prop)
diff --git a/vendor/msm8916/init_shell.te b/vendor/msm8916/init_shell.te
index fe54e552..ccb17877 100644
--- a/vendor/msm8916/init_shell.te
+++ b/vendor/msm8916/init_shell.te
@@ -27,6 +27,4 @@
 
 # media_codecs_eld_prop - to choose target specific media_codecs.xml
 # media_settings_xml_prop - to choose target specific media_profiles.xml
-allow qti_init_shell {
-    media_msm8939hw_prop
-}:property_service set;
+set_prop(qti_init_shell, media_msm8939hw_prop)
diff --git a/vendor/msm8952/init_shell.te b/vendor/msm8952/init_shell.te
index 1ff91807..4e58fcdc 100644
--- a/vendor/msm8952/init_shell.te
+++ b/vendor/msm8952/init_shell.te
@@ -28,10 +28,8 @@
 # media_codecs_eld_prop - to choose target specific media_codecs.xml
 # media_settings_xml_prop - to choose target specific media_profiles.xml
 # media_msm8956_version_prop - to choose target version specific media_codecs.xml
-allow qti_init_shell {
-    media_msm8956hw_prop
-    media_msm8956_version_prop
-}:property_service set;
+set_prop(qti_init_shell, media_msm8956hw_prop)
+set_prop(qti_init_shell, media_msm8956_version_prop)
 
 # For regionalization
 allow qti_init_shell regionalization_file:dir r_dir_perms;
diff --git a/vendor/msm8960/init_shell.te b/vendor/msm8960/init_shell.te
index a58c8b6f..4136ff3c 100644
--- a/vendor/msm8960/init_shell.te
+++ b/vendor/msm8960/init_shell.te
@@ -27,6 +27,4 @@
 
 #For property starting with hw
 #ctl_thermal-engine_prop - for access the thermal-engine
-allow qti_init_shell {
-   ctl_thermal-engine_prop
-}:property_service set;
+set_prop(qti_init_shell, ctl_thermal-engine_prop)
diff --git a/vendor/msm8996/init_shell.te b/vendor/msm8996/init_shell.te
index 5546fa1a..e2995e5c 100644
--- a/vendor/msm8996/init_shell.te
+++ b/vendor/msm8996/init_shell.te
@@ -25,4 +25,4 @@
 # OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
 # IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
-allow qti_init_shell ctl_qvrd_prop:property_service set;
+set_prop(qti_init_shell, ctl_qvrd_prop)
diff --git a/vendor/msm8998/init_shell.te b/vendor/msm8998/init_shell.te
index c0e5dd44..0b267e8f 100644
--- a/vendor/msm8998/init_shell.te
+++ b/vendor/msm8998/init_shell.te
@@ -30,7 +30,7 @@ allow qti_init_shell regionalization_file:dir r_dir_perms;
 allow qti_init_shell regionalization_file:file create_file_perms;
 
 # For VR
-allow qti_init_shell ctl_qvrd_prop:property_service set;
+set_prop(qti_init_shell, ctl_qvrd_prop)
 
 # For LPMs
 allow qti_init_shell sysfs_msm_power:file rw_file_perms;
diff --git a/vendor/sdm710/init_shell.te b/vendor/sdm710/init_shell.te
index 413d6a1f..98b61ee2 100644
--- a/vendor/sdm710/init_shell.te
+++ b/vendor/sdm710/init_shell.te
@@ -26,9 +26,7 @@
 # IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 
 # media_sdm710_version_prop - to choose target version specific media_codecs.xml
-allow qti_init_shell {
-    vendor_media_sdm710_version_prop
-}:property_service set;
+set_prop(qti_init_shell, vendor_media_sdm710_version_prop)
 
 # For regionalization
 allow qti_init_shell regionalization_file:dir r_dir_perms;
diff --git a/vendor/test/fidotest.te b/vendor/test/fidotest.te
index a331dca9..d0adb00d 100644
--- a/vendor/test/fidotest.te
+++ b/vendor/test/fidotest.te
@@ -17,9 +17,6 @@ userdebug_or_eng(`
   #Allow fido test daemons to be registered with service manager
   allow fidotest fidotest_service:service_manager add;
 
-  # Allow communication with init over property server
-  unix_socket_connect(fidotest, property, init);
-
   # Allow access to tee device
   allow fidotest tee_device:chr_file rw_file_perms;
 
diff --git a/vendor/test/qseeproxysample.te b/vendor/test/qseeproxysample.te
index 1e71b7f7..381400ff 100644
--- a/vendor/test/qseeproxysample.te
+++ b/vendor/test/qseeproxysample.te
@@ -45,9 +45,6 @@ userdebug_or_eng(`
   #Allow test daemon to use system_server via binder to check caller identity
   binder_call(qseeproxysample, system_server)
 
-  # Allow communication with init over property server
-  unix_socket_connect(qseeproxysample, property, init);
-
   # Allow access to tee device
   allow qseeproxysample tee_device:chr_file rw_file_perms;
 
-- 
2.17.1

