From f5acd8c4baed50b199ddef3871073fd384c9d633 Mon Sep 17 00:00:00 2001
From: Rashed Abdel-Tawab <rashed@linux.com>
Date: Fri, 17 Aug 2018 12:30:19 -0700
Subject: [PATCH 2/3] sepol: hostapd is now hal_wifi_hostapd

Change-Id: I91648b2b07340b9a061c04246f68d8dbdef0e008
---
 common/cnd.te         |  6 -----
 common/file_contexts  |  1 -
 common/fstman.te      |  2 +-
 common/hostapd.te     | 61 -------------------------------------------
 common/netd.te        |  1 -
 common/wigighalsvc.te |  2 +-
 legacy-common/netd.te |  1 -
 7 files changed, 2 insertions(+), 72 deletions(-)
 delete mode 100644 common/hostapd.te

diff --git a/common/cnd.te b/common/cnd.te
index bf885b3..8b25008 100644
--- a/common/cnd.te
+++ b/common/cnd.te
@@ -69,12 +69,6 @@ allow cnd socket_device:dir remove_name;
 # explicitly allow udp socket permissions for appdomain
 #allow cnd appdomain:udp_socket rw_socket_perms;
 
-#allow cnd daemon to invoke hostapd_cli
-allow cnd vendor_shell_exec:file rx_file_perms;
-domain_auto_trans(cnd, hostapd_exec, hostapd)
-allow cnd hostapd_socket:dir r_dir_perms;
-unix_socket_send(cnd, hostapd, hostapd)
-
 # only allow getopt for appdomain
 allow appdomain zygote:unix_dgram_socket getopt;
 dontaudit { domain -appdomain } zygote:unix_dgram_socket getopt;
diff --git a/common/file_contexts b/common/file_contexts
index cff4932..3246408 100644
--- a/common/file_contexts
+++ b/common/file_contexts
@@ -219,7 +219,6 @@
 /(vendor|system/vendor)/bin/spdaemon            u:object_r:spdaemon_exec:s0
 /(vendor|system/vendor)/bin/sec_nvm             u:object_r:sec_nvm_exec:s0
 /(vendor|system/vendor)/bin/cnss-daemon         u:object_r:wcnss_service_exec:s0
-/(vendor|system/vendor)/bin/hostapd_cli         u:object_r:hostapd_exec:s0
 /(vendor|system/vendor)/bin/adsprpcd            u:object_r:adsprpcd_exec:s0
 /(vendor|system/vendor)/bin/cdsprpcd            u:object_r:cdsprpcd_exec:s0
 /(vendor|system/vendor)/bin/wpa_cli             u:object_r:wcnss_service_exec:s0
diff --git a/common/fstman.te b/common/fstman.te
index 7df904e..2cda090 100644
--- a/common/fstman.te
+++ b/common/fstman.te
@@ -59,7 +59,7 @@ allow fstman wifi_vendor_data_file:file create_file_perms;
 
 # fstman needs to communicate with wpa_supplicant and hostapd using socket
 # for managing FST state
-allow fstman { hal_wifi_supplicant hostapd }:unix_dgram_socket sendto;
+allow fstman { hal_wifi_supplicant hal_wifi_hostapd }:unix_dgram_socket sendto;
 # supplicant interface sockets
 allow fstman wifi_vendor_wpa_socket:dir rw_dir_perms;
 allow fstman wifi_vendor_wpa_socket:sock_file create_file_perms;
diff --git a/common/hostapd.te b/common/hostapd.te
deleted file mode 100644
index 307bb11..0000000
--- a/common/hostapd.te
+++ /dev/null
@@ -1,61 +0,0 @@
-# Copyright (c) 2015,2017, The Linux Foundation. All rights reserved.
-#
-# Redistribution and use in source and binary forms, with or without
-# modification, are permitted provided that the following conditions are
-# met:
-#     * Redistributions of source code must retain the above copyright
-#       notice, this list of conditions and the following disclaimer.
-#     * Redistributions in binary form must reproduce the above
-#       copyright notice, this list of conditions and the following
-#       disclaimer in the documentation and/or other materials provided
-#       with the distribution.
-#     * Neither the name of The Linux Foundation nor the names of its
-#       contributors may be used to endorse or promote products derived
-#       from this software without specific prior written permission.
-#
-# THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESS OR IMPLIED
-# WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT
-# ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
-# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
-# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
-# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
-# BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
-# WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
-# OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN
-# IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-
-# Allow hostapd_cli to work. hostapd_cli creates a socket in
-# /data/misc/wifi/sockets which hostapd communicates with.
-userdebug_or_eng(`
-  unix_socket_send(hostapd, wifi_vendor_wpa, su)
-')
-
-binder_call(hostapd, cnd)
-unix_socket_connect(hostapd, cnd, cnd)
-unix_socket_send(hostapd, cnd, cnd)
-allow hostapd cnd:{
-          fifo_file
-          netlink_route_socket
-          netlink_tcpdiag_socket
-          unix_stream_socket} { read write };
-allow hostapd cnd:fifo_file r_file_perms;
-allow hostapd smem_log_device:chr_file rw_file_perms;
-allow hostapd fstman:unix_dgram_socket sendto;
-allow hostapd wifi_vendor_data_file:dir w_dir_perms;
-allow hostapd wifi_vendor_data_file:file create_file_perms;
-allow hostapd wifi_vendor_hostapd_socket:dir w_dir_perms;
-allow hostapd wifi_vendor_hostapd_socket:sock_file { unlink create setattr };
-# wigig_hostapd has its own directory for sockets,
-# in order to prevent conflicts with wifi hostapd
-# allow wigig_hostapd to create the directory holding its control socket
-allow hostapd wigig_hostapd_socket:dir create_dir_perms;
-# wigig_hostapd needs to create, bind to, read and write its control socket
-allow hostapd wigig_hostapd_socket:sock_file create_file_perms;
-# allow wigig_hostapd to send replies to wigighalsvc
-allow hostapd wigighalsvc:unix_dgram_socket sendto;
-# allow hostapd to attach to fstman socket
-allow hostapd wpa_socket:dir r_dir_perms;
-allow hostapd wpa_socket:sock_file rw_file_perms;
-allow hostapd wifi_vendor_wpa_socket:dir r_dir_perms;
-allow hostapd wifi_vendor_wpa_socket:sock_file rw_file_perms;
diff --git a/common/netd.te b/common/netd.te
index f1df8f3..23b3516 100644
--- a/common/netd.te
+++ b/common/netd.te
@@ -19,7 +19,6 @@ allowxperm netd self: { unix_stream_socket } ioctl priv_sock_ioctls;
 set_prop(netd, netd_prop)
 
 allow netd self:capability fsetid;
-#allow netd hostapd:unix_dgram_socket sendto;
 
 # Allow netd to chmod dir /data/misc/dhcp
 allow netd dhcp_data_file:dir create_dir_perms;
diff --git a/common/wigighalsvc.te b/common/wigighalsvc.te
index 0a35ca6..fe1f9fd 100644
--- a/common/wigighalsvc.te
+++ b/common/wigighalsvc.te
@@ -54,7 +54,7 @@ allow hal_wigig wifi_vendor_data_file:dir rw_dir_perms;
 allow hal_wigig wifi_vendor_data_file:file create_file_perms;
 
 # connect to supplicant by socket
-allow hal_wigig { hal_wifi_supplicant hostapd }:unix_dgram_socket sendto;
+allow hal_wigig { hal_wifi_supplicant hal_wifi_hostapd }:unix_dgram_socket sendto;
 allow hal_wigig wpa_socket:dir rw_dir_perms;
 allow hal_wigig wpa_socket:sock_file create_file_perms;
 
diff --git a/legacy-common/netd.te b/legacy-common/netd.te
index c550eed..82ad28c 100644
--- a/legacy-common/netd.te
+++ b/legacy-common/netd.te
@@ -1,4 +1,3 @@
 unix_socket_connect(netd, cnd, cnd)
 allow netd wfdservice:tcp_socket rw_socket_perms;
-allow netd hostapd:unix_dgram_socket sendto;
 allow netd wpa_socket:sock_file create_file_perms;
-- 
2.17.1

