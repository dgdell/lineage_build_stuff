From ff69ebb508733fe336fcb99385482cafc4559c92 Mon Sep 17 00:00:00 2001
From: jrior001 <jriordan001@gmail.com>
Date: Mon, 8 Jan 2018 01:02:01 -0500
Subject: [PATCH 3/5] sepolicy: adapt sudaemon policy for O

Change-Id: Iab4322eb3fec84f210607a2e2a176580f48b945c
---
 common/private/su.te | 12 ++++++++++++
 common/public/su.te  | 17 +++++------------
 2 files changed, 17 insertions(+), 12 deletions(-)
 create mode 100644 common/private/su.te

diff --git a/common/private/su.te b/common/private/su.te
new file mode 100644
index 0000000..bd19cff
--- /dev/null
+++ b/common/private/su.te
@@ -0,0 +1,12 @@
+userdebug_or_eng(`
+  typeattribute sudaemon coredomain;
+
+  domain_trans(init, su_exec, sudaemon)
+
+  type_transition sudaemon socket_device:sock_file superuser_device;
+
+  # sudaemon is also permissive to permit setenforce.
+  permissive sudaemon;
+
+  app_domain(sudaemon)
+')
diff --git a/common/public/su.te b/common/public/su.te
index 1a2a2b3..f4c2a08 100644
--- a/common/public/su.te
+++ b/common/public/su.te
@@ -3,21 +3,15 @@ type superuser_device, file_type, mlstrustedobject;
 ## Perms for the daemon
 
 userdebug_or_eng(`
-  domain_trans(init, su_exec, sudaemon)
 
   typeattribute sudaemon domain, mlstrustedsubject;
 
-  type_transition sudaemon socket_device:sock_file superuser_device;
   # The userspace app uses /dev sockets to control per-app access
   allow sudaemon superuser_device:dir { create rw_dir_perms setattr unlink };
   allow sudaemon superuser_device:sock_file { create setattr unlink write };
 
-  # sudaemon is also permissive to permit setenforce.
-  permissive sudaemon;
-
   # Add sudaemon to various domains
   net_domain(sudaemon)
-  app_domain(sudaemon)
 
   dontaudit sudaemon self:capability_class_set *;
   dontaudit sudaemon kernel:security *;
@@ -54,11 +48,10 @@ userdebug_or_eng(`
   # typealias shell alias suclient;
   # domain_auto_trans(untrusted_app, su_exec, suclient)
 
-  allow untrusted_app su_exec:file { execute_no_trans getattr open read execute };
-  allow untrusted_app sudaemon:unix_stream_socket { connectto read write setopt ioctl };
-  allow untrusted_app superuser_device:dir { r_dir_perms };
-  allow untrusted_app superuser_device:sock_file { write };
-
+  allow untrusted_app_all su_exec:file { execute_no_trans getattr open read execute };
+  allow untrusted_app_all sudaemon:unix_stream_socket { connectto read write setopt ioctl };
+  allow untrusted_app_all superuser_device:dir { r_dir_perms };
+  allow untrusted_app_all superuser_device:sock_file { write };
 
   # For Settings control of access
   allow system_app superuser_device:sock_file { read write create setattr unlink getattr };
@@ -69,4 +62,4 @@ userdebug_or_eng(`
 
 ')
 
-neverallow { domain userdebug_or_eng(`-dumpstate -shell -su -untrusted_app -init -sudaemon') } su_exec:file no_x_file_perms;
+neverallow { domain userdebug_or_eng(`-dumpstate -shell -su -untrusted_app_all -init -sudaemon') } su_exec:file no_x_file_perms;
-- 
2.7.4

