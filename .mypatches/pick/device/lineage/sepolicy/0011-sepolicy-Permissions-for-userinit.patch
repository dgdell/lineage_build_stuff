From 30470df5c0c4eda60b3d15d0af0658244b8686a2 Mon Sep 17 00:00:00 2001
From: Emerson Pinter <dev@pinter.com.br>
Date: Thu, 12 Feb 2015 19:20:19 -0200
Subject: [PATCH 11/14] sepolicy: Permissions for userinit

Change-Id: Icaf9d191841a6214925729e40d84a61a2ebf2296
---
 common/private/file_contexts | 1 +
 common/private/sysinit.te    | 9 +++++++++
 common/private/userinit.te   | 1 +
 3 files changed, 11 insertions(+)

diff --git a/common/private/file_contexts b/common/private/file_contexts
index 69bdbfd..b028f39 100644
--- a/common/private/file_contexts
+++ b/common/private/file_contexts
@@ -15,4 +15,5 @@
 /system/bin/sysinit                     u:object_r:sysinit_exec:s0
 
 # Userinit
+/data/local/userinit\.sh                u:object_r:userinit_data_exec:s0
 /system/etc/init\.d/90userinit          u:object_r:userinit_exec:s0
diff --git a/common/private/sysinit.te b/common/private/sysinit.te
index 1bfa703..96a0cc5 100644
--- a/common/private/sysinit.te
+++ b/common/private/sysinit.te
@@ -8,3 +8,12 @@ allow sysinit devpts:chr_file rw_file_perms;
 allow sysinit self:process setcurrent;
 allow sysinit shell_exec:file rx_file_perms;
 allow sysinit system_file:file rx_file_perms;
+
+userdebug_or_eng(`
+    allow sysinit userinit_data_exec:file { r_file_perms relabelto };
+    allow sysinit sysfs:file rw_file_perms;
+    allow sysinit sysfs_devices_system_cpu:file write;
+    allow sysinit self:capability dac_override;
+    allow sysinit userinit_exec:file rx_file_perms;
+    set_prop(sysinit, userinit_prop)
+')
diff --git a/common/private/userinit.te b/common/private/userinit.te
index b12167d..37fd643 100644
--- a/common/private/userinit.te
+++ b/common/private/userinit.te
@@ -1,3 +1,4 @@
 type userinit_exec, exec_type, file_type;
+type userinit_data_exec, file_type;
 
 set_prop(userinit_exec, userinit_prop)
-- 
2.7.4

