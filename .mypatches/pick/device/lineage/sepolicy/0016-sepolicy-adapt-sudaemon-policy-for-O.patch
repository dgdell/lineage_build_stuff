From 926a794a2c2fcdf83421e1269e312ea014f162f9 Mon Sep 17 00:00:00 2001
From: jrior001 <jriordan001@gmail.com>
Date: Mon, 8 Jan 2018 01:02:01 -0500
Subject: [PATCH 16/16] sepolicy: adapt sudaemon policy for O

Change-Id: Iab4322eb3fec84f210607a2e2a176580f48b945c
---
 common/private/su.te  | 12 ++++++++++++
 common/public/su.te   |  8 +-------
 qcom/common/device.te |  1 +
 3 files changed, 14 insertions(+), 7 deletions(-)
 create mode 100644 common/private/su.te
 create mode 100644 qcom/common/device.te

diff --git a/common/private/su.te b/common/private/su.te
new file mode 100644
index 0000000..bd19cff
--- /dev/null
+++ b/common/private/su.te
@@ -0,0 +1,12 @@
+userdebug_or_eng(`
+  typeattribute sudaemon coredomain;
+
+  domain_trans(init, su_exec, sudaemon)
+
+  type_transition sudaemon socket_device:sock_file superuser_device;
+
+  # sudaemon is also permissive to permit setenforce.
+  permissive sudaemon;
+
+  app_domain(sudaemon)
+')
diff --git a/common/public/su.te b/common/public/su.te
index 1a2a2b3..f21a0cd 100644
--- a/common/public/su.te
+++ b/common/public/su.te
@@ -3,21 +3,15 @@ type superuser_device, file_type, mlstrustedobject;
 ## Perms for the daemon
 
 userdebug_or_eng(`
-  domain_trans(init, su_exec, sudaemon)
 
   typeattribute sudaemon domain, mlstrustedsubject;
 
-  type_transition sudaemon socket_device:sock_file superuser_device;
   # The userspace app uses /dev sockets to control per-app access
   allow sudaemon superuser_device:dir { create rw_dir_perms setattr unlink };
   allow sudaemon superuser_device:sock_file { create setattr unlink write };
 
-  # sudaemon is also permissive to permit setenforce.
-  permissive sudaemon;
-
   # Add sudaemon to various domains
   net_domain(sudaemon)
-  app_domain(sudaemon)
 
   dontaudit sudaemon self:capability_class_set *;
   dontaudit sudaemon kernel:security *;
@@ -54,7 +48,7 @@ userdebug_or_eng(`
   # typealias shell alias suclient;
   # domain_auto_trans(untrusted_app, su_exec, suclient)
 
-  allow untrusted_app su_exec:file { execute_no_trans getattr open read execute };
+  # allow untrusted_app su_exec:file { execute_no_trans getattr open read execute };
   allow untrusted_app sudaemon:unix_stream_socket { connectto read write setopt ioctl };
   allow untrusted_app superuser_device:dir { r_dir_perms };
   allow untrusted_app superuser_device:sock_file { write };
diff --git a/qcom/common/device.te b/qcom/common/device.te
new file mode 100644
index 0000000..9e49627
--- /dev/null
+++ b/qcom/common/device.te
@@ -0,0 +1 @@
+type persist_block_device, dev_type;
-- 
2.7.4

