From a43899741fdd5f136beda3efa8292cf4b66d97d4 Mon Sep 17 00:00:00 2001
From: Tim Schumacher <timschumi2@arcor.de>
Date: Sun, 30 Apr 2017 18:00:39 +0200
Subject: [PATCH 18/74] mirror: Add mirror-regen script

Change-Id: I50b1a7b0a615fbe7a8808035e977b2193aceb315
---
 README.md       |  3 +++
 mirror-regen.sh | 64 +++++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 67 insertions(+)
 create mode 100755 mirror-regen.sh

diff --git a/README.md b/README.md
index 91bb331..11863db 100644
--- a/README.md
+++ b/README.md
@@ -5,3 +5,6 @@ Usage: `repo init -u http://github.com/LineageOS/mirror --mirror`
 Once the mirror is synced you can then run `repo init -u /path/to/mirror/LineageOS/android.git -b $BRANCHNAME` and sync normally.
 
 If you want to sync the source quickly but want it to be up-to-date without syncing the mirror every time, then run `repo init -u http://www.github.com/LineageOS/android -b $BRANCHNAME --reference=/path/to/mirror/`. This will init the new repo and fetch all the (available) data from the mirror, but will fallback to GitHub if something is missing in the mirror.
+
+To update the mirror, either edit the manifest manually or use the `manifest-regen.sh` script.  
+**WARNING:** The script causes a data usage of ~15 MB. Also, it is possible that it fails downloading a page of repositories. As a result, these repositories that were on that page will be missing in the mirror manifest. **Please double check the resulting manifest before submitting it to Gerrit**
diff --git a/mirror-regen.sh b/mirror-regen.sh
new file mode 100755
index 0000000..7d10679
--- /dev/null
+++ b/mirror-regen.sh
@@ -0,0 +1,64 @@
+#!/bin/bash
+
+# Initializing/Clearing Variables
+ORG="LineageOS"
+OUTPUT="default.xml"
+NUM_REPOS=0
+NUM_PAGES=0
+TMP=""
+AUTH=""
+if [ -n "$1" ]; then
+  AUTH="-u $1"
+fi
+echo -n "" > $OUTPUT
+
+function filter_json()
+{
+  # Define filter function to extract data from the JSON returned by the GitHub API
+  cat - | grep "\"$1\"" | sed -e "s/ *\"$1\": \"//g" | sed -e "s/ *\"$1\": //g" | sed -e "s/\",$//g" | sed -e "s/,$//g"
+}
+
+# Fetching Organization Information (Number of Repos, etc.)
+echo "---- Fetching organization information ----"
+NUM_REPOS=$(curl -i -# $AUTH "https://api.github.com/orgs/$ORG" | filter_json "public_repos")
+NUM_PAGES=$(( NUM_REPOS / 100 ))
+if [ $((NUM_PAGES * 100)) -lt $NUM_REPOS ]; then
+  NUM_PAGES=$((NUM_PAGES+1))
+fi
+echo ""
+echo "Number of Repos: $NUM_REPOS"
+echo "Number of Pages: $NUM_PAGES"
+echo ""
+
+# Fetch the repo names
+COUNTER=1
+while [ ! $COUNTER -gt $NUM_PAGES ]; do
+  echo "---- Fetching page $COUNTER of $NUM_PAGES ----"
+  if [ "$TMP" != "" ]; then
+    TMP="$TMP
+"
+  fi
+  TMP="$TMP$(curl -# $AUTH "https://api.github.com/orgs/$ORG/repos?per_page=100&type=public&page=$COUNTER" | filter_json "full_name")"
+  let COUNTER=COUNTER+1
+  echo ""
+done
+
+# Write to the output file
+cat >> $OUTPUT << "EOF"
+<?xml version="1.0" encoding="UTF-8"?>
+<manifest>
+
+  <remote  name="github"
+           fetch=".." />
+
+  <default revision="master"
+           remote="github"
+           sync-j="4" />
+
+EOF
+while read repo; do
+  echo "  <project name=\"$repo\" />" >> $OUTPUT
+done <<< "$(echo "$TMP" | sort - | uniq )"
+echo "</manifest>" >> $OUTPUT
+
+echo "Done generating manifest at $OUTPUT"
-- 
2.17.1

