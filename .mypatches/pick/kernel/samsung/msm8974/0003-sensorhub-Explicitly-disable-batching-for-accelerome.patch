From f67a91361e3b4da6834c1a3e328a773c4c68ca95 Mon Sep 17 00:00:00 2001
From: "Kevin F. Haggerty" <haggertk@lineageos.org>
Date: Mon, 30 Jul 2018 08:04:03 -0600
Subject: [PATCH 03/25] sensorhub: Explicitly disable batching for
 accelerometer

Change-Id: I8145da2cfb8037053dc580e5ae5bf9508d9325a1
Signed-off-by: Kevin F. Haggerty <haggertk@lineageos.org>
---
 drivers/sensorhub/stm/ssp_data.c    | 4 +++-
 drivers/sensorhub/stm32f/ssp_data.c | 4 +++-
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/drivers/sensorhub/stm/ssp_data.c b/drivers/sensorhub/stm/ssp_data.c
index d4832763b02..a1bfc6bb169 100644
--- a/drivers/sensorhub/stm/ssp_data.c
+++ b/drivers/sensorhub/stm/ssp_data.c
@@ -285,7 +285,9 @@ int parse_dataframe(struct ssp_data *data, char *pchRcvDataFrame, int iLength) {
 			memcpy(&length, pchRcvDataFrame + iDataIdx, 2);
 			iDataIdx += 2;
 			sensortime.batch_count = sensortime.batch_count_fixed = length;
-			sensortime.batch_mode = length > 1 ? BATCH_MODE_RUN : BATCH_MODE_NONE;
+			sensortime.batch_mode = (iSensorData != ACCELEROMETER_SENSOR) && (length > 1)
+					? BATCH_MODE_RUN
+					: BATCH_MODE_NONE;
 			sensortime.irq_diff = data->timestamp - data->lastTimestamp[iSensorData];
 
 			if (sensortime.batch_mode == BATCH_MODE_RUN) {
diff --git a/drivers/sensorhub/stm32f/ssp_data.c b/drivers/sensorhub/stm32f/ssp_data.c
index 4d75cb22168..27b396e6eae 100644
--- a/drivers/sensorhub/stm32f/ssp_data.c
+++ b/drivers/sensorhub/stm32f/ssp_data.c
@@ -231,7 +231,9 @@ int parse_dataframe(struct ssp_data *data, char *pchRcvDataFrame, int iLength) {
 			memcpy(&length, pchRcvDataFrame + iDataIdx, 2);
 			iDataIdx += 2;
 			sensortime.batch_count = sensortime.batch_count_fixed = length;
-			sensortime.batch_mode = length > 1 ? BATCH_MODE_RUN : BATCH_MODE_NONE;
+			sensortime.batch_mode = (iSensorData != ACCELEROMETER_SENSOR) && (length > 1)
+					? BATCH_MODE_RUN
+					: BATCH_MODE_NONE;
 			sensortime.irq_diff = data->timestamp - data->lastTimestamp[iSensorData];
 
 			if (sensortime.batch_mode == BATCH_MODE_RUN) {
-- 
2.17.1

