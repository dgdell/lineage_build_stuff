From eec3722d1e4b2c445be783091f93876d2df5b36a Mon Sep 17 00:00:00 2001
From: Michael Bestas <mikeioannina@gmail.com>
Date: Tue, 14 Oct 2014 06:21:58 +0300
Subject: [PATCH 5/8] Camera2: Add option to set max screen brightness

* Set maximum screen brightness while the user is inside the camera app

Change-Id: I8b16ba47a933bc7d6b0c1cd62bfd6ca54875ce1e
---
 res/values/cm_strings.xml                    |  4 ++++
 res/xml/camera_preferences.xml               |  7 +++++++
 res/xml/video_preferences.xml                |  7 +++++++
 src/com/android/camera/CameraActivity.java   | 20 ++++++++++++++++++++
 src/com/android/camera/CameraSettings.java   |  1 +
 src/com/android/camera/ComboPreferences.java |  3 ++-
 src/com/android/camera/PhotoMenu.java        |  2 ++
 src/com/android/camera/PhotoModule.java      |  7 +++++++
 src/com/android/camera/VideoMenu.java        |  4 +++-
 src/com/android/camera/VideoModule.java      |  4 ++++
 10 files changed, 57 insertions(+), 2 deletions(-)

diff --git a/res/values/cm_strings.xml b/res/values/cm_strings.xml
index c38530f..f152ea4 100644
--- a/res/values/cm_strings.xml
+++ b/res/values/cm_strings.xml
@@ -140,4 +140,8 @@
     <string name="pref_camera_shutter_speed_entry_15" translatable="false">15</string>
     <string name="pref_camera_shutter_speed_entry_30" translatable="false">30</string>
 
+    <!-- Max brightness -->
+    <string name="pref_camera_max_brightness_title">Bright screen</string>
+    <string name="pref_camera_max_brightness_default" translatable="false">off</string>
+
 </resources>
diff --git a/res/xml/camera_preferences.xml b/res/xml/camera_preferences.xml
index 3cfee49..a5fc85c 100755
--- a/res/xml/camera_preferences.xml
+++ b/res/xml/camera_preferences.xml
@@ -446,4 +446,11 @@
             camera:singleIcon="@drawable/ic_settings_powershutter"
             camera:entries="@array/pref_switch_entries"
             camera:entryValues="@array/pref_switch_entryvalues" />
+    <IconListPreference
+            camera:key="pref_max_brightness"
+            camera:defaultValue="@string/pref_camera_max_brightness_default"
+            camera:title="@string/pref_camera_max_brightness_title"
+            camera:singleIcon="@drawable/ic_settings_bright_screen"
+            camera:entries="@array/pref_switch_entries"
+            camera:entryValues="@array/pref_switch_entryvalues" />
 </PreferenceGroup>
diff --git a/res/xml/video_preferences.xml b/res/xml/video_preferences.xml
index be724ec..e60dbc3 100644
--- a/res/xml/video_preferences.xml
+++ b/res/xml/video_preferences.xml
@@ -227,4 +227,11 @@
             camera:singleIcon="@drawable/ic_settings_powershutter"
             camera:entries="@array/pref_switch_entries"
             camera:entryValues="@array/pref_switch_entryvalues" />
+    <IconListPreference
+            camera:key="pref_max_brightness"
+            camera:defaultValue="@string/pref_camera_max_brightness_default"
+            camera:title="@string/pref_camera_max_brightness_title"
+            camera:singleIcon="@drawable/ic_settings_bright_screen"
+            camera:entries="@array/pref_switch_entries"
+            camera:entryValues="@array/pref_switch_entryvalues" />
 </PreferenceGroup>
diff --git a/src/com/android/camera/CameraActivity.java b/src/com/android/camera/CameraActivity.java
index e796d3c..b48a232 100644
--- a/src/com/android/camera/CameraActivity.java
+++ b/src/com/android/camera/CameraActivity.java
@@ -230,6 +230,8 @@ public class CameraActivity extends Activity
     private boolean mInCameraApp = true;
     // Keep track of powershutter state
     public static boolean mPowerShutter = false;
+    // Keep track of max brightness state
+    public static boolean mMaxBrightness = false;
     private int mLastRawOrientation;
     private MyOrientationEventListener mOrientationListener;
     private Handler mMainHandler;
@@ -2059,6 +2061,24 @@ public class CameraActivity extends Activity
         }
     }
 
+    protected void initMaxBrightness(ComboPreferences prefs) {
+        String val = prefs.getString(CameraSettings.KEY_MAX_BRIGHTNESS,
+                getResources().getString(R.string.pref_camera_max_brightness_default));
+
+        Window win = getWindow();
+        WindowManager.LayoutParams params = win.getAttributes();
+
+        mMaxBrightness = val.equals(CameraSettings.VALUE_ON);
+
+        if (mMaxBrightness && mInCameraApp) {
+            params.screenBrightness = WindowManager.LayoutParams.BRIGHTNESS_OVERRIDE_FULL;
+        } else {
+            params.screenBrightness = WindowManager.LayoutParams.BRIGHTNESS_OVERRIDE_NONE;
+        }
+
+        win.setAttributes(params);
+    }
+
     protected void setResultEx(int resultCode) {
         mResultCodeForTesting = resultCode;
         setResult(resultCode);
diff --git a/src/com/android/camera/CameraSettings.java b/src/com/android/camera/CameraSettings.java
index dd843b0..210e110 100644
--- a/src/com/android/camera/CameraSettings.java
+++ b/src/com/android/camera/CameraSettings.java
@@ -89,6 +89,7 @@ public class CameraSettings {
     public static final String KEY_STARTUP_MODULE_INDEX = "camera.startup_module";
 
     public static final String KEY_POWER_SHUTTER = "pref_power_shutter";
+    public static final String KEY_MAX_BRIGHTNESS = "pref_max_brightness";
     public static final String KEY_VIDEO_ENCODER = "pref_camera_videoencoder_key";
     public static final String KEY_AUDIO_ENCODER = "pref_camera_audioencoder_key";
     public static final String KEY_POWER_MODE = "pref_camera_powermode_key";
diff --git a/src/com/android/camera/ComboPreferences.java b/src/com/android/camera/ComboPreferences.java
index 8c7e2b9..dd1183b 100644
--- a/src/com/android/camera/ComboPreferences.java
+++ b/src/com/android/camera/ComboPreferences.java
@@ -158,7 +158,8 @@ public class ComboPreferences implements
                 || key.equals(SettingsManager.KEY_MONO_ONLY)
                 || key.equals(SettingsManager.KEY_MONO_PREVIEW)
                 || key.equals(SettingsManager.KEY_CLEARSIGHT)
-                || key.equals(CameraSettings.KEY_POWER_SHUTTER);
+                || key.equals(CameraSettings.KEY_POWER_SHUTTER)
+                || key.equals(CameraSettings.KEY_MAX_BRIGHTNESS);
     }
 
     @Override
diff --git a/src/com/android/camera/PhotoMenu.java b/src/com/android/camera/PhotoMenu.java
index 5afada8..ef6e256 100644
--- a/src/com/android/camera/PhotoMenu.java
+++ b/src/com/android/camera/PhotoMenu.java
@@ -204,6 +204,7 @@ public class PhotoMenu extends MenuController
                 CameraSettings.KEY_SELFIE_MIRROR,
                 CameraSettings.KEY_SHUTTER_SOUND,
                 CameraSettings.KEY_POWER_SHUTTER,
+                CameraSettings.KEY_MAX_BRIGHTNESS,
                 CameraSettings.KEY_SATURATION,
                 CameraSettings.KEY_CONTRAST,
                 CameraSettings.KEY_SHARPNESS,
@@ -232,6 +233,7 @@ public class PhotoMenu extends MenuController
                 CameraSettings.KEY_SHUTTER_SPEED,
                 CameraSettings.KEY_REDEYE_REDUCTION,
                 CameraSettings.KEY_POWER_SHUTTER,
+                CameraSettings.KEY_MAX_BRIGHTNESS,
                 CameraSettings.KEY_SATURATION,
                 CameraSettings.KEY_CONTRAST,
                 CameraSettings.KEY_SHARPNESS,
diff --git a/src/com/android/camera/PhotoModule.java b/src/com/android/camera/PhotoModule.java
index 87092bc..e9a5b34 100644
--- a/src/com/android/camera/PhotoModule.java
+++ b/src/com/android/camera/PhotoModule.java
@@ -616,6 +616,9 @@ public class PhotoModule
         // Power shutter
         mActivity.initPowerShutter(mPreferences);
 
+        // Max brightness
+        mActivity.initMaxBrightness(mPreferences);
+
         if (mOpenCameraThread == null) {
             mOpenCameraThread = new OpenCameraThread();
             mOpenCameraThread.start();
@@ -2918,6 +2921,9 @@ public class PhotoModule
         // Load the power shutter
         mActivity.initPowerShutter(mPreferences);
 
+        // Load max brightness
+        mActivity.initMaxBrightness(mPreferences);
+
         mNamedImages = null;
 
         if (mLocationManager != null) mLocationManager.recordLocation(false);
@@ -5136,6 +5142,7 @@ public class PhotoModule
         if (mUI.mMenuInitialized) {
             setCameraParametersWhenIdle(UPDATE_PARAM_PREFERENCE);
             mActivity.initPowerShutter(mPreferences);
+            mActivity.initMaxBrightness(mPreferences);
         } else {
             mHandler.sendEmptyMessage(SET_PHOTO_UI_PARAMS);
         }
diff --git a/src/com/android/camera/VideoMenu.java b/src/com/android/camera/VideoMenu.java
index 1211d78..3543c91 100644
--- a/src/com/android/camera/VideoMenu.java
+++ b/src/com/android/camera/VideoMenu.java
@@ -121,7 +121,8 @@ public class VideoMenu extends MenuController
                 CameraSettings.KEY_VIDEOCAMERA_FOCUS_TIME,
                 CameraSettings.KEY_VIDEO_HIGH_FRAME_RATE,
                 CameraSettings.KEY_DIS,
-                CameraSettings.KEY_POWER_SHUTTER
+                CameraSettings.KEY_POWER_SHUTTER,
+                CameraSettings.KEY_MAX_BRIGHTNESS
         };
         mOtherKeys2 = new String[] {
                 CameraSettings.KEY_VIDEOCAMERA_FLASH_MODE,
@@ -136,6 +137,7 @@ public class VideoMenu extends MenuController
                 CameraSettings.KEY_VIDEOCAMERA_FOCUS_TIME,
                 CameraSettings.KEY_VIDEO_HIGH_FRAME_RATE,
                 CameraSettings.KEY_POWER_SHUTTER,
+                CameraSettings.KEY_MAX_BRIGHTNESS,
                 CameraSettings.KEY_SEE_MORE,
                 CameraSettings.KEY_NOISE_REDUCTION,
                 CameraSettings.KEY_DIS,
diff --git a/src/com/android/camera/VideoModule.java b/src/com/android/camera/VideoModule.java
index f5ca2ac..453a475 100644
--- a/src/com/android/camera/VideoModule.java
+++ b/src/com/android/camera/VideoModule.java
@@ -530,6 +530,9 @@ public class VideoModule implements CameraModule,
         // Power shutter
         mActivity.initPowerShutter(mPreferences);
 
+        // Max brightness
+        mActivity.initMaxBrightness(mPreferences);
+
         /*
          * To reduce startup time, we start the preview in another thread.
          * We make sure the preview is started at the end of onCreate.
@@ -3094,6 +3097,7 @@ public class VideoModule implements CameraModule,
                 mPreferences.getString(CameraSettings.KEY_CAMERA_SAVEPATH, "0").equals("1"));
             mActivity.updateStorageSpaceAndHint();
             mActivity.initPowerShutter(mPreferences);
+            mActivity.initMaxBrightness(mPreferences);
         }
     }
 
-- 
2.7.4

