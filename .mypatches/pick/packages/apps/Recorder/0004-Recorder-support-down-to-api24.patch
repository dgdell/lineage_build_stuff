From a3c0030ae3075345abf7e3b9a3edf3b9ea9971a2 Mon Sep 17 00:00:00 2001
From: Joey <joey@lineageos.org>
Date: Sat, 19 May 2018 22:23:55 +0200
Subject: [PATCH 4/5] Recorder: support down to api24

Change-Id: I31595a77c939877de5f4c69d96f135e551fc181a
Signed-off-by: Joey <joey@lineageos.org>
---
 app/build.gradle                               |  2 +-
 app/src/main/AndroidManifest.xml               |  2 +-
 .../recorder/screen/OverlayService.java        |  8 ++++++++
 .../recorder/screen/ScreencastService.java     | 18 +++++++++++++-----
 .../recorder/sounds/SoundRecorderService.java  | 12 ++++++++++--
 .../lineageos/recorder/ui/OverlayLayer.java    |  5 ++++-
 6 files changed, 37 insertions(+), 10 deletions(-)

diff --git a/app/build.gradle b/app/build.gradle
index 6145fb4..19840a1 100644
--- a/app/build.gradle
+++ b/app/build.gradle
@@ -5,7 +5,7 @@ android {
     buildToolsVersion "27.0.3"
     defaultConfig {
         applicationId "org.lineageos.recorder"
-        minSdkVersion 26
+        minSdkVersion 24
         targetSdkVersion 27
         versionCode 1
         versionName "1.1"
diff --git a/app/src/main/AndroidManifest.xml b/app/src/main/AndroidManifest.xml
index 7d7479d..1dd8782 100644
--- a/app/src/main/AndroidManifest.xml
+++ b/app/src/main/AndroidManifest.xml
@@ -27,7 +27,7 @@
     <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
 
     <!-- This is needed for aosp build env -->
-    <uses-sdk android:minSdkVersion='25'
+    <uses-sdk android:minSdkVersion='24'
         tools:ignore="GradleOverrides" />
 
     <application
diff --git a/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java b/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java
index 4526366..0455321 100644
--- a/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java
+++ b/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java
@@ -21,6 +21,7 @@ import android.app.NotificationManager;
 import android.app.PendingIntent;
 import android.app.Service;
 import android.content.Intent;
+import android.os.Build;
 import android.os.IBinder;
 import android.support.v4.app.NotificationCompat;
 
@@ -82,6 +83,13 @@ public class OverlayService extends Service {
         super.onCreate();
 
         NotificationManager notificationManager = getSystemService(NotificationManager.class);
+
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O ||
+                notificationManager == null || notificationManager
+                .getNotificationChannel(SCREENCAST_OVERLAY_NOTIFICATION_CHANNEL) != null) {
+            return;
+        }
+
         CharSequence name = getString(R.string.screen_overlay_channel_title);
         String description = getString(R.string.screen_overlay_channel_desc);
         NotificationChannel notificationChannel =
diff --git a/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java b/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java
index 180357f..0fb6111 100644
--- a/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java
+++ b/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java
@@ -27,6 +27,7 @@ import android.content.IntentFilter;
 import android.graphics.Point;
 import android.hardware.display.DisplayManager;
 import android.hardware.display.VirtualDisplay;
+import android.os.Build;
 import android.os.Environment;
 import android.os.IBinder;
 import android.os.StatFs;
@@ -113,7 +114,19 @@ public class ScreencastService extends Service {
     public void onCreate() {
         super.onCreate();
 
+        IntentFilter filter = new IntentFilter();
+        filter.addAction(Intent.ACTION_USER_BACKGROUND);
+        filter.addAction(Intent.ACTION_SHUTDOWN);
+        registerReceiver(mBroadcastReceiver, filter);
+
         mNotificationManager = getSystemService(NotificationManager.class);
+
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O ||
+                mNotificationManager == null || mNotificationManager.getNotificationChannel(
+                        SCREENCAST_NOTIFICATION_CHANNEL) != null) {
+            return;
+        }
+
         CharSequence name = getString(R.string.screen_channel_title);
         String description = getString(R.string.screen_channel_desc);
         NotificationChannel notificationChannel =
@@ -121,11 +134,6 @@ public class ScreencastService extends Service {
                         name, NotificationManager.IMPORTANCE_LOW);
         notificationChannel.setDescription(description);
         mNotificationManager.createNotificationChannel(notificationChannel);
-
-        IntentFilter filter = new IntentFilter();
-        filter.addAction(Intent.ACTION_USER_BACKGROUND);
-        filter.addAction(Intent.ACTION_SHUTDOWN);
-        registerReceiver(mBroadcastReceiver, filter);
     }
 
     @Override
diff --git a/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java b/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java
index 19bd3e9..003bb97 100644
--- a/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java
+++ b/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java
@@ -27,6 +27,7 @@ import android.content.IntentFilter;
 import android.media.AudioFormat;
 import android.media.AudioRecord;
 import android.media.MediaRecorder;
+import android.os.Build;
 import android.os.Environment;
 import android.os.IBinder;
 import android.support.v4.app.NotificationCompat;
@@ -111,7 +112,16 @@ public class SoundRecorderService extends Service {
     public void onCreate() {
         super.onCreate();
 
+        registerReceiver(mShutdownReceiver, new IntentFilter(Intent.ACTION_SHUTDOWN));
+
         mNotificationManager = getSystemService(NotificationManager.class);
+
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O ||
+                mNotificationManager == null || mNotificationManager.getNotificationChannel(
+                        SOUNDRECORDER_NOTIFICATION_CHANNEL) != null) {
+            return;
+        }
+
         CharSequence name = getString(R.string.sound_channel_title);
         String description = getString(R.string.sound_channel_desc);
         NotificationChannel notificationChannel =
@@ -119,8 +129,6 @@ public class SoundRecorderService extends Service {
                         name, NotificationManager.IMPORTANCE_LOW);
         notificationChannel.setDescription(description);
         mNotificationManager.createNotificationChannel(notificationChannel);
-
-        registerReceiver(mShutdownReceiver, new IntentFilter(Intent.ACTION_SHUTDOWN));
     }
 
     @Override
diff --git a/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java b/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java
index 5c7064f..a215093 100644
--- a/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java
+++ b/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java
@@ -17,6 +17,7 @@ package org.lineageos.recorder.ui;
 
 import android.content.Context;
 import android.graphics.PixelFormat;
+import android.os.Build;
 import android.view.Gravity;
 import android.view.LayoutInflater;
 import android.view.MotionEvent;
@@ -44,7 +45,9 @@ public class OverlayLayer extends View {
         mParams = new WindowManager.LayoutParams(
                 ViewGroup.LayoutParams.WRAP_CONTENT,
                 ViewGroup.LayoutParams.WRAP_CONTENT,
-                WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
+                Build.VERSION.SDK_INT >= Build.VERSION_CODES.O ?
+                        WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY :
+                        WindowManager.LayoutParams.TYPE_SYSTEM_ALERT,
                 WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
                         WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,
                 PixelFormat.TRANSLUCENT);
-- 
2.17.0

