From 51aac4ab136ed5dba717cdfdce2038c5a67a8e33 Mon Sep 17 00:00:00 2001
From: Joey <joey@lineageos.org>
Date: Sat, 19 May 2018 22:23:55 +0200
Subject: [PATCH 4/5] Recorder: set build.gradle minsdk to 25 to match lineage
 build env

and fix sdk25 support

Change-Id: I31595a77c939877de5f4c69d96f135e551fc181a
Signed-off-by: Joey <joey@lineageos.org>
---
 app/build.gradle                                 |  2 +-
 .../recorder/screen/OverlayService.java          | 10 +++++++++-
 .../recorder/screen/ScreencastService.java       | 16 +++++++++++-----
 .../recorder/sounds/SoundRecorderService.java    | 10 ++++++++--
 .../org/lineageos/recorder/ui/OverlayLayer.java  |  5 ++++-
 5 files changed, 33 insertions(+), 10 deletions(-)

diff --git a/app/build.gradle b/app/build.gradle
index 6145fb4..7fbbbe5 100644
--- a/app/build.gradle
+++ b/app/build.gradle
@@ -5,7 +5,7 @@ android {
     buildToolsVersion "27.0.3"
     defaultConfig {
         applicationId "org.lineageos.recorder"
-        minSdkVersion 26
+        minSdkVersion 25
         targetSdkVersion 27
         versionCode 1
         versionName "1.1"
diff --git a/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java b/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java
index 4526366..e0fe56c 100644
--- a/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java
+++ b/app/src/main/java/org/lineageos/recorder/screen/OverlayService.java
@@ -21,6 +21,7 @@ import android.app.NotificationManager;
 import android.app.PendingIntent;
 import android.app.Service;
 import android.content.Intent;
+import android.os.Build;
 import android.os.IBinder;
 import android.support.v4.app.NotificationCompat;
 
@@ -81,6 +82,10 @@ public class OverlayService extends Service {
     public void onCreate() {
         super.onCreate();
 
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O) {
+            return;
+        }
+
         NotificationManager notificationManager = getSystemService(NotificationManager.class);
         CharSequence name = getString(R.string.screen_overlay_channel_title);
         String description = getString(R.string.screen_overlay_channel_desc);
@@ -88,7 +93,10 @@ public class OverlayService extends Service {
                 new NotificationChannel(SCREENCAST_OVERLAY_NOTIFICATION_CHANNEL,
                         name, NotificationManager.IMPORTANCE_LOW);
         notificationChannel.setDescription(description);
-        notificationManager.createNotificationChannel(notificationChannel);
+
+        if (notificationManager != null) {
+            notificationManager.createNotificationChannel(notificationChannel);
+        }
     }
 
     @Override
diff --git a/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java b/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java
index 180357f..c11302a 100644
--- a/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java
+++ b/app/src/main/java/org/lineageos/recorder/screen/ScreencastService.java
@@ -27,6 +27,7 @@ import android.content.IntentFilter;
 import android.graphics.Point;
 import android.hardware.display.DisplayManager;
 import android.hardware.display.VirtualDisplay;
+import android.os.Build;
 import android.os.Environment;
 import android.os.IBinder;
 import android.os.StatFs;
@@ -113,7 +114,17 @@ public class ScreencastService extends Service {
     public void onCreate() {
         super.onCreate();
 
+        IntentFilter filter = new IntentFilter();
+        filter.addAction(Intent.ACTION_USER_BACKGROUND);
+        filter.addAction(Intent.ACTION_SHUTDOWN);
+        registerReceiver(mBroadcastReceiver, filter);
+
         mNotificationManager = getSystemService(NotificationManager.class);
+
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O) {
+            return;
+        }
+
         CharSequence name = getString(R.string.screen_channel_title);
         String description = getString(R.string.screen_channel_desc);
         NotificationChannel notificationChannel =
@@ -121,11 +132,6 @@ public class ScreencastService extends Service {
                         name, NotificationManager.IMPORTANCE_LOW);
         notificationChannel.setDescription(description);
         mNotificationManager.createNotificationChannel(notificationChannel);
-
-        IntentFilter filter = new IntentFilter();
-        filter.addAction(Intent.ACTION_USER_BACKGROUND);
-        filter.addAction(Intent.ACTION_SHUTDOWN);
-        registerReceiver(mBroadcastReceiver, filter);
     }
 
     @Override
diff --git a/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java b/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java
index 19bd3e9..7583481 100644
--- a/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java
+++ b/app/src/main/java/org/lineageos/recorder/sounds/SoundRecorderService.java
@@ -27,6 +27,7 @@ import android.content.IntentFilter;
 import android.media.AudioFormat;
 import android.media.AudioRecord;
 import android.media.MediaRecorder;
+import android.os.Build;
 import android.os.Environment;
 import android.os.IBinder;
 import android.support.v4.app.NotificationCompat;
@@ -111,7 +112,14 @@ public class SoundRecorderService extends Service {
     public void onCreate() {
         super.onCreate();
 
+        registerReceiver(mShutdownReceiver, new IntentFilter(Intent.ACTION_SHUTDOWN));
+
         mNotificationManager = getSystemService(NotificationManager.class);
+
+        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.O) {
+            return;
+        }
+
         CharSequence name = getString(R.string.sound_channel_title);
         String description = getString(R.string.sound_channel_desc);
         NotificationChannel notificationChannel =
@@ -119,8 +127,6 @@ public class SoundRecorderService extends Service {
                         name, NotificationManager.IMPORTANCE_LOW);
         notificationChannel.setDescription(description);
         mNotificationManager.createNotificationChannel(notificationChannel);
-
-        registerReceiver(mShutdownReceiver, new IntentFilter(Intent.ACTION_SHUTDOWN));
     }
 
     @Override
diff --git a/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java b/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java
index 5c7064f..a215093 100644
--- a/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java
+++ b/app/src/main/java/org/lineageos/recorder/ui/OverlayLayer.java
@@ -17,6 +17,7 @@ package org.lineageos.recorder.ui;
 
 import android.content.Context;
 import android.graphics.PixelFormat;
+import android.os.Build;
 import android.view.Gravity;
 import android.view.LayoutInflater;
 import android.view.MotionEvent;
@@ -44,7 +45,9 @@ public class OverlayLayer extends View {
         mParams = new WindowManager.LayoutParams(
                 ViewGroup.LayoutParams.WRAP_CONTENT,
                 ViewGroup.LayoutParams.WRAP_CONTENT,
-                WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,
+                Build.VERSION.SDK_INT >= Build.VERSION_CODES.O ?
+                        WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY :
+                        WindowManager.LayoutParams.TYPE_SYSTEM_ALERT,
                 WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE |
                         WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,
                 PixelFormat.TRANSLUCENT);
-- 
2.17.0

