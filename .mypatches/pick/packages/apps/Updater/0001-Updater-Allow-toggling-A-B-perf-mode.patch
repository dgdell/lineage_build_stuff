From ea5c20e5e8669d1067f7029ae1f6661129b0f7bd Mon Sep 17 00:00:00 2001
From: TheScarastic <warabhishek@gmail.com>
Date: Tue, 12 Jun 2018 15:10:04 +0530
Subject: [PATCH] Updater: Allow toggling A/B perf mode

Change-Id: I380a39bf6008b341c8005ac548d42d2413d0d643
---
 res/layout/preferences_dialog.xml                         | 8 ++++++++
 res/values/strings.xml                                    | 2 ++
 src/org/lineageos/updater/UpdatesActivity.java            | 8 ++++++++
 .../lineageos/updater/controller/ABUpdateInstaller.java   | 4 ++++
 src/org/lineageos/updater/misc/Constants.java             | 2 ++
 src/org/lineageos/updater/misc/Utils.java                 | 4 ++++
 6 files changed, 28 insertions(+)

diff --git a/res/layout/preferences_dialog.xml b/res/layout/preferences_dialog.xml
index 999d67f..898f53e 100644
--- a/res/layout/preferences_dialog.xml
+++ b/res/layout/preferences_dialog.xml
@@ -30,4 +30,12 @@
         android:layout_marginBottom="16dp"
         android:text="@string/menu_mobile_data_warning"
         android:textSize="16sp" />
+
+    <Switch
+        android:id="@+id/preferences_ab_perf_mode"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:layout_marginBottom="16dp"
+        android:text="@string/menu_ab_perf_mode"
+        android:textSize="16sp" />
 </LinearLayout>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index d4709c5..8dcf377 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -143,4 +143,6 @@
     <string name="new_updates_channel_title">New updates</string>
     <string name="ongoing_channel_title">Ongoing downloads</string>
     <string name="update_failed_channel_title">Update failed</string>
+
+    <string name="menu_ab_perf_mode">Install A/B Updates faster</string>
 </resources>
diff --git a/src/org/lineageos/updater/UpdatesActivity.java b/src/org/lineageos/updater/UpdatesActivity.java
index fc3e78b..0305aa9 100644
--- a/src/org/lineageos/updater/UpdatesActivity.java
+++ b/src/org/lineageos/updater/UpdatesActivity.java
@@ -409,11 +409,17 @@ public class UpdatesActivity extends UpdatesListActivity {
         Switch autoCheck = view.findViewById(R.id.preferences_auto_updates_check);
         Switch autoDelete = view.findViewById(R.id.preferences_auto_delete_updates);
         Switch dataWarning = view.findViewById(R.id.preferences_mobile_data_warning);
+        Switch abPerfMode = view.findViewById(R.id.preferences_ab_perf_mode);
+
+        if (!Utils.isAbDevice()) {
+            abPerfMode.setVisibility(View.GONE);
+        }
 
         SharedPreferences prefs = PreferenceManager.getDefaultSharedPreferences(this);
         autoCheck.setChecked(prefs.getBoolean(Constants.PREF_AUTO_UPDATES_CHECK, true));
         autoDelete.setChecked(prefs.getBoolean(Constants.PREF_AUTO_DELETE_UPDATES, false));
         dataWarning.setChecked(prefs.getBoolean(Constants.PREF_MOBILE_DATA_WARNING, true));
+        abPerfMode.setChecked(prefs.getBoolean(Constants.PREF_AB_PERF_MODE, false));
 
         new AlertDialog.Builder(this)
                 .setTitle(R.string.menu_preferences)
@@ -426,6 +432,8 @@ public class UpdatesActivity extends UpdatesListActivity {
                                     autoDelete.isChecked())
                             .putBoolean(Constants.PREF_MOBILE_DATA_WARNING,
                                     dataWarning.isChecked())
+                            .putBoolean(Constants.PREF_AB_PERF_MODE,
+                                    abPerfMode.isChecked())
                             .apply();
 
                     if (autoCheck.isChecked()) {
diff --git a/src/org/lineageos/updater/controller/ABUpdateInstaller.java b/src/org/lineageos/updater/controller/ABUpdateInstaller.java
index 82215f4..4ecfaf7 100644
--- a/src/org/lineageos/updater/controller/ABUpdateInstaller.java
+++ b/src/org/lineageos/updater/controller/ABUpdateInstaller.java
@@ -200,6 +200,10 @@ class ABUpdateInstaller {
             }
         }
 
+        boolean enableABPerfMode = PreferenceManager.getDefaultSharedPreferences(mContext)
+                .getBoolean(Constants.PREF_AB_PERF_MODE, false);
+        mUpdateEngine.setPerformanceMode(enableABPerfMode);
+
         String zipFileUri = "file://" + file.getAbsolutePath();
         mUpdateEngine.applyPayload(zipFileUri, offset, 0, headerKeyValuePairs);
 
diff --git a/src/org/lineageos/updater/misc/Constants.java b/src/org/lineageos/updater/misc/Constants.java
index 71582ae..521e4ff 100644
--- a/src/org/lineageos/updater/misc/Constants.java
+++ b/src/org/lineageos/updater/misc/Constants.java
@@ -26,11 +26,13 @@ public final class Constants {
     public static final String PREF_LAST_UPDATE_CHECK = "last_update_check";
     public static final String PREF_AUTO_UPDATES_CHECK = "auto_updates_check";
     public static final String PREF_AUTO_DELETE_UPDATES = "auto_delete_updates";
+    public static final String PREF_AB_PERF_MODE = "ab_perf_mode";
     public static final String PREF_MOBILE_DATA_WARNING = "pref_mobile_data_warning";
     public static final String PREF_NEEDS_REBOOT_ID = "needs_reboot_id";
 
     public static final String UNCRYPT_FILE_EXT = ".uncrypt";
 
+    public static final String PROP_AB_DEVICE = "ro.build.ab_update";
     public static final String PROP_BUILD_DATE = "ro.build.date.utc";
     public static final String PROP_BUILD_VERSION = "ro.lineage.build.version";
     public static final String PROP_BUILD_VERSION_INCREMENTAL = "ro.build.version.incremental";
diff --git a/src/org/lineageos/updater/misc/Utils.java b/src/org/lineageos/updater/misc/Utils.java
index 67895da..b9583cf 100644
--- a/src/org/lineageos/updater/misc/Utils.java
+++ b/src/org/lineageos/updater/misc/Utils.java
@@ -362,4 +362,8 @@ public class Utils {
         StorageManager sm = (StorageManager) context.getSystemService(Context.STORAGE_SERVICE);
         return sm.isEncrypted(file);
     }
+
+    public static boolean isAbDevice() {
+        return !SystemProperties.get(Constants.PROP_AB_DEVICE).isEmpty();
+    }
 }
-- 
2.17.1

