From da1c6afc82858a7ebda4ffa634a5c317966347bf Mon Sep 17 00:00:00 2001
From: Tom Marshall <tdm@cyngn.com>
Date: Mon, 27 Jun 2016 14:31:57 -0700
Subject: [PATCH 5/9] Settings: Set root access options appropriately

It is possible to be running a user build with a debuggable boot image.
In this case, "su" will not be available.  So only show none/adb.

Issue-Id: BACON-4461
Change-Id: Iaa7df8311b9ea81eabb1566ba6f9159fdc9fab34
---
 res/values/cm_arrays.xml                                      | 10 ++++++++++
 res/xml/development_prefs.xml                                 |  4 +---
 src/com/android/settings/development/DevelopmentSettings.java |  9 +++++++++
 3 files changed, 20 insertions(+), 3 deletions(-)

diff --git a/res/values/cm_arrays.xml b/res/values/cm_arrays.xml
index 5f64ea3..011ba45 100644
--- a/res/values/cm_arrays.xml
+++ b/res/values/cm_arrays.xml
@@ -217,4 +217,14 @@
         <item>2</item>
         <item>3</item>
     </string-array>
+
+    <string-array name="root_access_entries_adb" translatable="false">
+        <item>@string/root_access_none</item>
+        <item>@string/root_access_adb</item>
+    </string-array>
+
+    <string-array name="root_access_values_adb" translatable="false">
+        <item>0</item>
+        <item>2</item>
+    </string-array>
 </resources>
diff --git a/res/xml/development_prefs.xml b/res/xml/development_prefs.xml
index f74d96d..a8bbfbf 100644
--- a/res/xml/development_prefs.xml
+++ b/res/xml/development_prefs.xml
@@ -124,9 +124,7 @@
     <ListPreference
         android:key="root_access"
         android:title="@string/root_access"
-        android:persistent="false"
-        android:entries="@array/root_access_entries"
-        android:entryValues="@array/root_access_values" />
+        android:persistent="false" />
 
     <PreferenceCategory android:key="debug_debugging_category"
             android:title="@string/debug_debugging_category">
diff --git a/src/com/android/settings/development/DevelopmentSettings.java b/src/com/android/settings/development/DevelopmentSettings.java
index 501a7c5..aa288ac 100644
--- a/src/com/android/settings/development/DevelopmentSettings.java
+++ b/src/com/android/settings/development/DevelopmentSettings.java
@@ -106,6 +106,8 @@ import com.android.settingslib.drawer.CategoryKey;
 
 import lineageos.providers.LineageSettings;
 
+import org.lineageos.internal.util.FileUtils;
+
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.HashSet;
@@ -620,6 +622,13 @@ public class DevelopmentSettings extends RestrictedSettingsFragment
         mRootAccess = (ListPreference) findPreference(ROOT_ACCESS_KEY);
         mRootAccess.setOnPreferenceChangeListener(this);
         if (!removeRootOptionsIfRequired()) {
+            if (FileUtils.fileExists("/system/xbin/su")) {
+                mRootAccess.setEntries(R.array.root_access_entries);
+                mRootAccess.setEntryValues(R.array.root_access_values);
+            } else {
+                mRootAccess.setEntries(R.array.root_access_entries_adb);
+                mRootAccess.setEntryValues(R.array.root_access_values_adb);
+            }
             mAllPrefs.add(mRootAccess);
         }
         addDashboardCategoryPreferences();
-- 
2.7.4

