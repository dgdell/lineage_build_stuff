From eddc2748c9530f3df5ec635485437e0201f21e07 Mon Sep 17 00:00:00 2001
From: Danny Baumann <dannybaumann@web.de>
Date: Thu, 20 Apr 2017 12:41:39 +0200
Subject: [PATCH 16/20] Pass selected folder to message search.

Allows searching in selected folder instead of inbox.

Change-Id: I251a34b85aa35997a9d7c5705d4e206c8c88f564
---
 src/com/android/mail/providers/Folder.java              | 8 ++++++--
 src/com/android/mail/providers/UIProvider.java          | 5 +++++
 src/com/android/mail/ui/AbstractActivityController.java | 5 ++++-
 3 files changed, 15 insertions(+), 3 deletions(-)

diff --git a/src/com/android/mail/providers/Folder.java b/src/com/android/mail/providers/Folder.java
index 9b6fa5033..bd701a10c 100644
--- a/src/com/android/mail/providers/Folder.java
+++ b/src/com/android/mail/providers/Folder.java
@@ -507,13 +507,17 @@ public class Folder implements Parcelable, Comparable<Folder> {
      * Construct a folder that queries for search results. Do not call on the UI
      * thread.
      */
-    public static ObjectCursorLoader<Folder> forSearchResults(Account account, String query,
-            String queryIdentifier, Context context) {
+    public static ObjectCursorLoader<Folder> forSearchResults(Account account, Folder folder,
+            String query, String queryIdentifier, Context context) {
         if (account.searchUri != null) {
             final Uri.Builder searchBuilder = account.searchUri.buildUpon();
             searchBuilder.appendQueryParameter(UIProvider.SearchQueryParameters.QUERY, query);
             searchBuilder.appendQueryParameter(UIProvider.SearchQueryParameters.QUERY_IDENTIFER,
                     queryIdentifier);
+            if (folder != null) {
+                searchBuilder.appendQueryParameter(UIProvider.SearchQueryParameters.FOLDER_ID,
+                        String.valueOf(folder.id));
+            }
             final Uri searchUri = searchBuilder.build();
             return new ObjectCursorLoader<Folder>(context, searchUri, UIProvider.FOLDERS_PROJECTION,
                     FACTORY);
diff --git a/src/com/android/mail/providers/UIProvider.java b/src/com/android/mail/providers/UIProvider.java
index 3bb6da54a..94a3769f8 100644
--- a/src/com/android/mail/providers/UIProvider.java
+++ b/src/com/android/mail/providers/UIProvider.java
@@ -732,6 +732,11 @@ public class UIProvider {
         */
         public static final String QUERY_IDENTIFER = "query_identifier";
 
+        /**
+         * Parameter used to specify the folder to search in
+         */
+        public static final String FOLDER_ID = "folder_id";
+
         private SearchQueryParameters() {}
     }
 
diff --git a/src/com/android/mail/ui/AbstractActivityController.java b/src/com/android/mail/ui/AbstractActivityController.java
index a7de33b60..d38539071 100644
--- a/src/com/android/mail/ui/AbstractActivityController.java
+++ b/src/com/android/mail/ui/AbstractActivityController.java
@@ -875,9 +875,10 @@ public abstract class AbstractActivityController implements ActivityController,
      * @param intent Intent that the app was started with. This intent contains the search query.
      */
     private void fetchSearchFolder(Intent intent) {
-        final Bundle args = new Bundle(1);
+        final Bundle args = new Bundle(2);
         args.putString(ConversationListContext.EXTRA_SEARCH_QUERY, intent
                 .getStringExtra(ConversationListContext.EXTRA_SEARCH_QUERY));
+        args.putParcelable(Utils.EXTRA_FOLDER, intent.getParcelableExtra(Utils.EXTRA_FOLDER));
         mActivity.getLoaderManager().restartLoader(LOADER_SEARCH, args, mFolderCallbacks);
     }
 
@@ -2247,6 +2248,7 @@ public abstract class AbstractActivityController implements ActivityController,
         intent.setAction(Intent.ACTION_SEARCH);
         intent.putExtra(ConversationListContext.EXTRA_SEARCH_QUERY, query);
         intent.putExtra(Utils.EXTRA_ACCOUNT, mAccount);
+        intent.putExtra(Utils.EXTRA_FOLDER, mFolder);
         intent.setComponent(mActivity.getComponentName());
         mSearchViewController.showSearchActionBar(
                 MaterialSearchViewController.SEARCH_VIEW_STATE_GONE);
@@ -3508,6 +3510,7 @@ public abstract class AbstractActivityController implements ActivityController,
                 case LOADER_SEARCH:
                     LogUtils.d(LOG_TAG, "LOADER_SEARCH created");
                     return Folder.forSearchResults(mAccount,
+                            (Folder) args.getParcelable(Utils.EXTRA_FOLDER),
                             args.getString(ConversationListContext.EXTRA_SEARCH_QUERY),
                             // We can just use current time as a unique identifier for this search
                             Long.toString(SystemClock.uptimeMillis()),
-- 
2.17.1

