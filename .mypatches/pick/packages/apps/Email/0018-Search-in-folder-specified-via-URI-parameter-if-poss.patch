From 1b5dfd3aa073e5ba03ade695cc64ef1760e8affe Mon Sep 17 00:00:00 2001
From: Danny Baumann <dannybaumann@web.de>
Date: Thu, 20 Apr 2017 12:42:22 +0200
Subject: [PATCH 18/19] Search in folder specified via URI parameter, if
 possible.

Change-Id: Ie2e9b8f4980be593e65c8d1c57dab785aa1efb29
---
 .../android/email/provider/EmailProvider.java | 24 +++++++++++++++----
 1 file changed, 20 insertions(+), 4 deletions(-)

diff --git a/provider_src/com/android/email/provider/EmailProvider.java b/provider_src/com/android/email/provider/EmailProvider.java
index 12c31b4b3..003ed705a 100644
--- a/provider_src/com/android/email/provider/EmailProvider.java
+++ b/provider_src/com/android/email/provider/EmailProvider.java
@@ -6039,10 +6039,26 @@ public class EmailProvider extends ContentProvider
     private Cursor uiSearch(Uri uri, String[] projection) {
         LogUtils.d(TAG, "runSearchQuery in search %s", uri);
         final long accountId = Long.parseLong(uri.getLastPathSegment());
+        long folderId = -1;
 
-        // TODO: Check the actual mailbox
-        Mailbox inbox = Mailbox.restoreMailboxOfType(getContext(), accountId, Mailbox.TYPE_INBOX);
-        if (inbox == null) {
+        try {
+            String folderIdString = uri.getQueryParameter(
+                    UIProvider.SearchQueryParameters.FOLDER_ID);
+            if (folderIdString != null) {
+                folderId = Long.valueOf(folderIdString);
+            }
+        } catch (NumberFormatException e) {
+            // ignore and keep -1
+        }
+
+        Mailbox folder = null;
+        if (folderId >= 0) {
+            folder = Mailbox.restoreMailboxWithId(getContext(), folderId);
+        }
+        if (folder == null) {
+            folder = Mailbox.restoreMailboxOfType(getContext(), accountId, Mailbox.TYPE_INBOX);
+        }
+        if (folder == null) {
             LogUtils.w(Logging.LOG_TAG, "In uiSearch, inbox doesn't exist for account "
                     + accountId);
 
@@ -6058,7 +6074,7 @@ public class EmailProvider extends ContentProvider
         Mailbox searchMailbox = getSearchMailbox(accountId);
         final long searchMailboxId = searchMailbox.mId;
 
-        mSearchParams = new SearchParams(inbox.mId, filter, searchMailboxId);
+        mSearchParams = new SearchParams(folder.mId, filter, searchMailboxId);
 
         final Context context = getContext();
         if (mSearchParams.mOffset == 0) {
-- 
2.17.1

