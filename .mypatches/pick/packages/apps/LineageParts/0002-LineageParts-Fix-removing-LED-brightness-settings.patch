From ea273212a7a3e5bf3b597f794996cdb1e9f71858 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Thu, 22 Feb 2018 20:51:13 +0100
Subject: [PATCH 2/5] LineageParts: Fix removing LED brightness settings

*) And some misc clean up whilst we're here.

Change-Id: I8ffb0dbe287d063e6e89fc16658ec728cd585226
---
 .../NotificationLightSettings.java            | 31 +++++++++++++------
 1 file changed, 22 insertions(+), 9 deletions(-)

diff --git a/src/org/lineageos/lineageparts/notificationlight/NotificationLightSettings.java b/src/org/lineageos/lineageparts/notificationlight/NotificationLightSettings.java
index 6c58e82..4f48580 100644
--- a/src/org/lineageos/lineageparts/notificationlight/NotificationLightSettings.java
+++ b/src/org/lineageos/lineageparts/notificationlight/NotificationLightSettings.java
@@ -61,9 +61,17 @@ import lineageos.util.ColorUtils;
 public class NotificationLightSettings extends SettingsPreferenceFragment implements
         Preference.OnPreferenceChangeListener, ApplicationLightPreference.ItemLongClickListener {
     private static final String TAG = "NotificationLightSettings";
+
+    private static final String ADVANCED_SECTION = "advanced_section";
+    private static final String APPLICATION_SECTION = "applications_list";
+    private static final String BRIGHTNESS_SECTION = "brightness_section";
+    private static final String GENERAL_SECTION = "general_section";
+    private static final String PHONE_SECTION = "phone_list";
+
     private static final String DEFAULT_PREF = "default";
     private static final String MISSED_CALL_PREF = "missed_call";
     private static final String VOICEMAIL_PREF = "voicemail";
+
     public static final int ACTION_TEST = 0;
     public static final int ACTION_DELETE = 1;
     private static final int MENU_ADD = 0;
@@ -86,7 +94,11 @@ public class NotificationLightSettings extends SettingsPreferenceFragment implem
     private PackageListAdapter mPackageAdapter;
     private String mPackageList;
     private Map<String, Package> mPackages;
+    // liblights supports brightness control
+    private boolean mHALAdjustableBrightness;
+    // Supports rgb color control
     private boolean mMultiColorLed;
+    // Supports adjustable pulse
     private boolean mLedCanPulse;
 
     @Override
@@ -101,8 +113,8 @@ public class NotificationLightSettings extends SettingsPreferenceFragment implem
         PreferenceScreen prefSet = getPreferenceScreen();
         Resources resources = getResources();
 
-        PreferenceGroup mAdvancedPrefs = (PreferenceGroup) prefSet.findPreference("advanced_section");
-        PreferenceGroup mGeneralPrefs = (PreferenceGroup) prefSet.findPreference("general_section");
+        PreferenceGroup mAdvancedPrefs = (PreferenceGroup) prefSet.findPreference(ADVANCED_SECTION);
+        PreferenceGroup mGeneralPrefs = (PreferenceGroup) prefSet.findPreference(GENERAL_SECTION);
 
         // Get the system defined default notification color
         mDefaultColor =
@@ -113,6 +125,8 @@ public class NotificationLightSettings extends SettingsPreferenceFragment implem
         mDefaultLedOff = resources.getInteger(
                 com.android.internal.R.integer.config_defaultNotificationLedOff);
 
+        mHALAdjustableBrightness = LightsCapabilities.supports(
+                context, LightsCapabilities.LIGHTS_ADJUSTABLE_NOTIFICATION_LED_BRIGHTNESS);
         mLedCanPulse = LightsCapabilities.supports(
                 context, LightsCapabilities.LIGHTS_PULSATING_LED);
         mMultiColorLed = LightsCapabilities.supports(
@@ -135,9 +149,8 @@ public class NotificationLightSettings extends SettingsPreferenceFragment implem
         mScreenOnLightsPref.setOnPreferenceChangeListener(this);
         mCustomEnabledPref = (LineageSystemSettingSwitchPreference)
                 findPreference(LineageSettings.System.NOTIFICATION_LIGHT_PULSE_CUSTOM_ENABLE);
-        if (!LightsCapabilities.supports(
-                context, LightsCapabilities.LIGHTS_ADJUSTABLE_NOTIFICATION_LED_BRIGHTNESS)) {
-            mAdvancedPrefs.removePreference(mNotificationBrightnessPref);
+        if (!mMultiColorLed && !mHALAdjustableBrightness) {
+            removePreference(BRIGHTNESS_SECTION);
         }
         if (!mLedCanPulse && !mMultiColorLed) {
             mGeneralPrefs.removePreference(mDefaultPref);
@@ -152,7 +165,7 @@ public class NotificationLightSettings extends SettingsPreferenceFragment implem
         TelephonyManager tm = (TelephonyManager) getActivity().getSystemService(Context.TELEPHONY_SERVICE);
         if (tm.getPhoneType() == TelephonyManager.PHONE_TYPE_NONE
                 || (!mLedCanPulse && !mMultiColorLed)) {
-            removePreference("phone_list");
+            removePreference(PHONE_SECTION);
         } else {
             mCallPref = (ApplicationLightPreference) findPreference(MISSED_CALL_PREF);
             mCallPref.setOnPreferenceChangeListener(this);
@@ -164,9 +177,9 @@ public class NotificationLightSettings extends SettingsPreferenceFragment implem
         }
 
         if (!mLedCanPulse && !mMultiColorLed) {
-            removePreference("applications_list");
+            removePreference(APPLICATION_SECTION);
         } else {
-            mApplicationPrefList = (PreferenceGroup) findPreference("applications_list");
+            mApplicationPrefList = (PreferenceGroup) findPreference(APPLICATION_SECTION);
             mApplicationPrefList.setOrderingAsAdded(false);
         }
 
@@ -231,7 +244,7 @@ public class NotificationLightSettings extends SettingsPreferenceFragment implem
         }
 
         if (mLedCanPulse || mMultiColorLed) {
-            mApplicationPrefList = (PreferenceGroup) findPreference("applications_list");
+            mApplicationPrefList = (PreferenceGroup) findPreference(APPLICATION_SECTION);
             mApplicationPrefList.setOrderingAsAdded(false);
         }
     }
-- 
2.17.0

