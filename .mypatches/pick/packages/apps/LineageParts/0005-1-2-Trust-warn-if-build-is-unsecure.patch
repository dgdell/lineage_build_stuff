From 45b33e395c3da4f0d99070b58a3caf95273d6c3a Mon Sep 17 00:00:00 2001
From: Tobias Tefke <tobias.tefke@tutanota.com>
Date: Thu, 14 Jun 2018 12:03:48 +0200
Subject: [PATCH 5/6] [1/2] Trust: warn if build is unsecure

The icon was taken from Google's material design icons
(https://github.com/google/material-design-icons)

Change-Id: I81f2fde0b9d1b513d1fe504d75ed418b2e999fd9
---
 res/drawable/ic_trust_platform_bad.xml        | 26 ++++++++++++
 res/drawable/ic_trust_platform_good.xml       | 26 ++++++++++++
 res/drawable/ic_trust_platform_poor.xml       | 26 ++++++++++++
 res/values/strings.xml                        | 10 ++++-
 res/xml/trust_preferences.xml                 |  4 ++
 .../lineageparts/trust/TrustPreferences.java  | 40 ++++++++++++++++++-
 6 files changed, 130 insertions(+), 2 deletions(-)
 create mode 100644 res/drawable/ic_trust_platform_bad.xml
 create mode 100644 res/drawable/ic_trust_platform_good.xml
 create mode 100644 res/drawable/ic_trust_platform_poor.xml

diff --git a/res/drawable/ic_trust_platform_bad.xml b/res/drawable/ic_trust_platform_bad.xml
new file mode 100644
index 0000000..719d711
--- /dev/null
+++ b/res/drawable/ic_trust_platform_bad.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2015 The Android Open Source Project
+     Copyright (C) 2018 The LineageOS Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+        android:width="24dp"
+        android:height="24dp"
+        android:viewportWidth="24"
+        android:viewportHeight="24">
+    <path
+        android:fillColor="@color/trust_status_bad"
+        android:pathData="M22,9L22,7h-2L20,5c0,-1.1 -0.9,-2 -2,-2L4,3c-1.1,0 -2,0.9 -2,2v14c0,1.1 0.9,2 2,2h14c1.1,0 2,-0.9 2,-2v-2h2v-2h-2v-2h2v-2h-2L20,9h2zM18,19L4,19L4,5h14v14zM6,13h5v4L6,17zM12,7h4v3h-4zM6,7h5v5L6,12zM12,11h4v6h-4z"/>
+</vector>
diff --git a/res/drawable/ic_trust_platform_good.xml b/res/drawable/ic_trust_platform_good.xml
new file mode 100644
index 0000000..d691ac0
--- /dev/null
+++ b/res/drawable/ic_trust_platform_good.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2015 The Android Open Source Project
+     Copyright (C) 2018 The LineageOS Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+        android:width="24dp"
+        android:height="24dp"
+        android:viewportWidth="24"
+        android:viewportHeight="24">
+    <path
+        android:fillColor="@color/trust_status_good"
+        android:pathData="M22,9L22,7h-2L20,5c0,-1.1 -0.9,-2 -2,-2L4,3c-1.1,0 -2,0.9 -2,2v14c0,1.1 0.9,2 2,2h14c1.1,0 2,-0.9 2,-2v-2h2v-2h-2v-2h2v-2h-2L20,9h2zM18,19L4,19L4,5h14v14zM6,13h5v4L6,17zM12,7h4v3h-4zM6,7h5v5L6,12zM12,11h4v6h-4z"/>
+</vector>
diff --git a/res/drawable/ic_trust_platform_poor.xml b/res/drawable/ic_trust_platform_poor.xml
new file mode 100644
index 0000000..652fd2b
--- /dev/null
+++ b/res/drawable/ic_trust_platform_poor.xml
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+     Copyright (C) 2015 The Android Open Source Project
+     Copyright (C) 2018 The LineageOS Project
+
+     Licensed under the Apache License, Version 2.0 (the "License");
+     you may not use this file except in compliance with the License.
+     You may obtain a copy of the License at
+
+          http://www.apache.org/licenses/LICENSE-2.0
+
+     Unless required by applicable law or agreed to in writing, software
+     distributed under the License is distributed on an "AS IS" BASIS,
+     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+     See the License for the specific language governing permissions and
+     limitations under the License.
+-->
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+        android:width="24dp"
+        android:height="24dp"
+        android:viewportWidth="24"
+        android:viewportHeight="24">
+    <path
+        android:fillColor="@color/trust_status_poor"
+        android:pathData="M22,9L22,7h-2L20,5c0,-1.1 -0.9,-2 -2,-2L4,3c-1.1,0 -2,0.9 -2,2v14c0,1.1 0.9,2 2,2h14c1.1,0 2,-0.9 2,-2v-2h2v-2h-2v-2h2v-2h-2L20,9h2zM18,19L4,19L4,5h14v14zM6,13h5v4L6,17zM12,7h4v3h-4zM6,7h5v5L6,12zM12,11h4v6h-4z"/>
+</vector>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 613678b..c711000 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -718,9 +718,17 @@
     <string name="trust_feature_security_patches_explain">Security patches are released monthly by Google and SoC vendors to address flaws in the system which could be exploited by malicious apps to bypass security restrictions and can cause temporary or permanent damage to your device.\nWhile platform patches are updated globally every month, vendor patches are updated from the OEM from time to time.\nTo keep your device safe make sure your LineageOS build is always up-to-date.</string>
     <string name="trust_feature_encryption">Encryption</string>
     <string name="trust_feature_encryption_value_enabled">Enabled</string>
-    <string name="trust_feature_encryption_value_nolock">Needs a secure lock screen</string>
+    <string name="trust_feature_encryption_value_nolock">Needs a secure "lock screen</string>
     <string name="trust_feature_encryption_value_disabled">Disabled</string>
     <string name="trust_feature_encryption_explain">Encrypting your device prevents access to your data when your phone is off or in recovery mode. This is particularly important if your phone is stolen, and prevents people from reading your messages, contacts, and other private information without the password.\nTo make the encryption more effective you need to set a secure lock screen.</string>
+    <string name="trust_feature_platform">LineageOS platform</string>
+    <string name="trust_feature_platform_base">Debugging features: %1$s\nYour build was signed with %2$s keys</string>
+    <string name="trust_feature_platform_insecure">insecure features are enabled</string>
+    <string name="trust_feature_platform_debuggable">enabled</string>
+    <string name="trust_feature_platform_secure">disabled</string>
+    <string name="trust_feature_platform_keys_public">public</string>
+    <string name="trust_feature_platform_keys_private">private</string>
+    <string name="trust_feature_platform_explain">Developers can enable debugging features for tracing bugs. These features weaken the system security and should therefore be disabled in releases. Moreover, your build should be signed with private keys. Using public keys is a security hole because everybody can use them. This allows attackers to replace system apps and access their data.</string>
     <string name="trust_category_tools">Privacy</string>
     <string name="trust_notification_alerts_title">Security alerts</string>
     <string name="trust_notifications_alerts_summary">Display notifications when a security issue is found</string>
diff --git a/res/xml/trust_preferences.xml b/res/xml/trust_preferences.xml
index cf65f6e..4022147 100644
--- a/res/xml/trust_preferences.xml
+++ b/res/xml/trust_preferences.xml
@@ -37,6 +37,10 @@
         <Preference
             android:key="trust_encryption"
             android:title="@string/trust_feature_encryption" />
+
+        <Preference
+            android:key="trust_platform"
+            android:title="@string/trust_feature_platform" />
     </PreferenceCategory>
 
     <PreferenceCategory
diff --git a/src/org/lineageos/lineageparts/trust/TrustPreferences.java b/src/org/lineageos/lineageparts/trust/TrustPreferences.java
index aba31f1..63f50f0 100644
--- a/src/org/lineageos/lineageparts/trust/TrustPreferences.java
+++ b/src/org/lineageos/lineageparts/trust/TrustPreferences.java
@@ -37,6 +37,7 @@ public class TrustPreferences extends SettingsPreferenceFragment {
     private Preference mRootPref;
     private Preference mSecurityPatchesPref;
     private Preference mEncryptionPref;
+    private Preference mPlatformPref;
     private PreferenceCategory mToolsCategory;
     private ListPreference mSmsLimitPref;
 
@@ -56,6 +57,7 @@ public class TrustPreferences extends SettingsPreferenceFragment {
         mRootPref = findPreference("trust_root");
         mSecurityPatchesPref = findPreference("trust_security_patch");
         mEncryptionPref = findPreference("trust_encryption");
+        mPlatformPref = findPreference("trust_platform");
         mToolsCategory = (PreferenceCategory) findPreference("trust_category_tools");
         mSmsLimitPref = (ListPreference) mToolsCategory.findPreference("sms_security_check_limit");
 
@@ -67,6 +69,8 @@ public class TrustPreferences extends SettingsPreferenceFragment {
                 showInfo(R.string.trust_feature_security_patches_explain));
         mEncryptionPref.setOnPreferenceClickListener(p ->
                 showInfo(R.string.trust_feature_encryption_explain));
+        mPlatformPref.setOnPreferenceClickListener(p ->
+                showInfo(R.string.trust_feature_platform_explain));
         mSmsLimitPref.setOnPreferenceChangeListener((p, v) ->
                 onSmsLimitChanged(Integer.parseInt((String) v)));
 
@@ -81,11 +85,14 @@ public class TrustPreferences extends SettingsPreferenceFragment {
         int secVLevel =
                 mInterface.getLevelForFeature(TrustInterface.TRUST_FEATURE_VENDOR_SECURITY_PATCH);
         int encryptLevel = mInterface.getLevelForFeature(TrustInterface.TRUST_FEATURE_ENCRYPTION);
+        int debugging = mInterface.getLevelForFeature(TrustInterface.TRUST_FEATURE_DEBUGGING);
+        int keys = mInterface.getLevelForFeature(TrustInterface.TRUST_FEATURE_KEYS);
 
         setupSELinux(seLinuxLevel);
         setupRoot(rootLevel);
         setupSecurityPatches(secPLevel, secVLevel);
         setupEncryption(encryptLevel);
+        setupPlatform(debugging, keys);
 
         if (!isTelephony()) {
             mToolsCategory.removePreference(mSmsLimitPref);
@@ -182,6 +189,37 @@ public class TrustPreferences extends SettingsPreferenceFragment {
         mEncryptionPref.setSummary(getContext().getString(summary));
     }
 
+    private void setupPlatform(int debugging, int keys) {
+        int icon;
+        int summaryD, summaryK;
+
+        switch (debugging) {
+            case TrustInterface.TRUST_FEATURE_LEVEL_GOOD:
+                icon = R.drawable.ic_trust_platform_good;
+                summaryD = R.string.trust_feature_platform_secure;
+                break;
+            case TrustInterface.TRUST_FEATURE_LEVEL_POOR:
+                icon = R.drawable.ic_trust_platform_poor;
+                summaryD = R.string.trust_feature_platform_debuggable;
+                break;
+            default:
+                icon = R.drawable.ic_trust_platform_bad;
+                summaryD = R.string.trust_feature_platform_insecure;
+        }
+
+        if (keys == TrustInterface.TRUST_FEATURE_LEVEL_BAD) {
+            icon = R.drawable.ic_trust_platform_bad;
+            summaryK = R.string.trust_feature_platform_keys_public;
+        } else {
+            summaryK = R.string.trust_feature_platform_keys_private;
+        }
+
+        Context context = getContext();
+        mPlatformPref.setIcon(icon);
+        mPlatformPref.setSummary(context.getString(R.string.trust_feature_platform_base,
+                context.getString(summaryD), context.getString(summaryK)));
+    }
+    
     private boolean showInfo(int text) {
         new AlertDialog.Builder(getContext())
             .setMessage(text)
@@ -207,4 +245,4 @@ public class TrustPreferences extends SettingsPreferenceFragment {
         PackageManager pm = getContext().getPackageManager();
         return pm.hasSystemFeature(PackageManager.FEATURE_TELEPHONY);
     }
-}
\ No newline at end of file
+}
-- 
2.17.1

