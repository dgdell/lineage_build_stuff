From b8c24dff0da54962ab6177ef5bc258d8c277f5eb Mon Sep 17 00:00:00 2001
From: Rashed Abdel-Tawab <rashed@linux.com>
Date: Mon, 14 May 2018 14:35:32 -0700
Subject: [PATCH 4/5] LineageParts: Add Reader mode frontend

Change-Id: I36e473ccd30be6799a1cff797d6b7dd63fbb2db5
---
 res/values/strings.xml                           |  2 ++
 res/xml/livedisplay.xml                          |  7 +++++++
 .../livedisplay/LiveDisplaySettings.java         | 16 +++++++++++++++-
 3 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/res/values/strings.xml b/res/values/strings.xml
index a2cc958..586ee51 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -160,6 +160,8 @@
     <string name="live_display_color_profile_srgb_summary">Colors accurate to the sRGB color space</string>
     <string name="live_display_color_profile_dci_p3_title">DCI-P3</string>
     <string name="live_display_color_profile_dci_p3_summary">Colors accurate to the DCI-P3 color space</string>
+    <string name="live_display_reading_mode_title">Reading mode</string>
+    <string name="live_display_reading_mode_summary">Grayscale mode for long-term reading</string>
     <string name="color_calibration_title">Color calibration</string>
     <string name="color_calibration_summary">Calibrate on-screen colors</string>
     <string name="color_red_title">Red</string>
diff --git a/res/xml/livedisplay.xml b/res/xml/livedisplay.xml
index f1d0414..60ea916 100644
--- a/res/xml/livedisplay.xml
+++ b/res/xml/livedisplay.xml
@@ -47,6 +47,13 @@
                 android:summary="@string/live_display_outdoor_mode_summary"
                 android:defaultValue="@*lineageos.platform:bool/config_defaultAutoOutdoorMode" />
 
+        <!-- Reading mode -->
+        <lineageos.preference.LineageSystemSettingSwitchPreference
+                android:key="display_reading_mode"
+                android:title="@string/live_display_reading_mode_title"
+                android:summary="@string/live_display_reading_mode_summary"
+                android:defaultValue="false" />
+
     </PreferenceCategory>
 
     <PreferenceCategory
diff --git a/src/org/lineageos/lineageparts/livedisplay/LiveDisplaySettings.java b/src/org/lineageos/lineageparts/livedisplay/LiveDisplaySettings.java
index a28482b..6e67a3c 100644
--- a/src/org/lineageos/lineageparts/livedisplay/LiveDisplaySettings.java
+++ b/src/org/lineageos/lineageparts/livedisplay/LiveDisplaySettings.java
@@ -1,6 +1,6 @@
 /*
  * Copyright (C) 2015 The CyanogenMod Project
- *               2017 The LineageOS Project
+ *               2017-2018 The LineageOS Project
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -53,6 +53,7 @@ import static lineageos.hardware.LiveDisplayManager.FEATURE_COLOR_ADJUSTMENT;
 import static lineageos.hardware.LiveDisplayManager.FEATURE_COLOR_ENHANCEMENT;
 import static lineageos.hardware.LiveDisplayManager.FEATURE_DISPLAY_MODES;
 import static lineageos.hardware.LiveDisplayManager.FEATURE_PICTURE_ADJUSTMENT;
+import static lineageos.hardware.LiveDisplayManager.FEATURE_READING_ENHANCEMENT;
 import static lineageos.hardware.LiveDisplayManager.MODE_OFF;
 import static lineageos.hardware.LiveDisplayManager.MODE_OUTDOOR;
 
@@ -67,6 +68,7 @@ public class LiveDisplaySettings extends SettingsPreferenceFragment implements S
     private static final String KEY_LIVE_DISPLAY = "live_display";
     private static final String KEY_LIVE_DISPLAY_AUTO_OUTDOOR_MODE =
             "display_auto_outdoor_mode";
+    private static final String KEY_LIVE_DISPLAY_READING_ENHANCEMENT = "display_reading_mode";
     private static final String KEY_LIVE_DISPLAY_LOW_POWER = "display_low_power";
     private static final String KEY_LIVE_DISPLAY_COLOR_ENHANCE = "display_color_enhance";
     private static final String KEY_LIVE_DISPLAY_TEMPERATURE = "live_display_color_temperature";
@@ -94,6 +96,7 @@ public class LiveDisplaySettings extends SettingsPreferenceFragment implements S
     private SwitchPreference mColorEnhancement;
     private SwitchPreference mLowPower;
     private SwitchPreference mOutdoorMode;
+    private SwitchPreference mReadingMode;
 
     private PictureAdjustment mPictureAdjustment;
     private DisplayTemperature mDisplayTemperature;
@@ -184,6 +187,15 @@ public class LiveDisplaySettings extends SettingsPreferenceFragment implements S
             mOutdoorMode = null;
         }
 
+        mReadingMode = (SwitchPreference) findPreference(KEY_LIVE_DISPLAY_READING_ENHANCEMENT);
+        if (liveDisplayPrefs != null && mReadingMode != null
+                && !mHardware.isSupported(LineageHardwareManager.FEATURE_READING_ENHANCEMENT)) {
+            liveDisplayPrefs.removePreference(mReadingMode);
+            mReadingMode = null;
+        } else {
+            mReadingMode.setOnPreferenceChangeListener(this);
+        }
+
         mLowPower = (SwitchPreference) findPreference(KEY_LIVE_DISPLAY_LOW_POWER);
         if (advancedPrefs != null && mLowPower != null
                 && !mConfig.hasFeature(FEATURE_CABC)) {
@@ -334,6 +346,8 @@ public class LiveDisplaySettings extends SettingsPreferenceFragment implements S
                     break;
                 }
             }
+        } else if (preference == mReadingMode) {
+            mHardware.setGrayscale((Boolean) objValue);
         }
         return true;
     }
-- 
2.17.0

