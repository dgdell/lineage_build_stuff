From 179e48a4730acc852ac8caa37a6a872d85893566 Mon Sep 17 00:00:00 2001
From: Roman Birg <roman@cyngn.com>
Date: Sun, 27 May 2018 12:41:52 +0200
Subject: [PATCH 2/4] parts: add SMS rate limit setting

Change-Id: Ie8fea98e9e24b0f6302eaed22af9241f85ca965a
Signed-off-by: Joey <joey@lineageos.org>
---
 res/values/arrays.xml                         | 17 +++++++++++++
 res/values/strings.xml                        |  3 +++
 res/xml/trust_preferences.xml                 | 12 +++++++++-
 .../lineageparts/trust/TrustPreferences.java  | 24 +++++++++++++++++++
 4 files changed, 55 insertions(+), 1 deletion(-)

diff --git a/res/values/arrays.xml b/res/values/arrays.xml
index a86234b..dad0c41 100644
--- a/res/values/arrays.xml
+++ b/res/values/arrays.xml
@@ -418,4 +418,21 @@
         <item>2</item> <!-- Force light -->
         <item>3</item> <!-- Force dark -->
     </string-array>
+
+    <!-- Sms limit -->
+    <string-array name="sms_security_check_limit_entries" translatable="false">
+        <item>5</item>
+        <item>10</item>
+        <item>30</item>
+        <item>50</item>
+        <item>100</item>
+    </string-array>
+
+    <string-array name="sms_security_check_limit_values" translatable="false">
+        <item>5</item>
+        <item>10</item>
+        <item>30</item>
+        <item>50</item>
+        <item>100</item>
+    </string-array>
 </resources>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 586ee51..3070c83 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -722,4 +722,7 @@
     <string name="trust_onboarding_learn_more">Learn more</string>
     <string name="trust_onboarding_done">Got it</string>
 
+    <!-- Sms limit -->
+    <string name="sms_security_check_limit_title">SMS message limit</string>
+    <string name="sms_security_check_limit_summary">Display an alert when more than %s SMS messages are being sent in 15 minutes</string>
 </resources>
diff --git a/res/xml/trust_preferences.xml b/res/xml/trust_preferences.xml
index 2e4e0a6..2afae69 100644
--- a/res/xml/trust_preferences.xml
+++ b/res/xml/trust_preferences.xml
@@ -39,12 +39,22 @@
             android:title="@string/trust_feature_encryption" />
     </PreferenceCategory>
 
-    <PreferenceCategory android:title="@string/trust_category_tools">
+    <PreferenceCategory
+        android:key="trust_category_tools"
+        android:title="@string/trust_category_tools">
 
         <org.lineageos.internal.lineageparts.LineagePartsPreference
             android:key="privacy_guard_manager" />
 
         <org.lineageos.internal.lineageparts.LineagePartsPreference
             android:key="lineagestats" />
+
+        <ListPreference
+            android:key="sms_security_check_limit"
+            android:defaultValue="30"
+            android:entries="@array/sms_security_check_limit_entries"
+            android:entryValues="@array/sms_security_check_limit_values"
+            android:summary="@string/sms_security_check_limit_summary"
+            android:title="@string/sms_security_check_limit_title" />
     </PreferenceCategory>
 </PreferenceScreen>
diff --git a/src/org/lineageos/lineageparts/trust/TrustPreferences.java b/src/org/lineageos/lineageparts/trust/TrustPreferences.java
index cb30772..5fe79d7 100644
--- a/src/org/lineageos/lineageparts/trust/TrustPreferences.java
+++ b/src/org/lineageos/lineageparts/trust/TrustPreferences.java
@@ -17,8 +17,12 @@ package org.lineageos.lineageparts.trust;
 
 import android.app.AlertDialog;
 import android.content.Context;
+import android.content.pm.PackageManager;
 import android.os.Bundle;
+import android.provider.Settings;
+import android.support.v7.preference.ListPreference;
 import android.support.v7.preference.Preference;
+import android.support.v7.preference.PreferenceCategory;
 import android.util.Log;
 
 import org.lineageos.lineageparts.R;
@@ -33,6 +37,8 @@ public class TrustPreferences extends SettingsPreferenceFragment {
     private Preference mRootPref;
     private Preference mSecurityPatchesPref;
     private Preference mEncryptionPref;
+    private PreferenceCategory mToolsCategory;
+    private ListPreference mSmsLimitPref;
 
     private TrustInterface mInterface;
 
@@ -59,6 +65,9 @@ public class TrustPreferences extends SettingsPreferenceFragment {
                 showInfo(R.string.trust_feature_security_patches_explain));
         mEncryptionPref.setOnPreferenceClickListener(p ->
                 showInfo(R.string.trust_feature_encryption_explain));
+        mSmsLimitPref.setOnPreferenceChangeListener((p, v) ->
+                onSmsLimitChanged(Integer.parseInt((String) v)));
+
         setup();
     }
 
@@ -75,6 +84,10 @@ public class TrustPreferences extends SettingsPreferenceFragment {
         setupRoot(rootLevel);
         setupSecurityPatches(secPLevel, secVLevel);
         setupEncryption(encryptLevel);
+
+        if (!isTelephony()) {
+            mToolsCategory.removePreference(mSmsLimitPref);
+        }
     }
 
     private void setupSELinux(int level) {
@@ -172,4 +185,15 @@ public class TrustPreferences extends SettingsPreferenceFragment {
             .show();
         return true;
     }
+
+    private boolean onSmsLimitChanged(Integer value) {
+        Settings.Global.putInt(getContext().getContentResolver(),
+                Settings.Global.SMS_OUTGOING_CHECK_MAX_COUNT, value);
+        return true;
+    }
+
+    private boolean isTelephony() {
+        PackageManager pm = getContext().getPackageManager();
+        return pm.hasSystemFeature(PackageManager.FEATURE_TELEPHONY);
+    }
 }
\ No newline at end of file
-- 
2.17.0

