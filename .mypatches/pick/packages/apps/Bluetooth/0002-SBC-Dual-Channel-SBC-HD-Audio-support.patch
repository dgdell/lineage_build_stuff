From d8a2c10fa0cc782c1c3a09e237cd2f62023f6dea Mon Sep 17 00:00:00 2001
From: ValdikSS <iam@valdikss.org.ru>
Date: Mon, 10 Sep 2018 02:02:50 +0300
Subject: [PATCH 2/2] SBC Dual Channel (SBC HD Audio) support

"HD Audio" checkbox is not checked for SBC by default.

Change-Id: Id45c48aeaa2eb86f3dffa0cc825d1e09f1c00187
---
 src/com/android/bluetooth/a2dp/A2dpService.java      | 6 +++++-
 src/com/android/bluetooth/a2dp/A2dpStateMachine.java | 8 ++++++++
 2 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/com/android/bluetooth/a2dp/A2dpService.java b/src/com/android/bluetooth/a2dp/A2dpService.java
index bdab866f..e7fb8e60 100755
--- a/src/com/android/bluetooth/a2dp/A2dpService.java
+++ b/src/com/android/bluetooth/a2dp/A2dpService.java
@@ -68,7 +68,11 @@ public class A2dpService extends ProfileService {
             boolean supportsOptional = false;
             for (BluetoothCodecConfig config :
                     mStateMachine.getCodecStatus().getCodecsSelectableCapabilities()) {
-                if (!config.isMandatoryCodec()) {
+                if (!(config.isMandatoryCodec())
+                        || (config.isMandatoryCodec()
+                                   && (config.getChannelMode() & config.CHANNEL_MODE_DUAL_CHANNEL)
+                                           == config.CHANNEL_MODE_DUAL_CHANNEL)) {
+                    /* SBC Dual Channel capability */
                     supportsOptional = true;
                     break;
                 }
diff --git a/src/com/android/bluetooth/a2dp/A2dpStateMachine.java b/src/com/android/bluetooth/a2dp/A2dpStateMachine.java
index 82ed7e0b..c7e4fb26 100755
--- a/src/com/android/bluetooth/a2dp/A2dpStateMachine.java
+++ b/src/com/android/bluetooth/a2dp/A2dpStateMachine.java
@@ -843,6 +843,14 @@ final class A2dpStateMachine extends StateMachine {
             BluetoothCodecConfig codecConfig = codecConfigArray[i];
             if (!codecConfig.isMandatoryCodec()) {
                 codecConfigArray[i] = null;
+            } else {
+                /* Rebuild SBC selectable codec with Dual Channel (SBC HD audio) */
+                codecConfigArray[i] = new BluetoothCodecConfig(
+                        BluetoothCodecConfig.SOURCE_CODEC_TYPE_SBC, mA2dpSourceCodecPrioritySbc,
+                        BluetoothCodecConfig.SAMPLE_RATE_NONE,
+                        BluetoothCodecConfig.BITS_PER_SAMPLE_NONE,
+                        BluetoothCodecConfig.CHANNEL_MODE_DUAL_CHANNEL, 0 /* codecSpecific1 */,
+                        0 /* codecSpecific2 */, 0 /* codecSpecific3 */, 0 /* codecSpecific4 */);
             }
         }
 
-- 
2.17.1

