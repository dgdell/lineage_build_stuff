From 3bef9056f5bce20d5634ff7156c1f447af4b17c8 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Thu, 24 May 2018 20:00:16 +0200
Subject: [PATCH] Jelly: Add support for multiple windows

Change-Id: Ic1d2b395fd4343c442243f1008f72b363270206d
---
 .../java/org/lineageos/jelly/MainActivity.java  |  2 +-
 .../lineageos/jelly/webview/ChromeClient.java   | 17 +++++++++++++++++
 .../org/lineageos/jelly/webview/WebViewExt.java |  1 +
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/app/src/main/java/org/lineageos/jelly/MainActivity.java b/app/src/main/java/org/lineageos/jelly/MainActivity.java
index 71990dd..6dee049 100644
--- a/app/src/main/java/org/lineageos/jelly/MainActivity.java
+++ b/app/src/main/java/org/lineageos/jelly/MainActivity.java
@@ -98,8 +98,8 @@ public class MainActivity extends WebViewExtActivity implements
          SearchBarController.OnCancelListener {
     private static final String TAG = MainActivity.class.getSimpleName();
     private static final String PROVIDER = "org.lineageos.jelly.fileprovider";
-    private static final String EXTRA_INCOGNITO = "extra_incognito";
     private static final String EXTRA_DESKTOP_MODE = "extra_desktop_mode";
+    public static final String EXTRA_INCOGNITO = "extra_incognito";
     public static final String EXTRA_URL = "extra_url";
     public static final String EXTRA_UI_MODE = "extra_ui_mode";
     public static final String EVENT_CHANGE_UI_MODE = "intent_change_ui_mode";
diff --git a/app/src/main/java/org/lineageos/jelly/webview/ChromeClient.java b/app/src/main/java/org/lineageos/jelly/webview/ChromeClient.java
index acf91be..3c59294 100644
--- a/app/src/main/java/org/lineageos/jelly/webview/ChromeClient.java
+++ b/app/src/main/java/org/lineageos/jelly/webview/ChromeClient.java
@@ -18,6 +18,7 @@ package org.lineageos.jelly.webview;
 import android.content.ActivityNotFoundException;
 import android.content.Intent;
 import android.graphics.Bitmap;
+import android.os.Message;
 import android.net.Uri;
 import android.view.View;
 import android.webkit.GeolocationPermissions;
@@ -27,6 +28,7 @@ import android.webkit.WebView;
 import android.widget.ProgressBar;
 import android.widget.Toast;
 
+import org.lineageos.jelly.MainActivity;
 import org.lineageos.jelly.R;
 import org.lineageos.jelly.history.HistoryProvider;
 import org.lineageos.jelly.ui.UrlBarController;
@@ -106,4 +108,19 @@ class ChromeClient extends WebChromeClientCompat {
     public void onHideCustomView() {
         mActivity.onHideCustomView();
     }
+
+    @Override
+    public boolean onCreateWindow(WebView view, boolean isDialog,
+                                  boolean isUserGesture, Message resultMsg) {
+        WebView.HitTestResult result = view.getHitTestResult();
+        String data = result.getExtra();
+        Intent intent = new Intent(mActivity, MainActivity.class);
+        if (data != null && !data.isEmpty()) {
+            intent.setData(Uri.parse(data));
+        }
+        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_DOCUMENT | Intent.FLAG_ACTIVITY_MULTIPLE_TASK);
+        intent.putExtra(MainActivity.EXTRA_INCOGNITO, mIncognito);
+        mActivity.startActivity(intent);
+        return true;
+    }
 }
diff --git a/app/src/main/java/org/lineageos/jelly/webview/WebViewExt.java b/app/src/main/java/org/lineageos/jelly/webview/WebViewExt.java
index 37f8af4..6009234 100644
--- a/app/src/main/java/org/lineageos/jelly/webview/WebViewExt.java
+++ b/app/src/main/java/org/lineageos/jelly/webview/WebViewExt.java
@@ -95,6 +95,7 @@ public class WebViewExt extends WebView {
         getSettings().setJavaScriptEnabled(PrefsUtils.getJavascript(mActivity));
         getSettings().setJavaScriptCanOpenWindowsAutomatically(PrefsUtils.getJavascript(mActivity));
         getSettings().setGeolocationEnabled(PrefsUtils.getLocation(mActivity));
+        getSettings().setSupportMultipleWindows(true);
         getSettings().setBuiltInZoomControls(true);
         getSettings().setDisplayZoomControls(false);
         getSettings().setAppCacheEnabled(!mIncognito);
-- 
2.17.0

