From f6877b515104fbdd064e01377b31217d56fdaf62 Mon Sep 17 00:00:00 2001
From: Florin9doi <florin9doi@gmail.com>
Date: Sat, 15 Sep 2018 23:48:36 +0300
Subject: [PATCH 1/4] Resolve conflicting visibilty on nextAlarmPanel

Main Circle/Rectangle view needs to control visibilty

Change-Id: I27ce74494270c5a74ae7e5b6eb4d9f8e7c4c894b
---
 src/org/lineageos/flipflap/CircleView.java      |  6 ++++--
 src/org/lineageos/flipflap/NextAlarmPanel.java  |  4 +---
 src/org/lineageos/flipflap/RectangularView.java | 11 +++++++----
 3 files changed, 12 insertions(+), 9 deletions(-)

diff --git a/src/org/lineageos/flipflap/CircleView.java b/src/org/lineageos/flipflap/CircleView.java
index 8b09a87..621aa17 100644
--- a/src/org/lineageos/flipflap/CircleView.java
+++ b/src/org/lineageos/flipflap/CircleView.java
@@ -24,6 +24,7 @@ import android.content.Context;
 import android.graphics.Canvas;
 import android.provider.ContactsContract;
 import android.util.Log;
+import android.text.TextUtils;
 import android.view.View;
 import android.widget.ImageButton;
 import android.widget.TextView;
@@ -127,6 +128,7 @@ public class CircleView extends FlipFlapView {
     }
 
     private void updateViewVisibility() {
+        String nextAlarm = mNextAlarmPanel.getNextAlarm();
         mClockPanel.setVisibility(View.VISIBLE);
 
         if (mRinging || mCallActive) {
@@ -145,12 +147,12 @@ public class CircleView extends FlipFlapView {
             }
         } else if (mAlarmActive) {
             mDatePanel.setVisibility(View.VISIBLE);
-            mNextAlarmPanel.setVisibility(View.VISIBLE);
+            mNextAlarmPanel.setVisibility(TextUtils.isEmpty(nextAlarm) ? View.GONE : View.VISIBLE);
             mAlarmPanel.setVisibility(View.VISIBLE);
             mPhonePanel.setVisibility(View.GONE);
         } else {
             mDatePanel.setVisibility(View.VISIBLE);
-            mNextAlarmPanel.setVisibility(View.VISIBLE);
+            mNextAlarmPanel.setVisibility(TextUtils.isEmpty(nextAlarm) ? View.GONE : View.VISIBLE);
             mAlarmPanel.setVisibility(View.GONE);
             mPhonePanel.setVisibility(View.GONE);
         }
diff --git a/src/org/lineageos/flipflap/NextAlarmPanel.java b/src/org/lineageos/flipflap/NextAlarmPanel.java
index 02585d6..065d7b0 100644
--- a/src/org/lineageos/flipflap/NextAlarmPanel.java
+++ b/src/org/lineageos/flipflap/NextAlarmPanel.java
@@ -101,11 +101,9 @@ public class NextAlarmPanel extends LinearLayout {
     private void refreshAlarmStatus() {
         String nextAlarm = getNextAlarm();
         mAlarmText.setText(nextAlarm);
-        setVisibility(TextUtils.isEmpty(nextAlarm)
-                ? View.GONE : View.VISIBLE);
     }
 
-    private String getNextAlarm() {
+    public String getNextAlarm() {
         AlarmManager.AlarmClockInfo nextAlarmClock = mAlarmManager.getNextAlarmClock();
         if (nextAlarmClock != null) {
             String skeleton = DateFormat.is24HourFormat(mContext) ? "EHm" : "Ehma";
diff --git a/src/org/lineageos/flipflap/RectangularView.java b/src/org/lineageos/flipflap/RectangularView.java
index 012d3e2..b68611c 100644
--- a/src/org/lineageos/flipflap/RectangularView.java
+++ b/src/org/lineageos/flipflap/RectangularView.java
@@ -25,6 +25,7 @@ import android.content.res.Resources;
 import android.graphics.Canvas;
 import android.provider.ContactsContract;
 import android.util.Log;
+import android.text.TextUtils;
 import android.view.View;
 import android.widget.ImageButton;
 import android.widget.TextView;
@@ -136,16 +137,17 @@ public class RectangularView extends FlipFlapView {
     }
 
     private void updateViewVisibility() {
+        String nextAlarm = mNextAlarmPanel.getNextAlarm();
+
         if (mRinging || mCallActive) {
             if (mNeedsSmallView) {
                 mClockPanel.setVisibility(View.GONE);
                 mDatePanel.setVisibility(View.GONE);
-                mNextAlarmPanel.setVisibility(View.GONE);
             } else {
                 mClockPanel.setVisibility(View.VISIBLE);
                 mDatePanel.setVisibility(View.VISIBLE);
-                mNextAlarmPanel.setVisibility(View.VISIBLE);
             }
+            mNextAlarmPanel.setVisibility(View.GONE);
             mAlarmPanel.setVisibility(View.GONE);
             mPhonePanel.setVisibility(View.VISIBLE);
             if (mRinging) {
@@ -165,14 +167,15 @@ public class RectangularView extends FlipFlapView {
             } else {
                 mClockPanel.setVisibility(View.VISIBLE);
                 mDatePanel.setVisibility(View.VISIBLE);
-                mNextAlarmPanel.setVisibility(View.VISIBLE);
+                mNextAlarmPanel.setVisibility(TextUtils.isEmpty(nextAlarm)
+                    ? View.GONE : View.VISIBLE);
             }
             mAlarmPanel.setVisibility(View.VISIBLE);
             mPhonePanel.setVisibility(View.GONE);
         } else {
             mClockPanel.setVisibility(View.VISIBLE);
             mDatePanel.setVisibility(View.VISIBLE);
-            mNextAlarmPanel.setVisibility(View.VISIBLE);
+            mNextAlarmPanel.setVisibility(TextUtils.isEmpty(nextAlarm) ? View.GONE : View.VISIBLE);
             mAlarmPanel.setVisibility(View.GONE);
             mPhonePanel.setVisibility(View.GONE);
         }
-- 
2.17.1

