From 2b602b6f94bdf24201ddf8ec5e31c27862f67c9a Mon Sep 17 00:00:00 2001
From: Abhisek Devkota <ciwrl@lineageos.org>
Date: Sat, 3 Feb 2018 14:55:29 -0800
Subject: [PATCH 3/9] SUW: Integrate with GMS flow

Change-Id: Ibb010da847deebec83520b752dacc9e743971878
---
 res/raw/wizard_script.xml                          | 64 +++++++++++-----------
 res/raw/wizard_script_user.xml                     | 52 ++++++------------
 res/values/config.xml                              |  2 +
 .../setupwizard/SetupWizardActivity.java           |  4 --
 4 files changed, 52 insertions(+), 70 deletions(-)

diff --git a/res/raw/wizard_script.xml b/res/raw/wizard_script.xml
index fab2588..61e0516 100644
--- a/res/raw/wizard_script.xml
+++ b/res/raw/wizard_script.xml
@@ -25,59 +25,59 @@
     adb shell am to-intent-uri -a com.android.setupwizard.WELCOME -f 0x10000000 \-\-ez firstRun true
 -->
 
-<WizardScript wizard:firstAction="welcome"
-              xmlns:wizard="http://schemas.android.com/apk/res/com.google.android.setupwizard">
-    <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.LINEAGE_WELCOME;end" id="welcome">
-        <result wizard:action="locale" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.LINEAGE_LOCALE;end" id="locale">
-        <result wizard:action="sim_missing" />
-    </WizardAction>
-    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_qr_provision_flow" id="qr_provision_flow">
+<WizardScript wizard:version="2"
+  xmlns:wizard="http://schemas.android.com/apk/res/com.google.android.setupwizard">
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.OEM_PRE_SETUP;end" id="oem_pre_setup" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.WELCOME;end" id="welcome">
+        <result wizard:resultCode="101" wizard:action="check_user_unlock_qr" wizard:name="start_qr_provision" />
+        <result wizard:resultCode="111" wizard:action="check_user_unlock_dpm_user_complete" wizard:name="dpm_user_complete" />
+        <result wizard:action="check_user_unlock" />
+    </WizardAction>
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CHECK_USER_UNLOCK;end" id="check_user_unlock_qr">
+        <result wizard:action="qr_provision_flow" />
+    </WizardAction>
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CHECK_USER_UNLOCK;end" id="check_user_unlock_dpm_user_complete">
         <result wizard:action="oem_post_setup" />
     </WizardAction>
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CHECK_USER_UNLOCK;end" id="check_user_unlock" />
     <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.SIM_MISSING;end" id="sim_missing">
+        <result wizard:resultCode="101" wizard:action="esim_intro" wizard:name="esim" />
         <result wizard:action="carrier_setup" />
     </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CARRIER_SETUP;end" id="carrier_setup">
-        <result wizard:action="background_activation" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.ESIM_INTRO;end" id="esim_intro" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CARRIER_SETUP;end" id="carrier_setup" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.SIM_SETUP;end" id="sim_setup" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.DEVICE_OWNER_WARNING;end" id="device_owner_warning">
+        <result wizard:resultCode="1" wizard:action="check_frp" wizard:name="skip" />
     </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.BACKGROUND_ACTIVATION;end" id="background_activation">
-        <result wizard:action="sim_setup" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.FACTORY_RESET;end" id="factory_reset" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.CHECK_FRP;end" id="check_frp" />
+    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_connect_and_update_flow" id="connect_and_update">
+        <result wizard:resultCode="1" wizard:action="no_network_flow" wizard:name="no_connection" />
     </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.SIM_SETUP;end" id="sim_setup">
-        <result wizard:action="flow_choice" />
+    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_zero_touch_flow" id="zero_touch">
+        <result wizard:resultCode="111" wizard:action="oem_post_setup" wizard:name="dpm_user_complete" />
     </WizardAction>
     <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.FLOW_CHOICE;end" id="flow_choice">
-        <result wizard:resultCode="-1" wizard:action="restore_choice" wizard:name="ok" />
         <result wizard:resultCode="1" wizard:action="setup_as_new_flow" wizard:name="skip" />
-        <result wizard:action="restore_with_account_flow" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.RESTORE_CHOICE;end" id="restore_choice">
-        <result wizard:resultCode="101" wizard:action="restore_with_device_flow" wizard:name="d2d" />
-        <result wizard:resultCode="102" wizard:action="restore_with_ios_flow" wizard:name="ios_restore" />
-        <result wizard:action="restore_with_account_flow" />
-    </WizardAction>
-    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_restore_with_account_flow" id="restore_with_account_flow">
-        <result wizard:action="oem_post_setup" />
+        <result wizard:resultCode="101" wizard:action="exit" wizard:name="demo_mode_flow" />
     </WizardAction>
-    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_restore_with_device_flow" id="restore_with_device_flow">
+    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_restore_flow" id="restore_flow">
         <result wizard:action="oem_post_setup" />
     </WizardAction>
-    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_restore_with_ios_flow" id="restore_with_ios_flow">
+    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_setup_as_new_flow" id="setup_as_new_flow">
         <result wizard:action="oem_post_setup" />
     </WizardAction>
-    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_setup_as_new_flow" id="setup_as_new_flow">
+    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_no_network_flow" id="no_network_flow">
         <result wizard:action="oem_post_setup" />
     </WizardAction>
+    <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_qr_provision_flow" id="qr_provision_flow" />
     <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.LINEAGE_SETTINGS;end" id="oem_post_setup">
         <result wizard:action="finish" />
     </WizardAction>
     <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.LINEAGE_SETUP_COMPLETE;end" id="finish">
         <result wizard:action="exit" />
     </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.EXIT;end" id="exit">
-        <result wizard:action="cm_exit" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.EXIT;end" id="cm_exit" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.KID_POST_SETUP;end" id="kid_post_setup" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.EXIT;end" id="exit" />
 </WizardScript>
diff --git a/res/raw/wizard_script_user.xml b/res/raw/wizard_script_user.xml
index 0844e2d..149c500 100644
--- a/res/raw/wizard_script_user.xml
+++ b/res/raw/wizard_script_user.xml
@@ -23,50 +23,37 @@
 
     adb shell am to-intent-uri -a com.android.setupwizard.WELCOME -f 0x10000000 \-\-ez firstRun true
 -->
-<WizardScript wizard:firstAction="oem_pre_setup"
-              xmlns:wizard="http://schemas.android.com/apk/res/com.google.android.setupwizard">
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.OEM_PRE_SETUP;end" id="oem_pre_setup">
-        <result wizard:action="welcome" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.LINEAGE_WELCOME;end" id="welcome">
-        <result wizard:action="secondary_user_warning" />
-    </WizardAction>
+<WizardScript wizard:version="2"
+  xmlns:wizard="http://schemas.android.com/apk/res/com.google.android.setupwizard">
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.OEM_PRE_SETUP;end" id="oem_pre_setup" />
     <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.USER_WARNING;end" id="secondary_user_warning">
-        <result wizard:resultCode="111" wizard:action="oem_post_setup" wizard:name="dpm_user_complete" />
-        <result wizard:action="network_settings" />
+        <result wizard:resultCode="111" wizard:action="check_user_unlock_dpm_user_complete" wizard:name="dpm_user_complete" />
+        <result wizard:action="check_user_unlock" />
     </WizardAction>
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CHECK_USER_UNLOCK;end" id="check_user_unlock_dpm_user_complete">
+        <result wizard:action="oem_post_setup" />
+    </WizardAction>
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CHECK_USER_UNLOCK;end" id="check_user_unlock" />
     <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.NETWORK_SETTINGS;end" id="network_settings">
-        <result wizard:resultCode="101" wizard:action="wifi_settings" wizard:name="see_all_wifi" />
+        <result wizard:resultCode="102" wizard:action="wifi_settings" wizard:name="see_all_wifi" />
         <result wizard:resultCode="1" wizard:action="no_account_flow" wizard:name="skip" />
         <result wizard:action="captive_portal" />
     </WizardAction>
     <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.WIFI_SETTINGS;end" id="wifi_settings">
-        <result wizard:action="captive_portal" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CAPTIVE_PORTAL;end" id="captive_portal">
-        <result wizard:action="gms_checkin" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_CHECKIN;end" id="gms_checkin">
-        <result wizard:action="load_account_intent" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.LOAD_ADD_ACCOUNT_INTENT;end" id="load_account_intent">
-        <result wizard:action="account_setup" />
+        <result wizard:resultCode="1" wizard:action="no_account_flow" wizard:name="skip" />
     </WizardAction>
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.CAPTIVE_PORTAL;end" id="captive_portal" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_CHECKIN;end" id="gms_checkin" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.LOAD_ADD_ACCOUNT_INTENT;end" id="load_account_intent" />
     <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ACCOUNT_SETUP;end" id="account_setup">
         <result wizard:resultCode="1" wizard:action="no_account_flow" wizard:name="skip" />
         <result wizard:resultCode="111" wizard:action="oem_post_setup" wizard:name="dpm_user_complete" />
-        <result wizard:action="gms_account_checkin" />
     </WizardAction>
     <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.GMS_ACCOUNT_CHECKIN;end" id="gms_account_checkin">
         <result wizard:resultCode="1" wizard:action="mfm_check" wizard:name="skip" />
-        <result wizard:action="start_vpa" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.START_VPA;end" id="start_vpa">
-        <result wizard:action="mfm_check" />
     </WizardAction>
     <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.ACCOUNT_CHECK;end" id="mfm_check">
         <result wizard:resultCode="1" wizard:action="no_account_flow" wizard:name="skip" />
-        <result wizard:action="account_flow" />
     </WizardAction>
     <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_user_account_flow" id="account_flow">
         <result wizard:action="oem_post_setup" />
@@ -74,11 +61,8 @@
     <WizardAction wizard:script="android.resource://com.google.android.setupwizard/xml/wizard_script_user_no_account_flow" id="no_account_flow">
         <result wizard:action="oem_post_setup" />
     </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.LINEAGE_SETUP_COMPLETE;end" id="oem_post_setup">
-        <result wizard:action="exit" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.EXIT;end" id="exit">
-        <result wizard:action="cm_exit" />
-    </WizardAction>
-    <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.EXIT;end" id="cm_exit" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.cyanogenmod.setupwizard.LINEAGE_SETUP_COMPLETE;end" id="oem_post_setup" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.google.android.setupwizard.KID_POST_SETUP;end" id="kid_post_setup" />
+    <WizardAction wizard:uri="intent:#Intent;action=com.android.setupwizard.EXIT;end" id="exit" />
+    <WizardAction id="END_OF_SCRIPT" />
 </WizardScript>
diff --git a/res/values/config.xml b/res/values/config.xml
index e2e8c8f..a6d861b 100644
--- a/res/values/config.xml
+++ b/res/values/config.xml
@@ -21,4 +21,6 @@
          0=default sim image, 1=sim on side, 2=sim on back-->
     <integer name="sim_image_type">0</integer>
     <bool name="check_custom_theme_by_default">true</bool>
+    <string name="wizard_script_uri" translatable="false">android.resource://com.cyanogenmod.setupwizard/raw/wizard_script</string>
+
 </resources>
diff --git a/src/com/cyanogenmod/setupwizard/SetupWizardActivity.java b/src/com/cyanogenmod/setupwizard/SetupWizardActivity.java
index c138235..244f666 100644
--- a/src/com/cyanogenmod/setupwizard/SetupWizardActivity.java
+++ b/src/com/cyanogenmod/setupwizard/SetupWizardActivity.java
@@ -44,11 +44,7 @@ public class SetupWizardActivity extends BaseSetupWizardActivity {
             if (LOGV) {
                 Log.v(TAG, "Has GMS disabling local wizard manager");
             }
-            Intent intent = new Intent("android.intent.action.MAIN");
-            intent.addCategory("android.intent.category.HOME");
             SetupWizardUtils.disableComponentsForGMS(this);
-            intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
-            startActivity(intent);
             finish();
         } else {
             onSetupStart();
-- 
2.7.4

