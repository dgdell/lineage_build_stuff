From 0d5a73334579af75e706230566bad428d6a3d280 Mon Sep 17 00:00:00 2001
From: Jorge Ruesga <jorge@ruesga.com>
Date: Sun, 19 Apr 2015 22:41:21 +0200
Subject: [PATCH 07/12] exchange: fix eas autodiscover

Change-Id: If368396d608b0bec63bc794d70d1b4ba9b7b5d8e
Signed-off-by: Jorge Ruesga <jorge@ruesga.com>
---
 src/com/android/exchange/eas/EasAutoDiscover.java | 12 ++++++++++++
 src/com/android/exchange/service/EasService.java  | 11 +++++++++--
 2 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/src/com/android/exchange/eas/EasAutoDiscover.java b/src/com/android/exchange/eas/EasAutoDiscover.java
index b8e95719..e2ebd473 100644
--- a/src/com/android/exchange/eas/EasAutoDiscover.java
+++ b/src/com/android/exchange/eas/EasAutoDiscover.java
@@ -5,6 +5,7 @@ import android.net.Uri;
 import android.os.Bundle;
 import android.util.Xml;
 
+import com.android.emailcommon.mail.MessagingException;
 import com.android.emailcommon.provider.Account;
 import com.android.emailcommon.provider.HostAuth;
 import com.android.emailcommon.service.EmailServiceProxy;
@@ -417,4 +418,15 @@ public class EasAutoDiscover extends EasOperation {
         }
         return null;
     }
+
+    public static int translateToMessagingException(int easDiscoveryResultCode) {
+        switch (easDiscoveryResultCode) {
+        case RESULT_SC_UNAUTHORIZED:
+            return MessagingException.AUTODISCOVER_AUTHENTICATION_FAILED;
+        case RESULT_OK:
+            return MessagingException.AUTODISCOVER_AUTHENTICATION_RESULT;
+        default:
+            return MessagingException.UNSPECIFIED_EXCEPTION;
+        }
+    }
 }
diff --git a/src/com/android/exchange/service/EasService.java b/src/com/android/exchange/service/EasService.java
index aeb49a55..42acd3e3 100644
--- a/src/com/android/exchange/service/EasService.java
+++ b/src/com/android/exchange/service/EasService.java
@@ -206,6 +206,12 @@ public class EasService extends Service {
                 Bundle result = autoDiscoverInternal(uri, attempt, username, password, true);
                 int resultCode = result.getInt(EmailServiceProxy.AUTO_DISCOVER_BUNDLE_ERROR_CODE);
                 if (resultCode != EasAutoDiscover.RESULT_BAD_RESPONSE) {
+                    // To fix autodiscover setup we need to fill the bundle with the appropriate
+                    // MessagingException to code, which can be interpreted by our Email app.
+                    // We leave untouched the original extra so it can be used by Gmail and other
+                    // email clients.
+                    result.putInt(EmailServiceProxy.AUTO_DISCOVER_BUNDLE_MESSAGING_ERROR_CODE,
+                            EasAutoDiscover.translateToMessagingException(resultCode));
                     return result;
                 } else {
                     LogUtils.d(TAG, "got BAD_RESPONSE");
@@ -224,7 +230,8 @@ public class EasService extends Service {
                 // Try again recursively with the new uri. TODO we should limit the number of redirects.
                 final String redirectUri = op.getRedirectUri();
                 return autoDiscoverInternal(redirectUri, attempt, username, password, canRetry);
-            } else if (result == EasAutoDiscover.RESULT_SC_UNAUTHORIZED) {
+            } else if (result == EasAutoDiscover.RESULT_SC_UNAUTHORIZED ||
+                    result == EasAutoDiscover.RESULT_AUTHENTICATION_ERROR) {
                 if (canRetry && username.contains("@")) {
                     // Try again using the bare user name
                     final int atSignIndex = username.indexOf('@');
@@ -237,7 +244,7 @@ public class EasService extends Service {
                     // to begin with. Either way, failure.
                     final Bundle bundle = new Bundle(1);
                     bundle.putInt(EmailServiceProxy.AUTO_DISCOVER_BUNDLE_ERROR_CODE,
-                            EasAutoDiscover.RESULT_OTHER_FAILURE);
+                            EasAutoDiscover.RESULT_SC_UNAUTHORIZED);
                     return bundle;
                 }
             } else if (result != EasAutoDiscover.RESULT_OK) {
-- 
2.17.1

