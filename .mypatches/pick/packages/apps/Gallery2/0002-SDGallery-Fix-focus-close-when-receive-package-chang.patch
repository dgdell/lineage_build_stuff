From e9bfcecc94f869a8002ba89746fcdbb46a7dbd73 Mon Sep 17 00:00:00 2001
From: zhuw <zhuw@codeaurora.org>
Date: Tue, 22 May 2018 18:34:39 +0800
Subject: [PATCH 2/3] SDGallery:Fix focus close when receive package changed
 intent

use startForegroundService instead of startService on O-version

Change-Id: I936b47cee1f3fbccc33cc4ee60960f27242cbfe7
---
 .../gallery3d/app/PackagesMonitor.java        | 25 ++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)
 mode change 100644 => 100755 src/com/android/gallery3d/app/PackagesMonitor.java

diff --git a/src/com/android/gallery3d/app/PackagesMonitor.java b/src/com/android/gallery3d/app/PackagesMonitor.java
old mode 100644
new mode 100755
index 9b2412f1b..7fc0059b5
--- a/src/com/android/gallery3d/app/PackagesMonitor.java
+++ b/src/com/android/gallery3d/app/PackagesMonitor.java
@@ -17,10 +17,14 @@
 package com.android.gallery3d.app;
 
 import android.app.IntentService;
+import android.app.Notification;
+import android.app.NotificationChannel;
+import android.app.NotificationManager;
 import android.content.BroadcastReceiver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.SharedPreferences;
+import android.os.Build;
 import android.preference.PreferenceManager;
 
 import com.android.gallery3d.picasasource.PicasaSource;
@@ -37,7 +41,11 @@ public class PackagesMonitor extends BroadcastReceiver {
     @Override
     public void onReceive(final Context context, final Intent intent) {
         intent.setClass(context, AsyncService.class);
-        context.startService(intent);
+        if(Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
+            context.startForegroundService(intent);
+        } else {
+            context.startService(intent);
+        }
     }
 
     public static class AsyncService extends IntentService {
@@ -45,6 +53,21 @@ public class PackagesMonitor extends BroadcastReceiver {
             super("GalleryPackagesMonitorAsync");
         }
 
+        @Override
+        public void onCreate() {
+            super.onCreate();
+            if(Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
+                String channelId = "GalleryPackagesMonitorAsync";
+                NotificationChannel channel = new NotificationChannel(channelId, channelId,
+                        NotificationManager.IMPORTANCE_LOW);
+                NotificationManager manager =
+                        (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);
+                manager.createNotificationChannel(channel);
+                startForeground(KEY_PACKAGES_VERSION.hashCode(),
+                        new Notification.Builder(getApplicationContext(), channelId).build());
+            }
+        }
+
         @Override
         protected void onHandleIntent(Intent intent) {
             onReceiveAsync(this, intent);
-- 
2.17.1

