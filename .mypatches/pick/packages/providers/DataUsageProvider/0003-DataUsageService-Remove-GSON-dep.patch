From 493a096466f8949ee34c67ba5961b8b2df836220 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Tue, 30 Jan 2018 20:55:33 +0000
Subject: [PATCH 3/3] DataUsageService: Remove GSON dep

Change-Id: Ia4904164e910459ea6a058bf524be0130d6dd518
---
 Android.mk                                         |  3 +-
 .../providers/datausage/DataUsageService.java      | 47 ----------------------
 2 files changed, 1 insertion(+), 49 deletions(-)

diff --git a/Android.mk b/Android.mk
index cad858f..696a333 100644
--- a/Android.mk
+++ b/Android.mk
@@ -21,8 +21,7 @@ LOCAL_MODULE_TAGS := optional
 LOCAL_STATIC_JAVA_LIBRARIES := \
     org.lineageos.platform.sdk \
     android-support-v4 \
-    android-support-v13 \
-    gson
+    android-support-v13
 
 LOCAL_SRC_FILES := $(call all-java-files-under, src)
 
diff --git a/src/org/lineage/providers/datausage/DataUsageService.java b/src/org/lineage/providers/datausage/DataUsageService.java
index 747cb17..237c370 100644
--- a/src/org/lineage/providers/datausage/DataUsageService.java
+++ b/src/org/lineage/providers/datausage/DataUsageService.java
@@ -59,7 +59,6 @@ import android.os.SystemProperties;
 import android.content.pm.UserInfo;
 
 import android.util.SparseArray;
-import com.google.gson.Gson;
 
 import lineageos.providers.DataUsageContract;
 import lineageos.providers.LineageSettings;
@@ -239,11 +238,6 @@ public class DataUsageService extends IntentService {
         }
     }
 
-    private class DataUsageExtraInfo {
-        ArrayList<Long> samples;
-    }
-    private String mAppWarnExtra;
-
     private void dataUsageUpdate() {
         long startTime = 0;
         long endTime = System.currentTimeMillis();
@@ -325,7 +319,6 @@ public class DataUsageService extends IntentService {
             appWarnSlowAvg = cursor.getLong(DataUsageContract.COLUMN_OF_SLOW_AVG);
             appWarnFastSamples = cursor.getInt(DataUsageContract.COLUMN_OF_FAST_SAMPLES);
             appWarnFastAvg = cursor.getLong(DataUsageContract.COLUMN_OF_FAST_AVG);
-            mAppWarnExtra = cursor.getString(DataUsageContract.COLUMN_OF_EXTRA);
 
             AppItem appItem = mKnownItems.get((int)appWarnUid);
 
@@ -438,14 +431,12 @@ public class DataUsageService extends IntentService {
             int active, long bytes
     ) {
         ContentValues values = new ContentValues();
-        String extraInfo = genExtraInfo(bytes);
         values.put(DataUsageContract.SLOW_AVG, slowAvg);
         values.put(DataUsageContract.SLOW_SAMPLES, slowSamples);
         values.put(DataUsageContract.FAST_AVG, fastAvg);
         values.put(DataUsageContract.FAST_SAMPLES, fastSamples);
         values.put(DataUsageContract.ACTIVE, active);
         values.put(DataUsageContract.BYTES, bytes);
-        values.put(DataUsageContract.EXTRA, extraInfo);
 
         getContentResolver().update(
                 DataUsageContract.CONTENT_URI,
@@ -455,44 +446,6 @@ public class DataUsageService extends IntentService {
         );
     }
 
-
-    /**
-     * In debug mode, generate extra samples inforamation that can be used to analyze
-     * algorithm manually
-     */
-    private String genExtraInfo(long bytes) {
-        if (!DEBUG) {
-            return "";
-        }
-
-        Gson gson = new Gson();
-        DataUsageExtraInfo extraInfo;
-
-        if (mAppWarnExtra == null || mAppWarnExtra == "") {
-            extraInfo = null;
-        } else {
-            try {
-                extraInfo = gson.fromJson(mAppWarnExtra, DataUsageExtraInfo.class);
-            } catch (Exception e) {
-                extraInfo = null;
-            }
-        }
-
-        if (extraInfo == null) {
-            extraInfo = new DataUsageExtraInfo();
-            extraInfo.samples = new ArrayList<Long>();
-        }
-
-        if (extraInfo.samples.size() == MAX_EXTRA_SAMPLE_COUNT) {
-            extraInfo.samples.remove(0);
-        }
-        extraInfo.samples.add(bytes);
-        String extraInfoJson = gson.toJson(extraInfo);
-        return extraInfoJson;
-    }
-
-
-
     private void genNotification(long uid, String appTitle, boolean firstTime) {
         Intent hideIntent = new Intent();
         hideIntent.setAction(HIDE_ACTION);
-- 
2.7.4

