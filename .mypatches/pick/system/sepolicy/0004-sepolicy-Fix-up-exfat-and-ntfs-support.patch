From 721cac56a34a047464c0496b5b6773fd8e7537dd Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Sat, 23 Dec 2017 19:36:26 +0100
Subject: [PATCH 4/8] sepolicy: Fix up exfat and ntfs support

* exfat-fuse (fuseblk)
* kernel exfat
* kernel ntfs

Change-Id: I4402477a0cd3d697c2cd3263c45f8e7e26aaf475
---
 private/app.te             | 14 ++++++++++----
 private/app_neverallows.te |  3 +++
 2 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/private/app.te b/private/app.te
index c0deb08..fe03692 100644
--- a/private/app.te
+++ b/private/app.te
@@ -238,15 +238,21 @@ allow { appdomain -isolated_app -ephemeral_app } sdcardfs:dir create_dir_perms;
 allow { appdomain -isolated_app -ephemeral_app } sdcardfs:file create_file_perms;
 # This should be removed if sdcardfs is modified to alter the secontext for its
 # accesses to the underlying FS.
-allow { appdomain -isolated_app -ephemeral_app } { media_rw_data_file sdcard_posix vfat }:dir create_dir_perms;
-allow { appdomain -isolated_app -ephemeral_app } { media_rw_data_file sdcard_posix vfat }:file create_file_perms;
+allow { appdomain -isolated_app -ephemeral_app } { exfat fuseblk media_rw_data_file ntfs sdcard_posix vfat }:dir create_dir_perms;
+allow { appdomain -isolated_app -ephemeral_app } { exfat fuseblk media_rw_data_file ntfs sdcard_posix vfat }:file create_file_perms;
 
 # Access OBBs (vfat images) mounted by vold (b/17633509)
 # File write access allowed for FDs returned through Storage Access Framework
-allow { appdomain -isolated_app -ephemeral_app } vfat:dir r_dir_perms;
-allow { appdomain -isolated_app -ephemeral_app } vfat:file rw_file_perms;
+allow { appdomain -isolated_app -ephemeral_app } exfat:dir r_dir_perms;
+allow { appdomain -isolated_app -ephemeral_app } exfat:file rw_file_perms;
+allow { appdomain -isolated_app -ephemeral_app } fuseblk:dir r_dir_perms;
+allow { appdomain -isolated_app -ephemeral_app } fuseblk:file rw_file_perms;
+allow { appdomain -isolated_app -ephemeral_app } ntfs:dir r_dir_perms;
+allow { appdomain -isolated_app -ephemeral_app } ntfs:file rw_file_perms;
 allow { appdomain -isolated_app -ephemeral_app } sdcard_posix:dir r_dir_perms;
 allow { appdomain -isolated_app -ephemeral_app } sdcard_posix:file rw_file_perms;
+allow { appdomain -isolated_app -ephemeral_app } vfat:dir r_dir_perms;
+allow { appdomain -isolated_app -ephemeral_app } vfat:file rw_file_perms;
 
 # Allow apps to use the USB Accessory interface.
 # http://developer.android.com/guide/topics/connectivity/usb/accessory.html
diff --git a/private/app_neverallows.te b/private/app_neverallows.te
index 583782d..2a75b6c 100644
--- a/private/app_neverallows.te
+++ b/private/app_neverallows.te
@@ -82,7 +82,10 @@ neverallow { all_untrusted_apps -mediaprovider } { cache_file cache_recovery_fil
 # application un-installation.
 neverallow { all_untrusted_apps -mediaprovider } {
   fs_type
+  -exfat                    # sdcard
   -fuse                     # sdcard
+  -fuseblk                  # sdcard
+  -ntfs                     # sdcard
   -sdcardfs                 # sdcard
   -sdcard_posix             # sdcard
   -vfat                     # sdcard
-- 
2.7.4

