From 21e0ec184fc51d6a7284c9f061ba796d6ea0f905 Mon Sep 17 00:00:00 2001
From: Dan Pasanen <dan.pasanen@gmail.com>
Date: Thu, 18 May 2017 21:55:50 -0500
Subject: [PATCH] sepolicy: allow update_engine to bypass neverallows for
 backuptool

Change-Id: Ieb8db266e9d17b9c5afc1d17410b33dca86fef17
---
 public/domain.te | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/public/domain.te b/public/domain.te
index 8640baaa..2cbe397c 100644
--- a/public/domain.te
+++ b/public/domain.te
@@ -398,6 +398,7 @@ neverallow { domain -init } properties_serial:file { no_w_file_perms no_x_file_p
 neverallow {
     domain
     -recovery
+    -update_engine
     with_asan(`-asan_extract')
 } {
     system_file
@@ -405,14 +406,15 @@ neverallow {
     exec_type
 }:dir_file_class_set { create write setattr relabelfrom append unlink link rename };
 
-neverallow { domain -recovery -kernel with_asan(`-asan_extract') } { system_file vendor_file_type exec_type }:dir_file_class_set relabelto;
+neverallow { domain -recovery -kernel -update_engine with_asan(`-asan_extract') } { system_file vendor_file_type exec_type }:dir_file_class_set relabelto;
 
 # Don't allow mounting on top of /system files or directories
 neverallow * exec_type:dir_file_class_set mounton;
 neverallow { domain -init } { system_file vendor_file_type }:dir_file_class_set mounton;
 
 # Nothing should be writing to files in the rootfs.
-neverallow { domain userdebug_or_eng(`-recovery') } rootfs:file { create write setattr relabelto append unlink link rename };
+neverallow { domain userdebug_or_eng(`-recovery -update_engine') } rootfs:file { create write setattr relabelto append unlink link rename };
+neverallow { -update_engine } rootfs:file { create write setattr relabelto append unlink link rename };
 
 # Restrict context mounts to specific types marked with
 # the contextmount_type attribute.
@@ -868,6 +870,7 @@ neverallow {
   -system_app
   -init
   -installd # for relabelfrom and unlink, check for this in explicit neverallow
+  -update_engine
   with_asan(`-asan_extract')
 } system_data_file:file no_w_file_perms;
 # do not grant anything greater than r_file_perms and relabelfrom unlink
-- 
2.17.0

