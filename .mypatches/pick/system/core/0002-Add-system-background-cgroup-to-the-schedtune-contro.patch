From f35cb9544428e235496fcee907e36610d56977c6 Mon Sep 17 00:00:00 2001
From: Vikram Mulukutla <markivx@codeaurora.org>
Date: Fri, 29 Apr 2016 13:01:38 -0700
Subject: [PATCH 2/4] Add system-background cgroup to the schedtune controller
 hierarchy.

Change-Id: Ic6f06defd0065c0580a4bca14ac7d5351aca1072
---
 libcutils/sched_policy.cpp | 4 ++++
 rootdir/init.rc            | 4 ++++
 2 files changed, 8 insertions(+)

diff --git a/libcutils/sched_policy.cpp b/libcutils/sched_policy.cpp
index b00fa8561..3204b186d 100644
--- a/libcutils/sched_policy.cpp
+++ b/libcutils/sched_policy.cpp
@@ -64,6 +64,7 @@ static int bg_schedboost_fd = -1;
 static int fg_schedboost_fd = -1;
 static int ta_schedboost_fd = -1;
 static int rt_schedboost_fd = -1;
+static int system_bg_schedboost_fd = -1;
 
 /* Add tid to the scheduling group defined by the policy */
 static int add_tid_to_cgroup(int tid, int fd)
@@ -162,6 +163,8 @@ static void __initialize() {
                 bg_schedboost_fd = open(filename, O_WRONLY | O_CLOEXEC);
                 filename = "/dev/stune/rt/tasks";
                 rt_schedboost_fd = open(filename, O_WRONLY | O_CLOEXEC);
+                filename = "/dev/stune/system-background/tasks";
+                system_bg_schedboost_fd = open(filename, O_WRONLY | O_CLOEXEC);
             }
         }
     }
@@ -308,6 +311,7 @@ int set_cpuset_policy(int tid, SchedPolicy policy)
         break;
     case SP_SYSTEM:
         fd = system_bg_cpuset_fd;
+        boost_fd = system_bg_schedboost_fd;
         break;
     default:
         boost_fd = fd = -1;
diff --git a/rootdir/init.rc b/rootdir/init.rc
index eca160771..a8f81b65a 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -62,21 +62,25 @@ on init
     mkdir /dev/stune/background
     mkdir /dev/stune/top-app
     mkdir /dev/stune/rt
+    mkdir /dev/stune/system-background
     chown system system /dev/stune
     chown system system /dev/stune/foreground
     chown system system /dev/stune/background
     chown system system /dev/stune/top-app
     chown system system /dev/stune/rt
+    chown system system /dev/stune/system-background
     chown system system /dev/stune/tasks
     chown system system /dev/stune/foreground/tasks
     chown system system /dev/stune/background/tasks
     chown system system /dev/stune/top-app/tasks
     chown system system /dev/stune/rt/tasks
+    chown system system /dev/stune/system-background/tasks
     chmod 0664 /dev/stune/tasks
     chmod 0664 /dev/stune/foreground/tasks
     chmod 0664 /dev/stune/background/tasks
     chmod 0664 /dev/stune/top-app/tasks
     chmod 0664 /dev/stune/rt/tasks
+    chmod 0664 /dev/stune/system-background/tasks
 
     # Mount staging areas for devices managed by vold
     # See storage config details at http://source.android.com/tech/storage/
-- 
2.17.0

