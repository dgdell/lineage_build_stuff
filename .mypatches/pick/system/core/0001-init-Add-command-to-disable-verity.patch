From c53cdb2c56c975ba7298ed45a4282d93d60f99fb Mon Sep 17 00:00:00 2001
From: Ethan Chen <intervigil@gmail.com>
Date: Mon, 22 Jan 2018 23:30:20 -0800
Subject: [PATCH 1/6] init: Add command to disable verity

* Add a command so init can disable verity.

Change-Id: Ic0acfb7d2d93200cf54f005d935b4834c08c92b7
---
 init/Android.mk   |  1 +
 init/builtins.cpp | 11 +++++++++++
 2 files changed, 12 insertions(+)

diff --git a/init/Android.mk b/init/Android.mk
index f8d1d22d7..6d91fa19b 100644
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -87,6 +87,7 @@ LOCAL_STATIC_LIBRARIES := \
     libprocessgroup \
     libavb \
     libkeyutils \
+    libveritytool \
 
 LOCAL_REQUIRED_MODULES := \
     e2fsdroid \
diff --git a/init/builtins.cpp b/init/builtins.cpp
index bb1b5eab0..d95b26748 100644
--- a/init/builtins.cpp
+++ b/init/builtins.cpp
@@ -53,6 +53,7 @@
 #include <selinux/android.h>
 #include <selinux/label.h>
 #include <selinux/selinux.h>
+#include <verity_tool.h>
 
 #include "action.h"
 #include "bootchart.h"
@@ -659,6 +660,14 @@ static int do_sysclktz(const std::vector<std::string>& args) {
     return -1;
 }
 
+static int do_verity_disable(const std::vector<std::string>& args) {
+    return set_verity_enabled(false);
+}
+
+static int do_verity_enable(const std::vector<std::string>& args) {
+    return set_verity_enabled(true);
+}
+
 static int do_verity_load_state(const std::vector<std::string>& args) {
     int mode = -1;
     bool loaded = fs_mgr_load_verity_state(&mode);
@@ -950,6 +959,8 @@ const BuiltinFunctionMap::Map& BuiltinFunctionMap::map() const {
         {"symlink",                 {2,     2,    do_symlink}},
         {"sysclktz",                {1,     1,    do_sysclktz}},
         {"trigger",                 {1,     1,    do_trigger}},
+        {"verity_disable",          {0,     0,    do_verity_disable}},
+        {"verity_enable",           {0,     0,    do_verity_enable}},
         {"verity_load_state",       {0,     0,    do_verity_load_state}},
         {"verity_update_state",     {0,     0,    do_verity_update_state}},
         {"wait",                    {1,     2,    do_wait}},
-- 
2.17.1

