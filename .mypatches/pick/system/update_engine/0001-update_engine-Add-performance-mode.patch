From 8b9071fecf28c5f2cb93defd9339b25d87f4aa02 Mon Sep 17 00:00:00 2001
From: Gabriele M <moto.falcon.git@gmail.com>
Date: Thu, 14 Jun 2018 01:10:09 +0200
Subject: [PATCH] update_engine: Add performance mode

Allow to move update_engine from the system-background cgroup
to the foreground cgroup to speed up the installation of the
updates.

Change-Id: Iaa531a925f9e1a26e834d7448c4755151adcfea2
---
 binder_bindings/android/os/IUpdateEngine.aidl |  2 ++
 binder_service_android.cc                     |  7 +++++++
 binder_service_android.h                      |  1 +
 service_delegate_android_interface.h          |  2 ++
 update_attempter_android.cc                   | 14 ++++++++++++++
 update_attempter_android.h                    |  3 +++
 update_engine.rc                              |  1 -
 update_engine_client_android.cc               |  5 +++++
 8 files changed, 34 insertions(+), 1 deletion(-)

diff --git a/binder_bindings/android/os/IUpdateEngine.aidl b/binder_bindings/android/os/IUpdateEngine.aidl
index 7e26752..2837a75 100644
--- a/binder_bindings/android/os/IUpdateEngine.aidl
+++ b/binder_bindings/android/os/IUpdateEngine.aidl
@@ -37,4 +37,6 @@ interface IUpdateEngine {
   void cancel();
   /** @hide */
   void resetStatus();
+  /** @hide */
+  void setPerformanceMode(in boolean enable);
 }
diff --git a/binder_service_android.cc b/binder_service_android.cc
index e179c62..09ddd4c 100644
--- a/binder_service_android.cc
+++ b/binder_service_android.cc
@@ -157,4 +157,11 @@ bool BinderUpdateEngineAndroidService::UnbindCallback(const IBinder* callback) {
   return true;
 }
 
+Status BinderUpdateEngineAndroidService::setPerformanceMode(bool enable) {
+  brillo::ErrorPtr error;
+  if (!service_delegate_->SetPerformanceMode(enable, &error))
+    return ErrorPtrToStatus(error);
+  return Status::ok();
+}
+
 }  // namespace chromeos_update_engine
diff --git a/binder_service_android.h b/binder_service_android.h
index 7d66fcc..16f77ec 100644
--- a/binder_service_android.h
+++ b/binder_service_android.h
@@ -68,6 +68,7 @@ class BinderUpdateEngineAndroidService : public android::os::BnUpdateEngine,
   android::binder::Status resume() override;
   android::binder::Status cancel() override;
   android::binder::Status resetStatus() override;
+  android::binder::Status setPerformanceMode(bool enable) override;
 
  private:
   // Remove the passed |callback| from the list of registered callbacks. Called
diff --git a/service_delegate_android_interface.h b/service_delegate_android_interface.h
index 7dae40f..58e7bf3 100644
--- a/service_delegate_android_interface.h
+++ b/service_delegate_android_interface.h
@@ -70,6 +70,8 @@ class ServiceDelegateAndroidInterface {
   // of error, returns false and sets |error| accordingly.
   virtual bool ResetStatus(brillo::ErrorPtr* error) = 0;
 
+  virtual bool SetPerformanceMode(bool enable, brillo::ErrorPtr* error) = 0;
+
  protected:
   ServiceDelegateAndroidInterface() = default;
 };
diff --git a/update_attempter_android.cc b/update_attempter_android.cc
index 6c992c8..a9387ef 100644
--- a/update_attempter_android.cc
+++ b/update_attempter_android.cc
@@ -27,6 +27,7 @@
 #include <brillo/data_encoding.h>
 #include <brillo/message_loops/message_loop.h>
 #include <brillo/strings/string_utils.h>
+#include <cutils/sched_policy.h>
 #include <log/log.h>
 
 #include "update_engine/common/constants.h"
@@ -88,6 +89,7 @@ UpdateAttempterAndroid::UpdateAttempterAndroid(
       hardware_(hardware),
       processor_(new ActionProcessor()) {
   network_selector_ = network::CreateNetworkSelector();
+  set_cpuset_policy(0, SP_BACKGROUND);
 }
 
 UpdateAttempterAndroid::~UpdateAttempterAndroid() {
@@ -290,6 +292,18 @@ bool UpdateAttempterAndroid::ResetStatus(brillo::ErrorPtr* error) {
   }
 }
 
+bool UpdateAttempterAndroid::SetPerformanceMode(bool enable,
+                                                brillo::ErrorPtr* error) {
+  LOG(INFO) << (enable ? "Enabling" : "Disabling") << " performance mode.";
+
+  if (performance_mode_ == enable)
+    return true;
+  if (set_cpuset_policy(0, enable ? SP_FOREGROUND : SP_BACKGROUND) < 0)
+    return LogAndSetError(error, FROM_HERE, "Could not change policy");
+  performance_mode_ = enable;
+  return true;
+}
+
 void UpdateAttempterAndroid::ProcessingDone(const ActionProcessor* processor,
                                             ErrorCode code) {
   LOG(INFO) << "Processing Done.";
diff --git a/update_attempter_android.h b/update_attempter_android.h
index 167191e..e059751 100644
--- a/update_attempter_android.h
+++ b/update_attempter_android.h
@@ -66,6 +66,7 @@ class UpdateAttempterAndroid
   bool ResumeUpdate(brillo::ErrorPtr* error) override;
   bool CancelUpdate(brillo::ErrorPtr* error) override;
   bool ResetStatus(brillo::ErrorPtr* error) override;
+  bool SetPerformanceMode(bool enable, brillo::ErrorPtr* error) override;
 
   // ActionProcessorDelegate methods:
   void ProcessingDone(const ActionProcessor* processor,
@@ -162,6 +163,8 @@ class UpdateAttempterAndroid
   // before applying an update to the other slot.
   bool updated_boot_flags_ = false;
 
+  bool performance_mode_ = false;
+
   DISALLOW_COPY_AND_ASSIGN(UpdateAttempterAndroid);
 };
 
diff --git a/update_engine.rc b/update_engine.rc
index b6a706a..76b6d9b 100644
--- a/update_engine.rc
+++ b/update_engine.rc
@@ -2,4 +2,3 @@ service update_engine /system/bin/update_engine --logtostderr --foreground
     class late_start
     user root
     group root system wakelock inet cache
-    writepid /dev/cpuset/system-background/tasks
diff --git a/update_engine_client_android.cc b/update_engine_client_android.cc
index 989a97e..52457ec 100644
--- a/update_engine_client_android.cc
+++ b/update_engine_client_android.cc
@@ -129,6 +129,7 @@ int UpdateEngineClientAndroid::OnInit() {
               false,
               "Follow status update changes until a final state is reached. "
               "Exit status is 0 if the update succeeded, and 1 otherwise.");
+  DEFINE_bool(perf_mode, false, "Enable perf mode.");
 
   // Boilerplate init commands.
   base::CommandLine::Init(argc_, argv_);
@@ -179,6 +180,10 @@ int UpdateEngineClientAndroid::OnInit() {
     return ExitWhenIdle(service_->resetStatus());
   }
 
+  if (FLAGS_perf_mode) {
+    return ExitWhenIdle(service_->setPerformanceMode(true));
+  }
+
   if (FLAGS_follow) {
     // Register a callback object with the service.
     callback_ = new UECallback(this);
-- 
2.17.1

