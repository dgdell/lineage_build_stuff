From 8d8c47512f934b364650909e87be6779a27aa509 Mon Sep 17 00:00:00 2001
From: Bryan Tong Minh <bryan.tongminh@gmail.com>
Date: Sat, 14 Jan 2017 17:53:20 +0100
Subject: [PATCH 8/9] Add detection for WSL

Change-Id: I8d57cd653157bb9b51019b3cc1192c8210e990e2
---
 core/combo/HOST_EXTRA_wsl-x86_64.mk | 18 ++++++++++++++++++
 core/combo/HOST_linux-x86_64.mk     |  5 +++++
 core/envsetup.mk                    |  6 ++++++
 3 files changed, 29 insertions(+)
 create mode 100644 core/combo/HOST_EXTRA_wsl-x86_64.mk

diff --git a/core/combo/HOST_EXTRA_wsl-x86_64.mk b/core/combo/HOST_EXTRA_wsl-x86_64.mk
new file mode 100644
index 000000000..b5b90a53f
--- /dev/null
+++ b/core/combo/HOST_EXTRA_wsl-x86_64.mk
@@ -0,0 +1,18 @@
+#
+# Copyright (C) 2018 The LineageOS Project
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#      http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+
+# Configuration for builds hosted on wsl-x86_64.
+# Included by combo/HOST_linux-x86_64.mk
\ No newline at end of file
diff --git a/core/combo/HOST_linux-x86_64.mk b/core/combo/HOST_linux-x86_64.mk
index 845733f74..60306ba4f 100644
--- a/core/combo/HOST_linux-x86_64.mk
+++ b/core/combo/HOST_linux-x86_64.mk
@@ -20,3 +20,8 @@
 define $(combo_var_prefix)transform-shared-lib-to-toc
 $(call _gen_toc_command_for_elf,$(1),$(2))
 endef
+
+# Microsoft Windows Subsystem for Linux
+ifeq ($(HOST_OS_IS_WSL),true)
+include $(BUILD_COMBOS)/HOST_EXTRA_wsl-x86_64.mk
+endif
\ No newline at end of file
diff --git a/core/envsetup.mk b/core/envsetup.mk
index d9842e37f..b1e60b297 100644
--- a/core/envsetup.mk
+++ b/core/envsetup.mk
@@ -102,6 +102,12 @@ UNAME := $(shell uname -sm)
 # HOST_OS
 ifneq (,$(findstring Linux,$(UNAME)))
   HOST_OS := linux
+    ifneq (,$(findstring Microsoft,$(shell uname -r)))
+      # Microsoft Windows Subsystem for Linux
+      # The HOST_OS is still Linux but with some limitations.
+      # Assumes that there are no other Microsoft Linux kernels
+      HOST_OS_IS_WSL := true
+    endif
 endif
 ifneq (,$(findstring Darwin,$(UNAME)))
   HOST_OS := darwin
-- 
2.17.0

