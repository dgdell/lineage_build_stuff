From 0305887f7f5a9b95799d42bc74ca6d9d9cd378df Mon Sep 17 00:00:00 2001
From: Christian Oder <myself5@carbonrom.org>
Date: Mon, 30 Jul 2018 11:55:29 +0200
Subject: [PATCH 20/22] build: Allow using prebuilt vbmeta images in signed
 builds

* this allows custom signing with prebuilt vbmeta images

Change-Id: I8b6849a24b20fb9255e113b15c7f9ab9df054a81
---
 core/Makefile                                 |  1 +
 tools/releasetools/add_img_to_target_files.py | 21 +++++++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/core/Makefile b/core/Makefile
index 87f758725..8045d640f 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -2718,6 +2718,7 @@ endif
 ifdef BOARD_PREBUILT_VBMETAIMAGE
 	$(hide) mkdir -p $(zip_root)/IMAGES
 	$(hide) cp $(INSTALLED_VBMETAIMAGE_TARGET) $(zip_root)/IMAGES/
+	$(hide) echo "avb_prebuilt_vbmeta=true" >> $(zip_root)/META/misc_info.txt
 endif
 ifdef BOARD_PREBUILT_VENDORIMAGE
 	$(hide) mkdir -p $(zip_root)/IMAGES
diff --git a/tools/releasetools/add_img_to_target_files.py b/tools/releasetools/add_img_to_target_files.py
index 940853f27..fe6c3aef2 100755
--- a/tools/releasetools/add_img_to_target_files.py
+++ b/tools/releasetools/add_img_to_target_files.py
@@ -448,6 +448,23 @@ def AddDisabledVBMeta(output_zip):
   assert p.returncode == 0, "avbtool make_vbmeta_image failed"
   img.Write()
 
+def AddPrebuiltVBMeta(output_zip):
+  """Copies the prebuilt VBMeta image and store it in output_zip.
+
+  Args:
+    output_zip: The output zip file, which needs to be already open.
+  """
+  img = OutputFile(output_zip, OPTIONS.input_tmp, "IMAGES", "vbmeta.img")
+  if not os.path.exists(img.input_name):
+    print("Adding vbmeta.img from OUT")
+    shutil.copyfile(os.path.join(os.getenv('OUT'), "vbmeta.img"),
+        os.path.join(OPTIONS.input_tmp, "IMAGES/vbmeta.img"))
+  else:
+    print("Adding vbmeta.img from IMAGES")
+
+  if output_zip:
+    common.File.FromLocalFile("IMAGES/vbmeta.img", img.input_name).AddToZip(output_zip)
+
 def AddPartitionTable(output_zip, prefix="IMAGES/"):
   """Create a partition table image and store it in output_zip."""
 
@@ -707,6 +724,10 @@ def AddImagesToTargetFiles(filename):
     banner("vbmeta")
     AddDisabledVBMeta(output_zip)
 
+  if OPTIONS.info_dict.get("avb_prebuilt_vbmeta") == "true":
+    banner("vbmeta")
+    AddPrebuiltVBMeta(output_zip)
+
   # For devices using A/B update, copy over images from RADIO/ and/or
   # VENDOR_IMAGES/ to IMAGES/ and make sure we have all the needed
   # images ready under IMAGES/. All images should have '.img' as extension.
-- 
2.17.1

