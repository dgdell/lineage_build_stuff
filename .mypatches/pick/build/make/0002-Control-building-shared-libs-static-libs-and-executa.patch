From 4d1f95ef021826ca2f461f98329bc2326ed89c1f Mon Sep 17 00:00:00 2001
From: Pengxuan Zheng <pzheng@codeaurora.org>
Date: Fri, 28 Apr 2017 15:49:24 -0700
Subject: [PATCH 2/8] Control building shared libs, static libs and executables
 with SDLLVM LTO

Change-Id: I92bd8bf222969802568a5825e9d5eac11b43fda7
---
 core/clear_vars.mk     |  5 ++++-
 core/executable.mk     | 10 ++++++++++
 core/shared_library.mk | 10 ++++++++++
 core/static_library.mk | 10 ++++++++++
 4 files changed, 34 insertions(+), 1 deletion(-)

diff --git a/core/clear_vars.mk b/core/clear_vars.mk
index d4ed145..560db8d 100644
--- a/core/clear_vars.mk
+++ b/core/clear_vars.mk
@@ -26,7 +26,6 @@ LOCAL_CFLAGS:=
 LOCAL_CHECKED_MODULE:=
 LOCAL_C_INCLUDES:=
 LOCAL_CLANG:=
-LOCAL_SDCLANG:=
 LOCAL_CLANG_ASFLAGS:=
 LOCAL_CLANG_CFLAGS:=
 LOCAL_CLANG_CONLYFLAGS:=
@@ -409,6 +408,10 @@ LOCAL_MODULE_STEM_32:=
 LOCAL_MODULE_STEM_64:=
 LOCAL_MODULE_SYMLINKS_32:=
 LOCAL_MODULE_SYMLINKS_64:=
+LOCAL_SDCLANG:=
+LOCAL_SDCLANG_EXTRA_FLAGS_32:=
+LOCAL_SDCLANG_EXTRA_FLAGS_64:=
+LOCAL_SDCLANG_LTO:=
 LOCAL_SHARED_LIBRARIES_32:=
 LOCAL_SHARED_LIBRARIES_64:=
 LOCAL_SRC_FILES_32:=
diff --git a/core/executable.mk b/core/executable.mk
index f1b2462..e87e6f7 100644
--- a/core/executable.mk
+++ b/core/executable.mk
@@ -54,6 +54,10 @@ endif
 
 my_skip_non_preferred_arch :=
 
+ifeq ($(LOCAL_SDCLANG),true)
+include $(SDCLANG_FLAG_DEFS)
+endif
+
 # check if preferred arch is supported
 include $(BUILD_SYSTEM)/module_arch_supported.mk
 ifeq ($(my_module_arch_supported),true)
@@ -92,4 +96,10 @@ LOCAL_NO_2ND_ARCH_MODULE_SUFFIX :=
 
 my_module_arch_supported :=
 
+ifeq ($(LOCAL_SDCLANG),true)
+ifeq ($(LOCAL_SDCLANG_LTO),true)
+include $(SDCLANG_LTO_DEFS)
+endif
+endif
+
 endif
diff --git a/core/shared_library.mk b/core/shared_library.mk
index a15b1a6..af28012 100644
--- a/core/shared_library.mk
+++ b/core/shared_library.mk
@@ -22,6 +22,10 @@ endif
 endif # my_module_multilib == both
 
 
+ifeq ($(LOCAL_SDCLANG),true)
+include $(SDCLANG_FLAG_DEFS)
+endif
+
 LOCAL_2ND_ARCH_VAR_PREFIX :=
 include $(BUILD_SYSTEM)/module_arch_supported.mk
 
@@ -49,6 +53,12 @@ LOCAL_2ND_ARCH_VAR_PREFIX :=
 
 endif # TARGET_2ND_ARCH
 
+ifeq ($(LOCAL_SDCLANG),true)
+ifeq ($(LOCAL_SDCLANG_LTO),true)
+include $(SDCLANG_LTO_DEFS)
+endif
+endif
+
 my_module_arch_supported :=
 
 ###########################################################
diff --git a/core/static_library.mk b/core/static_library.mk
index 25e5279..bbc24bd 100644
--- a/core/static_library.mk
+++ b/core/static_library.mk
@@ -7,6 +7,10 @@ ifndef my_module_multilib
 my_module_multilib := both
 endif
 
+ifeq ($(LOCAL_SDCLANG),true)
+include $(SDCLANG_FLAG_DEFS)
+endif
+
 LOCAL_2ND_ARCH_VAR_PREFIX :=
 include $(BUILD_SYSTEM)/module_arch_supported.mk
 
@@ -34,6 +38,12 @@ LOCAL_2ND_ARCH_VAR_PREFIX :=
 
 endif # TARGET_2ND_ARCH
 
+ifeq ($(LOCAL_SDCLANG),true)
+ifeq ($(LOCAL_SDCLANG_LTO),true)
+include $(SDCLANG_LTO_DEFS)
+endif
+endif
+
 my_module_arch_supported :=
 
 ###########################################################
-- 
2.7.4

