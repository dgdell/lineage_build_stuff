From d56f5ddcd163ce44a36b7aa3b534ffb1bf3869f0 Mon Sep 17 00:00:00 2001
From: Pengxuan Zheng <pzheng@codeaurora.org>
Date: Mon, 10 Apr 2017 17:26:55 -0700
Subject: [PATCH 2/8] Add support for building with proprietary compiler

Change-Id: Ib846d2a1bed7af56671726d8a7b79598d9db1259
---
 core/binary.mk      | 15 +++++++++++++++
 core/clear_vars.mk  |  1 +
 core/definitions.mk |  6 ++++--
 3 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/core/binary.mk b/core/binary.mk
index 9fecccf..5d1761d 100644
--- a/core/binary.mk
+++ b/core/binary.mk
@@ -414,6 +414,13 @@ else ifeq ($(my_clang),)
     my_clang := true
 endif
 
+my_sdclang := $(strip $(LOCAL_SDCLANG))
+ifeq ($(SDCLANG),true)
+    ifeq ($(my_sdclang),)
+        my_sdclang := true
+    endif
+endif
+
 ifeq ($(LOCAL_C_STD),)
     my_c_std_version := $(DEFAULT_C_STD_VERSION)
 else ifeq ($(LOCAL_C_STD),experimental)
@@ -595,6 +602,14 @@ my_target_global_cflags := $($(LOCAL_2ND_ARCH_VAR_PREFIX)CLANG_$(my_prefix)GLOBA
 my_target_global_conlyflags := $($(LOCAL_2ND_ARCH_VAR_PREFIX)CLANG_$(my_prefix)GLOBAL_CONLYFLAGS) $(my_c_std_conlyflags)
 my_target_global_cppflags := $($(LOCAL_2ND_ARCH_VAR_PREFIX)CLANG_$(my_prefix)GLOBAL_CPPFLAGS) $(my_cpp_std_cppflags)
 my_target_global_ldflags := $($(LOCAL_2ND_ARCH_VAR_PREFIX)CLANG_$(my_prefix)GLOBAL_LDFLAGS)
+ifeq ($(my_sdclang),true)
+    ifeq ($(strip $(my_cc)),)
+        my_cc := $(SDCLANG_PATH)/clang
+    endif
+    ifeq ($(strip $(my_cxx)),)
+        my_cxx := $(SDCLANG_PATH)/clang++
+    endif
+endif
 else
 my_target_global_cflags := $($(LOCAL_2ND_ARCH_VAR_PREFIX)$(my_prefix)GLOBAL_CFLAGS)
 my_target_global_conlyflags := $($(LOCAL_2ND_ARCH_VAR_PREFIX)$(my_prefix)GLOBAL_CONLYFLAGS) $(my_c_std_conlyflags)
diff --git a/core/clear_vars.mk b/core/clear_vars.mk
index 5ef9f09..d4ed145 100644
--- a/core/clear_vars.mk
+++ b/core/clear_vars.mk
@@ -26,6 +26,7 @@ LOCAL_CFLAGS:=
 LOCAL_CHECKED_MODULE:=
 LOCAL_C_INCLUDES:=
 LOCAL_CLANG:=
+LOCAL_SDCLANG:=
 LOCAL_CLANG_ASFLAGS:=
 LOCAL_CLANG_CFLAGS:=
 LOCAL_CLANG_CONLYFLAGS:=
diff --git a/core/definitions.mk b/core/definitions.mk
index 95e9a02..b407081 100644
--- a/core/definitions.mk
+++ b/core/definitions.mk
@@ -1230,7 +1230,8 @@ define transform-cpp-to-o-compiler-args
 	$(PRIVATE_CPPFLAGS) \
 	$(PRIVATE_DEBUG_CFLAGS) \
 	$(PRIVATE_CFLAGS_NO_OVERRIDE) \
-	$(PRIVATE_CPPFLAGS_NO_OVERRIDE)
+	$(PRIVATE_CPPFLAGS_NO_OVERRIDE) \
+	$(if $(findstring $(SDCLANG_PATH),$(PRIVATE_CXX)),$(SDCLANG_COMMON_FLAGS))
 endef
 
 define clang-tidy-cpp
@@ -1270,7 +1271,8 @@ define transform-c-or-s-to-o-compiler-args
 	    $(PRIVATE_TARGET_GLOBAL_CONLYFLAGS) \
 	    $(PRIVATE_ARM_CFLAGS) \
 	 ) \
-	 $(1)
+	 $(1) \
+	$(if $(findstring $(SDCLANG_PATH),$(PRIVATE_CXX)),$(SDCLANG_COMMON_FLAGS))
 endef
 
 define transform-c-to-o-compiler-args
-- 
2.7.4

