From 55b97d61f30294eee07f00380bb2e673828e926d Mon Sep 17 00:00:00 2001
From: Karthik Gopalan <gkarth@codeaurora.org>
Date: Mon, 26 Mar 2018 10:45:32 +0530
Subject: [PATCH 09/13] libc: Add fortify support for kryo memcpy.

Add fortify support for kryo memcpy.

CRs-Fixed: 2212422

Change-Id: Icc8f15bff008792d6b6a1247e916c3f79ed0543f
---
 libc/Android.bp                            |  8 +++++
 libc/arch-arm64/kryo/bionic/__memcpy_chk.S | 42 ++++++++++++++++++++++
 libc/arch-arm64/kryo/bionic/memcpy.S       | 13 -------
 3 files changed, 50 insertions(+), 13 deletions(-)
 create mode 100644 libc/arch-arm64/kryo/bionic/__memcpy_chk.S

diff --git a/libc/Android.bp b/libc/Android.bp
index 6ed17e988..b756c03a6 100644
--- a/libc/Android.bp
+++ b/libc/Android.bp
@@ -829,6 +829,14 @@ cc_library_static {
             srcs: [
                 "arch-arm64/generic/bionic/__memcpy_chk.S",
             ],
+            kryo: {
+                srcs: [
+                    "arch-arm64/kryo/bionic/__memcpy_chk.S",
+                ],
+                exclude_srcs: [
+                    "arch-arm64/generic/bionic/__memcpy_chk.S",
+                ],
+            },
         },
     },
 }
diff --git a/libc/arch-arm64/kryo/bionic/__memcpy_chk.S b/libc/arch-arm64/kryo/bionic/__memcpy_chk.S
new file mode 100644
index 000000000..42177758b
--- /dev/null
+++ b/libc/arch-arm64/kryo/bionic/__memcpy_chk.S
@@ -0,0 +1,42 @@
+/*
+ * Copyright (C) 2017 The Android Open Source Project
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ *  * Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in
+ *    the documentation and/or other materials provided with the
+ *    distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
+ * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
+ * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS
+ * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED
+ * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
+ * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
+ * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
+ * SUCH DAMAGE.
+ */
+
+#include <private/bionic_asm.h>
+
+ENTRY(__memcpy_chk)
+  cmp x2, x3
+  bls memcpy
+
+  // Preserve for accurate backtrace.
+  stp x29, x30, [sp, -16]!
+  .cfi_def_cfa_offset 16
+  .cfi_rel_offset x29, 0
+  .cfi_rel_offset x30, 8
+
+  bl __memcpy_chk_fail
+END(__memcpy_chk)
diff --git a/libc/arch-arm64/kryo/bionic/memcpy.S b/libc/arch-arm64/kryo/bionic/memcpy.S
index 0be2aac83..fc487d3a4 100644
--- a/libc/arch-arm64/kryo/bionic/memcpy.S
+++ b/libc/arch-arm64/kryo/bionic/memcpy.S
@@ -30,19 +30,6 @@
 
 #include <private/bionic_asm.h>
 
-ENTRY(__memcpy_chk)
-  cmp x2, x3
-  bls memcpy
-
-  // Preserve for accurate backtrace.
-  stp x29, x30, [sp, -16]!
-  .cfi_def_cfa_offset 16
-  .cfi_rel_offset x29, 0
-  .cfi_rel_offset x30, 8
-
-  bl __memcpy_chk_fail
-END(__memcpy_chk)
-
 ENTRY(memcpy)
   #include "memcpy_base.S"
 END(memcpy)
-- 
2.17.1

