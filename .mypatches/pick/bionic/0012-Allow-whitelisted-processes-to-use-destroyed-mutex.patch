From b3820aba17091dd191af0fb7252662471b21a3a8 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Sun, 26 Aug 2018 20:44:12 +0200
Subject: [PATCH 12/13] Allow whitelisted processes to use destroyed mutex

Change-Id: I72bd795f71ced1f060ed669db44b647a200fc268
---
 libc/Android.bp               |  8 ++++++++
 libc/bionic/pthread_mutex.cpp | 14 ++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/libc/Android.bp b/libc/Android.bp
index eeeadb672..6b63ca45d 100644
--- a/libc/Android.bp
+++ b/libc/Android.bp
@@ -1540,6 +1540,14 @@ cc_library_static {
         "bionic/fork.cpp",
     ],
 
+    product_variables: {
+        lineage: {
+            target_destroyed_mutex_usage_whitelist: {
+                cppflags: ["-DDESTROYED_MUTEX_USAGE_WHITELIST=\"%s\""],
+            }
+        },
+    },
+
     cppflags: ["-Wold-style-cast"],
     include_dirs: ["bionic/libstdc++/include"],
     name: "libc_pthread",
diff --git a/libc/bionic/pthread_mutex.cpp b/libc/bionic/pthread_mutex.cpp
index 8602d464a..ef447d7b7 100644
--- a/libc/bionic/pthread_mutex.cpp
+++ b/libc/bionic/pthread_mutex.cpp
@@ -789,6 +789,20 @@ static inline __always_inline bool IsMutexDestroyed(uint16_t mutex_state) {
 // ARM64. So make it noinline.
 static int __attribute__((noinline)) HandleUsingDestroyedMutex(pthread_mutex_t* mutex,
                                                                const char* function_name) {
+#ifdef DESTROYED_MUTEX_USAGE_WHITELIST
+    char whitelist[sizeof(DESTROYED_MUTEX_USAGE_WHITELIST)];
+    strcpy(whitelist, DESTROYED_MUTEX_USAGE_WHITELIST);
+
+    const char *progname = getprogname();
+    char *token = strtok(whitelist, " ");
+
+    while (token != NULL) {
+        if (strcmp(token, progname) == 0) {
+            return EBUSY;
+        }
+        token = strtok(whitelist, " ");
+    }
+#endif
     if (bionic_get_application_target_sdk_version() >= __ANDROID_API_P__) {
         (void)(mutex);
         (void)(function_name);
-- 
2.17.1

