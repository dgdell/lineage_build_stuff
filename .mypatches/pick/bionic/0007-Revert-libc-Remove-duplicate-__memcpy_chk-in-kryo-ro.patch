From 3e6983b3c4ffdcab38ccb2ffee06332b97925ba3 Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Fri, 24 Aug 2018 15:20:44 +0200
Subject: [PATCH 07/13] Revert "libc: Remove duplicate __memcpy_chk in kryo
 routines"

This reverts commit 78a1d0ef26b2b709e196e37376cc9d19e489af75.

Change-Id: I777de44b165cb6c2f5501098cbd401467701147f
---
 libc/arch-arm64/kryo/bionic/memcpy.S    | 13 +++++++++++++
 libc/arch-arm64/kryo300/bionic/memcpy.S | 13 +++++++++++++
 2 files changed, 26 insertions(+)

diff --git a/libc/arch-arm64/kryo/bionic/memcpy.S b/libc/arch-arm64/kryo/bionic/memcpy.S
index fc487d3a4..0be2aac83 100644
--- a/libc/arch-arm64/kryo/bionic/memcpy.S
+++ b/libc/arch-arm64/kryo/bionic/memcpy.S
@@ -30,6 +30,19 @@
 
 #include <private/bionic_asm.h>
 
+ENTRY(__memcpy_chk)
+  cmp x2, x3
+  bls memcpy
+
+  // Preserve for accurate backtrace.
+  stp x29, x30, [sp, -16]!
+  .cfi_def_cfa_offset 16
+  .cfi_rel_offset x29, 0
+  .cfi_rel_offset x30, 8
+
+  bl __memcpy_chk_fail
+END(__memcpy_chk)
+
 ENTRY(memcpy)
   #include "memcpy_base.S"
 END(memcpy)
diff --git a/libc/arch-arm64/kryo300/bionic/memcpy.S b/libc/arch-arm64/kryo300/bionic/memcpy.S
index fc487d3a4..0be2aac83 100644
--- a/libc/arch-arm64/kryo300/bionic/memcpy.S
+++ b/libc/arch-arm64/kryo300/bionic/memcpy.S
@@ -30,6 +30,19 @@
 
 #include <private/bionic_asm.h>
 
+ENTRY(__memcpy_chk)
+  cmp x2, x3
+  bls memcpy
+
+  // Preserve for accurate backtrace.
+  stp x29, x30, [sp, -16]!
+  .cfi_def_cfa_offset 16
+  .cfi_rel_offset x29, 0
+  .cfi_rel_offset x30, 8
+
+  bl __memcpy_chk_fail
+END(__memcpy_chk)
+
 ENTRY(memcpy)
   #include "memcpy_base.S"
 END(memcpy)
-- 
2.17.1

