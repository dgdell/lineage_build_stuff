From 77aa3c62abb9223b47b7bf7cc0c5b3f7c8ace8b5 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Fri, 22 Dec 2017 15:28:19 +0100
Subject: [PATCH 06/14] sepolicy: Readd perfd policies

Change-Id: I276c2b254b2c6d58278a19da0ac34f4f4fd962c1
---
 legacy-common/audioserver.te    |  4 ++++
 legacy-common/cameraserver.te   |  2 ++
 legacy-common/file_contexts     |  5 +++++
 legacy-common/mediacodec.te     |  1 +
 legacy-common/perfd.te          | 46 +++++++++++++++++++++++++++++++++++++++++
 legacy-common/surfaceflinger.te |  4 ++++
 legacy-common/system_server.te  |  4 ++++
 7 files changed, 66 insertions(+)
 create mode 100644 legacy-common/audioserver.te
 create mode 100644 legacy-common/cameraserver.te
 create mode 100644 legacy-common/mediacodec.te
 create mode 100644 legacy-common/perfd.te
 create mode 100644 legacy-common/surfaceflinger.te
 create mode 100644 legacy-common/system_server.te

diff --git a/legacy-common/audioserver.te b/legacy-common/audioserver.te
new file mode 100644
index 0000000..ab11974
--- /dev/null
+++ b/legacy-common/audioserver.te
@@ -0,0 +1,4 @@
+# Access to perflock
+allow audioserver mpctl_socket:dir r_dir_perms;
+unix_socket_send(audioserver, mpctl, perfd)
+unix_socket_connect(audioserver, mpctl, perfd)
diff --git a/legacy-common/cameraserver.te b/legacy-common/cameraserver.te
new file mode 100644
index 0000000..8762d22
--- /dev/null
+++ b/legacy-common/cameraserver.te
@@ -0,0 +1,2 @@
+# Interaction with mptcl and thermal sockets
+unix_socket_connect(cameraserver, mpctl, perfd)
diff --git a/legacy-common/file_contexts b/legacy-common/file_contexts
index e17e697..a815a48 100644
--- a/legacy-common/file_contexts
+++ b/legacy-common/file_contexts
@@ -6,5 +6,10 @@
 /sys/devices(/platform)?/soc\.0/[a-z0-9]+.qcom,mdss_mdp/qcom,mdss_fb_primary\.[0-9]+/leds/lcd-backlight(/.*)?   u:object_r:sysfs_graphics:s0
 /sys/devices(/platform)?/soc\.0/[a-z0-9]+.qcom,mdss_mdp/caps   u:object_r:sysfs_graphics:s0
 
+# Perfd
+/(vendor|system/vendor)/bin/perfd     u:object_r:perfd_exec:s0
+/data/system/perfd(/.*)?              u:object_r:mpctl_data_file:s0
+/dev/socket/perfd                     u:object_r:mpctl_socket:s0
+
 # Subsys restart
 /sys/devices(/platform)?/soc\.0/[a-z0-9\.:]+,[a-z0-9\-]+/subsys[0-9]+/name    u:object_r:sysfs_ssr:s0
diff --git a/legacy-common/mediacodec.te b/legacy-common/mediacodec.te
new file mode 100644
index 0000000..e0d7d0a
--- /dev/null
+++ b/legacy-common/mediacodec.te
@@ -0,0 +1 @@
+unix_socket_connect(mediacodec, mpctl, perfd)
diff --git a/legacy-common/perfd.te b/legacy-common/perfd.te
new file mode 100644
index 0000000..03fe599
--- /dev/null
+++ b/legacy-common/perfd.te
@@ -0,0 +1,46 @@
+type perfd, domain;
+type perfd_exec, exec_type, vendor_file_type, file_type;
+
+init_daemon_domain(perfd)
+
+allow perfd {
+    sysfs_devices_system_cpu
+    sysfs_cpu_online
+    sysfs_scsi_host
+    proc
+    sysfs
+}:file rw_file_perms;
+
+# Allow access to devfreq sysfs entry
+r_dir_file(perfd, sysfs_devfreq)
+allow perfd sysfs_devfreq:file write;
+
+# Allow access to msm_perf sysfs entry
+r_dir_file(perfd, sysfs_msm_perf)
+allow perfd sysfs_msm_perf:file write;
+
+# Allow access to msm_power sysfs entry
+r_dir_file(perfd, sysfs_msm_power)
+allow perfd sysfs_msm_power:file write;
+
+# Allow access to lib sysfs entry
+allow perfd sysfs_lib:file w_file_perms;
+
+# Allow access to kgsl sysfs entry
+r_dir_file(perfd, sysfs_kgsl)
+
+# mpctl socket
+allow perfd mpctl_socket:sock_file rw_file_perms;
+
+# default_values file
+allow perfd mpctl_data_file:dir rw_dir_perms;
+allow perfd mpctl_data_file:file create_file_perms;
+
+# Thermal lib access
+unix_socket_connect(perfd, thermal, thermal-engine)
+
+# Allow perfd to set properties
+set_prop(perfd, freq_prop)
+
+allow perfd cgroup:file r_file_perms;
+allow perfd sysfs:dir r_dir_perms;
diff --git a/legacy-common/surfaceflinger.te b/legacy-common/surfaceflinger.te
new file mode 100644
index 0000000..9286faa
--- /dev/null
+++ b/legacy-common/surfaceflinger.te
@@ -0,0 +1,4 @@
+# Access to perflock
+allow surfaceflinger mpctl_socket:dir r_dir_perms;
+unix_socket_send(surfaceflinger, mpctl, perfd)
+unix_socket_connect(surfaceflinger, mpctl, perfd)
diff --git a/legacy-common/system_server.te b/legacy-common/system_server.te
new file mode 100644
index 0000000..ea797ca
--- /dev/null
+++ b/legacy-common/system_server.te
@@ -0,0 +1,4 @@
+# Access to perflock
+allow system_server mpctl_socket:dir r_dir_perms;
+unix_socket_send(system_server, mpctl, perfd)
+unix_socket_connect(system_server, mpctl, perfd)
-- 
2.7.4

