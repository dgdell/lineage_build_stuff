From ccbb6921cb0cc299233dcff7d54fc7f9802be1c6 Mon Sep 17 00:00:00 2001
From: Al Viro <viro@zeniv.linux.org.uk>
Date: Sat, 20 Jul 2013 03:11:32 +0400
Subject: [PATCH 102/132] allow O_TMPFILE to work with O_WRONLY

Change-Id: If1758bafed5fe780665a899fa456417680f3a24c
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
---
 fs/open.c                   | 2 ++
 include/asm-generic/fcntl.h | 4 ++--
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/fs/open.c b/fs/open.c
index bf74d0bf756..e1f610318c3 100644
--- a/fs/open.c
+++ b/fs/open.c
@@ -935,6 +935,8 @@ static inline int build_open_flags(int flags, umode_t mode, struct open_flags *o
 		if ((flags & O_TMPFILE_MASK) != O_TMPFILE)
 			return -EINVAL;
 		acc_mode = MAY_OPEN | ACC_MODE(flags);
+		if (!(acc_mode & MAY_WRITE))
+			return -EINVAL;
 	} else if (flags & O_PATH) {
 		/*
 		 * If we have O_PATH in the open flag. Then we
diff --git a/include/asm-generic/fcntl.h b/include/asm-generic/fcntl.h
index 8f66a146375..acfb6ab2adc 100644
--- a/include/asm-generic/fcntl.h
+++ b/include/asm-generic/fcntl.h
@@ -89,8 +89,8 @@
 #endif
 
 /* a horrid kludge trying to make sure that this will fail on old kernels */
-#define O_TMPFILE (__O_TMPFILE | O_DIRECTORY | O_RDWR)
-#define O_TMPFILE_MASK (__O_TMPFILE | O_DIRECTORY | O_CREAT | O_ACCMODE)      
+#define O_TMPFILE (__O_TMPFILE | O_DIRECTORY)
+#define O_TMPFILE_MASK (__O_TMPFILE | O_DIRECTORY | O_CREAT)      
 
 #ifndef O_NDELAY
 #define O_NDELAY	O_NONBLOCK
-- 
2.17.1

