From 1cbaffba14fbe169000c535a9ef7e5d74bfa455e Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Thu, 3 Jan 2019 17:13:04 +0100
Subject: [PATCH 06/10] su: Make gotos looks sane

Change-Id: I12ffb531a6bb3bdf7e45a2c1978a3268ee68c195
---
 daemon.c | 27 +++++++++++++++++----------
 1 file changed, 17 insertions(+), 10 deletions(-)

diff --git a/daemon.c b/daemon.c
index 80f735be..82d4baa4 100644
--- a/daemon.c
+++ b/daemon.c
@@ -87,14 +87,18 @@ static int recv_fd(int sockfd) {
 
     struct cmsghdr* cmsg = CMSG_FIRSTHDR(&msg);
 
-    if (cmsg == NULL || cmsg->cmsg_len != CMSG_LEN(sizeof(int)) || cmsg->cmsg_level != SOL_SOCKET ||
+    if (cmsg == NULL ||
+        cmsg->cmsg_len != CMSG_LEN(sizeof(int)) ||
+        cmsg->cmsg_level != SOL_SOCKET ||
         cmsg->cmsg_type != SCM_RIGHTS) {
-    error:
-        ALOGE("unable to read fd");
-        exit(-1);
+        goto error;
     }
 
     return *(int*)CMSG_DATA(cmsg);
+
+error:
+    ALOGE("unable to read fd");
+    exit(-1);
 }
 
 /*
@@ -146,10 +150,14 @@ static void send_fd(int sockfd, int fd) {
     }
 
     if (sendmsg(sockfd, &msg, 0) != 1) {
-    error:
-        PLOGE("unable to send fd");
-        exit(-1);
+        goto error;
     }
+
+    return;
+
+error:
+    PLOGE("unable to send fd");
+    exit(-1);
 }
 
 static int read_int(int fd) {
@@ -329,7 +337,7 @@ static int daemon_accept(int fd) {
 
         // In parent, wait for the child to exit, and send the exit code
         // across the wire.
-        int status, code;
+        int code, status;
 
         free(pts_slave);
 
@@ -343,7 +351,7 @@ static int daemon_accept(int fd) {
         // Is the file descriptor actually open?
         if (fcntl(fd, F_GETFD) == -1) {
             if (errno != EBADF) {
-                goto error;
+                return code;
             }
         }
 
@@ -354,7 +362,6 @@ static int daemon_accept(int fd) {
         }
 
         close(fd);
-    error:
         ALOGD("child exited");
         return code;
     }
-- 
2.17.1

