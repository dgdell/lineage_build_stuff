From bb6dfecc050a8a4d3efa96162f01c7530ca68de8 Mon Sep 17 00:00:00 2001
From: Michael Bestas <mkbestas@lineageos.org>
Date: Wed, 20 Dec 2017 22:07:16 +0200
Subject: [PATCH 2/3] cryptfs_hw: Featurize support for waiting on QSEE to
 start

* Match keymaster change to support older blobs

Change-Id: I2d45fe60e0f4bf076d064d6c432740af0b3c840c
---
 Android.bp   | 3 +++
 cryptfs_hw.c | 7 +++++++
 2 files changed, 10 insertions(+)

diff --git a/Android.bp b/Android.bp
index 12e2aa6..ea6cbb0 100644
--- a/Android.bp
+++ b/Android.bp
@@ -18,6 +18,9 @@ cc_library_shared {
 
     product_variables: {
         lineage: {
+            should_skip_waiting_for_qsee: {
+                cflags: ["-DSKIP_WAITING_FOR_QSEE"],
+            },
             supports_legacy_hw_fde: {
                 cflags: ["-DLEGACY_HW_DISK_ENCRYPTION"],
             },
diff --git a/cryptfs_hw.c b/cryptfs_hw.c
index 36d5d48..42bf4c4 100644
--- a/cryptfs_hw.c
+++ b/cryptfs_hw.c
@@ -97,6 +97,12 @@ static inline void* secure_memset(void* v, int c , size_t n)
 }
 
 #ifdef LEGACY_HW_DISK_ENCRYPTION
+#ifdef SKIP_WAITING_FOR_QSEE
+static int is_qseecom_up()
+{
+    return 1;
+}
+#else
 static int is_qseecom_up()
 {
     int i = 0;
@@ -110,6 +116,7 @@ static int is_qseecom_up()
     }
     return 0;
 }
+#endif
 
 static int load_qseecom_library()
 {
-- 
2.17.1

