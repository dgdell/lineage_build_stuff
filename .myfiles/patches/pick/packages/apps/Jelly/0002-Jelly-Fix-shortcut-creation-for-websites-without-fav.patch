From a9666cb99636211768ce46c6855219ec8f23ddb4 Mon Sep 17 00:00:00 2001
From: LuK1337 <priv.luk@gmail.com>
Date: Thu, 8 Nov 2018 14:22:27 +0100
Subject: [PATCH 2/2] Jelly: Fix shortcut creation for websites without favicon

* Fixes: BUGBASH-2490

Change-Id: I2b18ca086b192544711824939c5d7922ff041684
---
 .../java/org/lineageos/jelly/MainActivity.java    | 15 +++++++++------
 1 file changed, 9 insertions(+), 6 deletions(-)

diff --git a/app/src/main/java/org/lineageos/jelly/MainActivity.java b/app/src/main/java/org/lineageos/jelly/MainActivity.java
index 27e4e84..fdb7454 100644
--- a/app/src/main/java/org/lineageos/jelly/MainActivity.java
+++ b/app/src/main/java/org/lineageos/jelly/MainActivity.java
@@ -706,20 +706,23 @@ public class MainActivity extends WebViewExtActivity implements
         intent.setData(Uri.parse(mWebView.getUrl()));
         intent.setAction(Intent.ACTION_MAIN);
 
-        Bitmap icon = mUrlIcon == null ?
-                BitmapFactory.decodeResource(getResources(), R.mipmap.ic_launcher) : mUrlIcon;
-        Bitmap launcherIcon = UiUtils.getShortcutIcon(icon, getThemeColorWithFallback());
+        Icon launcherIcon;
+
+        if (mUrlIcon != null) {
+            launcherIcon = Icon.createWithBitmap(
+                    UiUtils.getShortcutIcon(mUrlIcon, getThemeColorWithFallback()));
+        } else {
+            launcherIcon = Icon.createWithResource(this, R.mipmap.ic_launcher);
+        }
 
         String title = mWebView.getTitle();
         ShortcutInfo shortcutInfo = new ShortcutInfo.Builder(this, title)
                 .setShortLabel(title)
-                .setIcon(Icon.createWithBitmap(launcherIcon))
+                .setIcon(launcherIcon)
                 .setIntent(intent)
                 .build();
 
         getSystemService(ShortcutManager.class).requestPinShortcut(shortcutInfo, null);
-
-        launcherIcon.recycle();
     }
 
     private void setImmersiveMode(boolean enable) {
-- 
2.17.1

