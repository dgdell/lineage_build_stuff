From 5ffd359df9844f05788521ed1a924e44b29e7f66 Mon Sep 17 00:00:00 2001
From: Fabrice Bellet <fabrice@bellet.info>
Date: Mon, 12 Mar 2018 22:10:36 +0100
Subject: [PATCH] Release the wakelock before worker thread termination

This case may happen when a new weather update is immediately scheduled
(for example after the location has changed), while another request is
in progress, and network is not available.

Change-Id: I592a5091425e56d0e3c8e7a50230ec64a9145075
---
 .../lineageos/lockclock/weather/WeatherUpdateService.java   | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/org/lineageos/lockclock/weather/WeatherUpdateService.java b/src/org/lineageos/lockclock/weather/WeatherUpdateService.java
index 711d571..9dd362d 100644
--- a/src/org/lineageos/lockclock/weather/WeatherUpdateService.java
+++ b/src/org/lineageos/lockclock/weather/WeatherUpdateService.java
@@ -313,7 +313,11 @@ public class WeatherUpdateService extends Service {
 
         public void tearDown() {
             if (D) Log.d(TAG, "Tearing down worker thread");
-            if (isProcessing()) mWeatherManager.cancelRequest(mRequestId);
+            if (isProcessing()) {
+                cancelTimeoutAlarm();
+                mWeatherManager.cancelRequest(mRequestId);
+                broadcastAndCleanUp(true);
+            }
             quit();
         }
 
-- 
2.17.1

