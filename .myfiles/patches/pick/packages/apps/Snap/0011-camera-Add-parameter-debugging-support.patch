From 19534ff9ca69c9844645b9d4c9c39c7344d46b57 Mon Sep 17 00:00:00 2001
From: Steve Kondik <shade@chemlab.org>
Date: Mon, 14 Oct 2013 12:25:08 -0700
Subject: [PATCH 011/173] camera: Add parameter debugging support

Change-Id: Ifc1653f0046af169ba36d94796b4d9a3055c6798
---
 src/com/android/camera/PhotoModule.java     |  1 +
 src/com/android/camera/VideoModule.java     |  3 +++
 src/com/android/camera/util/CameraUtil.java | 26 ++++++++++++++++-----
 3 files changed, 24 insertions(+), 6 deletions(-)

diff --git a/src/com/android/camera/PhotoModule.java b/src/com/android/camera/PhotoModule.java
index 6fd9a2636..29ca03ced 100644
--- a/src/com/android/camera/PhotoModule.java
+++ b/src/com/android/camera/PhotoModule.java
@@ -4237,6 +4237,7 @@ public class PhotoModule
                 doModeSwitch = updateCameraParametersPreference();
             }
 
+            CameraUtil.dumpParameters(mParameters);
             mCameraDevice.setParameters(mParameters);
 
             // Switch to gcam module if HDR+ was selected
diff --git a/src/com/android/camera/VideoModule.java b/src/com/android/camera/VideoModule.java
index 55db5a611..db5949224 100644
--- a/src/com/android/camera/VideoModule.java
+++ b/src/com/android/camera/VideoModule.java
@@ -2803,6 +2803,9 @@ public class VideoModule implements CameraModule,
         int jpegQuality = CameraProfile.getJpegEncodingQualityParameter(mCameraId,
                 CameraProfile.QUALITY_HIGH);
         mParameters.setJpegQuality(jpegQuality);
+
+        CameraUtil.dumpParameters(mParameters);
+
         //Call Qcom related Camera Parameters
         qcomSetCameraParameters();
 
diff --git a/src/com/android/camera/util/CameraUtil.java b/src/com/android/camera/util/CameraUtil.java
index 4dbe29132..8d59a2e1c 100755
--- a/src/com/android/camera/util/CameraUtil.java
+++ b/src/com/android/camera/util/CameraUtil.java
@@ -70,6 +70,7 @@ import java.io.Closeable;
 import java.io.IOException;
 import java.lang.reflect.Method;
 import java.text.SimpleDateFormat;
+import java.util.Arrays;
 import java.util.Comparator;
 import java.util.Date;
 import java.util.List;
@@ -91,6 +92,7 @@ import java.util.Collection;
 import java.util.Collections;
 import java.util.Iterator;
 import java.util.Set;
+import java.util.TreeSet;
 
 import static android.content.Context.MODE_PRIVATE;
 
@@ -762,13 +764,25 @@ public class CameraUtil {
         return optimalSize;
     }
 
-    public static void dumpParameters(Parameters parameters) {
-        String flattened = parameters.flatten();
-        StringTokenizer tokenizer = new StringTokenizer(flattened, ";");
-        Log.d(TAG, "Dump all camera parameters:");
-        while (tokenizer.hasMoreElements()) {
-            Log.d(TAG, tokenizer.nextToken());
+    public static void dumpParameters(Parameters params) {
+        Set<String> sortedParams = new TreeSet<String>();
+        sortedParams.addAll(Arrays.asList(params.flatten().split(";")));
+        StringBuilder sb = new StringBuilder();
+        sb.append("[");
+        Iterator<String> i = sortedParams.iterator();
+        while (i.hasNext()) {
+            String nextParam = i.next();
+            if ((sb.length() + nextParam.length()) > 2044) {
+                Log.d(TAG, "Parameters: " + sb.toString());
+                sb = new StringBuilder();
+            }
+            sb.append(nextParam);
+            if (i.hasNext()) {
+                sb.append(", ");
+            }
         }
+        sb.append("]");
+        Log.d(TAG, "Parameters: " + sb.toString());
     }
 
     /**
-- 
2.17.1

