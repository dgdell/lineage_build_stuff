From 9f7f250cf107f0c399ffaee37a67a087ef38d307 Mon Sep 17 00:00:00 2001
From: codeworkx <codeworkx@cyanogenmod.org>
Date: Sun, 21 Feb 2016 11:17:12 +0100
Subject: [PATCH 084/206] Snap: fix camera hang on LGE G4 when flash got used

Change-Id: I23e53333a0bbe2a12e64e87ec8594aeaa503e9fc
---
 src/com/android/camera/PhotoModule.java | 13 ++++++++++---
 1 file changed, 10 insertions(+), 3 deletions(-)

diff --git a/src/com/android/camera/PhotoModule.java b/src/com/android/camera/PhotoModule.java
index 9d59a91c3..f4463fbf3 100644
--- a/src/com/android/camera/PhotoModule.java
+++ b/src/com/android/camera/PhotoModule.java
@@ -1924,9 +1924,16 @@ public class PhotoModule
                     new JpegPictureCallback(loc));
             setCameraState(SNAPSHOT_IN_PROGRESS);
 
-            // LGE G4: Preview needs to be restarted when flash got used while luminance is low
-            if (CameraUtil.isLowLuminance(mParameters)) {
-                setupPreview();
+            // LGE G4: Preview needs to be restarted when flash got used
+            if (CameraUtil.isSupported(mParameters, CameraSettings.KEY_LUMINANCE_CONITION)) {
+                String flashMode = mPreferences.getString(
+                                    CameraSettings.KEY_FLASH_MODE,
+                                    mActivity.getString(R.string.pref_camera_flashmode_default));
+                if (flashMode.equals(Parameters.FLASH_MODE_ON) || 
+                        (!flashMode.equals(Parameters.FLASH_MODE_OFF) &&
+                        CameraUtil.isLowLuminance(mParameters))) {
+                    setupPreview();
+                }
             }
         }
 
-- 
2.17.1

