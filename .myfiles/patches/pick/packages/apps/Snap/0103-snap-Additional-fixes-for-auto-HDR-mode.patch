From ed54d537bcbf0ac33e937a4392c0f71ea9c0c5f5 Mon Sep 17 00:00:00 2001
From: Steve Kondik <steve@cyngn.com>
Date: Sat, 30 Jul 2016 21:37:36 -0700
Subject: [PATCH 103/194] snap: Additional fixes for auto-HDR mode

Change-Id: I0d9b982dc9d817b40d59fc5fa58d542a213a3d1f
---
 src/com/android/camera/PhotoModule.java | 67 +++++++++++++++----------
 1 file changed, 41 insertions(+), 26 deletions(-)

diff --git a/src/com/android/camera/PhotoModule.java b/src/com/android/camera/PhotoModule.java
index 740d27f96..c9a6496d3 100644
--- a/src/com/android/camera/PhotoModule.java
+++ b/src/com/android/camera/PhotoModule.java
@@ -105,6 +105,7 @@ import java.io.FileNotFoundException;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.OutputStream;
+import java.util.Arrays;
 import java.lang.NumberFormatException;
 import java.util.List;
 import java.util.Vector;
@@ -3655,32 +3656,6 @@ public class PhotoModule
 
         String zsl = mPreferences.getString(CameraSettings.KEY_ZSL,
                                   mActivity.getString(R.string.pref_camera_zsl_default));
-        String auto_hdr = mPreferences.getString(CameraSettings.KEY_AUTO_HDR,
-                                       mActivity.getString(R.string.pref_camera_auto_hdr_default));
-        if (CameraUtil.isAutoHDRSupported(mParameters)) {
-            mParameters.set("auto-hdr-enable",auto_hdr);
-            if (auto_hdr.equals("enable")) {
-                mActivity.runOnUiThread(new Runnable() {
-                    public void run() {
-                        if (mDrawAutoHDR != null) {
-                            mDrawAutoHDR.setVisibility(View.VISIBLE);
-                        }
-                    }
-                });
-                mParameters.setSceneMode("asd");
-                mCameraDevice.setMetadataCb(mMetaDataCallback);
-            }
-            else {
-                mAutoHdrEnable = false;
-                mActivity.runOnUiThread( new Runnable() {
-                    public void run () {
-                        if (mDrawAutoHDR != null) {
-                            mDrawAutoHDR.setVisibility (View.INVISIBLE);
-                        }
-                    }
-                });
-            }
-        }
         ParametersWrapper.setZSLMode(mParameters, zsl);
         if(zsl.equals("on") && ParametersWrapper.getSupportedZSLModes(mParameters) != null) {
             //Switch on ZSL Camera mode
@@ -3760,6 +3735,8 @@ public class PhotoModule
                 + mInstantCaptureSnapShot);
         mParameters.set(CameraSettings.KEY_QC_INSTANT_CAPTURE, instantCapture);
 
+        updateAutoHDR();
+
         //Set Histogram
         String histogram = mPreferences.getString(
                 CameraSettings.KEY_HISTOGRAM,
@@ -3888,6 +3865,44 @@ public class PhotoModule
         }
     }
 
+    private void updateAutoHDR() {
+        String autoHdr = mPreferences.getString(CameraSettings.KEY_AUTO_HDR,
+                mActivity.getString(R.string.pref_camera_auto_hdr_default));
+        String advancedFeature = mPreferences.getString(
+                CameraSettings.KEY_ADVANCED_FEATURES,
+                mActivity.getString(R.string.pref_camera_advanced_feature_default));
+
+        if (CameraUtil.isAutoHDRSupported(mParameters)) {
+            if (autoHdr.equals("enable") &&
+                    ("asd".equals(mSceneMode) || "auto".equals(mSceneMode)) &&
+                    CameraUtil.isSupported("asd", mParameters.getSupportedSceneModes()) &&
+                    (advancedFeature == null || "none".equals(advancedFeature))) {
+                mActivity.runOnUiThread(new Runnable() {
+                    public void run() {
+                        if (mDrawAutoHDR != null) {
+                            mDrawAutoHDR.setVisibility(View.VISIBLE);
+                        }
+                    }
+                });
+                mParameters.setSceneMode("asd");
+                mCameraDevice.setMetadataCb(mMetaDataCallback);
+                mParameters.set("auto-hdr-enable", "enable");
+            }
+            else {
+                mAutoHdrEnable = false;
+                mActivity.runOnUiThread( new Runnable() {
+                    public void run () {
+                        if (mDrawAutoHDR != null) {
+                            mDrawAutoHDR.setVisibility (View.INVISIBLE);
+                        }
+                    }
+                });
+                mCameraDevice.setMetadataCb(null);
+                mParameters.set("auto-hdr-enable", "disable");
+            }
+        }
+    }
+
     private void setFlipValue() {
         // Read Flip mode from adb command
         //value: 0(default) - FLIP_MODE_OFF
-- 
2.17.1

