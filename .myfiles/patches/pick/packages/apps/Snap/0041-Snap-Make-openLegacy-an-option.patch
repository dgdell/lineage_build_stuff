From b95a1236fe807a086bd577556665620cf4e7550a Mon Sep 17 00:00:00 2001
From: codeworkx <codeworkx@cyanogenmod.org>
Date: Thu, 22 Dec 2016 20:05:52 +0100
Subject: [PATCH 041/194] Snap: Make openLegacy an option

Using openLegacy on QCamera3 forces it to use QCamera2
and fall back to api v1 which is not what we want on v2 devices.

Change-Id: Ic392a4ae9403ebae36940ddf0727237d9cb9e8f0
---
 res/values/config.xml                         |  6 +++
 .../camera/AndroidCameraManagerImpl.java      | 50 +++++++++++++------
 2 files changed, 40 insertions(+), 16 deletions(-)

diff --git a/res/values/config.xml b/res/values/config.xml
index de0ca1cf6..b998fd277 100644
--- a/res/values/config.xml
+++ b/res/values/config.xml
@@ -28,6 +28,12 @@
          of the fullscreen pano preview. -->
     <bool name="enable_warped_pano_preview">true</bool>
 
+    <!-- Opens back camera using openLegacy() and forces api v1 -->
+    <bool name="back_camera_open_legacy">true</bool>
+
+    <!-- Opens front camera using openLegacy() and forces api v1 -->
+    <bool name="front_camera_open_legacy">true</bool>
+
     <!-- Restart preview for back camera onPictureTaken -->
     <bool name="back_camera_restart_preview_onPictureTaken">false</bool>
 
diff --git a/src/com/android/camera/AndroidCameraManagerImpl.java b/src/com/android/camera/AndroidCameraManagerImpl.java
index cad136cde..228df03b9 100644
--- a/src/com/android/camera/AndroidCameraManagerImpl.java
+++ b/src/com/android/camera/AndroidCameraManagerImpl.java
@@ -21,10 +21,12 @@ import static com.android.camera.util.CameraUtil.Assert;
 import java.io.IOException;
 
 import android.annotation.TargetApi;
+import android.content.Context;
 import android.graphics.SurfaceTexture;
 import android.hardware.Camera;
 import android.hardware.Camera.AutoFocusCallback;
 import android.hardware.Camera.AutoFocusMoveCallback;
+import android.hardware.Camera.CameraInfo;
 import android.hardware.Camera.ErrorCallback;
 import android.hardware.Camera.FaceDetectionListener;
 import android.hardware.Camera.OnZoomChangeListener;
@@ -41,11 +43,13 @@ import android.util.Log;
 import android.view.SurfaceHolder;
 import android.hardware.Camera.CameraDataCallback;
 import android.hardware.Camera.CameraMetaDataCallback;
+import com.android.camera.app.CameraApp;
 import com.android.camera.util.ApiHelper;
 import android.os.ConditionVariable;
 import java.lang.reflect.Method;
 
 import org.codeaurora.snapcam.wrapper.CameraWrapper;
+import org.codeaurora.snapcam.R;
 
 /**
  * A class to implement {@link CameraManager} of the Android camera framework.
@@ -235,28 +239,42 @@ class AndroidCameraManagerImpl implements CameraManager {
             try {
                 switch (msg.what) {
                     case OPEN_CAMERA:
-                        try {
-                            Method openMethod = Class.forName("android.hardware.Camera").getMethod(
-                                    "openLegacy", int.class, int.class);
-                            mCamera = (android.hardware.Camera) openMethod.invoke(
-                                    null, msg.arg1, CAMERA_HAL_API_VERSION_1_0);
-                        } catch (Exception e) {
-                            /* Retry with open if openLegacy doesn't exist/fails */
-                            Log.v(TAG, "openLegacy failed due to " + e.getMessage()
-                                    + ", using open instead");
-                            mCamera = android.hardware.Camera.open(msg.arg1);
+                        final int cameraId = msg.arg1;
+                        Context context = CameraApp.getContext();
+
+                        CameraInfo info = CameraHolder.instance().getCameraInfo()[cameraId];
+
+                        final boolean isBackCamera =
+                                info.facing == CameraInfo.CAMERA_FACING_BACK;
+                        final boolean isFrontCamera =
+                                info.facing == CameraInfo.CAMERA_FACING_FRONT;
+                        final boolean useOpenLegacyForBackCamera = context.getResources()
+                                .getBoolean(R.bool.back_camera_open_legacy);
+                        final boolean useOpenLegacyForFrontCamera = context.getResources()
+                                .getBoolean(R.bool.front_camera_open_legacy);
+
+                        if (isBackCamera && useOpenLegacyForBackCamera ||
+                                isFrontCamera && useOpenLegacyForFrontCamera) {
+                            try {
+                                Method openMethod = Class.forName("android.hardware.Camera")
+                                        .getMethod("openLegacy", int.class, int.class);
+                                mCamera = (android.hardware.Camera) openMethod.invoke(null,
+                                        cameraId, CAMERA_HAL_API_VERSION_1_0);
+                            } catch (Exception e) {
+                                /* Retry with open if openLegacy doesn't exist/fails */
+                                Log.v(TAG, "openLegacy failed due to " + e.getMessage()
+                                        + ", using open instead");
+                                mCamera = android.hardware.Camera.open(cameraId);
+                            }
+                        } else {
+                            mCamera = android.hardware.Camera.open(cameraId);
                         }
 
                         if (mCamera != null) {
                             mParametersIsDirty = true;
-
-                            // Get a instance of Camera.Parameters for later use.
-                            if (mParamsToSet == null) {
-                                mParamsToSet = mCamera.getParameters();
-                            }
                         } else {
                             if (msg.obj != null) {
-                                ((CameraOpenErrorCallback) msg.obj).onDeviceOpenFailure(msg.arg1);
+                                ((CameraOpenErrorCallback) msg.obj).onDeviceOpenFailure(cameraId);
                             }
                         }
                         return;
-- 
2.17.1

