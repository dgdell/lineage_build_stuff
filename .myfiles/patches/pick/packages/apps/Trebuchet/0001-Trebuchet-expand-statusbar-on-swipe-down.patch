From e5fea63a2fa6694d009813edea442a0971aee983 Mon Sep 17 00:00:00 2001
From: Thecrazyskull <anaskarbila@gmail.com>
Date: Sat, 2 Dec 2017 16:37:04 +0100
Subject: [PATCH 1/5] Trebuchet: expand statusbar on swipe down

Change-Id: I5e75b7e1c6806dae9ac2a000e377873319a5f787
Signed-off-by: Joey Rizzoli <joey@lineageos.org>
Signed-off-by: Luca Stefani <luca.stefani.ge1@gmail.com>
---
 AndroidManifest.xml                           |  1 +
 .../uioverrides/SwipeDownListener.java        | 81 +++++++++++++++++++
 .../launcher3/uioverrides/UiFactory.java      |  9 ++-
 res/values/lineage_strings.xml                |  3 +
 res/xml/launcher_preferences.xml              |  7 ++
 5 files changed, 98 insertions(+), 3 deletions(-)
 create mode 100644 quickstep/src/com/android/launcher3/uioverrides/SwipeDownListener.java

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 578e01745..6141d56c9 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -49,6 +49,7 @@
     <uses-permission android:name="com.android.launcher.permission.WRITE_SETTINGS" />
     <uses-permission android:name="com.android.launcher3.permission.READ_SETTINGS" />
     <uses-permission android:name="com.android.launcher3.permission.WRITE_SETTINGS" />
+    <uses-permission android:name="android.permission.EXPAND_STATUS_BAR" />
 
     <application
         android:backupAgent="com.android.launcher3.LauncherBackupAgent"
diff --git a/quickstep/src/com/android/launcher3/uioverrides/SwipeDownListener.java b/quickstep/src/com/android/launcher3/uioverrides/SwipeDownListener.java
new file mode 100644
index 000000000..f4dd99caa
--- /dev/null
+++ b/quickstep/src/com/android/launcher3/uioverrides/SwipeDownListener.java
@@ -0,0 +1,81 @@
+/*
+ * Copyright (C) 2016 The Android Open Source Project
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package com.android.launcher3.uioverrides;
+
+import static com.android.launcher3.LauncherState.NORMAL;
+
+import android.content.Context;
+import android.content.SharedPreferences;
+import android.util.Log;
+import android.view.GestureDetector;
+import android.view.MotionEvent;
+
+import com.android.launcher3.Launcher;
+import com.android.launcher3.Utilities;
+import com.android.launcher3.util.TouchController;
+
+import java.lang.reflect.InvocationTargetException;
+import java.lang.reflect.Method;
+
+public class SwipeDownListener implements TouchController {
+    private static final String PREF_STATUSBAR_EXPAND = "pref_expand_statusbar";
+
+    private GestureDetector mGestureDetector;
+    private Launcher mLauncher;
+
+    public SwipeDownListener(Launcher launcher) {
+        SharedPreferences prefs = Utilities.getPrefs(launcher.getApplicationContext());
+
+        mLauncher = launcher;
+        mGestureDetector = new GestureDetector(launcher,
+                new GestureDetector.SimpleOnGestureListener() {
+            @Override
+            public boolean onFling(MotionEvent e1, MotionEvent e2, float vX, float vy) {
+                if (prefs.getBoolean(PREF_STATUSBAR_EXPAND, true) && e1.getY() < e2.getY()) {
+                    expandStatusBar(launcher);
+                }
+                return true;
+            }
+        });
+    }
+
+    @Override
+    public boolean onControllerInterceptTouchEvent(MotionEvent ev) {
+        if (mLauncher.isInState(NORMAL)) {
+            mGestureDetector.onTouchEvent(ev);
+        }
+        return false;
+    }
+
+    @Override
+    public boolean onControllerTouchEvent(MotionEvent ev) {
+        return false;
+    }
+
+    private void expandStatusBar(Context context) {
+        try {
+            Object service = context.getSystemService("statusbar");
+            Class<?> manager = Class.forName("android.app.StatusBarManager");
+            Method expand = manager.getMethod("expandNotificationsPanel");
+            expand.invoke(service);
+        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException |
+                InvocationTargetException e) {
+            Log.w("Reflection",
+                    "Can't to invoke android.app.StatusBarManager$expandNotificationsPanel");
+        }
+    }
+}
\ No newline at end of file
diff --git a/quickstep/src/com/android/launcher3/uioverrides/UiFactory.java b/quickstep/src/com/android/launcher3/uioverrides/UiFactory.java
index ac9f8634e..a893dafd0 100644
--- a/quickstep/src/com/android/launcher3/uioverrides/UiFactory.java
+++ b/quickstep/src/com/android/launcher3/uioverrides/UiFactory.java
@@ -63,19 +63,22 @@ public class UiFactory {
             return new TouchController[] {
                     launcher.getDragController(),
                     new OverviewToAllAppsTouchController(launcher),
-                    new LauncherTaskViewController(launcher)};
+                    new LauncherTaskViewController(launcher),
+                    new SwipeDownListener(launcher)};
         }
         if (launcher.getDeviceProfile().isVerticalBarLayout()) {
             return new TouchController[] {
                     launcher.getDragController(),
                     new OverviewToAllAppsTouchController(launcher),
                     new LandscapeEdgeSwipeController(launcher),
-                    new LauncherTaskViewController(launcher)};
+                    new LauncherTaskViewController(launcher),
+                    new SwipeDownListener(launcher)};
         } else {
             return new TouchController[] {
                     launcher.getDragController(),
                     new PortraitStatesTouchController(launcher),
-                    new LauncherTaskViewController(launcher)};
+                    new LauncherTaskViewController(launcher),
+                    new SwipeDownListener(launcher)};
         }
     }
 
diff --git a/res/values/lineage_strings.xml b/res/values/lineage_strings.xml
index de030f9fb..96a265409 100644
--- a/res/values/lineage_strings.xml
+++ b/res/values/lineage_strings.xml
@@ -46,4 +46,7 @@
     <!-- Folder titles -->
     <string name="google_title" translatable="false">Google</string>
     <string name="play_folder_title">Play</string>
+
+    <!-- Expand statusbar -->
+    <string name="statusbar_expand">Swipe down to show notifications</string>
 </resources>
diff --git a/res/xml/launcher_preferences.xml b/res/xml/launcher_preferences.xml
index f87d0a046..21d49bc61 100644
--- a/res/xml/launcher_preferences.xml
+++ b/res/xml/launcher_preferences.xml
@@ -74,4 +74,11 @@
         android:title="@string/drawer_show_labels"
         android:defaultValue="true"
         android:persistent="true" />
+
+    <SwitchPreference
+        android:key="pref_expand_statusbar"
+        android:title="@string/statusbar_expand"
+        android:defaultValue="true"
+        android:persistent="true" />
+
 </PreferenceScreen>
-- 
2.17.1

