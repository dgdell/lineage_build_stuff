From 56e417033d0955b33aae6c512a928ecc89b8a980 Mon Sep 17 00:00:00 2001
From: Michael W <baddaemon87@gmail.com>
Date: Tue, 7 Jun 2016 21:05:00 +0200
Subject: [PATCH 52/67] Gallery2: Remove more possible NPEs

getCache can return null ->
check this before proceeding

Change-Id: I834780a4dafbe22f2d345fe5571cb20f3f3e5e2e
---
 src/com/android/gallery3d/app/MoviePlayer.java        | 1 +
 src/com/android/gallery3d/data/ImageCacheService.java | 6 ++++++
 2 files changed, 7 insertions(+)

diff --git a/src/com/android/gallery3d/app/MoviePlayer.java b/src/com/android/gallery3d/app/MoviePlayer.java
index 980400927..cd715332c 100755
--- a/src/com/android/gallery3d/app/MoviePlayer.java
+++ b/src/com/android/gallery3d/app/MoviePlayer.java
@@ -1703,6 +1703,7 @@ class Bookmarker {
             BlobCache cache = CacheManager.getCache(mContext,
                     BOOKMARK_CACHE_FILE, BOOKMARK_CACHE_MAX_ENTRIES,
                     BOOKMARK_CACHE_MAX_BYTES, BOOKMARK_CACHE_VERSION);
+            if (cache == null) return null;
 
             byte[] data = cache.lookup(uri.hashCode());
             if (data == null) return null;
diff --git a/src/com/android/gallery3d/data/ImageCacheService.java b/src/com/android/gallery3d/data/ImageCacheService.java
index 129c113a6..861d4b766 100644
--- a/src/com/android/gallery3d/data/ImageCacheService.java
+++ b/src/com/android/gallery3d/data/ImageCacheService.java
@@ -56,6 +56,8 @@ public class ImageCacheService {
      * @return true if the image data is found; false if not found.
      */
     public boolean getImageData(Path path, long timeModified, int type, BytesBuffer buffer) {
+        if (mCache == null) return false;
+
         byte[] key = makeKey(path, timeModified, type);
         long cacheKey = Utils.crc64Long(key);
         try {
@@ -81,6 +83,8 @@ public class ImageCacheService {
     }
 
     public void putImageData(Path path, long timeModified, int type, byte[] value) {
+        if (mCache == null) return;
+
         byte[] key = makeKey(path, timeModified, type);
         long cacheKey = Utils.crc64Long(key);
         ByteBuffer buffer = ByteBuffer.allocate(key.length + value.length);
@@ -99,6 +103,8 @@ public class ImageCacheService {
     }
 
     public void clearImageData(Path path, long timeModified, int type) {
+        if (mCache == null) return;
+
         byte[] key = makeKey(path, timeModified, type);
         long cacheKey = Utils.crc64Long(key);
         if (mCache == null) {
-- 
2.17.1

