From 252b703398f14ab0aaad9a2a8f07ef2a5b972db8 Mon Sep 17 00:00:00 2001
From: Artem Borisov <dedsa2002@gmail.com>
Date: Wed, 19 Sep 2018 17:02:06 +0300
Subject: [PATCH 1/4] Telephony: Support muting by RIL command

While almost everyone already moved to AudioManager years ago,
some OEMs (cough Huawei) still use RIL for muting and don't
promote the necessary calls in their audio HAL.
Let's handle these odd cases too when it's necessary.

Change-Id: Id916dec2574d6e57b6f809fbaf2b0959c0cc7256
---
 res/values/config.xml                               |  2 +-
 .../services/telephony/TelephonyConnection.java     | 13 +++++++++++++
 2 files changed, 14 insertions(+), 1 deletion(-)

diff --git a/res/values/config.xml b/res/values/config.xml
index 855fa925c..ba94790c3 100644
--- a/res/values/config.xml
+++ b/res/values/config.xml
@@ -96,7 +96,7 @@
     <!-- Determine whether calls to mute the microphone in PhoneUtils
          are routed through the android.media.AudioManager class (true) or through
          the com.android.internal.telephony.Phone interface (false). -->
-    <bool name="send_mic_mute_to_AudioManager">false</bool>
+    <bool name="send_mic_mute_to_AudioManager">true</bool>
 
     <!-- Determines if device implements a noise suppression device for in call audio-->
     <!-- DEPRECATED: Use CarrierConfigManager#KEY_HAS_IN_CALL_NOISE_SUPPRESSION_BOOL -->
diff --git a/src/com/android/services/telephony/TelephonyConnection.java b/src/com/android/services/telephony/TelephonyConnection.java
index db4cc1018..c4ff6fe14 100644
--- a/src/com/android/services/telephony/TelephonyConnection.java
+++ b/src/com/android/services/telephony/TelephonyConnection.java
@@ -670,6 +670,11 @@ abstract class TelephonyConnection extends Connection implements Holdable {
      */
     private boolean mShowPreciseFailedCause;
 
+    /**
+     * Indicates whether this device supports muting via AudioManager.
+     */
+    private boolean mSendMicMuteToAudioManager = true;
+
     /**
      * Listeners to our TelephonyConnection specific callbacks
      */
@@ -683,6 +688,11 @@ abstract class TelephonyConnection extends Connection implements Holdable {
         if (originalConnection != null) {
             setOriginalConnection(originalConnection);
         }
+        Phone phone = getPhone();
+        if (phone != null) {
+            mSendMicMuteToAudioManager = phone.getContext().getResources().getBoolean(
+                    R.bool.send_mic_mute_to_AudioManager);
+        }
     }
 
     /**
@@ -697,6 +707,9 @@ abstract class TelephonyConnection extends Connection implements Holdable {
         // TODO: update TTY mode.
         if (getPhone() != null) {
             getPhone().setEchoSuppressionEnabled();
+            if (!mSendMicMuteToAudioManager) {
+                getPhone().setMute(audioState.isMuted());
+            }
         }
     }
 
-- 
2.17.1

