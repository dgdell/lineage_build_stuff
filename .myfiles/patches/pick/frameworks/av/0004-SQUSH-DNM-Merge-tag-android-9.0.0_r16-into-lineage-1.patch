From 7ed67b9af22834ae5577257b18b363d93190cc6c Mon Sep 17 00:00:00 2001
From: Luca Stefani <luca.stefani.ge1@gmail.com>
Date: Tue, 6 Nov 2018 14:48:59 +0100
Subject: [PATCH 4/5] [SQUSH][DNM] Merge tag 'android-9.0.0_r16' into
 lineage-16.0

commit 59a2058610bb56c26120e256c0cf4198af1d901d
Merge: 3c99bb4e5 083263937
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Mon Sep 10 23:21:09 2018 +0000

    Merge cherrypicks of [4986743, 4986744, 4987539, 4987168, 4986376, 4986377, 4986378, 4986889, 4986745, 4986746, 4986747, 4986748, 4986749, 4986750, 4986773, 4987169, 4987170, 4987611, 4987631, 4987632, 4987633, 4987634, 4986890, 4987612, 4987651, 4987598, 4987613, 4987614, 4987615, 4987599, 4986379, 4986380, 4987652, 4987653, 4987691, 4986774] into pi-qpr1-release

    Change-Id: I8b14c931d6192636f154f39319c51aa8b4d7527b

commit 083263937bfb1623adf6015da7ca3cdc258e0352
Author: Sungtak Lee <taklee@google.com>
Date:   Tue Aug 7 18:01:50 2018 -0700

    NuPlayer2CCDecoder: Add bound check before memcpy

    Test: none
    Bug: 111874331
    Change-Id: I6764802e8e8afd7e970ee433741f73a9b3d366dd
    (cherry picked from commit 71920217d6017a5112ecd73abc4e68c16d680458)
    (cherry picked from commit e96c64a0d21d1ab2c9ba9726766fd8432462888a)

commit efe34a570d91b826b009d40e44c2e470dd180ace
Author: Chong Zhang <chz@google.com>
Date:   Fri Aug 24 14:49:33 2018 -0700

    Fix race condition for cas sessions

    Change the session to shared_ptr and use atomic_load/store.

    Test: POC; CTS MediaCasTest; CTS MediaDrmClearkeyTest#
    testClearKeyPlaybackMpeg2ts
    bug: 113027383

    Change-Id: I75f4cb33a022f28d45918442d64c5c46df2640ef
    (cherry picked from commit 7934a8f7ee0988b181980b9e6f24ca7dd357f5e3)

commit 3c99bb4e5e6157eb085d12807bdc38d7fd60f888
Merge: 2fb20ff25 5d2ca663c
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Aug 23 03:03:29 2018 +0000

    Snap for 4972147 from 5d2ca663c2144548f4236060732fe07eec6a0273 to pi-qpr1-release

    Change-Id: I13e11c9bee8952380345886234bbf1ff604be6a6

commit 2fb20ff256ae5115a732ed9099d87ffad37deac1
Merge: a1b7d63d2 3e4991757
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Aug 22 03:14:25 2018 +0000

    Snap for 4969136 from 3e49917579411b540b770d0edf3987944fb443da to pi-qpr1-release

    Change-Id: Id6735de8015399df65835da9cbbd1e33b1cfd787

commit 5d2ca663c2144548f4236060732fe07eec6a0273
Author: Yiwei Zhang <zzyiwei@google.com>
Date:   Tue Aug 21 15:13:36 2018 -0700

    Get screenrecord to exclude black cutout

    Bug: b/112869712
    Test: adb shell screenrecord
    Change-Id: I69b497b81cfca93a8ad9ed46f25cdbb5dda81a89
    Merged-In: I69b497b81cfca93a8ad9ed46f25cdbb5dda81a89

commit 3e49917579411b540b770d0edf3987944fb443da
Merge: 32b8c20db a3aa0f377
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Aug 21 04:12:21 2018 +0000

    Merge "Fix detected integer sanitization" into pi-dev

commit a1b7d63d20c16c4602699f6ea99c22ae64e2effa
Merge: 0d6dace0e 32b8c20db
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Aug 21 03:14:29 2018 +0000

    Snap for 4966094 from 32b8c20dbc5a82252c7c21e42a95065908da626d to pi-qpr1-release

    Change-Id: I7732bad6cb0d6812e27b70330ab6f921862cf747

commit 32b8c20dbc5a82252c7c21e42a95065908da626d
Author: Eino-Ville Talvala <etalvala@google.com>
Date:   Mon Aug 20 10:27:58 2018 -0700

    Camera service: Extend UID check timeout to 300ms.

    Also make the timeout sleeping more granular, so that the wait
    won't always be 300ms in case the initial checks fail.

    Test: Camera CTS passes
    Bug: 110840510
    Change-Id: I3f0d09913b10526dd27cecca50c111712da82846

commit 0d6dace0ec7c1594781c9c12d2d5344f69666109
Merge: 8f1a4605f 11e0589b4
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Fri Aug 17 03:02:26 2018 +0000

    Snap for 4959688 from 11e0589b4dea913f66668ea483dd52eed3d3869b to pi-qpr1-release

    Change-Id: I11eafb10d5628acbb1c2579da94a5220b5e76f91

commit 8f1a4605f6198371c8da7d514d3fa2c00dcbb7d3
Merge: 3cd77b1f1 38b87fea5
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Aug 16 03:05:46 2018 +0000

    Snap for 4957529 from 38b87fea5346c1f93b59c6c08648fe3c90dfb501 to pi-qpr1-release

    Change-Id: I01ebd9cc240af288b530042fe07e806f1b8b4e27

commit 11e0589b4dea913f66668ea483dd52eed3d3869b
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Wed Aug 15 13:59:56 2018 -0700

    Camera: Documentation update to remove physicalIds

    Public API doesn't see android.logicalcam.physicalIds. Remove it
    from public doc.

    Bug: 112655222
    Test: Manual reading of modified text
    Change-Id: I111a57d6dbdbd2f10df5e440c34ee8526918e134

commit 38b87fea5346c1f93b59c6c08648fe3c90dfb501
Merge: 22fca9cd6 72b157869
Author: Jeff Tinker <jtinker@google.com>
Date:   Wed Aug 15 05:44:30 2018 -0700

    [automerger skipped] [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0 am: c88022c3de am: eea2ec03a4 am: 949bb98535 skipped: 1e3a02a61c am: 0b127b39f5 am: feeda6ddb0
    am: 72b1578695  -s ours

    Change-Id: I189c8e579479a1f70b4d736236bc30762f75b9c9

commit 72b1578695fa1d541800895a1595317c12415f74
Merge: f19106c7c feeda6ddb
Author: Jeff Tinker <jtinker@google.com>
Date:   Wed Aug 15 05:06:03 2018 -0700

    [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0 am: c88022c3de am: eea2ec03a4 am: 949bb98535 skipped: 1e3a02a61c am: 0b127b39f5
    am: feeda6ddb0

    Change-Id: I5b74913b0d90ed40651f8e2d276bfb4f80e0d4ce

commit feeda6ddb0bc57eddb2d4468dc478ab6ac5ef1cb
Merge: dd57ac5b2 0b127b39f
Author: Jeff Tinker <jtinker@google.com>
Date:   Wed Aug 15 01:44:59 2018 -0700

    [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0 am: c88022c3de am: eea2ec03a4 am: 949bb98535 skipped: 1e3a02a61c
    am: 0b127b39f5

    Change-Id: Iffead21fcb5bd624ee95160faec39eb02ad8d981

commit 22fca9cd6248868e96cd3abb99b25d74948baada
Merge: 0c6fa0439 f19106c7c
Author: Jeff Tinker <jtinker@google.com>
Date:   Wed Aug 15 01:23:12 2018 -0700

    Merge "Fix information disclosure in mediadrmserver" into oc-dev am: f452267ae8 am: dd57ac5b26
    am: f19106c7cc

    Change-Id: I793b94bfbb7305bffcdd1c8c44fa989a10f3a4af

commit f19106c7cc11e62411677d8f4a4059e315bf8279
Merge: fc842287c dd57ac5b2
Author: Jeff Tinker <jtinker@google.com>
Date:   Tue Aug 14 21:20:16 2018 -0700

    Merge "Fix information disclosure in mediadrmserver" into oc-dev am: f452267ae8
    am: dd57ac5b26

    Change-Id: I6bf2cbd05b71fc09320de267c89210319be427a6

commit 3cd77b1f1ef05a378cb45029b9442a86b98c6914
Merge: 5fe99bad5 0c6fa0439
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Aug 15 03:14:44 2018 +0000

    Snap for 4954419 from 0c6fa04393feee62429a8d672f194f430c122dea to pi-qpr1-release

    Change-Id: I68dd3936c5631e09440369d7ede563b02a356342

commit 0b127b39f5940099a498e1d7c9a1a678ce2fa39b
Merge: f452267ae 1e3a02a61
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 15 03:06:13 2018 +0000

    [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0 am: c88022c3de am: eea2ec03a4 am: 949bb98535 skipped: 1e3a02a61c

    Change-Id: Iee5d340f7a878129ed8118fcf40291b7ca0040d7

commit 1e3a02a61c1d381c365c5295fc2ced702df4d170
Merge: 457277787 949bb9853
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 15 03:06:11 2018 +0000

    [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0 am: c88022c3de am: eea2ec03a4 am: 949bb98535

    Change-Id: I52549e142d262a3c32996d2a70b86963e1e79a37

commit 949bb9853554f36e9887d26c75d322d426453bdb
Merge: 7b432adb1 eea2ec03a
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 15 03:06:10 2018 +0000

    [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0 am: c88022c3de am: eea2ec03a4

    Change-Id: I1b459a5507a259d12ee1bb7c8a94870554bc1ca4

commit eea2ec03a47164952c309be720f72012521e40bb
Merge: 1d1379f47 c88022c3d
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 15 03:06:08 2018 +0000

    [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0 am: c88022c3de

    Change-Id: I216ce9065f3a5ecd26add57b7f9bad8d16fe330d

commit c88022c3de609a177fc595eea128697fd791d3f0
Merge: fe8dc0611 ecb2df5bc
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 15 03:06:06 2018 +0000

    [automerger] Fix information disclosure in mediadrmserver DO NOT MERGE am: ecb2df5bc0

    Change-Id: Iba22b0efec9ee75ee535c10a0415b4a1e70adfb0

commit ecb2df5bc0c13fc7d7370f27017178111cd7727e
Author: Jeff Tinker <jtinker@google.com>
Date:   Fri Jul 13 16:58:04 2018 -0700

    Fix information disclosure in mediadrmserver DO NOT MERGE

    Test:POC provided in bug
    Bug:79218474
    Change-Id: Ida9323dc1939e3c6e9fffe302bc8284d181817a7

commit dd57ac5b265b50dc90fb01750f64f901a2f5b048
Merge: 960c43e6f f452267ae
Author: Jeff Tinker <jtinker@google.com>
Date:   Tue Aug 14 18:11:33 2018 -0700

    Merge "Fix information disclosure in mediadrmserver" into oc-dev
    am: f452267ae8

    Change-Id: I96ab0c115e78c10930a9bd12837b422f8cd8bce5

commit f452267ae8b167c108c060694aa60f6f9674dcb6
Merge: 1b227ecd3 c1bf68a8d
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Aug 14 23:49:37 2018 +0000

    Merge "Fix information disclosure in mediadrmserver" into oc-dev

commit 0c6fa04393feee62429a8d672f194f430c122dea
Merge: bca21402a fc842287c
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Aug 14 10:41:52 2018 -0700

    [automerger] Check for overflow of crypto size am: d1fd027612 am: fe8dc06116 am: 1d1379f47d am: 7b432adb13 am: 4572777872 am: 1b227ecd31 am: 960c43e6f5
    am: fc842287cc

    Change-Id: I5cbac23cf714e2198f60e8f0b24e87d07e068c74

commit fc842287cc2c1397c03a48f6d60a54e4dcf109f4
Merge: ff404db0d 960c43e6f
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Aug 14 10:30:37 2018 -0700

    [automerger] Check for overflow of crypto size am: d1fd027612 am: fe8dc06116 am: 1d1379f47d am: 7b432adb13 am: 4572777872 am: 1b227ecd31
    am: 960c43e6f5

    Change-Id: I25778ee7a8acbafcb9fe4249fd2c8857612bb180

commit 960c43e6f5dc9b0683e80f5cd04fa8d5a73426ce
Merge: 9353b051f 1b227ecd3
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Aug 14 10:21:28 2018 -0700

    [automerger] Check for overflow of crypto size am: d1fd027612 am: fe8dc06116 am: 1d1379f47d am: 7b432adb13 am: 4572777872
    am: 1b227ecd31

    Change-Id: Iac94e76d0c99846da1b1b9cc2dbef180640eec1a

commit 5fe99bad5dd4b0c92cfba237f2947ceb03cb461a
Merge: 84287719f bca21402a
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Thu Aug 9 03:04:31 2018 +0000

    Snap for 4942392 from bca21402a34ecc676d23ef137b78cd131762f6c0 to pi-qpr1-release

    Change-Id: Ie514f3d9280f6fd6073a183bd914dd2c58f14887

commit bca21402a34ecc676d23ef137b78cd131762f6c0
Merge: fcb8fd352 4ae244cab
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Aug 8 17:48:58 2018 +0000

    Merge "Set rlimit rtprio for cameraserver" into pi-dev

commit 84287719fe7c721aad66a6f1776fd1ef118044db
Merge: 4e79635ea fcb8fd352
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Wed Aug 8 03:01:19 2018 +0000

    Snap for 4939496 from fcb8fd352a4ab57e16d72695883533b30f630143 to pi-qpr1-release

    Change-Id: If936b7d4cc4d531fb367f16131d934658b919b76

commit fcb8fd352a4ab57e16d72695883533b30f630143
Author: Ray Essick <essick@google.com>
Date:   Tue Aug 7 09:39:38 2018 -0700

    Rework NuPlayer::getStats() synchronization

    undo earlier change moving this to the handler thread, instead using
    a mutex to protect the contended resources: mAudioDecoder and
    mVideoDecoder.

    Bug: 110855771
    Bug: 78365291
    Bug: 111910846
    Test: playback with persist.debug.sfstats=={0,1}
    Change-Id: If8822dba9dae6ac0698b142166604371cd6742b2

commit 4ae244cab4fe715fc2729e906b7dda3075fbbac3
Author: Philip Cuadra <philipcuadra@google.com>
Date:   Fri Aug 3 11:22:11 2018 -0700

    Set rlimit rtprio for cameraserver

    Set rlimit rtprio for cameraserver to allow it to inherit rt priority
    via binder priority inheritance.

    Bug:  80502612
    Test: confirmed rt prio inheritance via systrace
    Change-Id: I916370981690126c7c5302699c7c1bf5b6052685

commit 4e79635ea806116e55be77a700b9705de1c5d7da
Merge: 8cf7a263e b9e822981
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Aug 7 03:02:06 2018 +0000

    Snap for 4937098 from b9e822981c6f0204d7d592ae0438b7c3ce8ba0d1 to pi-qpr1-release

    Change-Id: I30d14ee18f9955a17c760e59b7fd3128556a2bd8

commit b9e822981c6f0204d7d592ae0438b7c3ce8ba0d1
Merge: 306a06900 ec1a9b524
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Aug 7 00:36:09 2018 +0000

    Merge "SoftXaac: Handle error cases when decoder fails to initialize" into pi-dev

commit ec1a9b524cbbddd16f2c730c35f54b3a05f4c9a0
Author: Harish Mahendrakar <harish.mahendrakar@ittiam.com>
Date:   Fri Aug 3 17:05:48 2018 -0700

    SoftXaac: Handle error cases when decoder fails to initialize

    When decoder fails to initialize, it doesn't consume any bytes in
    subsequent process call. Avoid this by returning an error when decoder
    is not initialized before first process call.

    Bug: 112194305
    Test: cts-tradefed run commandAndExit cts-dev -m CtsSecurityTestCases\
     -t android.security.cts.StagefrightTest#testStagefright_c_2016_2428

    Change-Id: I38ef56e8ff544567c3219c03dc6133c1ef98f3b3

commit 8cf7a263e9ccadf2a5543f9c5767484df67b2b4a
Merge: 2d6e14bb8 306a06900
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Mon Aug 6 03:04:24 2018 +0000

    Snap for 4933870 from 306a06900b25b5ccd393fb08a6637d74f84e166f to pi-qpr1-release

    Change-Id: I6c05d220f013b5e808cea024f5540b2b7e6bb83b

commit 306a06900b25b5ccd393fb08a6637d74f84e166f
Author: Eino-Ville Talvala <etalvala@google.com>
Date:   Wed Aug 1 17:23:36 2018 -0700

    Camera: Documentation updates for calibration and distortion correction

    - Add more notes on coordinate axes
    - Add more text on metadata when distortion correction is active
    - Note that poseTranslation needs to be negated in many use cases
    - Fix coordinate system references for OIS reporting, add more information
    - Note that pixel centers at half-integers for the camera API metadata
      such as lens intrinsics

    Bug: 79371566
    Bug: 74434422
    Bug: 109742048
    Bug: 109834325
    Bug: 109817371
    Bug: 112107924
    Test: Manual reading of added text
    Change-Id: I8609e951c5045d0e918b2c791fcbe50dc8d0873f

commit 1b227ecd315e902630af71c7d2b34e8f5250a01c
Merge: 11eddd5a2 457277787
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 1 17:33:17 2018 +0000

    [automerger] Check for overflow of crypto size am: d1fd027612 am: fe8dc06116 am: 1d1379f47d am: 7b432adb13 am: 4572777872

    Change-Id: I61f454707ead459e64c810548032c99856b96467

commit 4572777872c494ca442ff433d448cbecb94bb11d
Merge: c60f2ff6b 7b432adb1
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 1 17:33:15 2018 +0000

    [automerger] Check for overflow of crypto size am: d1fd027612 am: fe8dc06116 am: 1d1379f47d am: 7b432adb13

    Change-Id: Id71c686d3c894e1b1dbab0ff01432698a41981f4

commit 7b432adb13ef12b3d989c729626e286fe2cef779
Merge: 17ae20876 1d1379f47
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 1 17:33:14 2018 +0000

    [automerger] Check for overflow of crypto size am: d1fd027612 am: fe8dc06116 am: 1d1379f47d

    Change-Id: I909560dad9565c5113c8432842934b66971ff511

commit 1d1379f47dd975f9e9a86940e927e0ca5335d70e
Merge: b7b790ef8 fe8dc0611
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 1 17:33:12 2018 +0000

    [automerger] Check for overflow of crypto size am: d1fd027612 am: fe8dc06116

    Change-Id: I9d6534a3b64e57922cf033b70535b7d2544f1cf2

commit fe8dc06116d0a172774a226158458443a76e6ccb
Merge: a3acb4c0f d1fd02761
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Wed Aug 1 17:33:09 2018 +0000

    [automerger] Check for overflow of crypto size am: d1fd027612

    Change-Id: I065fd02eeebfacd1e525bf52d0b17787ab8db9b2

commit d1fd02761236b35a336434367131f71bef7405c9
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jul 31 15:12:51 2018 -0700

    Check for overflow of crypto size

    Bug: 111603051
    Test: CTS
    Change-Id: Ib5b1802b9b35769a25c16e2b977308cf7a810606

commit 2d6e14bb81eb3842c6d3172d52d62a3cc34c7e3e
Merge: 96d34e016 29ac15a48
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Tue Jul 31 03:13:18 2018 +0000

    Snap for 4922203 from 29ac15a480e7114ce109ca6bdc19ea75725b19b2 to pi-qpr1-release

    Change-Id: Ifb531ae022888d23d3dd8f828193a018ccc42006

commit 29ac15a480e7114ce109ca6bdc19ea75725b19b2
Merge: 155af760e 44b042cac
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jul 31 01:13:57 2018 +0000

    Merge "Abort read() after CameraSource has stopped" into pi-dev

commit 155af760ed105c02f5cd1930e5b9e7934d6a81df
Merge: 7794b6cdc d5523ea59
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jul 30 22:39:18 2018 +0000

    Merge "media sync: forcefully limit correction by VideoFrameScheduler." into pi-dev

commit 7794b6cdcf92727a01836142880180df682326a0
Merge: 210ba5c4d ea8ebd5fc
Author: Eric Laurent <elaurent@google.com>
Date:   Mon Jul 30 22:36:20 2018 +0000

    Merge "audio policy: fix regression in Audio MMAP device selection" into pi-dev

commit ea8ebd5fcbfe399c7876909e2e680d59fba59cf0
Author: Eric Laurent <elaurent@google.com>
Date:   Mon Jul 23 14:15:40 2018 -0700

    audio policy: fix regression in Audio MMAP device selection

    Commit f3a5a601 caused a regression for AAudio MMAP playback use case
    where disconnecting currently selected device does not generate a
    disconnect callback to client causing silent audio until the
    stream is closed and reopened.

    This CL fixes a logical flaw in method SessionRouteMap::getActiveDeviceForStream()
    introduced by commit f3a5a601 causing a stale forced device to be
    returned after this device was disconnected.

    Bug: 111711159
    Bug: 79878501
    Test: CTS tests for audi routing and AAudio. Audio smoke tests
    Merged-In: Ibb16e26bc59b9e3f99bc74eb944601c6be5026dd
    Change-Id: Ibb16e26bc59b9e3f99bc74eb944601c6be5026dd

commit 96d34e016b4e4c4b5b70e19d4a81f44888a43c10
Merge: a3d1098ec 210ba5c4d
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Mon Jul 30 03:13:22 2018 +0000

    Snap for 4920102 from 210ba5c4da9391e06dbb9bf624783e747d192b04 to pi-qpr1-release

    Change-Id: I11a8f33878c17fe9b97bb541a0a8a364540c2283

commit 44b042cacaf79836bc982de2e889fc46d291c613
Author: Pawin Vongmasa <pawin@google.com>
Date:   Thu Jul 26 12:11:05 2018 -0700

    Abort read() after CameraSource has stopped

    Before this change, CameraSource::read() may loop forever if
    - setStopTimeUs() is called when there are no pending unprocessed
    frames; and
    - New frames that arrive after setStopTimeUs() was called have timestamps
    greater than what was passed to setStopTimeUs().

    This change makes read() return ERROR_END_OF_STREAM in this situation.

    Test: cts-tradefed run cts -m CtsMediaTestCases \
    -t android.media.cts.MediaRandomTest#testRecorderRandomAction

    Test: cts-tradefed run cts -m CtsCameraTestCases \
    -t android.hardware.camera2.cts.FastBasicsTest

    Bug: 111661316
    Change-Id: I4db4011849dbf9cc4b31e7f142017a650e4d0ed7

commit a3d1098ec00619daec5278fcfeca4643c44212ec
Merge: bb7f3c5ee 46ba387b0
Author: android-build-team Robot <android-build-team-robot@google.com>
Date:   Fri Jul 27 03:15:16 2018 +0000

    Snap for 4916303 from 46ba387b026a3325a254f014f0f41548afba04c5 to pi-qpr1-release

    Change-Id: Ib7f3ce69298dd640475eee3f450707a5197b9b0e

commit 210ba5c4da9391e06dbb9bf624783e747d192b04
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Wed Jul 25 16:47:40 2018 -0700

    Camera: Handle abandoned surface in finishConfiguration

    It's possible that surface for a stream goes away after
    cameraservice configures HAL stream, either during configure_streams
    or when session parameters are updated.

    In this case, do not put camera device in an error state.

    Test: Camera CTS, GCA
    Bug: 111581884
    Change-Id: I7efc5aa22bc9b60ffaea23d8dae275f9a2bd026d

commit c1bf68a8d1321d7cdf7da6933f0b89b171d251c6
Author: Jeff Tinker <jtinker@google.com>
Date:   Tue Jul 24 14:13:13 2018 -0700

    Fix information disclosure in mediadrmserver

    Test:POC provided in bug
    Bug:79218474
    Change-Id: Iba12c07a5e615f8ed234b01ac53e3559ba9ac12e

commit 46ba387b026a3325a254f014f0f41548afba04c5
Merge: 6497af909 3a31de26d
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Mon Jul 23 21:59:28 2018 +0000

    Merge "stagefright: limit software renderer for actual OMX components" into pi-dev

commit 6497af909a1218a842ae65f12f7d1f4c98159580
Merge: 72714f997 b2f18166f
Author: Nadav Bar <nadavbar@google.com>
Date:   Sun Jul 22 06:48:28 2018 +0000

    Merge "Allow playing output to default output device when during uplink playback" into pi-dev

commit 3a31de26d3d82fddd26fcbe115c94013e7204094
Author: Wonsik Kim <wonsik@google.com>
Date:   Fri Jul 20 14:52:30 2018 -0700

    stagefright: limit software renderer for actual OMX components

    Bug: 111605816
    Test: atest CtsMediaTestCases:VideoEncoderTest
    Change-Id: I1ad7267f823abec99b73093be04e5ec38ff3c162

commit 72714f997a33cb85d05bfa34fdf497b18222a3ff
Merge: bb7f3c5ee 921893fd4
Author: Wonsik Kim <wonsik@google.com>
Date:   Fri Jul 20 00:55:51 2018 +0000

    Merge "stagefright: MediaCodec to allocate by owner" into pi-dev

commit 921893fd4f3196b8154ccf9051cc3cf35926e0c0
Author: Wonsik Kim <wonsik@google.com>
Date:   Thu Jul 12 10:32:24 2018 -0700

    stagefright: MediaCodec to allocate by owner

    Bug: 111605816
    Test: adb shell stagefright -p
    Change-Id: I33d25ae707e151d4c703140acef730b10296f426

commit bb7f3c5ee905896c5ed6efa3920e13bc1aed49b9
Merge: b14fef4ab 66a38580f
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Thu Jul 19 16:12:17 2018 +0000

    Merge "Camera: update hardware level related docs" into pi-dev

commit b2f18166ff6a85305e8921a64c47f8cbff4575e2
Author: Nadav Bar <nadavbar@google.com>
Date:   Wed Jul 18 13:01:53 2018 +0300

    Allow playing output to default output device when during uplink playback

    Change the current behavior of AudioPolicyManager during incall music playback to allow apps that want to play audio with AUDIO_STREAM_MUSIC to default device to route the audio to the default device chosen by the engine (and not the one forced by the ongoing incall music routing). The current behavior still playes the audio to the default output device, which will be set to the TELEPHONY_TX device whenever there is ongoing uplink playback. This change will only affect a case in which uplink playback is in progress and another app tries to play audio using the music stream at that time.

    Test: Tested manually that the behavior described in the bug is fixed and that both apps can play audio to two different output devices.
    Bug: 111467967.
    Change-Id: I25bccb635ea436bb6827483732e53c49c4b27825

commit b14fef4aba730eba6bd0b1426b726ac77987158f
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Mon Jul 16 10:22:21 2018 -0700

    Camera: Mark stream as ABANDONED if dequeueBuffer returns DEAD_OBJECT

    When consumer surface is destroyed, dequeueBuffer may return
    DEAD_OBJECT.

    We need to treat this condition as ABANDONED so that camera service
    stops repeating request. Otherwise, we may run into infinite loop.

    Test: Camera CTS
    Bug: 111384143
    Bug: 111381452
    Change-Id: If3348119521e9805085321c7f20abd7cc7f5dd43

commit a2a604341afe152682d4ba4f2b9990f6a74d9e34
Merge: 4e0dcf0ce ff404db0d
Author: Robert Shih <robertshih@google.com>
Date:   Sat Jul 14 01:10:03 2018 -0700

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev am: 11eddd5a22 am: 9353b051f9
    am: ff404db0d6

    Change-Id: I5302de302163f2f341e770b7fd48df245554174e

commit ff404db0d6611e86304075cf35a8835315bed63a
Merge: f3898d413 9353b051f
Author: Robert Shih <robertshih@google.com>
Date:   Sat Jul 14 01:06:09 2018 -0700

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev am: 11eddd5a22
    am: 9353b051f9

    Change-Id: Idc0ff3824ed1bf9b7cca41702379a79bf12544f2

commit 9353b051f9ac567c67473d2ee9eb702f55ba3406
Merge: 0eaa9ea8b 11eddd5a2
Author: Robert Shih <robertshih@google.com>
Date:   Fri Jul 13 23:36:54 2018 -0700

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev
    am: 11eddd5a22

    Change-Id: Iabc41876ce5fd26e5383586d76f5f4c9b920b055

commit 11eddd5a222180edbf7fba4f69d733463ebf4553
Merge: d8cbab144 7fd048b3f
Author: Robert Shih <robertshih@google.com>
Date:   Sat Jul 14 06:23:21 2018 +0000

    Merge changes from topic "am-3d7d15cb-f02b-474d-adb3-adb7e033539e" into oc-dev

    * changes:
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764 am: c60f2ff6b4
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2
      [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5
      M3UParser: handle missing EXT-X-MEDIA URIs

commit 4e0dcf0ce1c842ed983d85716c8cacb02021d0ad
Merge: b50a84b3e f3898d413
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Fri Jul 13 17:19:13 2018 -0700

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer am: d8cbab1443 am: 0eaa9ea8b3
    am: f3898d4138

    Change-Id: I1d30a37796914c9a25c0de0613aa8979861e6498

commit f3898d4138b241e42e67062df84d40c94cb58a9f
Merge: fff36ab1b 0eaa9ea8b
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Fri Jul 13 17:06:00 2018 -0700

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer am: d8cbab1443
    am: 0eaa9ea8b3

    Change-Id: If2b503b048cb98e5b4ea851e43e821baf86e91a3

commit 0eaa9ea8b315b61aff863b729e4eccdb3560174e
Merge: 448b966b7 d8cbab144
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Fri Jul 13 15:42:41 2018 -0700

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer
    am: d8cbab1443

    Change-Id: I20857d5d8a057fb5eb6ef19d6b9b5a18fcc43144

commit d5523ea59a7c6e85b8ba28f6d92430a64a240e32
Author: Lajos Molnar <lajos@google.com>
Date:   Fri Jul 13 14:10:21 2018 -0700

    media sync: forcefully limit correction by VideoFrameScheduler.

    Don't allow video frame scheduler to correct by more than twice the
    correction limit. If this happens, restart the scheduler.

    Bug: 79400257
    Change-Id: I9c30ee0acf3bbb8ef89ce31672fe5f8055c85e2e

commit 66a38580fd9e7dcdd696e9bdcc9dadeb4584ff47
Author: Yin-Chia Yeh <yinchiayeh@google.com>
Date:   Fri Jul 13 11:50:32 2018 -0700

    Camera: update hardware level related docs

    Codegen doc update

    Test: none
    Bug: 77861412
    Change-Id: Iee396cae3a2b830556174169f3a2398ed0e0e20c

commit 7fd048b3fbb31b8e53bc2d76452bd3fb20d03f7a
Merge: 48dcdf9a7 c60f2ff6b
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:17 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764 am: c60f2ff6b4

    Change-Id: I4f5b1eec29da19eb35d8bda966bda6352950a2d8

commit c60f2ff6b4a9ab2b257be43918d9f527216d3f4e
Merge: 7d583f04d 17ae20876
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:15 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84 am: 17ae208764

    Change-Id: I98a69cea4885bd3b2a1c81801d51545c5bca1144

commit 17ae20876406e5b5d2e772795a62ce1b53767a40
Merge: 75a1f8ece b7b790ef8
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:13 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2 am: b7b790ef84

    Change-Id: I3f2bc0ae278e3353c6849c02eae543bb8a62e3f2

commit b7b790ef84dcff7205abf0c86988d8c9d3e71a8f
Merge: fd8da9c45 a3acb4c0f
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:11 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5 am: a3acb4c0f2

    Change-Id: I4cb61df3694d28593a6ba5da948ec470b0416b64

commit a3acb4c0f2131f954a0f1a3328694ac1864ce3b9
Merge: fa10a782b b8c3a74de
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Fri Jul 13 08:24:10 2018 +0000

    [automerger] M3UParser: handle missing EXT-X-MEDIA URIs am: b8c3a74de5

    Change-Id: I3eb6d9c776064ab65b9966afde17887ef7f751b1

commit b8c3a74de55a76e2ee21c731828a8afca7aa4ae0
Author: Robert Shih <robertshih@google.com>
Date:   Thu Jul 12 16:17:45 2018 -0700

    M3UParser: handle missing EXT-X-MEDIA URIs

    Bug: 111381540
    Test: http://devimages.apple.com.edgekey.net/streaming/examples/bipbop_16x9/bipbop_16x9_variant.m3u8
    Change-Id: I57f6cea59ce4c25267385289ab805eefe74b04ac

commit b50a84b3e1626527b0fb904f8e94038ef94b53db
Merge: ae88c15fc ee080fed1
Author: Eino-Ville Talvala <etalvala@google.com>
Date:   Fri Jul 13 06:49:49 2018 +0000

    Merge "Camera: DistortionMapper: Fix to work consistently" into pi-dev

commit d8cbab144398d0e9b3cdc2f8c42b4ea0c921e355
Author: Toshikazu Saito <toshikazu.x.saito@sony.com>
Date:   Tue Jul 10 15:38:38 2018 +0900

    Allow kPortModeDynamicANWBuffer for kBufferTypeANWBuffer in useBuffer

    Test: play contents
    Bug: 77486542
    Change-Id: I422d49a137889c417d855ebef954f882f67821ed

commit a3aa0f37774eadac0b538964f768c60880e9e8a5
Author: Ray Essick <essick@google.com>
Date:   Thu Jul 12 14:21:18 2018 -0700

    Fix detected integer sanitization

    Rework mp3 decode for several identified integer overflow issues.

    Bug: 110307597
    Test: replay podcast episodes causing issues
    Change-Id: I1b69474d3501ffa41c527c8d1c22405a335ab841

commit ee080fed199e60df07c0fcef970182ba09bf4367
Author: Eino-Ville Talvala <etalvala@google.com>
Date:   Mon Jun 25 10:41:04 2018 -0700

    Camera: DistortionMapper: Fix to work consistently

    - Ensure the conversions between pre-correction and active array coordinates
      are applied consistenly
    - Only some regions were being clamped to ensure they were within the
      destination region. Add more clamping, though some outputs still
      need to not be clamped, such as face rectangles which may extend outside
      the FOV.
    - Add simple transform mode since the full transform cannot safely be used
      to meet all consistency requirements in Android P

    Also update the unit tests to try to check for this corner case and the
    simple mode.

    Test: adb shell /data/nativetest/cameraservice_tests/cameraservice_test \
        --gtest_filter=*Distortion*
    Bug: 109766306
    Change-Id: Id6f23794d60d5ed9e04b155426741a504487e3d6

commit ae88c15fc1caa87e7178185f4913b08dc7607ed1
Merge: 946f8dd29 fff36ab1b
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 16:10:18 2018 -0700

    [automerger skipped] Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev am: 48dcdf9a78 am: 448b966b7a
    am: fff36ab1b0  -s ours

    Change-Id: I3d1d64e25ad591b9bbd2befa8eabce654d69290a

commit fff36ab1b09765db4df8803380cc41552147b8c8
Merge: 58d53f6c2 448b966b7
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 16:02:40 2018 -0700

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev am: 48dcdf9a78
    am: 448b966b7a

    Change-Id: I8bfef4e2a056761a53224985f47cad9f502ad9de

commit 448b966b7aabb0e198d49c388670d5c3a8ce83af
Merge: 22eab8fec 48dcdf9a7
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 15:56:13 2018 -0700

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev
    am: 48dcdf9a78

    Change-Id: I6694213e5c47fe1d206a07b0086fb20eef68983e

commit 48dcdf9a7856d49eeecbaa13f9ed81601eb8e2fa
Merge: 77c35f6ca f88d8ba86
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into oc-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88 am: 0bfabbf53d
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit 7d583f04d4068456cb40cf1c6d4694fc47d2209e
Merge: 301a0078a 0bfabbf53
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into nyc-mr2-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit 75a1f8ece070390c96228eecb5b281750cd4f21a
Merge: e5d3086f3 70c597fe8
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into cw-f-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit fd8da9c45dd1a08497272f94dbad141903aad81c
Merge: 1ff39c654 73bc1230e
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into nyc-mr1-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit fa10a782bdf739d0bbdee06d5b510031e9b915b5
Merge: e8d5d152b d04d54f84
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge changes from topic "am-79da5bca-0ca6-42a8-8b95-7ab98d864152" into nyc-dr1-dev

    * changes:
      [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323
      MediaExtractor: stop rendering when an error occurs

commit 642929a42b9945a7a54b49201779e9da8dace11e
Merge: 25e9dff25 9bc021a32
Author: Atanas Kirilov <akirilov@google.com>
Date:   Wed Jul 11 22:45:05 2018 +0000

    Merge "MediaExtractor: stop rendering when an error occurs" into nyc-dev

commit 946f8dd29282413be08edf61c2a5693e0fa8a249
Merge: 149cf6a4c 58d53f6c2
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jul 11 13:15:09 2018 -0700

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8 am: 77c35f6cac am: 22eab8fecd
    am: 58d53f6c28

    Change-Id: I977f6e8af49d8c38033f6e8c046deddda2b2df4f

commit 58d53f6c283731d9fbfd0e823b492fcb663fc9fe
Merge: ee82a4b03 22eab8fec
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jul 11 13:10:53 2018 -0700

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8 am: 77c35f6cac
    am: 22eab8fecd

    Change-Id: Id2135d79c7293256c74e6966f6add4bbdccb0621

commit 22eab8fecd694d9279756770e70a038f6947af5d
Merge: 767b86ffd 77c35f6ca
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jul 11 13:06:44 2018 -0700

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8
    am: 77c35f6cac

    Change-Id: I161ecd32a392f05dd535496ec119f5252fb77fc9

commit f88d8ba86a87c1e02c2062271a4404448b20aa1f
Merge: 91abb3dac 0bfabbf53
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:52 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88 am: 0bfabbf53d

    Change-Id: Ie57297887fb1bb7c851731592f62089aaee11837

commit 0bfabbf53d83c14a58f1ca38bd7505ffa2ae4e89
Merge: ac5986c05 70c597fe8
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:50 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7 am: 70c597fe88

    Change-Id: Iea1a919b03258d7d5653788feddc7e53461a16c9

commit 70c597fe888ab884e274f678394c35c8077c14b7
Merge: 5eb714ea0 73bc1230e
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:48 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843 am: 73bc1230e7

    Change-Id: I1ea228f53f99030fbf846a694b02e74f56159a94

commit 73bc1230e7b4d49ec5fc1765d1768dd1ab0ca7a6
Merge: 3d634e647 d04d54f84
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:46 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323 am: d04d54f843

    Change-Id: If7842c0575c4283518e15230d5550356dffe5021

commit d04d54f843c5aa314cb0cae5ac5009bd256cecb9
Merge: fe26fc144 9bc021a32
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Tue Jul 10 20:13:44 2018 +0000

    [automerger] MediaExtractor: stop rendering when an error occurs am: 9bc021a323

    Change-Id: I5c235031af2cf5c23bc37a0922a8f8836de28202

commit 9bc021a323873091ea98f77b3b3dc4732d1c92e6
Author: akirilov <akirilov@google.com>
Date:   Mon Jul 9 15:28:01 2018 -0700

    MediaExtractor: stop rendering when an error occurs

    Bug: 68664359
    Bug: 110435401

    Test: cts-tradefed run cts -m CtsSecurityTestCases -t android.security.cts.StagefrightTest#testStagefright_bug_68664359
    Test: cts-tradefed run cts -m CtsSecurityTestCases -t android.security.cts.StagefrightTest#testStagefright_bug_110435401

    Change-Id: Icff96fcaa76a5871e7f175b0384d47d5dca7313f
    Merged-In: If1322524fcfebc6c5f139288f044b0189da66c1b

commit 149cf6a4cecb2a165b550735fee3034d8c99b4bb
Author: Phil Burk <philburk@google.com>
Date:   Mon Jun 25 11:20:47 2018 -0700

    MediaExtractor: stop rendering when an error occurs

    Bug: 68664359
    Bug: 110435401
    Test: Try to play a bogus OTA file. See bug for details.
    Change-Id: If1322524fcfebc6c5f139288f044b0189da66c1b

commit e8924ce00fe33ebdb3aaf9f485a4a28684a5acd6
Merge: fcde24577 b131f4a7c
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Jun 27 22:08:27 2018 +0000

    Merge "Camera: Use default focal length in template to derive FOV" into pi-dev

commit fcde24577690a9c205266b72c51d498ced71b214
Merge: 53eea85dc 3bdcdff8c
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Wed Jun 27 19:26:42 2018 +0000

    Merge "Camera: Set inverse display transform if needed" into pi-dev

commit b131f4a7c8bcce698a4299434ffd9460dc30e9cf
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Thu Jun 21 18:19:11 2018 -0700

    Camera: Use default focal length in template to derive FOV

    This is consistent with the default focal length set by the API1-HAL3
    shim.

    Test: Camera CTS, FOV test for CtsVerifier
    Bug: 110445633
    Change-Id: I4ecfb32c7cecdd9c56e04b25cf4d92a86122b2cb

commit 3bdcdff8ce05ddc04e9feb6e09393d328b7bf318
Author: Emilian Peev <epeev@google.com>
Date:   Mon Jun 25 14:37:29 2018 +0100

    Camera: Set inverse display transform if needed

    Shared surface outputs currently re-use the transformation
    from the input queue directly. However the inverse display
    flag will get reset by the queue logic and needs to be set
    again before the incoming buffers are sent to the registered
    outputs.

    Bug: 110641448
    Test: Manual using application,
    Camera CTS
    Change-Id: I36859eb41ccab8459bbd97bad3ea0b6a8575489c

commit 77c35f6caca40daa67842842575796e74fff758b
Merge: 91abb3dac 301a0078a
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:12 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b am: 301a0078a8

    Change-Id: I6983d28e45c047ffb3b7db9a6d02240c5746eec3

commit 301a0078a8c9eb39f41c55043b09511f1b8f2aef
Merge: ac5986c05 e5d3086f3
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:10 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a am: e5d3086f3b

    Change-Id: I7c847f620deb25930874f676b81c09d34d5f5f72

commit e5d3086f3b22ebb478e453003711915b9ec690a0
Merge: 5eb714ea0 1ff39c654
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:08 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf am: 1ff39c654a

    Change-Id: I9a6766cd10724fd73e97ac633c835d70b07fdb4d

commit 1ff39c654ab9d594a807f6327e1a28c67517173d
Merge: 3d634e647 e8d5d152b
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:06 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c am: e8d5d152bf

    Change-Id: Ibd4d21d5826d9a072b5ab04ece651291c73e98de

commit e8d5d152bf4862007f87f1d7732fc6f6e3671b77
Merge: fe26fc144 25e9dff25
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:03 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9 am: 25e9dff25c

    Change-Id: I1152e6a6052862f54489fc48be76bde57120068d

commit 25e9dff25cb89ab290834320243d77643b052256
Merge: cc5d25bbc fc7a3a56f
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:02:01 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af am: fc7a3a56f9

    Change-Id: I9e321e4bd090b976dda07829bec093008ac59966

commit fc7a3a56f9d623ae33e8a26e02eae4a9b0883032
Merge: 7ad36b07d ad0ec9b3a
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:01:59 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a am: ad0ec9b3af

    Change-Id: Ia83dfb602b091c512653eb83d7aa43b1c6e44cf2

commit ad0ec9b3af078e24f0eda395a137466e20d0ec6d
Merge: 1d382c6b7 dce12d183
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:01:57 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba am: dce12d183a

    Change-Id: I8aa8cb36c18fea386753f1f5160f7b7499358cac

commit dce12d183ad3234b918595669b684fd2a1c10dac
Merge: 9c5774045 fe3708f7b
Author: Android Build Merger (Role) <noreply-android-build-merger@google.com>
Date:   Thu Jun 21 00:01:55 2018 +0000

    [automerger] Fix a race condition in OMXNodeInstance am: fe3708f7ba

    Change-Id: I6b438d3fd0cdbf8d4f85a7e2c053be1c5cbd5e82

commit fe3708f7baa75b37e7b1ac30f88acb33df3f5360
Author: Dongwon Kang <dwkang@google.com>
Date:   Wed Jun 20 16:05:45 2018 -0700

    Fix a race condition in OMXNodeInstance

    When it frees the buffers, there might be pending events in
    OMX::CallbackDispatcher and these event can be handled after
    the component frees the buffers. To prevent the UAF case, this
    change invalidates the buffers in the client side first before
    calling OMX_FreeBuffer.

    Test: run poc with and without the patch
    Test: cts-tradefed run cts-dev --module CtsMediaTestCases
          --compatibility:module-arg CtsMediaTestCases:include-annotation:
          android.platform.test.annotations.RequiresDevice
    Bug: 77474014
    Change-Id: I0b7c4291967564f697e7f6a5ecbc31d4dae3cbcd

commit 53eea85dcbdd3377c4c34e5f5b0eba8dbf6b5b29
Author: Emilian Peev <epeev@google.com>
Date:   Wed Jun 20 14:13:14 2018 +0100

    Camera: Use face priority scene as default

    Clients using the legacy API translation layer will
    default to face priority scene in case this mode is
    supported by the camera device.

    Bug: 110259811
    Test: Manual using application,
    Camera CTS

    Change-Id: I370f222c73ea6e133bb6cb334ced2e33a26bb8c5

commit a1caa67b77959d558fc90e6bf4ec0ed8f6caa85e
Merge: d62d30773 9fa929b6b
Author: Shuzhen Wang <shuzhenwang@google.com>
Date:   Tue Jun 19 20:19:38 2018 +0000

    Merge "Camera: NDK codegen doc update" into pi-dev

commit 9fa929b6b6449864030d491ff6c9da5111eba210
Author: Yin-Chia Yeh <yinchiayeh@google.com>
Date:   Fri Jun 15 15:38:34 2018 -0700

    Camera: NDK codegen doc update

    Test: N/A. Doc update
    Bug: 109666939
    Change-Id: I19bef18c164dae47c7b18e90d7c5d972dc02fd95

commit d62d30773decf3cd44cbd2a4edc8f0daf7c0ca5b
Author: Chong Zhang <chz@google.com>
Date:   Thu Jun 14 12:28:32 2018 -0700

    stagefright: send EOS to encoder for thumbnail extraction

    Decoders might hold on to decoded frames for certain streams,
    send EOS after last sample so that we get all output frames.

    bug: 110116757
    bug: 110226430

    Test: CTS HeifWriterTest; MediaMetadataRetrieverTest
    Change-Id: I0f8e7f1607857297325594adad8ca4fbff16e5e9

commit 70c2e5ea61daffd458fd0e57be8376036281f737
Merge: 63a0662d0 484e927cf
Author: TreeHugger Robot <treehugger-gerrit@google.com>
Date:   Tue Jun 12 23:42:31 2018 +0000

    Merge "audiopolicy: fix VoIP and system sound routing concurrency" into pi-dev

commit 484e927cf9e9bdd91f21796d52ea23c8fe49f670
Author: Eric Laurent <elaurent@google.com>
Date:   Thu Jun 7 17:29:23 2018 -0700

    audiopolicy: fix VoIP and system sound routing concurrency

    On platforms with dedicated output profiles for VoIP, activity on
    all output streams should be considered when use case priority is
    evaluated while selecting current device on a given output stream.

    For now, implement a simple rule taking only into account output streams
    attached to the same audio HAL module and limited to voice call use
    case.
    This should be extended to all use cases with a refined rule
    considering mutually exclusive devices (using same backend) as opposed
    to all streams on the same audio HAL module.

    Bug: 109640706
    Test: repro steps in b/109640706
    Change-Id: I2cea35911a6121980f128a3a3d694699364854eb

commit ac5986c05629bb1087923a464b39185989a03c53
Merge: 5673ef3ec 9cae8be44
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-mr2-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0 am: 8aeab2cad9 am: b04ca4cb26
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0 am: 8aeab2cad9
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 5eb714ea02451944dfde142bf4220544a9d83325
Merge: e143e026c b04ca4cb2
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into cw-f-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0 am: 8aeab2cad9
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 3d634e64725dd3d2c98baa8b045d1e764f2305e9
Merge: b5029cb71 8aeab2cad
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-mr1-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e am: 19d1113bb0
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit fe26fc14478921665ae6034063d6c77c87730f62
Merge: a333901a9 19d1113bb
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-dr1-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5 am: bad0533d2e
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit cc5d25bbcd124ec3aa8a0e0366c518e7e5c26d0b
Merge: cc3897e95 bad0533d2
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into nyc-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42 am: 4cdd5c3af5
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 7ad36b07d4f4a66756c32a6e3003f4f7ee93f12e
Merge: 6fac86e8f 4cdd5c3af
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into mnc-dr1.5-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86 am: 1c7bb87a42
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 1d382c6b797253ee363bd8d391561bce94795217
Merge: 9500a5c89 1c7bb87a4
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into cw-e-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152 am: ecc92a1a86
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit 9c5774045a3f12dc6e95eb91726fe7a5e332961a
Merge: 042483b6a ecc92a1a8
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge changes from topic "am-92cbb3f7-167f-4f57-b682-f916686fead9-mnc-dev" into mnc-dr-dev

    * changes:
      [automerger] Fix possible out of bounds read am: 3762e06152
      Fix possible out of bounds read

commit ed3f73e92a9aee279b60e174b443fd08bac2b847
Merge: 26e236bd4 3762e0615
Author: Marco Nelissen <marcone@google.com>
Date:   Tue Jun 5 21:39:01 2018 +0000

    Merge "Fix possible out of bounds read" into mnc-dev

Change-Id: I1d11ffecf2850c0739d4ae8e791c67b0d270754c
---
 camera/cameraserver/cameraserver.rc           |   1 +
 .../include/camera/NdkCameraMetadataTags.h    | 275 ++++++++++++++----
 cmds/screenrecord/screenrecord.cpp            |  80 +++--
 .../plugins/clearkey/ClearKeyCasPlugin.cpp    |  24 +-
 .../plugins/clearkey/ClearKeyCasPlugin.h      |   2 +-
 .../clearkey/ClearKeySessionLibrary.cpp       |   8 +-
 .../plugins/clearkey/ClearKeySessionLibrary.h |  10 +-
 .../nuplayer2/NuPlayer2CCDecoder.cpp          |  22 +-
 .../nuplayer/NuPlayer.cpp                     |  42 +--
 .../libmediaplayerservice/nuplayer/NuPlayer.h |   2 +-
 media/libstagefright/CameraSource.cpp         |   9 +-
 media/libstagefright/FrameDecoder.cpp         |   5 +-
 media/libstagefright/MediaCodec.cpp           |  24 +-
 media/libstagefright/VideoFrameScheduler.cpp  |   9 +
 .../codecs/mp3dec/src/pvmp3_framedecoder.cpp  |   6 +-
 .../codecs/mp3dec/src/pvmp3_get_side_info.cpp |   2 +-
 .../codecs/mp3dec/src/pvmp3_stereo_proc.cpp   |   4 +
 .../codecs/xaacdec/SoftXAAC.cpp               |   7 +-
 .../include/media/stagefright/CameraSource.h  |   1 +
 .../include/media/stagefright/MediaCodec.h    |   2 +-
 media/libstagefright/omx/OMXNodeInstance.cpp  |   5 +-
 .../managerdefinitions/src/SessionRoute.cpp   |  10 +-
 .../managerdefault/AudioPolicyManager.cpp     |  20 +-
 .../managerdefault/AudioPolicyManager.h       |   4 +
 .../camera/libcameraservice/CameraService.cpp |  12 +-
 .../libcameraservice/api1/Camera2Client.cpp   |   3 +-
 .../api1/client2/Parameters.cpp               | 119 +++++---
 .../api1/client2/Parameters.h                 |  14 +-
 .../device3/Camera3Device.cpp                 |  27 +-
 .../device3/Camera3OutputStream.cpp           |   2 +-
 .../device3/Camera3Stream.cpp                 |   9 +-
 .../libcameraservice/device3/Camera3Stream.h  |   1 +
 .../device3/Camera3StreamSplitter.cpp         |   4 +
 33 files changed, 538 insertions(+), 227 deletions(-)

diff --git a/camera/cameraserver/cameraserver.rc b/camera/cameraserver/cameraserver.rc
index fea5a1d5c..a9aae0b15 100644
--- a/camera/cameraserver/cameraserver.rc
+++ b/camera/cameraserver/cameraserver.rc
@@ -4,3 +4,4 @@ service cameraserver /system/bin/cameraserver
     group audio camera input drmrpc
     ioprio rt 4
     writepid /dev/cpuset/camera-daemon/tasks /dev/stune/top-app/tasks
+    rlimit rtprio 10 10
diff --git a/camera/ndk/include/camera/NdkCameraMetadataTags.h b/camera/ndk/include/camera/NdkCameraMetadataTags.h
index 3010646af..c1f5ddcb4 100644
--- a/camera/ndk/include/camera/NdkCameraMetadataTags.h
+++ b/camera/ndk/include/camera/NdkCameraMetadataTags.h
@@ -479,11 +479,26 @@ typedef enum acamera_metadata_tag {
      * Otherwise will always be present.</p>
      * <p>The maximum number of regions supported by the device is determined by the value
      * of android.control.maxRegionsAe.</p>
-     * <p>The coordinate system is based on the active pixel array,
-     * with (0,0) being the top-left pixel in the active pixel array, and
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with (0,0) being
+     * the top-left pixel in the active pixel array, and
      * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the
-     * bottom-right pixel in the active pixel array.</p>
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array, and
+     * (ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right
+     * pixel in the pre-correction active pixel array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array, and
+     * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
      * <p>The weight must be within <code>[0, 1000]</code>, and represents a weight
      * for every pixel in the area. This means that a large metering area
      * with the same weight as a smaller area will have more effect in
@@ -504,8 +519,10 @@ typedef enum acamera_metadata_tag {
      * The rectangle is defined to be inclusive on xmin and ymin, but exclusive on xmax and
      * ymax.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_CONTROL_AE_REGIONS =                                // int32[5*area_count]
             ACAMERA_CONTROL_START + 4,
@@ -641,11 +658,26 @@ typedef enum acamera_metadata_tag {
      * Otherwise will always be present.</p>
      * <p>The maximum number of focus areas supported by the device is determined by the value
      * of android.control.maxRegionsAf.</p>
-     * <p>The coordinate system is based on the active pixel array,
-     * with (0,0) being the top-left pixel in the active pixel array, and
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with (0,0) being
+     * the top-left pixel in the active pixel array, and
+     * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array, and
+     * (ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right
+     * pixel in the pre-correction active pixel array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array, and
      * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the
-     * bottom-right pixel in the active pixel array.</p>
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
      * <p>The weight must be within <code>[0, 1000]</code>, and represents a weight
      * for every pixel in the area. This means that a large metering area
      * with the same weight as a smaller area will have more effect in
@@ -667,8 +699,10 @@ typedef enum acamera_metadata_tag {
      * The rectangle is defined to be inclusive on xmin and ymin, but exclusive on xmax and
      * ymax.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_CONTROL_AF_REGIONS =                                // int32[5*area_count]
             ACAMERA_CONTROL_START + 8,
@@ -800,11 +834,26 @@ typedef enum acamera_metadata_tag {
      * Otherwise will always be present.</p>
      * <p>The maximum number of regions supported by the device is determined by the value
      * of android.control.maxRegionsAwb.</p>
-     * <p>The coordinate system is based on the active pixel array,
-     * with (0,0) being the top-left pixel in the active pixel array, and
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with (0,0) being
+     * the top-left pixel in the active pixel array, and
      * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the
-     * bottom-right pixel in the active pixel array.</p>
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array, and
+     * (ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right
+     * pixel in the pre-correction active pixel array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array, and
+     * (ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.width - 1,
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.height - 1) being the bottom-right pixel in the
+     * active pixel array.</p>
      * <p>The weight must range from 0 to 1000, and represents a weight
      * for every pixel in the area. This means that a large metering area
      * with the same weight as a smaller area will have more effect in
@@ -825,8 +874,10 @@ typedef enum acamera_metadata_tag {
      * The rectangle is defined to be inclusive on xmin and ymin, but exclusive on xmax and
      * ymax.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_CONTROL_AWB_REGIONS =                               // int32[5*area_count]
             ACAMERA_CONTROL_START + 12,
@@ -2261,7 +2312,9 @@ typedef enum acamera_metadata_tag {
      * <p>If this device is the largest or only camera device with a given facing, then this
      * position will be <code>(0, 0, 0)</code>; a camera device with a lens optical center located 3 cm
      * from the main sensor along the +X axis (to the right from the user's perspective) will
-     * report <code>(0.03, 0, 0)</code>.</p>
+     * report <code>(0.03, 0, 0)</code>.  Note that this means that, for many computer vision
+     * applications, the position needs to be negated to convert it to a translation from the
+     * camera to the origin.</p>
      * <p>To transform a pixel coordinates between two cameras facing the same direction, first
      * the source camera ACAMERA_LENS_DISTORTION must be corrected for.  Then the source
      * camera ACAMERA_LENS_INTRINSIC_CALIBRATION needs to be applied, followed by the
@@ -2273,7 +2326,8 @@ typedef enum acamera_metadata_tag {
      * <p>To compare this against a real image from the destination camera, the destination camera
      * image then needs to be corrected for radial distortion before comparison or sampling.</p>
      * <p>When ACAMERA_LENS_POSE_REFERENCE is GYROSCOPE, then this position is relative to
-     * the center of the primary gyroscope on the device.</p>
+     * the center of the primary gyroscope on the device. The axis definitions are the same as
+     * with PRIMARY_CAMERA.</p>
      *
      * @see ACAMERA_LENS_DISTORTION
      * @see ACAMERA_LENS_INTRINSIC_CALIBRATION
@@ -2367,13 +2421,15 @@ typedef enum acamera_metadata_tag {
      * </code></pre>
      * <p>which can then be combined with the camera pose rotation
      * <code>R</code> and translation <code>t</code> (ACAMERA_LENS_POSE_ROTATION and
-     * ACAMERA_LENS_POSE_TRANSLATION, respective) to calculate the
+     * ACAMERA_LENS_POSE_TRANSLATION, respectively) to calculate the
      * complete transform from world coordinates to pixel
      * coordinates:</p>
-     * <pre><code>P = [ K 0   * [ R t
-     *      0 1 ]     0 1 ]
+     * <pre><code>P = [ K 0   * [ R -Rt
+     *      0 1 ]      0 1 ]
      * </code></pre>
-     * <p>and with <code>p_w</code> being a point in the world coordinate system
+     * <p>(Note the negation of poseTranslation when mapping from camera
+     * to world coordinates, and multiplication by the rotation).</p>
+     * <p>With <code>p_w</code> being a point in the world coordinate system
      * and <code>p_s</code> being a point in the camera active pixel array
      * coordinate system, and with the mapping including the
      * homogeneous division by z:</p>
@@ -2395,6 +2451,13 @@ typedef enum acamera_metadata_tag {
      * activeArraySize rectangle), to determine the final pixel
      * coordinate of the world point for processed (non-RAW)
      * output buffers.</p>
+     * <p>For camera devices, the center of pixel <code>(x,y)</code> is located at
+     * coordinate <code>(x + 0.5, y + 0.5)</code>.  So on a device with a
+     * precorrection active array of size <code>(10,10)</code>, the valid pixel
+     * indices go from <code>(0,0)-(9,9)</code>, and an perfectly-built camera would
+     * have an optical center at the exact center of the pixel grid, at
+     * coordinates <code>(5.0, 5.0)</code>, which is the top-left corner of pixel
+     * <code>(5,5)</code>.</p>
      *
      * @see ACAMERA_LENS_DISTORTION
      * @see ACAMERA_LENS_POSE_ROTATION
@@ -2979,9 +3042,17 @@ typedef enum acamera_metadata_tag {
      * </ul></p>
      *
      * <p>This control can be used to implement digital zoom.</p>
-     * <p>The crop region coordinate system is based off
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being the
-     * top-left corner of the sensor active array.</p>
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being
+     * the top-left pixel of the active array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the active array.</p>
      * <p>Output streams use this rectangle to produce their output,
      * cropping to a smaller region if necessary to maintain the
      * stream's aspect ratio, then scaling the sensor input to
@@ -3000,18 +3071,26 @@ typedef enum acamera_metadata_tag {
      * outputs will crop horizontally (pillarbox), and 16:9
      * streams will match exactly. These additional crops will
      * be centered within the crop region.</p>
-     * <p>The width and height of the crop region cannot
-     * be set to be smaller than
+     * <p>If the coordinate system is ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, the width and height
+     * of the crop region cannot be set to be smaller than
      * <code>floor( activeArraySize.width / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code> and
      * <code>floor( activeArraySize.height / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code>, respectively.</p>
+     * <p>If the coordinate system is ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, the width
+     * and height of the crop region cannot be set to be smaller than
+     * <code>floor( preCorrectionActiveArraySize.width / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code>
+     * and
+     * <code>floor( preCorrectionActiveArraySize.height / ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM )</code>,
+     * respectively.</p>
      * <p>The camera device may adjust the crop region to account
      * for rounding and other hardware requirements; the final
      * crop region used will be included in the output capture
      * result.</p>
      * <p>The data representation is int[4], which maps to (left, top, width, height).</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_AVAILABLE_MAX_DIGITAL_ZOOM
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_SCALER_CROP_REGION =                                // int32[4]
             ACAMERA_SCALER_START,
@@ -3977,12 +4056,24 @@ typedef enum acamera_metadata_tag {
      * ACAMERA_SCALER_CROP_REGION, is defined relative to the active array rectangle given in
      * this field, with <code>(0, 0)</code> being the top-left of this rectangle.</p>
      * <p>The active array may be smaller than the full pixel array, since the full array may
-     * include black calibration pixels or other inactive regions, and geometric correction
-     * resulting in scaling or cropping may have been applied.</p>
+     * include black calibration pixels or other inactive regions.</p>
+     * <p>For devices that do not support ACAMERA_DISTORTION_CORRECTION_MODE control, the active
+     * array must be the same as ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.</p>
+     * <p>For devices that support ACAMERA_DISTORTION_CORRECTION_MODE control, the active array must
+     * be enclosed by ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE. The difference between
+     * pre-correction active array and active array accounts for scaling or cropping caused
+     * by lens geometric distortion correction.</p>
+     * <p>In general, application should always refer to active array size for controls like
+     * metering regions or crop region. Two exceptions are when the application is dealing with
+     * RAW image buffers (RAW_SENSOR, RAW10, RAW12 etc), or when application explicitly set
+     * ACAMERA_DISTORTION_CORRECTION_MODE to OFF. In these cases, application should refer
+     * to ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE.</p>
      * <p>The data representation is <code>int[4]</code>, which maps to <code>(left, top, width, height)</code>.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SCALER_CROP_REGION
      * @see ACAMERA_SENSOR_INFO_PIXEL_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE =                     // int32[4]
             ACAMERA_SENSOR_INFO_START,
@@ -4224,9 +4315,9 @@ typedef enum acamera_metadata_tag {
      * <ol>
      * <li>ACAMERA_LENS_DISTORTION.</li>
      * </ol>
-     * <p>If all of the geometric distortion fields are no-ops, this rectangle will be the same
-     * as the post-distortion-corrected rectangle given in
-     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.</p>
+     * <p>If the camera device doesn't support geometric distortion correction, or all of the
+     * geometric distortion fields are no-ops, this rectangle will be the same as the
+     * post-distortion-corrected rectangle given in ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.</p>
      * <p>This rectangle is defined relative to the full pixel array; (0,0) is the top-left of
      * the full pixel array, and the size of the full pixel array is given by
      * ACAMERA_SENSOR_INFO_PIXEL_ARRAY_SIZE.</p>
@@ -4372,11 +4463,22 @@ typedef enum acamera_metadata_tag {
      *   <li>ACameraMetadata from ACameraCaptureSession_captureCallback_result callbacks</li>
      * </ul></p>
      *
-     * <p>The coordinate system is that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being
+     * the top-left pixel of the active array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
      * <code>(0, 0)</code> being the top-left pixel of the active array.</p>
      * <p>Only available if ACAMERA_STATISTICS_FACE_DETECT_MODE == FULL</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      * @see ACAMERA_STATISTICS_FACE_DETECT_MODE
      */
     ACAMERA_STATISTICS_FACE_LANDMARKS =                         // int32[n*6]
@@ -4392,12 +4494,23 @@ typedef enum acamera_metadata_tag {
      *   <li>ACameraMetadata from ACameraCaptureSession_captureCallback_result callbacks</li>
      * </ul></p>
      *
-     * <p>The coordinate system is that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
+     * <p>For devices not supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system always follows that of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with <code>(0, 0)</code> being
+     * the top-left pixel of the active array.</p>
+     * <p>For devices supporting ACAMERA_DISTORTION_CORRECTION_MODE control, the coordinate
+     * system depends on the mode being set.
+     * When the distortion correction mode is OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE, with
+     * <code>(0, 0)</code> being the top-left pixel of the pre-correction active array.
+     * When the distortion correction mode is not OFF, the coordinate system follows
+     * ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE, with
      * <code>(0, 0)</code> being the top-left pixel of the active array.</p>
      * <p>Only available if ACAMERA_STATISTICS_FACE_DETECT_MODE != OFF
-     * The data representation is <code>int[4]</code>, which maps to <code>(left, top, width, height)</code>.</p>
+     * The data representation is <code>int[4]</code>, which maps to <code>(left, top, right, bottom)</code>.</p>
      *
+     * @see ACAMERA_DISTORTION_CORRECTION_MODE
      * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      * @see ACAMERA_STATISTICS_FACE_DETECT_MODE
      */
     ACAMERA_STATISTICS_FACE_RECTANGLES =                        // int32[n*4]
@@ -4574,8 +4687,8 @@ typedef enum acamera_metadata_tag {
     ACAMERA_STATISTICS_LENS_SHADING_MAP_MODE =                  // byte (acamera_metadata_enum_android_statistics_lens_shading_map_mode_t)
             ACAMERA_STATISTICS_START + 16,
     /**
-     * <p>A control for selecting whether OIS position information is included in output
-     * result metadata.</p>
+     * <p>A control for selecting whether optical stabilization (OIS) position
+     * information is included in output result metadata.</p>
      *
      * <p>Type: byte (acamera_metadata_enum_android_statistics_ois_data_mode_t)</p>
      *
@@ -4585,6 +4698,12 @@ typedef enum acamera_metadata_tag {
      *   <li>ACaptureRequest</li>
      * </ul></p>
      *
+     * <p>Since optical image stabilization generally involves motion much faster than the duration
+     * of individualq image exposure, multiple OIS samples can be included for a single capture
+     * result. For example, if the OIS reporting operates at 200 Hz, a typical camera operating
+     * at 30fps may have 6-7 OIS samples per capture result. This information can be combined
+     * with the rolling shutter skew to account for lens motion during image exposure in
+     * post-processing algorithms.</p>
      */
     ACAMERA_STATISTICS_OIS_DATA_MODE =                          // byte (acamera_metadata_enum_android_statistics_ois_data_mode_t)
             ACAMERA_STATISTICS_START + 17,
@@ -4616,11 +4735,15 @@ typedef enum acamera_metadata_tag {
      * </ul></p>
      *
      * <p>The array contains the amount of shifts in x direction, in pixels, based on OIS samples.
-     * A positive value is a shift from left to right in active array coordinate system. For
-     * example, if the optical center is (1000, 500) in active array coordinates, a shift of
-     * (3, 0) puts the new optical center at (1003, 500).</p>
+     * A positive value is a shift from left to right in the pre-correction active array
+     * coordinate system. For example, if the optical center is (1000, 500) in pre-correction
+     * active array coordinates, a shift of (3, 0) puts the new optical center at (1003, 500).</p>
      * <p>The number of shifts must match the number of timestamps in
      * ACAMERA_STATISTICS_OIS_TIMESTAMPS.</p>
+     * <p>The OIS samples are not affected by whether lens distortion correction is enabled (on
+     * supporting devices). They are always reported in pre-correction active array coordinates,
+     * since the scaling of OIS shifts would depend on the specific spot on the sensor the shift
+     * is needed.</p>
      *
      * @see ACAMERA_STATISTICS_OIS_TIMESTAMPS
      */
@@ -4637,11 +4760,15 @@ typedef enum acamera_metadata_tag {
      * </ul></p>
      *
      * <p>The array contains the amount of shifts in y direction, in pixels, based on OIS samples.
-     * A positive value is a shift from top to bottom in active array coordinate system. For
-     * example, if the optical center is (1000, 500) in active array coordinates, a shift of
-     * (0, 5) puts the new optical center at (1000, 505).</p>
+     * A positive value is a shift from top to bottom in pre-correction active array coordinate
+     * system. For example, if the optical center is (1000, 500) in active array coordinates, a
+     * shift of (0, 5) puts the new optical center at (1000, 505).</p>
      * <p>The number of shifts must match the number of timestamps in
      * ACAMERA_STATISTICS_OIS_TIMESTAMPS.</p>
+     * <p>The OIS samples are not affected by whether lens distortion correction is enabled (on
+     * supporting devices). They are always reported in pre-correction active array coordinates,
+     * since the scaling of OIS shifts would depend on the specific spot on the sensor the shift
+     * is needed.</p>
      *
      * @see ACAMERA_STATISTICS_OIS_TIMESTAMPS
      */
@@ -4993,12 +5120,26 @@ typedef enum acamera_metadata_tag {
      * the following code snippet can be used:</p>
      * <pre><code>// Returns true if the device supports the required hardware level, or better.
      * boolean isHardwareLevelSupported(CameraCharacteristics c, int requiredLevel) {
+     *     final int[] sortedHwLevels = {
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_LEGACY,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_EXTERNAL,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_LIMITED,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_FULL,
+     *         CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_3
+     *     };
      *     int deviceLevel = c.get(CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL);
-     *     if (deviceLevel == CameraCharacteristics.INFO_SUPPORTED_HARDWARE_LEVEL_LEGACY) {
-     *         return requiredLevel == deviceLevel;
+     *     if (requiredLevel == deviceLevel) {
+     *         return true;
      *     }
-     *     // deviceLevel is not LEGACY, can use numerical sort
-     *     return requiredLevel &lt;= deviceLevel;
+     *
+     *     for (int sortedlevel : sortedHwLevels) {
+     *         if (sortedlevel == requiredLevel) {
+     *             return true;
+     *         } else if (sortedlevel == deviceLevel) {
+     *             return false;
+     *         }
+     *     }
+     *     return false; // Should never reach here
      * }
      * </code></pre>
      * <p>At a high level, the levels are:</p>
@@ -5012,6 +5153,8 @@ typedef enum acamera_metadata_tag {
      *   post-processing settings, and image capture at a high rate.</li>
      * <li><code>LEVEL_3</code> devices additionally support YUV reprocessing and RAW image capture, along
      *   with additional output stream configurations.</li>
+     * <li><code>EXTERNAL</code> devices are similar to <code>LIMITED</code> devices with exceptions like some sensor or
+     *   lens information not reorted or less stable framerates.</li>
      * </ul>
      * <p>See the individual level enums for full descriptions of the supported capabilities.  The
      * ACAMERA_REQUEST_AVAILABLE_CAPABILITIES entry describes the device's capabilities at a
@@ -5315,18 +5458,36 @@ typedef enum acamera_metadata_tag {
      * any correction at all would slow down capture rate.  Every output stream will have a
      * similar amount of enhancement applied.</p>
      * <p>The correction only applies to processed outputs such as YUV, JPEG, or DEPTH16; it is not
-     * applied to any RAW output.  Metadata coordinates such as face rectangles or metering
-     * regions are also not affected by correction.</p>
-     * <p>Applications enabling distortion correction need to pay extra attention when converting
-     * image coordinates between corrected output buffers and the sensor array. For example, if
-     * the app supports tap-to-focus and enables correction, it then has to apply the distortion
-     * model described in ACAMERA_LENS_DISTORTION to the image buffer tap coordinates to properly
-     * calculate the tap position on the sensor active array to be used with
-     * ACAMERA_CONTROL_AF_REGIONS. The same applies in reverse to detected face rectangles if
-     * they need to be drawn on top of the corrected output buffers.</p>
+     * applied to any RAW output.</p>
+     * <p>This control will be on by default on devices that support this control. Applications
+     * disabling distortion correction need to pay extra attention with the coordinate system of
+     * metering regions, crop region, and face rectangles. When distortion correction is OFF,
+     * metadata coordinates follow the coordinate system of
+     * ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE. When distortion is not OFF, metadata
+     * coordinates follow the coordinate system of ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE.  The
+     * camera device will map these metadata fields to match the corrected image produced by the
+     * camera device, for both capture requests and results.  However, this mapping is not very
+     * precise, since rectangles do not generally map to rectangles when corrected.  Only linear
+     * scaling between the active array and precorrection active array coordinates is
+     * performed. Applications that require precise correction of metadata need to undo that
+     * linear scaling, and apply a more complete correction that takes into the account the app's
+     * own requirements.</p>
+     * <p>The full list of metadata that is affected in this way by distortion correction is:</p>
+     * <ul>
+     * <li>ACAMERA_CONTROL_AF_REGIONS</li>
+     * <li>ACAMERA_CONTROL_AE_REGIONS</li>
+     * <li>ACAMERA_CONTROL_AWB_REGIONS</li>
+     * <li>ACAMERA_SCALER_CROP_REGION</li>
+     * <li>android.statistics.faces</li>
+     * </ul>
      *
+     * @see ACAMERA_CONTROL_AE_REGIONS
      * @see ACAMERA_CONTROL_AF_REGIONS
+     * @see ACAMERA_CONTROL_AWB_REGIONS
      * @see ACAMERA_LENS_DISTORTION
+     * @see ACAMERA_SCALER_CROP_REGION
+     * @see ACAMERA_SENSOR_INFO_ACTIVE_ARRAY_SIZE
+     * @see ACAMERA_SENSOR_INFO_PRE_CORRECTION_ACTIVE_ARRAY_SIZE
      */
     ACAMERA_DISTORTION_CORRECTION_MODE =                        // byte (acamera_metadata_enum_android_distortion_correction_mode_t)
             ACAMERA_DISTORTION_CORRECTION_START,
@@ -7056,11 +7217,11 @@ typedef enum acamera_metadata_enum_acamera_request_available_capabilities {
      * camera in the list of supported camera devices.</p>
      * <p>This capability requires the camera device to support the following:</p>
      * <ul>
-     * <li>This camera device must list the following static metadata entries in <a href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics.html">CameraCharacteristics</a>:<ul>
-     * <li>android.logicalMultiCamera.physicalIds</li>
-     * <li>ACAMERA_LOGICAL_MULTI_CAMERA_SENSOR_SYNC_TYPE</li>
-     * </ul>
-     * </li>
+     * <li>The IDs of underlying physical cameras are returned via
+     *   <a href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics.html#getPhysicalCameraIds">CameraCharacteristics#getPhysicalCameraIds</a>.</li>
+     * <li>This camera device must list static metadata
+     *   ACAMERA_LOGICAL_MULTI_CAMERA_SENSOR_SYNC_TYPE in
+     *   <a href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics.html">CameraCharacteristics</a>.</li>
      * <li>The underlying physical cameras' static metadata must list the following entries,
      *   so that the application can correlate pixels from the physical streams:<ul>
      * <li>ACAMERA_LENS_POSE_REFERENCE</li>
diff --git a/cmds/screenrecord/screenrecord.cpp b/cmds/screenrecord/screenrecord.cpp
index 46035159e..d1859d142 100644
--- a/cmds/screenrecord/screenrecord.cpp
+++ b/cmds/screenrecord/screenrecord.cpp
@@ -139,14 +139,6 @@ static status_t configureSignals() {
     return NO_ERROR;
 }
 
-/*
- * Returns "true" if the device is rotated 90 degrees.
- */
-static bool isDeviceRotated(int orientation) {
-    return orientation != DISPLAY_ORIENTATION_0 &&
-            orientation != DISPLAY_ORIENTATION_180;
-}
-
 /*
  * Configures and starts the MediaCodec encoder.  Obtains an input surface
  * from the codec.
@@ -242,22 +234,11 @@ static status_t setDisplayProjection(
         const DisplayInfo& mainDpyInfo) {
 
     // Set the region of the layer stack we're interested in, which in our
-    // case is "all of it".  If the app is rotated (so that the width of the
-    // app is based on the height of the display), reverse width/height.
-    bool deviceRotated = isDeviceRotated(mainDpyInfo.orientation);
-    uint32_t sourceWidth, sourceHeight;
-    if (!deviceRotated) {
-        sourceWidth = mainDpyInfo.w;
-        sourceHeight = mainDpyInfo.h;
-    } else {
-        ALOGV("using rotated width/height");
-        sourceHeight = mainDpyInfo.w;
-        sourceWidth = mainDpyInfo.h;
-    }
-    Rect layerStackRect(sourceWidth, sourceHeight);
+    // case is "all of it".
+    Rect layerStackRect(mainDpyInfo.w, mainDpyInfo.h);
 
     // We need to preserve the aspect ratio of the display.
-    float displayAspect = (float) sourceHeight / (float) sourceWidth;
+    float displayAspect = (float) mainDpyInfo.h / (float) mainDpyInfo.w;
 
 
     // Set the way we map the output onto the display surface (which will
@@ -333,6 +314,22 @@ static status_t prepareVirtualDisplay(const DisplayInfo& mainDpyInfo,
     return NO_ERROR;
 }
 
+/*
+ * Set the main display width and height to the actual width and height
+ */
+static status_t getActualDisplaySize(const sp<IBinder>& mainDpy, DisplayInfo* mainDpyInfo) {
+    Rect viewport;
+    status_t err = SurfaceComposerClient::getDisplayViewport(mainDpy, &viewport);
+    if (err != NO_ERROR) {
+        fprintf(stderr, "ERROR: unable to get display viewport\n");
+        return err;
+    }
+    mainDpyInfo->w = viewport.width();
+    mainDpyInfo->h = viewport.height();
+
+    return NO_ERROR;
+}
+
 /*
  * Runs the MediaCodec encoder, sending the output to the MediaMuxer.  The
  * input frames are coming from the virtual display as fast as SurfaceFlinger
@@ -403,14 +400,22 @@ static status_t runEncoder(const sp<MediaCodec>& encoder,
                     // useful stuff is hard to get at without a Dalvik VM.
                     err = SurfaceComposerClient::getDisplayInfo(mainDpy,
                             &mainDpyInfo);
-                    if (err != NO_ERROR) {
+                    if (err == NO_ERROR) {
+                        err = getActualDisplaySize(mainDpy, &mainDpyInfo);
+                        if (err != NO_ERROR) {
+                            fprintf(stderr, "ERROR: unable to set actual display size\n");
+                            return err;
+                        }
+
+                        if (orientation != mainDpyInfo.orientation) {
+                            ALOGD("orientation changed, now %d", mainDpyInfo.orientation);
+                            SurfaceComposerClient::Transaction t;
+                            setDisplayProjection(t, virtualDpy, mainDpyInfo);
+                            t.apply();
+                            orientation = mainDpyInfo.orientation;
+                        }
+                    } else {
                         ALOGW("getDisplayInfo(main) failed: %d", err);
-                    } else if (orientation != mainDpyInfo.orientation) {
-                        ALOGD("orientation changed, now %d", mainDpyInfo.orientation);
-                        SurfaceComposerClient::Transaction t;
-                        setDisplayProjection(t, virtualDpy, mainDpyInfo);
-                        t.apply();
-                        orientation = mainDpyInfo.orientation;
                     }
                 }
 
@@ -552,6 +557,10 @@ static FILE* prepareRawOutput(const char* fileName) {
     return rawFp;
 }
 
+static inline uint32_t floorToEven(uint32_t num) {
+    return num & ~1;
+}
+
 /*
  * Main "do work" start point.
  *
@@ -579,6 +588,13 @@ static status_t recordScreen(const char* fileName) {
         fprintf(stderr, "ERROR: unable to get display characteristics\n");
         return err;
     }
+
+    err = getActualDisplaySize(mainDpy, &mainDpyInfo);
+    if (err != NO_ERROR) {
+        fprintf(stderr, "ERROR: unable to set actual display size\n");
+        return err;
+    }
+
     if (gVerbose) {
         printf("Main display is %dx%d @%.2ffps (orientation=%u)\n",
                 mainDpyInfo.w, mainDpyInfo.h, mainDpyInfo.fps,
@@ -586,12 +602,12 @@ static status_t recordScreen(const char* fileName) {
         fflush(stdout);
     }
 
-    bool rotated = isDeviceRotated(mainDpyInfo.orientation);
+    // Encoder can't take odd number as config
     if (gVideoWidth == 0) {
-        gVideoWidth = rotated ? mainDpyInfo.h : mainDpyInfo.w;
+        gVideoWidth = floorToEven(mainDpyInfo.w);
     }
     if (gVideoHeight == 0) {
-        gVideoHeight = rotated ? mainDpyInfo.w : mainDpyInfo.h;
+        gVideoHeight = floorToEven(mainDpyInfo.h);
     }
 
     // Configure and start the encoder.
diff --git a/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.cpp b/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.cpp
index 73ed8c363..1558e8b8d 100644
--- a/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.cpp
+++ b/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.cpp
@@ -118,9 +118,9 @@ status_t ClearKeyCasPlugin::openSession(CasSessionId* sessionId) {
 
 status_t ClearKeyCasPlugin::closeSession(const CasSessionId &sessionId) {
     ALOGV("closeSession: sessionId=%s", sessionIdToString(sessionId).string());
-    sp<ClearKeyCasSession> session =
+    std::shared_ptr<ClearKeyCasSession> session =
             ClearKeySessionLibrary::get()->findSession(sessionId);
-    if (session == NULL) {
+    if (session.get() == nullptr) {
         return ERROR_CAS_SESSION_NOT_OPENED;
     }
 
@@ -132,9 +132,9 @@ status_t ClearKeyCasPlugin::setSessionPrivateData(
         const CasSessionId &sessionId, const CasData & /*data*/) {
     ALOGV("setSessionPrivateData: sessionId=%s",
             sessionIdToString(sessionId).string());
-    sp<ClearKeyCasSession> session =
+    std::shared_ptr<ClearKeyCasSession> session =
             ClearKeySessionLibrary::get()->findSession(sessionId);
-    if (session == NULL) {
+    if (session.get() == nullptr) {
         return ERROR_CAS_SESSION_NOT_OPENED;
     }
     return OK;
@@ -143,9 +143,9 @@ status_t ClearKeyCasPlugin::setSessionPrivateData(
 status_t ClearKeyCasPlugin::processEcm(
         const CasSessionId &sessionId, const CasEcm& ecm) {
     ALOGV("processEcm: sessionId=%s", sessionIdToString(sessionId).string());
-    sp<ClearKeyCasSession> session =
+    std::shared_ptr<ClearKeyCasSession> session =
             ClearKeySessionLibrary::get()->findSession(sessionId);
-    if (session == NULL) {
+    if (session.get() == nullptr) {
         return ERROR_CAS_SESSION_NOT_OPENED;
     }
 
@@ -418,15 +418,15 @@ status_t ClearKeyDescramblerPlugin::setMediaCasSession(
         const CasSessionId &sessionId) {
     ALOGV("setMediaCasSession: sessionId=%s", sessionIdToString(sessionId).string());
 
-    sp<ClearKeyCasSession> session =
+    std::shared_ptr<ClearKeyCasSession> session =
             ClearKeySessionLibrary::get()->findSession(sessionId);
 
-    if (session == NULL) {
+    if (session.get() == nullptr) {
         ALOGE("ClearKeyDescramblerPlugin: session not found");
         return ERROR_CAS_SESSION_NOT_OPENED;
     }
 
-    mCASSession = session;
+    std::atomic_store(&mCASSession, session);
     return OK;
 }
 
@@ -447,12 +447,14 @@ ssize_t ClearKeyDescramblerPlugin::descramble(
           subSamplesToString(subSamples, numSubSamples).string(),
           srcPtr, dstPtr, srcOffset, dstOffset);
 
-    if (mCASSession == NULL) {
+    std::shared_ptr<ClearKeyCasSession> session = std::atomic_load(&mCASSession);
+
+    if (session.get() == nullptr) {
         ALOGE("Uninitialized CAS session!");
         return ERROR_CAS_DECRYPT_UNIT_NOT_INITIALIZED;
     }
 
-    return mCASSession->decrypt(
+    return session->decrypt(
             secure, scramblingControl,
             numSubSamples, subSamples,
             (uint8_t*)srcPtr + srcOffset,
diff --git a/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.h b/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.h
index 42cfb8f2f..389e1728d 100644
--- a/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.h
+++ b/drm/mediacas/plugins/clearkey/ClearKeyCasPlugin.h
@@ -120,7 +120,7 @@ public:
             AString *errorDetailMsg) override;
 
 private:
-    sp<ClearKeyCasSession> mCASSession;
+    std::shared_ptr<ClearKeyCasSession> mCASSession;
 
     String8 subSamplesToString(
             SubSample const *subSamples,
diff --git a/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.cpp b/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.cpp
index 4b4051d5b..3bb11768b 100644
--- a/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.cpp
+++ b/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.cpp
@@ -56,7 +56,7 @@ status_t ClearKeySessionLibrary::addSession(
 
     Mutex::Autolock lock(mSessionsLock);
 
-    sp<ClearKeyCasSession> session = new ClearKeyCasSession(plugin);
+    std::shared_ptr<ClearKeyCasSession> session(new ClearKeyCasSession(plugin));
 
     uint8_t *byteArray = (uint8_t *) &mNextSessionId;
     sessionId->push_back(byteArray[3]);
@@ -69,7 +69,7 @@ status_t ClearKeySessionLibrary::addSession(
     return OK;
 }
 
-sp<ClearKeyCasSession> ClearKeySessionLibrary::findSession(
+std::shared_ptr<ClearKeyCasSession> ClearKeySessionLibrary::findSession(
         const CasSessionId& sessionId) {
     Mutex::Autolock lock(mSessionsLock);
 
@@ -88,7 +88,7 @@ void ClearKeySessionLibrary::destroySession(const CasSessionId& sessionId) {
         return;
     }
 
-    sp<ClearKeyCasSession> session = mIDToSessionMap.valueAt(index);
+    std::shared_ptr<ClearKeyCasSession> session = mIDToSessionMap.valueAt(index);
     mIDToSessionMap.removeItemsAt(index);
 }
 
@@ -96,7 +96,7 @@ void ClearKeySessionLibrary::destroyPlugin(CasPlugin *plugin) {
     Mutex::Autolock lock(mSessionsLock);
 
     for (ssize_t index = (ssize_t)mIDToSessionMap.size() - 1; index >= 0; index--) {
-        sp<ClearKeyCasSession> session = mIDToSessionMap.valueAt(index);
+        std::shared_ptr<ClearKeyCasSession> session = mIDToSessionMap.valueAt(index);
         if (session->getPlugin() == plugin) {
             mIDToSessionMap.removeItemsAt(index);
         }
diff --git a/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.h b/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.h
index 01f5f477e..a537e63bc 100644
--- a/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.h
+++ b/drm/mediacas/plugins/clearkey/ClearKeySessionLibrary.h
@@ -32,6 +32,10 @@ class KeyFetcher;
 
 class ClearKeyCasSession : public RefBase {
 public:
+    explicit ClearKeyCasSession(CasPlugin *plugin);
+
+    virtual ~ClearKeyCasSession();
+
     ssize_t decrypt(
             bool secure,
             DescramblerPlugin::ScramblingControl scramblingControl,
@@ -58,8 +62,6 @@ private:
 
     friend class ClearKeySessionLibrary;
 
-    explicit ClearKeyCasSession(CasPlugin *plugin);
-    virtual ~ClearKeyCasSession();
     CasPlugin* getPlugin() const { return mPlugin; }
     status_t decryptPayload(
             const AES_KEY& key, size_t length, size_t offset, char* buffer) const;
@@ -73,7 +75,7 @@ public:
 
     status_t addSession(CasPlugin *plugin, CasSessionId *sessionId);
 
-    sp<ClearKeyCasSession> findSession(const CasSessionId& sessionId);
+    std::shared_ptr<ClearKeyCasSession> findSession(const CasSessionId& sessionId);
 
     void destroySession(const CasSessionId& sessionId);
 
@@ -85,7 +87,7 @@ private:
 
     Mutex mSessionsLock;
     uint32_t mNextSessionId;
-    KeyedVector<CasSessionId, sp<ClearKeyCasSession>> mIDToSessionMap;
+    KeyedVector<CasSessionId, std::shared_ptr<ClearKeyCasSession>> mIDToSessionMap;
 
     ClearKeySessionLibrary();
     DISALLOW_EVIL_CONSTRUCTORS(ClearKeySessionLibrary);
diff --git a/media/libmediaplayer2/nuplayer2/NuPlayer2CCDecoder.cpp b/media/libmediaplayer2/nuplayer2/NuPlayer2CCDecoder.cpp
index e48e38823..e2159659f 100644
--- a/media/libmediaplayer2/nuplayer2/NuPlayer2CCDecoder.cpp
+++ b/media/libmediaplayer2/nuplayer2/NuPlayer2CCDecoder.cpp
@@ -372,10 +372,16 @@ bool NuPlayer2::CCDecoder::parseMPEGCCData(int64_t timeUs, const uint8_t *data,
                             timeUs, mDTVCCPacket->data(), mDTVCCPacket->size());
                     mDTVCCPacket->setRange(0, 0);
                 }
+                if (mDTVCCPacket->size() + 2 > mDTVCCPacket->capacity()) {
+                    return false;
+                }
                 memcpy(mDTVCCPacket->data() + mDTVCCPacket->size(), br.data(), 2);
                 mDTVCCPacket->setRange(0, mDTVCCPacket->size() + 2);
                 br.skipBits(16);
             } else if (mDTVCCPacket->size() > 0 && cc_type == 2) {
+                if (mDTVCCPacket->size() + 2 > mDTVCCPacket->capacity()) {
+                    return false;
+                }
                 memcpy(mDTVCCPacket->data() + mDTVCCPacket->size(), br.data(), 2);
                 mDTVCCPacket->setRange(0, mDTVCCPacket->size() + 2);
                 br.skipBits(16);
@@ -403,6 +409,9 @@ bool NuPlayer2::CCDecoder::parseMPEGCCData(int64_t timeUs, const uint8_t *data,
                         line21CCBuf = new ABuffer((cc_count - i) * sizeof(CCData));
                         line21CCBuf->setRange(0, 0);
                     }
+                    if (line21CCBuf->size() + sizeof(cc) > line21CCBuf->capacity()) {
+                        return false;
+                    }
                     memcpy(line21CCBuf->data() + line21CCBuf->size(), &cc, sizeof(cc));
                     line21CCBuf->setRange(0, line21CCBuf->size() + sizeof(CCData));
                 }
@@ -464,6 +473,9 @@ bool NuPlayer2::CCDecoder::parseDTVCCPacket(int64_t timeUs, const uint8_t *data,
             size_t trackIndex = getTrackIndex(kTrackTypeCEA708, service_number, &trackAdded);
             if (mSelectedTrack == (ssize_t)trackIndex) {
                 sp<ABuffer> ccPacket = new ABuffer(block_size);
+                if (ccPacket->capacity() == 0) {
+                    return false;
+                }
                 memcpy(ccPacket->data(), br.data(), block_size);
                 mCCMap.add(timeUs, ccPacket);
             }
@@ -527,10 +539,12 @@ void NuPlayer2::CCDecoder::display(int64_t timeUs) {
         ccBuf = new ABuffer(size);
         ccBuf->setRange(0, 0);
 
-        for (ssize_t i = 0; i <= index; ++i) {
-            sp<ABuffer> buf = mCCMap.valueAt(i);
-            memcpy(ccBuf->data() + ccBuf->size(), buf->data(), buf->size());
-            ccBuf->setRange(0, ccBuf->size() + buf->size());
+        if (ccBuf->capacity() > 0) {
+            for (ssize_t i = 0; i <= index; ++i) {
+                sp<ABuffer> buf = mCCMap.valueAt(i);
+                memcpy(ccBuf->data() + ccBuf->size(), buf->data(), buf->size());
+                ccBuf->setRange(0, ccBuf->size() + buf->size());
+            }
         }
     }
 
diff --git a/media/libmediaplayerservice/nuplayer/NuPlayer.cpp b/media/libmediaplayerservice/nuplayer/NuPlayer.cpp
index 3ece28b5e..027a4f9fd 100644
--- a/media/libmediaplayerservice/nuplayer/NuPlayer.cpp
+++ b/media/libmediaplayerservice/nuplayer/NuPlayer.cpp
@@ -1120,6 +1120,7 @@ void NuPlayer::onMessageReceived(const sp<AMessage> &msg) {
             } else if (what == DecoderBase::kWhatShutdownCompleted) {
                 ALOGV("%s shutdown completed", audio ? "audio" : "video");
                 if (audio) {
+                    Mutex::Autolock autoLock(mDecoderLock);
                     mAudioDecoder.clear();
                     mAudioDecoderError = false;
                     ++mAudioDecoderGeneration;
@@ -1127,6 +1128,7 @@ void NuPlayer::onMessageReceived(const sp<AMessage> &msg) {
                     CHECK_EQ((int)mFlushingAudio, (int)SHUTTING_DOWN_DECODER);
                     mFlushingAudio = SHUT_DOWN;
                 } else {
+                    Mutex::Autolock autoLock(mDecoderLock);
                     mVideoDecoder.clear();
                     mVideoDecoderError = false;
                     ++mVideoDecoderGeneration;
@@ -1447,29 +1449,6 @@ void NuPlayer::onMessageReceived(const sp<AMessage> &msg) {
             break;
         }
 
-        case kWhatGetStats:
-        {
-            ALOGV("kWhatGetStats");
-
-            Vector<sp<AMessage>> *trackStats;
-            CHECK(msg->findPointer("trackstats", (void**)&trackStats));
-
-            trackStats->clear();
-            if (mVideoDecoder != NULL) {
-                trackStats->push_back(mVideoDecoder->getStats());
-            }
-            if (mAudioDecoder != NULL) {
-                trackStats->push_back(mAudioDecoder->getStats());
-            }
-
-            // respond for synchronization
-            sp<AMessage> response = new AMessage;
-            sp<AReplyToken> replyID;
-            CHECK(msg->senderAwaitsResponse(&replyID));
-            response->postReply(replyID);
-            break;
-        }
-
         default:
             TRESPASS();
             break;
@@ -1817,6 +1796,7 @@ void NuPlayer::restartAudio(
           (long long)currentPositionUs, forceNonOffload, needsToCreateAudioDecoder);
     if (mAudioDecoder != NULL) {
         mAudioDecoder->pause();
+        Mutex::Autolock autoLock(mDecoderLock);
         mAudioDecoder.clear();
         mAudioDecoderError = false;
         ++mAudioDecoderGeneration;
@@ -1935,6 +1915,8 @@ status_t NuPlayer::instantiateDecoder(
         }
     }
 
+    Mutex::Autolock autoLock(mDecoderLock);
+
     if (audio) {
         sp<AMessage> notify = new AMessage(kWhatAudioNotify, this);
         ++mAudioDecoderGeneration;
@@ -2236,13 +2218,15 @@ status_t NuPlayer::getCurrentPosition(int64_t *mediaUs) {
 void NuPlayer::getStats(Vector<sp<AMessage> > *trackStats) {
     CHECK(trackStats != NULL);
 
-    ALOGV("NuPlayer::getStats()");
-    sp<AMessage> msg = new AMessage(kWhatGetStats, this);
-    msg->setPointer("trackstats", trackStats);
+    trackStats->clear();
 
-    sp<AMessage> response;
-    (void) msg->postAndAwaitResponse(&response);
-    // response is for synchronization, ignore contents
+    Mutex::Autolock autoLock(mDecoderLock);
+    if (mVideoDecoder != NULL) {
+        trackStats->push_back(mVideoDecoder->getStats());
+    }
+    if (mAudioDecoder != NULL) {
+        trackStats->push_back(mAudioDecoder->getStats());
+    }
 }
 
 sp<MetaData> NuPlayer::getFileMeta() {
diff --git a/media/libmediaplayerservice/nuplayer/NuPlayer.h b/media/libmediaplayerservice/nuplayer/NuPlayer.h
index e400d161a..9f5be06d7 100644
--- a/media/libmediaplayerservice/nuplayer/NuPlayer.h
+++ b/media/libmediaplayerservice/nuplayer/NuPlayer.h
@@ -159,7 +159,6 @@ private:
         kWhatPrepareDrm                 = 'pDrm',
         kWhatReleaseDrm                 = 'rDrm',
         kWhatMediaClockNotify           = 'mckN',
-        kWhatGetStats                   = 'gSts',
     };
 
     wp<NuPlayerDriver> mDriver;
@@ -175,6 +174,7 @@ private:
     sp<DecoderBase> mVideoDecoder;
     bool mOffloadAudio;
     sp<DecoderBase> mAudioDecoder;
+    Mutex mDecoderLock;  // guard |mAudioDecoder| and |mVideoDecoder|.
     sp<CCDecoder> mCCDecoder;
     sp<Renderer> mRenderer;
     sp<ALooper> mRendererLooper;
diff --git a/media/libstagefright/CameraSource.cpp b/media/libstagefright/CameraSource.cpp
index 429e3a8bd..b5954b696 100644
--- a/media/libstagefright/CameraSource.cpp
+++ b/media/libstagefright/CameraSource.cpp
@@ -221,6 +221,7 @@ CameraSource::CameraSource(
       mNumFramesReceived(0),
       mLastFrameTimestampUs(0),
       mStarted(false),
+      mEos(false),
       mNumFramesEncoded(0),
       mTimeBetweenFrameCaptureUs(0),
       mFirstFrameTimeUs(0),
@@ -884,6 +885,7 @@ status_t CameraSource::reset() {
     {
         Mutex::Autolock autoLock(mLock);
         mStarted = false;
+        mEos = false;
         mStopSystemTimeUs = -1;
         mFrameAvailableCondition.signal();
 
@@ -1079,7 +1081,7 @@ status_t CameraSource::read(
 
     {
         Mutex::Autolock autoLock(mLock);
-        while (mStarted && mFramesReceived.empty()) {
+        while (mStarted && !mEos && mFramesReceived.empty()) {
             if (NO_ERROR !=
                 mFrameAvailableCondition.waitRelative(mLock,
                     mTimeBetweenFrameCaptureUs * 1000LL + CAMERA_SOURCE_TIMEOUT_NS)) {
@@ -1095,6 +1097,9 @@ status_t CameraSource::read(
         if (!mStarted) {
             return OK;
         }
+        if (mFramesReceived.empty()) {
+            return ERROR_END_OF_STREAM;
+        }
         frame = *mFramesReceived.begin();
         mFramesReceived.erase(mFramesReceived.begin());
 
@@ -1133,6 +1138,8 @@ bool CameraSource::shouldSkipFrameLocked(int64_t timestampUs) {
     if (mStopSystemTimeUs != -1 && timestampUs >= mStopSystemTimeUs) {
         ALOGV("Drop Camera frame at %lld  stop time: %lld us",
                 (long long)timestampUs, (long long)mStopSystemTimeUs);
+        mEos = true;
+        mFrameAvailableCondition.signal();
         return true;
     }
 
diff --git a/media/libstagefright/FrameDecoder.cpp b/media/libstagefright/FrameDecoder.cpp
index 29a219f5f..6e94517a3 100644
--- a/media/libstagefright/FrameDecoder.cpp
+++ b/media/libstagefright/FrameDecoder.cpp
@@ -301,10 +301,13 @@ status_t FrameDecoder::extractInternal() {
             err = mSource->read(&mediaBuffer, &mReadOptions);
             mReadOptions.clearSeekTo();
             if (err != OK) {
-                ALOGW("Input Error or EOS");
                 mHaveMoreInputs = false;
                 if (!mFirstSample && err == ERROR_END_OF_STREAM) {
+                    (void)mDecoder->queueInputBuffer(
+                            index, 0, 0, 0, MediaCodec::BUFFER_FLAG_EOS);
                     err = OK;
+                } else {
+                    ALOGW("Input Error: err=%d", err);
                 }
                 break;
             }
diff --git a/media/libstagefright/MediaCodec.cpp b/media/libstagefright/MediaCodec.cpp
index 72eff946c..353e40702 100644
--- a/media/libstagefright/MediaCodec.cpp
+++ b/media/libstagefright/MediaCodec.cpp
@@ -860,7 +860,15 @@ static CodecBase *CreateCCodec() {
 }
 
 //static
-sp<CodecBase> MediaCodec::GetCodecBase(const AString &name) {
+sp<CodecBase> MediaCodec::GetCodecBase(const AString &name, const char *owner) {
+    if (owner) {
+        if (strncmp(owner, "default", 8) == 0) {
+            return new ACodec;
+        } else if (strncmp(owner, "codec2", 7) == 0) {
+            return CreateCCodec();
+        }
+    }
+
     if (name.startsWithIgnoreCase("c2.")) {
         return CreateCCodec();
     } else if (name.startsWithIgnoreCase("omx.")) {
@@ -884,11 +892,6 @@ status_t MediaCodec::init(const AString &name) {
     // we need to invest in an extra looper to free the main event
     // queue.
 
-    mCodec = GetCodecBase(name);
-    if (mCodec == NULL) {
-        return NAME_NOT_FOUND;
-    }
-
     mCodecInfo.clear();
 
     bool secureCodec = false;
@@ -922,6 +925,11 @@ status_t MediaCodec::init(const AString &name) {
         return NAME_NOT_FOUND;
     }
 
+    mCodec = GetCodecBase(name, mCodecInfo->getOwnerName());
+    if (mCodec == NULL) {
+        return NAME_NOT_FOUND;
+    }
+
     if (mIsVideo) {
         // video codec needs dedicated looper
         if (mCodecLooper == NULL) {
@@ -1935,7 +1943,9 @@ void MediaCodec::onMessageReceived(const sp<AMessage> &msg) {
                         mAnalyticsItem->setCString(kCodecCodec, mComponentName.c_str());
                     }
 
-                    if (mComponentName.startsWith("OMX.google.")) {
+                    const char *owner = mCodecInfo->getOwnerName();
+                    if (mComponentName.startsWith("OMX.google.")
+                            && (owner == nullptr || strncmp(owner, "default", 8) == 0)) {
                         mFlags |= kFlagUsesSoftwareRenderer;
                     } else {
                         mFlags &= ~kFlagUsesSoftwareRenderer;
diff --git a/media/libstagefright/VideoFrameScheduler.cpp b/media/libstagefright/VideoFrameScheduler.cpp
index 6819bba40..9020fc1aa 100644
--- a/media/libstagefright/VideoFrameScheduler.cpp
+++ b/media/libstagefright/VideoFrameScheduler.cpp
@@ -475,7 +475,16 @@ nsecs_t VideoFrameScheduler::schedule(nsecs_t renderTime) {
                 nextVsyncTime += mVsyncPeriod;
                 if (vsyncsForLastFrame < ULONG_MAX)
                     ++vsyncsForLastFrame;
+            } else if (mTimeCorrection < -correctionLimit * 2
+                    || mTimeCorrection > correctionLimit * 2) {
+                ALOGW("correction beyond limit: %lld vs %lld (vsyncs for last frame: %zu, min: %zu)"
+                        " restarting. render=%lld",
+                        (long long)mTimeCorrection, (long long)correctionLimit,
+                        vsyncsForLastFrame, minVsyncsPerFrame, (long long)origRenderTime);
+                restart();
+                return origRenderTime;
             }
+
             ATRACE_INT("FRAME_VSYNCS", vsyncsForLastFrame);
         }
         mLastVsyncTime = nextVsyncTime;
diff --git a/media/libstagefright/codecs/mp3dec/src/pvmp3_framedecoder.cpp b/media/libstagefright/codecs/mp3dec/src/pvmp3_framedecoder.cpp
index 26bc25cd2..df6cd0393 100644
--- a/media/libstagefright/codecs/mp3dec/src/pvmp3_framedecoder.cpp
+++ b/media/libstagefright/codecs/mp3dec/src/pvmp3_framedecoder.cpp
@@ -299,7 +299,11 @@ ERROR_CODE pvmp3_framedecoder(tPVMP3DecoderExternal *pExt,
         }
 
 
-        bytes_to_discard = pVars->frame_start - pVars->sideInfo.main_data_begin - main_data_end;
+        // force signed computation; buffer sizes and offsets are all going to be
+        // well within the constraints of 32-bit signed math.
+        bytes_to_discard = pVars->frame_start
+                           - ((int32)pVars->sideInfo.main_data_begin)
+                           - ((int32)main_data_end);
 
 
         if (main_data_end > BUFSIZE)   /* check overflow on the buffer */
diff --git a/media/libstagefright/codecs/mp3dec/src/pvmp3_get_side_info.cpp b/media/libstagefright/codecs/mp3dec/src/pvmp3_get_side_info.cpp
index 7eaa86073..e55c2e70b 100644
--- a/media/libstagefright/codecs/mp3dec/src/pvmp3_get_side_info.cpp
+++ b/media/libstagefright/codecs/mp3dec/src/pvmp3_get_side_info.cpp
@@ -154,7 +154,7 @@ ERROR_CODE pvmp3_get_side_info(tmp3Bits    *inputStream,
                 tmp = getbits_crc(inputStream, 22, crc, info->error_protection);
 
                 si->ch[ch].gran[gr].big_values            = (tmp << 10) >> 23;   /* 9 */
-                si->ch[ch].gran[gr].global_gain           = ((tmp << 19) >> 24) - 210;   /* 8 */
+                si->ch[ch].gran[gr].global_gain        = (int32)((tmp << 19) >> 24) - 210; /* 8 */
                 si->ch[ch].gran[gr].scalefac_compress     = (tmp << 27) >> 28;   /* 4 */
                 si->ch[ch].gran[gr].window_switching_flag = tmp & 1;         /* 1 */
 
diff --git a/media/libstagefright/codecs/mp3dec/src/pvmp3_stereo_proc.cpp b/media/libstagefright/codecs/mp3dec/src/pvmp3_stereo_proc.cpp
index 10edfc3b3..4338c4380 100644
--- a/media/libstagefright/codecs/mp3dec/src/pvmp3_stereo_proc.cpp
+++ b/media/libstagefright/codecs/mp3dec/src/pvmp3_stereo_proc.cpp
@@ -178,6 +178,10 @@ const int32  is_ratio_factor[8] = {0,
 ; FUNCTION CODE
 ----------------------------------------------------------------------------*/
 
+#if __has_attribute(no_sanitize)
+// deliberately playing near overflow points of int32
+__attribute__((no_sanitize("integer")))
+#endif
 void pvmp3_st_mid_side(int32 xr[SUBBANDS_NUMBER*FILTERBANK_BANDS],
                        int32 xl[SUBBANDS_NUMBER*FILTERBANK_BANDS],
                        int32 Start,
diff --git a/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp b/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp
index f173e0fba..06b15b3e5 100644
--- a/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp
+++ b/media/libstagefright/codecs/xaacdec/SoftXAAC.cpp
@@ -689,7 +689,6 @@ void SoftXAAC::onQueueFilled(OMX_U32 /* portIndex */) {
                     notify(OMX_EventError, OMX_ErrorUndefined, err_code, NULL);
                     return;
                 }
-                mIsCodecConfigFlushRequired = true;
             }
 
             if (!mSampFreq || !mNumChannels) {
@@ -713,10 +712,14 @@ void SoftXAAC::onQueueFilled(OMX_U32 /* portIndex */) {
             signed int bytesConsumed = 0;
             int errorCode = 0;
             if (mIsCodecInitialized) {
+                mIsCodecConfigFlushRequired = true;
                 errorCode =
                     decodeXAACStream(inBuffer, inBufferLength, &bytesConsumed, &numOutBytes);
-            } else {
+            } else if (!mIsCodecConfigFlushRequired) {
                 ALOGW("Assumption that first frame after header initializes decoder failed!");
+                mSignalledError = true;
+                notify(OMX_EventError, OMX_ErrorUndefined, -1, NULL);
+                return;
             }
             inHeader->nFilledLen -= bytesConsumed;
             inHeader->nOffset += bytesConsumed;
diff --git a/media/libstagefright/include/media/stagefright/CameraSource.h b/media/libstagefright/include/media/stagefright/CameraSource.h
index 475976b6e..3037b72ff 100644
--- a/media/libstagefright/include/media/stagefright/CameraSource.h
+++ b/media/libstagefright/include/media/stagefright/CameraSource.h
@@ -204,6 +204,7 @@ protected:
     int32_t mNumFramesReceived;
     int64_t mLastFrameTimestampUs;
     bool mStarted;
+    bool mEos;
     int32_t mNumFramesEncoded;
 
     // Time between capture of two frames.
diff --git a/media/libstagefright/include/media/stagefright/MediaCodec.h b/media/libstagefright/include/media/stagefright/MediaCodec.h
index ad02004aa..7f6aae628 100644
--- a/media/libstagefright/include/media/stagefright/MediaCodec.h
+++ b/media/libstagefright/include/media/stagefright/MediaCodec.h
@@ -377,7 +377,7 @@ private:
 
     MediaCodec(const sp<ALooper> &looper, pid_t pid, uid_t uid);
 
-    static sp<CodecBase> GetCodecBase(const AString &name);
+    static sp<CodecBase> GetCodecBase(const AString &name, const char *owner = nullptr);
 
     static status_t PostAndAwaitResponse(
             const sp<AMessage> &msg, sp<AMessage> *response);
diff --git a/media/libstagefright/omx/OMXNodeInstance.cpp b/media/libstagefright/omx/OMXNodeInstance.cpp
index a68f9c75f..cfab2dac9 100644
--- a/media/libstagefright/omx/OMXNodeInstance.cpp
+++ b/media/libstagefright/omx/OMXNodeInstance.cpp
@@ -1613,12 +1613,15 @@ status_t OMXNodeInstance::freeBuffer(
     }
     BufferMeta *buffer_meta = static_cast<BufferMeta *>(header->pAppPrivate);
 
+    // Invalidate buffers in the client side first before calling OMX_FreeBuffer.
+    // If not, pending events in the client side might access the buffers after free.
+    invalidateBufferID(buffer);
+
     OMX_ERRORTYPE err = OMX_FreeBuffer(mHandle, portIndex, header);
     CLOG_IF_ERROR(freeBuffer, err, "%s:%u %#x", portString(portIndex), portIndex, buffer);
 
     delete buffer_meta;
     buffer_meta = NULL;
-    invalidateBufferID(buffer);
 
     return StatusFromOMXError(err);
 }
diff --git a/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp b/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp
index d34214b72..22065262a 100644
--- a/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp
+++ b/services/audiopolicy/common/managerdefinitions/src/SessionRoute.cpp
@@ -14,7 +14,7 @@
  * limitations under the License.
  */
 
-#define LOG_TAG "APM::SessionRoute"
+#define LOG_TAG "APM_SessionRoute"
 //#define LOG_NDEBUG 0
 
 #include "SessionRoute.h"
@@ -122,19 +122,17 @@ void SessionRouteMap::addRoute(audio_session_t session,
 audio_devices_t SessionRouteMap::getActiveDeviceForStream(audio_stream_type_t streamType,
                                                           const DeviceVector& availableDevices)
 {
-    audio_devices_t device = AUDIO_DEVICE_NONE;
-
     for (size_t index = 0; index < size(); index++) {
         sp<SessionRoute> route = valueAt(index);
         if (streamType == route->mStreamType && route->isActiveOrChanged()
                 && route->mDeviceDescriptor != 0) {
-            device = route->mDeviceDescriptor->type();
+            audio_devices_t device = route->mDeviceDescriptor->type();
             if (!availableDevices.getDevicesFromType(device).isEmpty()) {
-                break;
+                return device;
             }
         }
     }
-    return device;
+    return AUDIO_DEVICE_NONE;
 }
 
 } // namespace android
diff --git a/services/audiopolicy/managerdefault/AudioPolicyManager.cpp b/services/audiopolicy/managerdefault/AudioPolicyManager.cpp
index 97e75bd67..51654e838 100644
--- a/services/audiopolicy/managerdefault/AudioPolicyManager.cpp
+++ b/services/audiopolicy/managerdefault/AudioPolicyManager.cpp
@@ -4882,11 +4882,15 @@ audio_devices_t AudioPolicyManager::getNewOutputDevice(const sp<AudioOutputDescr
     //      use device for strategy DTMF
     // 9: the strategy for beacon, a.k.a. "transmitted through speaker" is active on the output:
     //      use device for strategy t-t-s
+
+    // FIXME: extend use of isStrategyActiveOnSameModule() to all strategies
+    // with a refined rule considering mutually exclusive devices (using same backend)
+    // as opposed to all streams on the same audio HAL module.
     if (isStrategyActive(outputDesc, STRATEGY_ENFORCED_AUDIBLE) &&
         mEngine->getForceUse(AUDIO_POLICY_FORCE_FOR_SYSTEM) == AUDIO_POLICY_FORCE_SYSTEM_ENFORCED) {
         device = getDeviceForStrategy(STRATEGY_ENFORCED_AUDIBLE, fromCache);
     } else if (isInCall() ||
-                    isStrategyActive(outputDesc, STRATEGY_PHONE)) {
+               isStrategyActiveOnSameModule(outputDesc, STRATEGY_PHONE)) {
         device = getDeviceForStrategy(STRATEGY_PHONE, fromCache);
     } else if (isStrategyActive(outputDesc, STRATEGY_SONIFICATION)) {
         device = getDeviceForStrategy(STRATEGY_SONIFICATION, fromCache);
@@ -5894,6 +5898,20 @@ bool AudioPolicyManager::isStrategyActive(const sp<AudioOutputDescriptor>& outpu
     return false;
 }
 
+bool AudioPolicyManager::isStrategyActiveOnSameModule(const sp<AudioOutputDescriptor>& outputDesc,
+                                          routing_strategy strategy, uint32_t inPastMs,
+                                          nsecs_t sysTime) const
+{
+    for (size_t i = 0; i < mOutputs.size(); i++) {
+        sp<SwAudioOutputDescriptor> desc = mOutputs.valueAt(i);
+        if (outputDesc->sharesHwModuleWith(desc)
+            && isStrategyActive(desc, strategy, inPastMs, sysTime)) {
+            return true;
+        }
+    }
+    return false;
+}
+
 audio_policy_forced_cfg_t AudioPolicyManager::getForceUse(audio_policy_force_use_t usage)
 {
     return mEngine->getForceUse(usage);
diff --git a/services/audiopolicy/managerdefault/AudioPolicyManager.h b/services/audiopolicy/managerdefault/AudioPolicyManager.h
index f3d333a4a..a44a0bdfb 100644
--- a/services/audiopolicy/managerdefault/AudioPolicyManager.h
+++ b/services/audiopolicy/managerdefault/AudioPolicyManager.h
@@ -321,6 +321,10 @@ protected:
         bool isStrategyActive(const sp<AudioOutputDescriptor>& outputDesc, routing_strategy strategy,
                               uint32_t inPastMs = 0, nsecs_t sysTime = 0) const;
 
+        bool isStrategyActiveOnSameModule(const sp<AudioOutputDescriptor>& outputDesc,
+                                                  routing_strategy strategy, uint32_t inPastMs = 0,
+                                                  nsecs_t sysTime = 0) const;
+
         // change the route of the specified output. Returns the number of ms we have slept to
         // allow new routing to take effect in certain cases.
         virtual uint32_t setOutputDevice(const sp<AudioOutputDescriptor>& outputDesc,
diff --git a/services/camera/libcameraservice/CameraService.cpp b/services/camera/libcameraservice/CameraService.cpp
index 0e7988730..0716af4d8 100644
--- a/services/camera/libcameraservice/CameraService.cpp
+++ b/services/camera/libcameraservice/CameraService.cpp
@@ -2468,7 +2468,8 @@ bool CameraService::UidPolicy::isUidActive(uid_t uid, String16 callingPackage) {
     return isUidActiveLocked(uid, callingPackage);
 }
 
-static const int kPollUidActiveTimeoutMillis = 50;
+static const int64_t kPollUidActiveTimeoutTotalMillis = 300;
+static const int64_t kPollUidActiveTimeoutMillis = 50;
 
 bool CameraService::UidPolicy::isUidActiveLocked(uid_t uid, String16 callingPackage) {
     // Non-app UIDs are considered always active
@@ -2496,7 +2497,8 @@ bool CameraService::UidPolicy::isUidActiveLocked(uid_t uid, String16 callingPack
             // activity being resumed. The proper fix is very risky, so we temporary add
             // some polling which should happen pretty rarely anyway as the race is hard
             // to hit.
-            active = am.isUidActive(uid, callingPackage);
+            active = mActiveUids.find(uid) != mActiveUids.end();
+            if (!active) active = am.isUidActive(uid, callingPackage);
             if (active) {
                 break;
             }
@@ -2504,11 +2506,15 @@ bool CameraService::UidPolicy::isUidActiveLocked(uid_t uid, String16 callingPack
                 startTimeMillis = uptimeMillis();
             }
             int64_t ellapsedTimeMillis = uptimeMillis() - startTimeMillis;
-            int64_t remainingTimeMillis = kPollUidActiveTimeoutMillis - ellapsedTimeMillis;
+            int64_t remainingTimeMillis = kPollUidActiveTimeoutTotalMillis - ellapsedTimeMillis;
             if (remainingTimeMillis <= 0) {
                 break;
             }
+            remainingTimeMillis = std::min(kPollUidActiveTimeoutMillis, remainingTimeMillis);
+
+            mUidLock.unlock();
             usleep(remainingTimeMillis * 1000);
+            mUidLock.lock();
         } while (true);
 
         if (active) {
diff --git a/services/camera/libcameraservice/api1/Camera2Client.cpp b/services/camera/libcameraservice/api1/Camera2Client.cpp
index 65faac94b..d59b31328 100644
--- a/services/camera/libcameraservice/api1/Camera2Client.cpp
+++ b/services/camera/libcameraservice/api1/Camera2Client.cpp
@@ -102,7 +102,7 @@ status_t Camera2Client::initializeImpl(TProviderPtr providerPtr, const String8&
     {
         SharedParameters::Lock l(mParameters);
 
-        res = l.mParameters.initialize(&(mDevice->info()), mDeviceVersion);
+        res = l.mParameters.initialize(mDevice.get(), mDeviceVersion);
         if (res != OK) {
             ALOGE("%s: Camera %d: unable to build defaults: %s (%d)",
                     __FUNCTION__, mCameraId, strerror(-res), res);
@@ -250,6 +250,7 @@ status_t Camera2Client::dumpClient(int fd, const Vector<String16>& args) {
     switch (p.sceneMode) {
         case ANDROID_CONTROL_SCENE_MODE_DISABLED:
             result.append("AUTO\n"); break;
+        CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_FACE_PRIORITY)
         CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_ACTION)
         CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_PORTRAIT)
         CASE_APPEND_ENUM(ANDROID_CONTROL_SCENE_MODE_LANDSCAPE)
diff --git a/services/camera/libcameraservice/api1/client2/Parameters.cpp b/services/camera/libcameraservice/api1/client2/Parameters.cpp
index d66dec49e..28d186abb 100644
--- a/services/camera/libcameraservice/api1/client2/Parameters.cpp
+++ b/services/camera/libcameraservice/api1/client2/Parameters.cpp
@@ -41,23 +41,29 @@ Parameters::Parameters(int cameraId,
         int cameraFacing) :
         cameraId(cameraId),
         cameraFacing(cameraFacing),
-        info(NULL) {
+        info(NULL),
+        mDefaultSceneMode(ANDROID_CONTROL_SCENE_MODE_DISABLED) {
 }
 
 Parameters::~Parameters() {
 }
 
-status_t Parameters::initialize(const CameraMetadata *info, int deviceVersion) {
+status_t Parameters::initialize(CameraDeviceBase *device, int deviceVersion) {
     status_t res;
+    if (device == nullptr) {
+        ALOGE("%s: device is null!", __FUNCTION__);
+        return BAD_VALUE;
+    }
 
-    if (info->entryCount() == 0) {
+    const CameraMetadata& info = device->info();
+    if (info.entryCount() == 0) {
         ALOGE("%s: No static information provided!", __FUNCTION__);
         return BAD_VALUE;
     }
-    Parameters::info = info;
+    Parameters::info = &info;
     mDeviceVersion = deviceVersion;
 
-    res = buildFastInfo();
+    res = buildFastInfo(device);
     if (res != OK) return res;
 
     res = buildQuirks();
@@ -557,6 +563,10 @@ status_t Parameters::initialize(const CameraMetadata *info, int deviceVersion) {
                     noSceneModes = true;
                     break;
                 case ANDROID_CONTROL_SCENE_MODE_FACE_PRIORITY:
+                    // Face priority can be used as alternate default if supported.
+                    // Per API contract it shouldn't override the user set flash,
+                    // white balance and focus modes.
+                    mDefaultSceneMode = availableSceneModes.data.u8[i];
                     // Not in old API
                     addComma = false;
                     break;
@@ -761,17 +771,7 @@ status_t Parameters::initialize(const CameraMetadata *info, int deviceVersion) {
     focusingAreas.clear();
     focusingAreas.add(Parameters::Area(0,0,0,0,0));
 
-    if (fastInfo.isExternalCamera) {
-        params.setFloat(CameraParameters::KEY_FOCAL_LENGTH, -1.0);
-    } else {
-        camera_metadata_ro_entry_t availableFocalLengths =
-            staticInfo(ANDROID_LENS_INFO_AVAILABLE_FOCAL_LENGTHS, 0, 0, false);
-        if (!availableFocalLengths.count) return NO_INIT;
-
-        float minFocalLength = availableFocalLengths.data.f[0];
-        params.setFloat(CameraParameters::KEY_FOCAL_LENGTH, minFocalLength);
-    }
-
+    params.setFloat(CameraParameters::KEY_FOCAL_LENGTH, fastInfo.defaultFocalLength);
 
     float horizFov, vertFov;
     res = calculatePictureFovs(&horizFov, &vertFov);
@@ -993,7 +993,7 @@ String8 Parameters::get() const {
     return paramsFlattened;
 }
 
-status_t Parameters::buildFastInfo() {
+status_t Parameters::buildFastInfo(CameraDeviceBase *device) {
 
     camera_metadata_ro_entry_t activeArraySize =
         staticInfo(ANDROID_SENSOR_INFO_ACTIVE_ARRAY_SIZE, 2, 4);
@@ -1109,20 +1109,12 @@ status_t Parameters::buildFastInfo() {
             focusDistanceCalibration.data.u8[0] !=
             ANDROID_LENS_INFO_FOCUS_DISTANCE_CALIBRATION_UNCALIBRATED);
 
-
-    camera_metadata_ro_entry_t hwLevel = staticInfo(ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL);
-    if (!hwLevel.count) return NO_INIT;
-    fastInfo.isExternalCamera =
-            hwLevel.data.u8[0] == ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL_EXTERNAL;
-
-    camera_metadata_ro_entry_t availableFocalLengths =
-        staticInfo(ANDROID_LENS_INFO_AVAILABLE_FOCAL_LENGTHS, 0, 0, /*required*/false);
-    if (!availableFocalLengths.count && !fastInfo.isExternalCamera) return NO_INIT;
+    res = getDefaultFocalLength(device);
+    if (res != OK) return res;
 
     SortedVector<int32_t> availableFormats = getAvailableOutputFormats();
     if (!availableFormats.size()) return NO_INIT;
 
-
     if (sceneModeOverrides.count > 0) {
         // sceneModeOverrides is defined to have 3 entries for each scene mode,
         // which are AE, AWB, and AF override modes the HAL wants for that scene
@@ -1200,19 +1192,6 @@ status_t Parameters::buildFastInfo() {
     fastInfo.bestFaceDetectMode = bestFaceDetectMode;
     fastInfo.maxFaces = maxFaces;
 
-    // Find smallest (widest-angle) focal length to use as basis of still
-    // picture FOV reporting.
-    if (fastInfo.isExternalCamera) {
-        fastInfo.minFocalLength = -1.0;
-    } else {
-        fastInfo.minFocalLength = availableFocalLengths.data.f[0];
-        for (size_t i = 1; i < availableFocalLengths.count; i++) {
-            if (fastInfo.minFocalLength > availableFocalLengths.data.f[i]) {
-                fastInfo.minFocalLength = availableFocalLengths.data.f[i];
-            }
-        }
-    }
-
     // Check if the HAL supports HAL_PIXEL_FORMAT_YCbCr_420_888
     fastInfo.useFlexibleYuv = false;
     for (size_t i = 0; i < availableFormats.size(); i++) {
@@ -1760,7 +1739,7 @@ status_t Parameters::set(const String8& paramString) {
 
     // SCENE_MODE
     validatedParams.sceneMode = sceneModeStringToEnum(
-        newParams.get(CameraParameters::KEY_SCENE_MODE) );
+        newParams.get(CameraParameters::KEY_SCENE_MODE), mDefaultSceneMode);
     if (validatedParams.sceneMode != sceneMode &&
             validatedParams.sceneMode !=
             ANDROID_CONTROL_SCENE_MODE_DISABLED) {
@@ -1778,7 +1757,7 @@ status_t Parameters::set(const String8& paramString) {
         }
     }
     bool sceneModeSet =
-            validatedParams.sceneMode != ANDROID_CONTROL_SCENE_MODE_DISABLED;
+            validatedParams.sceneMode != mDefaultSceneMode;
 
     // FLASH_MODE
     if (sceneModeSet) {
@@ -2157,7 +2136,7 @@ status_t Parameters::updateRequest(CameraMetadata *request) const {
     uint8_t reqSceneMode =
             sceneModeActive ? sceneMode :
             enableFaceDetect ? (uint8_t)ANDROID_CONTROL_SCENE_MODE_FACE_PRIORITY :
-            (uint8_t)ANDROID_CONTROL_SCENE_MODE_DISABLED;
+            mDefaultSceneMode;
     res = request->update(ANDROID_CONTROL_SCENE_MODE,
             &reqSceneMode, 1);
     if (res != OK) return res;
@@ -2446,6 +2425,50 @@ bool Parameters::useZeroShutterLag() const {
     return true;
 }
 
+status_t Parameters::getDefaultFocalLength(CameraDeviceBase *device) {
+    if (device == nullptr) {
+        ALOGE("%s: Camera device is nullptr", __FUNCTION__);
+        return BAD_VALUE;
+    }
+
+    camera_metadata_ro_entry_t hwLevel = staticInfo(ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL);
+    if (!hwLevel.count) return NO_INIT;
+    fastInfo.isExternalCamera =
+            hwLevel.data.u8[0] == ANDROID_INFO_SUPPORTED_HARDWARE_LEVEL_EXTERNAL;
+
+    camera_metadata_ro_entry_t availableFocalLengths =
+        staticInfo(ANDROID_LENS_INFO_AVAILABLE_FOCAL_LENGTHS, 0, 0, /*required*/false);
+    if (!availableFocalLengths.count && !fastInfo.isExternalCamera) return NO_INIT;
+
+    // Find focal length in PREVIEW template to use as default focal length.
+    if (fastInfo.isExternalCamera) {
+        fastInfo.defaultFocalLength = -1.0;
+    } else {
+        // Find smallest (widest-angle) focal length to use as basis of still
+        // picture FOV reporting.
+        fastInfo.defaultFocalLength = availableFocalLengths.data.f[0];
+        for (size_t i = 1; i < availableFocalLengths.count; i++) {
+            if (fastInfo.defaultFocalLength > availableFocalLengths.data.f[i]) {
+                fastInfo.defaultFocalLength = availableFocalLengths.data.f[i];
+            }
+        }
+
+        // Use focal length in preview template if it exists
+        CameraMetadata previewTemplate;
+        status_t res = device->createDefaultRequest(CAMERA3_TEMPLATE_PREVIEW, &previewTemplate);
+        if (res != OK) {
+            ALOGE("%s: Failed to create default PREVIEW request: %s (%d)",
+                    __FUNCTION__, strerror(-res), res);
+            return res;
+        }
+        camera_metadata_entry entry = previewTemplate.find(ANDROID_LENS_FOCAL_LENGTH);
+        if (entry.count != 0) {
+            fastInfo.defaultFocalLength = entry.data.f[0];
+        }
+    }
+    return OK;
+}
+
 const char* Parameters::getStateName(State state) {
 #define CASE_ENUM_TO_CHAR(x) case x: return(#x); break;
     switch(state) {
@@ -2589,12 +2612,12 @@ int Parameters::abModeStringToEnum(const char *abMode) {
         -1;
 }
 
-int Parameters::sceneModeStringToEnum(const char *sceneMode) {
+int Parameters::sceneModeStringToEnum(const char *sceneMode, uint8_t defaultSceneMode) {
     return
         !sceneMode ?
-            ANDROID_CONTROL_SCENE_MODE_DISABLED :
+            defaultSceneMode :
         !strcmp(sceneMode, CameraParameters::SCENE_MODE_AUTO) ?
-            ANDROID_CONTROL_SCENE_MODE_DISABLED :
+            defaultSceneMode :
         !strcmp(sceneMode, CameraParameters::SCENE_MODE_ACTION) ?
             ANDROID_CONTROL_SCENE_MODE_ACTION :
         !strcmp(sceneMode, CameraParameters::SCENE_MODE_PORTRAIT) ?
@@ -3241,12 +3264,12 @@ status_t Parameters::calculatePictureFovs(float *horizFov, float *vertFov)
     if (horizFov != NULL) {
         *horizFov = 180 / M_PI * 2 *
                 atanf(horizCropFactor * sensorSize.data.f[0] /
-                        (2 * fastInfo.minFocalLength));
+                        (2 * fastInfo.defaultFocalLength));
     }
     if (vertFov != NULL) {
         *vertFov = 180 / M_PI * 2 *
                 atanf(vertCropFactor * sensorSize.data.f[1] /
-                        (2 * fastInfo.minFocalLength));
+                        (2 * fastInfo.defaultFocalLength));
     }
     return OK;
 }
diff --git a/services/camera/libcameraservice/api1/client2/Parameters.h b/services/camera/libcameraservice/api1/client2/Parameters.h
index 97f8ea7f3..42e7a47c8 100644
--- a/services/camera/libcameraservice/api1/client2/Parameters.h
+++ b/services/camera/libcameraservice/api1/client2/Parameters.h
@@ -30,6 +30,8 @@
 #include <camera/CameraParameters2.h>
 #include <camera/CameraMetadata.h>
 
+#include "common/CameraDeviceBase.h"
+
 namespace android {
 namespace camera2 {
 
@@ -241,7 +243,7 @@ struct Parameters {
         };
         DefaultKeyedVector<uint8_t, OverrideModes> sceneModeOverrides;
         bool isExternalCamera;
-        float minFocalLength;
+        float defaultFocalLength;
         bool useFlexibleYuv;
         Size maxJpegSize;
         Size maxZslSize;
@@ -264,10 +266,10 @@ struct Parameters {
     ~Parameters();
 
     // Sets up default parameters
-    status_t initialize(const CameraMetadata *info, int deviceVersion);
+    status_t initialize(CameraDeviceBase *device, int deviceVersion);
 
     // Build fast-access device static info from static info
-    status_t buildFastInfo();
+    status_t buildFastInfo(CameraDeviceBase *device);
     // Query for quirks from static info
     status_t buildQuirks();
 
@@ -300,6 +302,9 @@ struct Parameters {
     // whether zero shutter lag should be used for non-recording operation
     bool useZeroShutterLag() const;
 
+    // Get default focal length
+    status_t getDefaultFocalLength(CameraDeviceBase *camera);
+
     // Calculate the crop region rectangle, either tightly about the preview
     // resolution, or a region just based on the active array; both take
     // into account the current zoom level.
@@ -326,7 +331,7 @@ struct Parameters {
     static const char* wbModeEnumToString(uint8_t wbMode);
     static int effectModeStringToEnum(const char *effectMode);
     static int abModeStringToEnum(const char *abMode);
-    static int sceneModeStringToEnum(const char *sceneMode);
+    static int sceneModeStringToEnum(const char *sceneMode, uint8_t defaultScene);
     static flashMode_t flashModeStringToEnum(const char *flashMode);
     static const char* flashModeEnumToString(flashMode_t flashMode);
     static focusMode_t focusModeStringToEnum(const char *focusMode);
@@ -434,6 +439,7 @@ private:
     Size getMaxSize(const Vector<Size>& sizes);
 
     int mDeviceVersion;
+    uint8_t mDefaultSceneMode;
 };
 
 // This class encapsulates the Parameters class so that it can only be accessed
diff --git a/services/camera/libcameraservice/device3/Camera3Device.cpp b/services/camera/libcameraservice/device3/Camera3Device.cpp
index 908fe43cd..79911fc18 100644
--- a/services/camera/libcameraservice/device3/Camera3Device.cpp
+++ b/services/camera/libcameraservice/device3/Camera3Device.cpp
@@ -2147,8 +2147,14 @@ status_t Camera3Device::setConsumerSurfaces(int streamId,
 
         res = stream->finishConfiguration();
         if (res != OK) {
-            SET_ERR_L("Can't finish configuring output stream %d: %s (%d)",
-                   stream->getId(), strerror(-res), res);
+            // If finishConfiguration fails due to abandoned surface, do not set
+            // device to error state.
+            bool isSurfaceAbandoned =
+                    (res == NO_INIT || res == DEAD_OBJECT) && stream->isAbandoned();
+            if (!isSurfaceAbandoned) {
+                SET_ERR_L("Can't finish configuring output stream %d: %s (%d)",
+                        stream->getId(), strerror(-res), res);
+            }
             return res;
         }
     }
@@ -2365,9 +2371,16 @@ bool Camera3Device::reconfigureCamera(const CameraMetadata& sessionParams) {
             //present streams end up with outstanding buffers that will
             //not get drained.
             internalUpdateStatusLocked(STATUS_ACTIVE);
+        } else if (rc == DEAD_OBJECT) {
+            // DEAD_OBJECT can be returned if either the consumer surface is
+            // abandoned, or the HAL has died.
+            // - If the HAL has died, configureStreamsLocked call will set
+            // device to error state,
+            // - If surface is abandoned, we should not set device to error
+            // state.
+            ALOGE("Failed to re-configure camera due to abandoned surface");
         } else {
-            setErrorStateLocked("%s: Failed to re-configure camera: %d",
-                    __FUNCTION__, rc);
+            SET_ERR_L("Failed to re-configure camera: %d", rc);
         }
     } else {
         ALOGE("%s: Failed to pause streaming: %d", __FUNCTION__, rc);
@@ -2501,6 +2514,9 @@ status_t Camera3Device::configureStreamsLocked(int operatingMode,
             CLOGE("Can't finish configuring input stream %d: %s (%d)",
                     mInputStream->getId(), strerror(-res), res);
             cancelStreamsConfigurationLocked();
+            if ((res == NO_INIT || res == DEAD_OBJECT) && mInputStream->isAbandoned()) {
+                return DEAD_OBJECT;
+            }
             return BAD_VALUE;
         }
     }
@@ -2514,6 +2530,9 @@ status_t Camera3Device::configureStreamsLocked(int operatingMode,
                 CLOGE("Can't finish configuring output stream %d: %s (%d)",
                         outputStream->getId(), strerror(-res), res);
                 cancelStreamsConfigurationLocked();
+                if ((res == NO_INIT || res == DEAD_OBJECT) && outputStream->isAbandoned()) {
+                    return DEAD_OBJECT;
+                }
                 return BAD_VALUE;
             }
         }
diff --git a/services/camera/libcameraservice/device3/Camera3OutputStream.cpp b/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
index b3c3717c3..2c020a279 100644
--- a/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
+++ b/services/camera/libcameraservice/device3/Camera3OutputStream.cpp
@@ -564,7 +564,7 @@ status_t Camera3OutputStream::getBufferLockedCommon(ANativeWindowBuffer** anb, i
 
             // Only transition to STATE_ABANDONED from STATE_CONFIGURED. (If it is STATE_PREPARING,
             // let prepareNextBuffer handle the error.)
-            if (res == NO_INIT && mState == STATE_CONFIGURED) {
+            if ((res == NO_INIT || res == DEAD_OBJECT) && mState == STATE_CONFIGURED) {
                 mState = STATE_ABANDONED;
             }
 
diff --git a/services/camera/libcameraservice/device3/Camera3Stream.cpp b/services/camera/libcameraservice/device3/Camera3Stream.cpp
index 87476612a..6154301b7 100644
--- a/services/camera/libcameraservice/device3/Camera3Stream.cpp
+++ b/services/camera/libcameraservice/device3/Camera3Stream.cpp
@@ -331,7 +331,14 @@ status_t Camera3Stream::finishConfiguration() {
 
     status_t res;
     res = configureQueueLocked();
-    if (res != OK) {
+    // configureQueueLocked could return error in case of abandoned surface.
+    // Treat as non-fatal error.
+    if (res == NO_INIT || res == DEAD_OBJECT) {
+        ALOGE("%s: Unable to configure stream %d queue (non-fatal): %s (%d)",
+                __FUNCTION__, mId, strerror(-res), res);
+        mState = STATE_ABANDONED;
+        return res;
+    } else if (res != OK) {
         ALOGE("%s: Unable to configure stream %d queue: %s (%d)",
                 __FUNCTION__, mId, strerror(-res), res);
         mState = STATE_ERROR;
diff --git a/services/camera/libcameraservice/device3/Camera3Stream.h b/services/camera/libcameraservice/device3/Camera3Stream.h
index e6fb7f9f4..1af939c0a 100644
--- a/services/camera/libcameraservice/device3/Camera3Stream.h
+++ b/services/camera/libcameraservice/device3/Camera3Stream.h
@@ -483,6 +483,7 @@ class Camera3Stream :
     // after the HAL has provided usage and max_buffers values. After this call,
     // the stream must be ready to produce all buffers for registration with
     // HAL.
+    // Returns NO_INIT or DEAD_OBJECT if the queue has been abandoned.
     virtual status_t configureQueueLocked() = 0;
 
     // Get the total number of buffers in the queue
diff --git a/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp b/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp
index a0be60803..8bc208dfa 100644
--- a/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp
+++ b/services/camera/libcameraservice/device3/Camera3StreamSplitter.cpp
@@ -500,6 +500,10 @@ void Camera3StreamSplitter::onFrameAvailable(const BufferItem& /*item*/) {
     SP_LOGV("acquired buffer %" PRId64 " from input at slot %d",
             bufferItem.mGraphicBuffer->getId(), bufferItem.mSlot);
 
+    if (bufferItem.mTransformToDisplayInverse) {
+        bufferItem.mTransform |= NATIVE_WINDOW_TRANSFORM_INVERSE_DISPLAY;
+    }
+
     // Attach and queue the buffer to each of the outputs
     BufferTracker& tracker = *(mBuffers[bufferId]);
 
-- 
2.17.1

