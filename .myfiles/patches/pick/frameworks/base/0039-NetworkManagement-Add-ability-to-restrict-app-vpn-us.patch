From 7559385557854e733628dfd67c654983f0cae760 Mon Sep 17 00:00:00 2001
From: Uldiniad <olivercscott@gmail.com>
Date: Wed, 31 Oct 2018 02:32:03 +0000
Subject: [PATCH 39/48] NetworkManagement : Add ability to restrict app vpn
 usage

Change-Id: Ia6bd0894f3298fe6fb5cca343cbfe025e3b88ee9
---
 .../android/net/NetworkPolicyManager.java     |  2 ++
 .../android/os/INetworkManagementService.aidl |  1 +
 .../server/NetworkManagementService.java      | 28 +++++++++++++++++++
 .../net/NetworkPolicyManagerService.java      |  2 ++
 4 files changed, 33 insertions(+)

diff --git a/core/java/android/net/NetworkPolicyManager.java b/core/java/android/net/NetworkPolicyManager.java
index f291c6724ad..aa62da59f8b 100644
--- a/core/java/android/net/NetworkPolicyManager.java
+++ b/core/java/android/net/NetworkPolicyManager.java
@@ -56,6 +56,8 @@ public class NetworkPolicyManager {
     public static final int POLICY_ALLOW_METERED_BACKGROUND = 0x4;
     /** Reject application network traffic on cellular network */
     public static final int POLICY_REJECT_ON_DATA = 0x10000;
+    /** Reject application network traffic on virtual private network */
+    public static final int POLICY_REJECT_ON_VPN = 0x12000;
     /** Reject application network traffic on wifi network */
     public static final int POLICY_REJECT_ON_WLAN = 0x8000;
 
diff --git a/core/java/android/os/INetworkManagementService.aidl b/core/java/android/os/INetworkManagementService.aidl
index 48515978323..31284666036 100644
--- a/core/java/android/os/INetworkManagementService.aidl
+++ b/core/java/android/os/INetworkManagementService.aidl
@@ -455,5 +455,6 @@ interface INetworkManagementService
      * Restrict UID from accessing data/wifi
      */
     void restrictAppOnData(int uid, boolean restrict);
+    void restrictAppOnVpn(int uid, boolean restrict);
     void restrictAppOnWlan(int uid, boolean restrict);
 }
diff --git a/services/core/java/com/android/server/NetworkManagementService.java b/services/core/java/com/android/server/NetworkManagementService.java
index 0383e0449c7..df9db7ee816 100644
--- a/services/core/java/com/android/server/NetworkManagementService.java
+++ b/services/core/java/com/android/server/NetworkManagementService.java
@@ -280,6 +280,9 @@ public class NetworkManagementService extends INetworkManagementService.Stub
     /** Set of UIDs blacklisted on cellular networks. */
     @GuardedBy("mQuotaLock")
     final SparseBooleanArray mDataBlacklist = new SparseBooleanArray();
+    /** Set of UIDs blacklisted on virtual private networks. */
+    @GuardedBy("mQuotaLock")
+    final SparseBooleanArray mVpnBlacklist = new SparseBooleanArray();
     /** Set of UIDs blacklisted on WiFi networks. */
     @GuardedBy("mQuotaLock")
     final SparseBooleanArray mWlanBlacklist = new SparseBooleanArray();
@@ -1846,6 +1849,31 @@ public class NetworkManagementService extends INetworkManagementService.Stub
         }
     }
 
+    @Override
+    public void restrictAppOnVpn(int uid, boolean restrict) {
+        mContext.enforceCallingOrSelfPermission(CONNECTIVITY_INTERNAL, TAG);
+        // silently discard when control disabled
+        if (!mBandwidthControlEnabled) return;
+
+        synchronized (mQuotaLock) {
+            boolean oldValue = mVpnBlacklist.get(uid, false);
+            if (oldValue == restrict) {
+                return;
+            }
+            mVpnBlacklist.put(uid, restrict);
+        }
+
+        try {
+            final String action = restrict ? "add" : "remove";
+            mConnector.execute("bandwidth", action + "restrictappsonvpn",
+                    "ppp0", uid);
+            mConnector.execute("bandwidth", action + "restrictappsonvpn",
+                    "tun0", uid);
+        } catch (NativeDaemonConnectorException e) {
+            throw e.rethrowAsParcelableException();
+        }
+    }
+
     @Override
     public void restrictAppOnWlan(int uid, boolean restrict) {
         mContext.enforceCallingOrSelfPermission(CONNECTIVITY_INTERNAL, TAG);
diff --git a/services/core/java/com/android/server/net/NetworkPolicyManagerService.java b/services/core/java/com/android/server/net/NetworkPolicyManagerService.java
index db33bd8f08d..fee9a425719 100644
--- a/services/core/java/com/android/server/net/NetworkPolicyManagerService.java
+++ b/services/core/java/com/android/server/net/NetworkPolicyManagerService.java
@@ -57,6 +57,7 @@ import static android.net.NetworkPolicyManager.POLICY_ALLOW_METERED_BACKGROUND;
 import static android.net.NetworkPolicyManager.POLICY_NONE;
 import static android.net.NetworkPolicyManager.POLICY_REJECT_METERED_BACKGROUND;
 import static android.net.NetworkPolicyManager.POLICY_REJECT_ON_DATA;
+import static android.net.NetworkPolicyManager.POLICY_REJECT_ON_VPN;
 import static android.net.NetworkPolicyManager.POLICY_REJECT_ON_WLAN;
 import static android.net.NetworkPolicyManager.RULE_ALLOW_ALL;
 import static android.net.NetworkPolicyManager.RULE_ALLOW_METERED;
@@ -3995,6 +3996,7 @@ public class NetworkPolicyManagerService extends INetworkPolicyManager.Stub {
 
         try {
             mNetworkManager.restrictAppOnData(uid, (uidPolicy & POLICY_REJECT_ON_DATA) != 0);
+            mNetworkManager.restrictAppOnVpn(uid, (uidPolicy & POLICY_REJECT_ON_VPN) != 0);
             mNetworkManager.restrictAppOnWlan(uid, (uidPolicy & POLICY_REJECT_ON_WLAN) != 0);
         } catch (RemoteException e) {
             // ignored; service lives in system_server
-- 
2.17.1

