From d010c342237097764fd571d9bb1ac34c222f4c44 Mon Sep 17 00:00:00 2001
From: Nicholas Sauer <nicksauer@google.com>
Date: Fri, 2 Nov 2018 17:04:52 -0700
Subject: [PATCH 10/15] Fix run-as for non-owner users

bug: 118501138
bug: 80126373
Test: cts-tradefed run cts-dev -a arm64-v8a -m CtsJvmtiRunTest1908HostTestCases
Change-Id: Iee25afbffc6990b46f508bfe8a9953bd2a35d118
---
 run-as/run-as.cpp | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/run-as/run-as.cpp b/run-as/run-as.cpp
index b27cfad7c..e83a756a0 100644
--- a/run-as/run-as.cpp
+++ b/run-as/run-as.cpp
@@ -159,6 +159,15 @@ int main(int argc, char* argv[]) {
   if (!packagelist_parse(packagelist_parse_callback, &info)) {
     error(1, errno, "packagelist_parse failed");
   }
+
+  // Handle a multi-user data path
+  if (userId > 0) {
+    free(info.data_dir);
+    if (asprintf(&info.data_dir, "/data/user/%d/%s", userId, pkgname) == -1) {
+      error(1, errno, "asprintf failed");
+    }
+  }
+
   if (info.uid == 0) {
     error(1, 0, "unknown package: %s", pkgname);
   }
-- 
2.17.1

