From 9788af85916817f30cb896335a976574d5b30e12 Mon Sep 17 00:00:00 2001
From: nx111 <NX111.AimH@gmail.com>
Date: Mon, 26 Nov 2018 20:07:04 +0800
Subject: [PATCH 173/173] snap: fix CameraHolder init error when context is
 null.

Change-Id: I420be857ef61bd926359377a2f0e12cbbb6f9baa
---
 src/com/android/camera/CameraHolder.java          | 7 ++++---
 src/com/android/camera/DisableCameraReceiver.java | 9 +++++++++
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/src/com/android/camera/CameraHolder.java b/src/com/android/camera/CameraHolder.java
index 585e3bb4d..345eb5140 100755
--- a/src/com/android/camera/CameraHolder.java
+++ b/src/com/android/camera/CameraHolder.java
@@ -173,11 +173,12 @@ public class CameraHolder {
         HandlerThread ht = new HandlerThread("CameraHolder");
         ht.start();
         mHandler = new MyHandler(ht.getLooper());
-        android.hardware.camera2.CameraManager manager =
-                (android.hardware.camera2.CameraManager) mContext.getSystemService(
-                        Context.CAMERA_SERVICE);
         String[] cameraIdList = null;
+
         try {
+            android.hardware.camera2.CameraManager manager =
+                (android.hardware.camera2.CameraManager) mContext.getSystemService(
+                        Context.CAMERA_SERVICE);
             cameraIdList = manager.getCameraIdList();
             mInfo = new CameraInfo[cameraIdList.length];
             for (int i = 0; i < cameraIdList.length; i++) {
diff --git a/src/com/android/camera/DisableCameraReceiver.java b/src/com/android/camera/DisableCameraReceiver.java
index 3551a4306..69d0f4a1e 100644
--- a/src/com/android/camera/DisableCameraReceiver.java
+++ b/src/com/android/camera/DisableCameraReceiver.java
@@ -22,6 +22,8 @@ import android.content.Context;
 import android.content.Intent;
 import android.content.pm.PackageManager;
 import android.hardware.Camera.CameraInfo;
+import com.android.camera.util.CameraUtil;
+import org.codeaurora.snapcam.R;
 import android.util.Log;
 
 // We want to disable camera-related activities if there is no camera. This
@@ -36,6 +38,13 @@ public class DisableCameraReceiver extends BroadcastReceiver {
 
     @Override
     public void onReceive(Context context, Intent intent) {
+        boolean mCamera2supported = CameraUtil.isCamera2Supported(context);
+
+        boolean mCamera2enabled = mCamera2supported &&
+                context.getResources().getBoolean(R.bool.support_camera_api_v2);
+
+        CameraHolder.setCamera2Mode(context, mCamera2enabled);
+
         // Disable camera-related activities if there is no camera.
         boolean needCameraActivity = CHECK_BACK_CAMERA_ONLY
             ? hasBackCamera()
-- 
2.17.1

